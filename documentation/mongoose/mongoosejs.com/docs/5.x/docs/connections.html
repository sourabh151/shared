<!DOCTYPE html><html lang="en">
<!-- Mirrored from mongoosejs.com/docs/5.x/docs/connections.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:51 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose v5.13.14: Connecting to MongoDB</title><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="stylesheet" href="../../../../unpkg.com/purecss%401.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous"><link rel="stylesheet" href="../../../../fonts.googleapis.com/cssd2d5.css?family=Open+Sans"><link rel="stylesheet" href="../../css/github.css"><link rel="stylesheet" href="../../css/mongoose5.css"><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="manifest" href="images/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="../../css/inlinecpc.css"><script type="text/javascript" src="../../js/native.js"></script><style>p { line-height: 1.5em }
</style></head><body><div id="layout"><div id="mobile-menu"><a class="menu-link" id="menuLink" href="#menu"><span></span></a><div id="mobile-logo-container"><a href="../../../index.html"><img id="logo" src="../../images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div></div><div id="menu"><div class="pure-menu"><div class="pure-menu-heading" id="logo-container"><a href="../../../index.html"><img id="logo" src="../../images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div><ul class="pure-menu-list" id="navbar"><li class="pure-menu-horizontal pure-menu-item pure-menu-has-children pure-menu-allow-hover version"><a class="pure-menu-link" href="#">Version 5.13.14</a><ul class="pure-menu-children"><li class="pure-menu-item"><a class="pure-menu-link" href="../../index-2.html">Version 6.x</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="../../4.x/index.html">Version 4.13.21</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="../../3.8.x/index.html">Version 3.8.40</a></li></ul></li><li class="pure-menu-item search"><input id="search-input-nav" type="text" placeholder="Search"><button id="search-button-nav"><img src="../../images/search.svg"></button></li><li class="pure-menu-item"><a class="pure-menu-link" href="index.html">Quick Start</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="guides.html">Guides</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="guide.html">Schemas</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="schematypes.html">SchemaTypes</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link selected" href="connections.html">Connections</a></li><li class="pure-menu-item tertiary-item"><a class="pure-menu-link" href="../tutorials/ssl.html">SSL Connections</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="models.html">Models</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="documents.html">Documents</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="subdocs.html">Subdocuments</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="queries.html">Queries</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="validation.html">Validation</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="middleware.html">Middleware</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="populate.html">Populate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="discriminators.html">Discriminators</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="plugins.html">Plugins</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="transactions.html">Transactions</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="typescript.html">TypeScript</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="api.html">API</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/mongoose.html">Mongoose</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/schema.html">Schema</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/connection.html">Connection</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/document.html">Document</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/model.html">Model</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/query.html">Query</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/aggregate.html">Aggregate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/schematype.html">SchemaType</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/virtualtype.html">VirtualType</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="compatibility.html">Version Compatibility</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="faq.html">FAQ</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="further_reading.html">Further Reading</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="enterprise.html">For Enterprise</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="built-with-mongoose.html" >Built with Mongoose</a></li></ul><div class="cpc-ad"><script async type="text/javascript" src="../../../../cdn.carbonads.com/carbonc27f.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=mongoosejscom" id="_carbonads_js"></script></div></div></div><div class="container"><div id="content"><a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/connections.md" target="_blank">
<img src="../../images/pencil.svg" />
</a><h2 id="connections">Connections</h2>
<script>
  _native.init("CK7DT53U",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# â€” #native_desc#</a>
</div>

<p>You can connect to MongoDB with the <code>mongoose.connect()</code> method.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/myapp'</span>, {<span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>});
</code></pre>
<p>This is the minimum needed to connect the <code>myapp</code> database running locally
on the default port (27017). If connecting fails on your machine, try using
<code>127.0.0.1</code> instead of <code>localhost</code>.</p>
<p>You can also specify several more parameters in the <code>uri</code>:</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://username:password@host:port/database?options...'</span>, {<span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>});
</code></pre>
<p>See the <a href="http://docs.mongodb.org/manual/reference/connection-string/">mongodb connection string spec</a> for more detail.</p>
<ul class="toc">
  <li><a href="#buffering">Buffering</a></li>
  <li><a href="#error-handling">Error Handling</a></li>
  <li><a href="#options">Options</a></li>
  <li><a href="#connection-string-options">Connection String Options</a></li>
  <li><a href="#connection-events">Connection Events</a></li>
  <li><a href="#keepAlive">A note about keepAlive</a></li>
  <li><a href="#server-selection">Server Selection</a></li>
  <li><a href="#replicaset_connections">Replica Set Connections</a></li>
  <li><a href="#replicaset-hostnames">Replica Set Host Names</a></li>
  <li><a href="#mongos_connections">Multi-mongos support</a></li>
  <li><a href="#multiple_connections">Multiple connections</a></li>
  <li><a href="#connection_pools">Connection Pools</a></li>
  <li><a href="#v5-changes">Option Changes in v5.x</a></li>
</ul>

<h3 id="buffering"><a href="#buffering">Operation Buffering</a></h3>

<p>Mongoose lets you start using your models immediately, without waiting for
mongoose to establish a connection to MongoDB.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/myapp'</span>, {<span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>});
<span class="hljs-keyword">const</span> MyModel = mongoose.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span> }));
<span class="hljs-comment">// Works</span>
MyModel.findOne(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{ <span class="hljs-comment">/* ... */</span> });
</code></pre>
<p>That&#39;s because mongoose buffers model function calls internally. This
buffering is convenient, but also a common source of confusion. Mongoose
will <em>not</em> throw any errors by default if you use a model without
connecting.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> MyModel = mongoose.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span> }));
<span class="hljs-comment">// Will just hang until mongoose successfully connects</span>
MyModel.findOne(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{ <span class="hljs-comment">/* ... */</span> });

setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/myapp'</span>, {<span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>});
}, <span class="hljs-number">60000</span>);
</code></pre>
<p>To disable buffering, turn off the <a href="guide.html#bufferCommands"><code>bufferCommands</code> option on your schema</a>.
If you have <code>bufferCommands</code> on and your connection is hanging, try turning
<code>bufferCommands</code> off to see if you haven&#39;t opened a connection properly.
You can also disable <code>bufferCommands</code> globally:</p>
<pre><code class="language-javascript">mongoose.set(<span class="hljs-string">'bufferCommands'</span>, <span class="hljs-literal">false</span>);
</code></pre>
<p>Note that buffering is also responsible for waiting until Mongoose
creates collections if you use the <a href="../../guide.html#autoCreate"><code>autoCreate</code> option</a>.
If you disable buffering, you should also disable the <code>autoCreate</code>
option and use <a href="../../api/model.html#model_Model.createCollection"><code>createCollection()</code></a>
to create <a href="../../guide.html#capped">capped collections</a> or
<a href="../../guide.html#collation">collections with collations</a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>
}, {
  <span class="hljs-attr">capped</span>: { <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span> },
  <span class="hljs-attr">bufferCommands</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">autoCreate</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// disable `autoCreate` since `bufferCommands` is false</span>
});

<span class="hljs-keyword">const</span> Model = mongoose.model(<span class="hljs-string">'Test'</span>, schema);
<span class="hljs-comment">// Explicitly create the collection before using it</span>
<span class="hljs-comment">// so the collection is capped.</span>
<span class="hljs-keyword">await</span> Model.createCollection();
</code></pre>
<h3 id="error-handling"><a href="#error-handling">Error Handling</a></h3>

<p>There are two classes of errors that can occur with a Mongoose connection.</p>
<ul>
<li>Error on initial connection. If initial connection fails, Mongoose will emit an &#39;error&#39; event and the promise <code>mongoose.connect()</code> returns will reject. However, Mongoose will <strong>not</strong> automatically try to reconnect.</li>
<li>Error after initial connection was established. Mongoose will attempt to reconnect, and it will emit an &#39;error&#39; event.</li>
</ul>
<p>To handle initial connection errors, you should use <code>.catch()</code> or <code>try/catch</code> with async/await.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span> }).
  catch(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> handleError(error));

<span class="hljs-comment">// Or:</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span> });
} <span class="hljs-keyword">catch</span> (error) {
  handleError(error);
}
</code></pre>
<p>To handle errors after initial connection was established, you should
listen for error events on the connection. However, you still need to
handle initial connection errors as shown above.</p>
<pre><code class="language-javascript">mongoose.connection.on(<span class="hljs-string">'error'</span>, err =&gt; {
  logError(err);
});
</code></pre>
<p>Note that Mongoose does not necessarily emit an &#39;error&#39; event if it loses connectivity to MongoDB. You should
listen to the <code>disconnected</code> event to report when Mongoose is disconnected from MongoDB.</p>
<h3 id="options"><a href="#options">Options</a></h3>

<p>The <code>connect</code> method also accepts an <code>options</code> object which will be passed
on to the underlying MongoDB driver.</p>
<pre><code class="language-javascript">mongoose.connect(uri, options);
</code></pre>
<p>A full list of options can be found on the <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect">MongoDB Node.js driver docs for <code>connect()</code></a>.
Mongoose passes options to the driver without modification, modulo a few
exceptions that are explained below.</p>
<ul>
<li><code>bufferCommands</code>    - This is a mongoose-specific option (not passed to the MongoDB driver) that disables <a href="../../faq.html#callback_never_executes">Mongoose&#39;s buffering mechanism</a></li>
<li><code>user</code>/<code>pass</code>       - The username and password for authentication. These options are Mongoose-specific, they are equivalent to the MongoDB driver&#39;s <code>auth.user</code> and <code>auth.password</code> options.</li>
<li><code>autoIndex</code>         - By default, mongoose will automatically build indexes defined in your schema when it connects. This is great for development, but not ideal for large production deployments, because index builds can cause performance degradation. If you set <code>autoIndex</code> to false, mongoose will not automatically build indexes for <strong>any</strong> model associated with this connection.</li>
<li><code>dbName</code>            - Specifies which database to connect to and overrides any database specified in the connection string. This is useful if you are unable to specify a default database in the connection string like with <a href="https://stackoverflow.com/questions/48917591/fail-to-connect-mongoose-to-atlas/48917626#48917626">some <code>mongodb+srv</code> syntax connections</a>.</li>
</ul>
<p>Below are some of the options that are important for tuning Mongoose.</p>
<ul>
<li><code>useNewUrlParser</code>   - The underlying MongoDB driver has deprecated their current <a href="https://docs.mongodb.com/manual/reference/connection-string/">connection string</a> parser. Because this is a major change, they added the <code>useNewUrlParser</code> flag to allow users to fall back to the old parser if they find a bug in the new parser. You should set <code>useNewUrlParser: true</code> unless that prevents you from connecting. Note that if you specify <code>useNewUrlParser: true</code>, you <strong>must</strong> specify a port in your connection string, like <code>mongodb://localhost:27017/dbname</code>. The new url parser does <em>not</em> support connection strings that do not have a port, like <code>mongodb://localhost/dbname</code>.</li>
<li><code>useCreateIndex</code>    - False by default. Set to <code>true</code> to make Mongoose&#39;s default index build use <code>createIndex()</code> instead of <code>ensureIndex()</code> to avoid deprecation warnings from the MongoDB driver.</li>
<li><code>useFindAndModify</code>  - True by default. Set to <code>false</code> to make <code>findOneAndUpdate()</code> and <code>findOneAndRemove()</code> use native <code>findOneAndUpdate()</code> rather than <code>findAndModify()</code>.</li>
<li><code>useUnifiedTopology</code>- False by default. Set to <code>true</code> to opt in to using <a href="../../deprecations.html#useunifiedtopology">the MongoDB driver&#39;s new connection management engine</a>. You should set this option to <code>true</code>, except for the unlikely case that it prevents you from maintaining a stable connection.</li>
<li><code>promiseLibrary</code>    - Sets the <a href="http://mongodb.github.io/node-mongodb-native/3.1/api/MongoClient.html">underlying driver&#39;s promise library</a>.</li>
<li><code>poolSize</code>          - The maximum number of sockets the MongoDB driver will keep open for this connection. By default, <code>poolSize</code> is 5. Keep in mind that, as of MongoDB 3.4, MongoDB only allows one operation per socket at a time, so you may want to increase this if you find you have a few slow queries that are blocking faster queries from proceeding. See <a href="http://thecodebarbarian.com/slow-trains-in-mongodb-and-nodejs">Slow Trains in MongoDB and Node.js</a>.</li>
<li><code>socketTimeoutMS</code>   - How long the MongoDB driver will wait before killing a socket due to inactivity <em>after initial connection</em>. A socket may be inactive because of either no activity or a long-running operation. This is set to <code>30000</code> by default, you should set this to 2-3x your longest running operation if you expect some of your database operations to run longer than 20 seconds. This option is passed to <a href="https://nodejs.org/api/net.html#net_socket_settimeout_timeout_callback">Node.js <code>socket#setTimeout()</code> function</a> after the MongoDB driver successfully completes.</li>
<li><code>family</code>            - Whether to connect using IPv4 or IPv6. This option passed to <a href="https://nodejs.org/api/dns.html#dns_dns_lookup_hostname_options_callback">Node.js&#39; <code>dns.lookup()</code></a> function. If you don&#39;t specify this option, the MongoDB driver will try IPv6 first and then IPv4 if IPv6 fails. If your <code>mongoose.connect(uri)</code> call takes a long time, try <code>mongoose.connect(uri, { family: 4 })</code></li>
<li><code>authSource</code>        - The database to use when authenticating with <code>user</code> and <code>pass</code>. In MongoDB, <a href="https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/">users are scoped to a database</a>. If you are getting an unexpected login failure, you may need to set this option.</li>
</ul>
<p>The following options are important for tuning Mongoose only if you are
running <strong>without</strong> <a href="../../deprecations.html#useunifiedtopology">the <code>useUnifiedTopology</code> option</a>:</p>
<ul>
<li><code>autoReconnect</code>     - The underlying MongoDB driver will automatically try to reconnect when it loses connection to MongoDB. Unless you are an extremely advanced user that wants to manage their own connection pool, do <strong>not</strong> set this option to <code>false</code>.</li>
<li><code>reconnectTries</code>    - If you&#39;re connected to a single server or mongos proxy (as opposed to a replica set), the MongoDB driver will try to reconnect every <code>reconnectInterval</code> milliseconds for <code>reconnectTries</code> times, and give up afterward. When the driver gives up, the mongoose connection emits a <code>reconnectFailed</code> event. This option does nothing for replica set connections.</li>
<li><code>reconnectInterval</code> - See <code>reconnectTries</code></li>
<li><code>bufferMaxEntries</code>  - The MongoDB driver also has its own buffering mechanism that kicks in when the driver is disconnected. Set this option to 0 and set <code>bufferCommands</code> to <code>false</code> on your schemas if you want your database operations to fail immediately when the driver is not connected, as opposed to waiting for reconnection.</li>
<li><code>connectTimeoutMS</code>  - How long the MongoDB driver will wait before killing a socket due to inactivity <em>during initial connection</em>. Defaults to 30000. This option is passed transparently to <a href="https://nodejs.org/api/net.html#net_socket_settimeout_timeout_callback">Node.js&#39; <code>socket#setTimeout()</code> function</a>.</li>
</ul>
<p>The following options are important for tuning Mongoose only if you are
running <strong>with</strong> <a href="../../deprecations.html#useunifiedtopology">the <code>useUnifiedTopology</code> option</a>:</p>
<ul>
<li><code>serverSelectionTimeoutMS</code> - With <code>useUnifiedTopology</code>, the MongoDB driver will try to find a server to send any given operation to, and keep retrying for <code>serverSelectionTimeoutMS</code> milliseconds. If not set, the MongoDB driver defaults to using <code>30000</code> (30 seconds).</li>
<li><code>heartbeatFrequencyMS</code> - With <code>useUnifiedTopology</code>, the MongoDB driver sends a heartbeat every <code>heartbeatFrequencyMS</code> to check on the status of the connection. A heartbeat is subject to <code>serverSelectionTimeoutMS</code>, so the MongoDB driver will retry failed heartbeats for up to 30 seconds by default. Mongoose only emits a <code>&#39;disconnected&#39;</code> event after a heartbeat has failed, so you may want to decrease this setting to reduce the time between when your server goes down and when Mongoose emits <code>&#39;disconnected&#39;</code>. We recommend you do <strong>not</strong> set this setting below 1000, too many heartbeats can lead to performance degradation.</li>
</ul>
<p>The <code>serverSelectionTimeoutMS</code> option also handles how long <code>mongoose.connect()</code> will
retry initial connection before erroring out. With <code>useUnifiedTopology</code>, <code>mongoose.connect()</code>
will retry for 30 seconds by default (default <code>serverSelectionTimeoutMS</code>) before
erroring out. To get faster feedback on failed operations, you can reduce <code>serverSelectionTimeoutMS</code>
to 5000 as shown below.</p>
<p>Example:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">useCreateIndex</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">useFindAndModify</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">autoIndex</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Don't build indexes</span>
  <span class="hljs-attr">poolSize</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// Maintain up to 10 socket connections</span>
  <span class="hljs-attr">serverSelectionTimeoutMS</span>: <span class="hljs-number">5000</span>, <span class="hljs-comment">// Keep trying to send operations for 5 seconds</span>
  <span class="hljs-attr">socketTimeoutMS</span>: <span class="hljs-number">45000</span>, <span class="hljs-comment">// Close sockets after 45 seconds of inactivity</span>
  <span class="hljs-attr">family</span>: <span class="hljs-number">4</span> <span class="hljs-comment">// Use IPv4, skip trying IPv6</span>
};
mongoose.connect(uri, options);
</code></pre>
<p>See <a href="http://mongodb.github.io/node-mongodb-native/3.1/reference/faq/">this page</a> for more information about <code>connectTimeoutMS</code> and <code>socketTimeoutMS</code></p>
<h3 id="callback"><a href="#callback">Callback</a></h3>

<p>The <code>connect()</code> function also accepts a callback parameter and returns a
<a href="promises.html">promise</a>.</p>
<pre><code class="language-javascript">mongoose.connect(uri, options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
  <span class="hljs-comment">// Check error in initial connection. There is no 2nd param to the callback.</span>
});

<span class="hljs-comment">// Or using promises</span>
mongoose.connect(uri, options).then(
  <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { <span class="hljs-comment">/** ready to use. The `mongoose.connect()` promise resolves to mongoose instance. */</span> },
  err =&gt; { <span class="hljs-comment">/** handle initial connection error */</span> }
);
</code></pre>
<h3 id="connection-string-options"><a href="#connection-string-options">Connection String Options</a></h3>

<p>You can also specify driver options in your connection string as
<a href="https://en.wikipedia.org/wiki/Query_string">parameters in the query string</a>
portion of the URI. This only applies to options passed to the MongoDB
driver. You <strong>can&#39;t</strong> set Mongoose-specific options like <code>bufferCommands</code>
in the query string.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test?connectTimeoutMS=1000&amp;bufferCommands=false&amp;authSource=otherdb'</span>);
<span class="hljs-comment">// The above is equivalent to:</span>
mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, {
  <span class="hljs-attr">connectTimeoutMS</span>: <span class="hljs-number">1000</span>
  <span class="hljs-comment">// Note that mongoose will **not** pull `bufferCommands` from the query string</span>
});
</code></pre>
<p>The disadvantage of putting options in the query string is that query
string options are harder to read. The advantage is that you only need a
single configuration option, the URI, rather than separate options for
<code>socketTimeoutMS</code>, <code>connectTimeoutMS</code>, etc. Best practice is to put options
that likely differ between development and production, like <code>replicaSet</code>
or <code>ssl</code>, in the connection string, and options that should remain constant,
like <code>connectTimeoutMS</code> or <code>poolSize</code>, in the options object.</p>
<p>The MongoDB docs have a full list of
<a href="https://docs.mongodb.com/manual/reference/connection-string/">supported connection string options</a>.
Below are some options that are often useful to set in the connection string because they
are closely associated with the hostname and authentication information.</p>
<ul>
<li><code>authSource</code>        - The database to use when authenticating with <code>user</code> and <code>pass</code>. In MongoDB, <a href="https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/">users are scoped to a database</a>. If you are getting an unexpected login failure, you may need to set this option.</li>
<li><code>family</code>            - Whether to connect using IPv4 or IPv6. This option passed to <a href="https://nodejs.org/api/dns.html#dns_dns_lookup_hostname_options_callback">Node.js&#39; <code>dns.lookup()</code></a> function. If you don&#39;t specify this option, the MongoDB driver will try IPv6 first and then IPv4 if IPv6 fails. If your <code>mongoose.connect(uri)</code> call takes a long time, try <code>mongoose.connect(uri, { family: 4 })</code></li>
</ul>
<h3 id="connection-events"><a href="#connection-events">Connection Events</a></h3>

<p>Connections inherit from <a href="https://nodejs.org/api/events.html#events_class_eventemitter">Node.js&#39; <code>EventEmitter</code> class</a>,
and emit events when something happens to the connection, like losing
connectivity to the MongoDB server. Below is a list of events that a
connection may emit.</p>
<ul>
<li><code>connecting</code>: Emitted when Mongoose starts making its initial connection to the MongoDB server</li>
<li><code>connected</code>: Emitted when Mongoose successfully makes its initial connection to the MongoDB server, or when Mongoose reconnects after losing connectivity.</li>
<li><code>open</code>: Equivalent to <code>connected</code></li>
<li><code>disconnecting</code>: Your app called <a href="api.html#connection_Connection-close"><code>Connection#close()</code></a> to disconnect from MongoDB</li>
<li><code>disconnected</code>: Emitted when Mongoose lost connection to the MongoDB server. This event may be due to your code explicitly closing the connection, the database server crashing, or network connectivity issues.</li>
<li><code>close</code>: Emitted after <a href="api.html#connection_Connection-close"><code>Connection#close()</code></a> successfully closes the connection. If you call <code>conn.close()</code>, you&#39;ll get both a &#39;disconnected&#39; event and a &#39;close&#39; event.</li>
<li><code>reconnected</code>: Emitted if Mongoose lost connectivity to MongoDB and successfully reconnected. Mongoose attempts to <a href="https://thecodebarbarian.com/managing-connections-with-the-mongodb-node-driver.html">automatically reconnect</a> when it loses connection to the database.</li>
<li><code>error</code>: Emitted if an error occurs on a connection, like a <code>parseError</code> due to malformed data or a payload larger than <a href="https://docs.mongodb.com/manual/reference/limits/#BSON-Document-Size">16MB</a>.</li>
<li><code>fullsetup</code>: Emitted when you&#39;re connecting to a replica set and Mongoose has successfully connected to the primary and at least one secondary.</li>
<li><code>all</code>: Emitted when you&#39;re connecting to a replica set and Mongoose has successfully connected to all servers specified in your connection string.</li>
<li><code>reconnectFailed</code>: Emitted when you&#39;re connected to a standalone server and Mongoose has run out of <a href="https://thecodebarbarian.com/managing-connections-with-the-mongodb-node-driver.html#handling-single-server-outages"><code>reconnectTries</code></a>. The <a href="http://npmjs.com/package/mongodb">MongoDB driver</a> will no longer attempt to reconnect after this event is emitted. This event will never be emitted if you&#39;re connected to a replica set.</li>
</ul>
<p>When you&#39;re connecting to a single MongoDB server (a &quot;standalone&quot;), Mongoose will emit &#39;disconnected&#39; if it gets
disconnected from the standalone server, and &#39;connected&#39; if it successfully connects to the standalone. In a
replica set with <code>useUnifiedTopology = true</code>, Mongoose will emit &#39;disconnected&#39; if it loses connectivity to
<em>every</em> server in the replica set, and &#39;connected&#39; if it manages to reconnect to at least one server in the replica set.</p>
<h3 id="keepAlive"><a href="#keepAlive">A note about keepAlive</a></h3>

<p>For long running applications, it is often prudent to enable <code>keepAlive</code>
with a number of milliseconds. Without it, after some period of time
you may start to see <code>&quot;connection closed&quot;</code> errors for what seems like
no reason. If so, after
<a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html">reading this</a>,
you may decide to enable <code>keepAlive</code>:</p>
<pre><code class="language-javascript">mongoose.connect(uri, { <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">keepAliveInitialDelay</span>: <span class="hljs-number">300000</span> });
</code></pre>
<p><code>keepAliveInitialDelay</code> is the number of milliseconds to wait before initiating <code>keepAlive</code> on the socket.
<code>keepAlive</code> is true by default since mongoose 5.2.0.</p>
<h3 id="replicaset_connections"><a href="#replicaset_connections">Replica Set Connections</a></h3>

<p>To connect to a replica set you pass a comma delimited list of hosts to
connect to rather than a single host.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]'</span> [, options]);
</code></pre>
<p>For example:</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://user:pw@host1.com:27017,host2.com:27017,host3.com:27017/testdb'</span>);
</code></pre>
<p>To connect to a single node replica set, specify the <code>replicaSet</code> option.</p>
<pre><code class="language-javascript">mongoose.connect(<span class="hljs-string">'mongodb://host1:port1/?replicaSet=rsName'</span>);
</code></pre>
<h3 id="server-selection"><a href="#server-selection">Server Selection</a></h3>

<p>If you enable the <code>useUnifiedTopology</code> option, the underlying MongoDB driver
will use <a href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst">server selection</a>
to connect to MongoDB and send operations to MongoDB. If the MongoDB
driver can&#39;t find a server to send an operation to after <code>serverSelectionTimeoutMS</code>,
you&#39;ll get the below error:</p>
<pre><code>MongoTimeoutError: Server selection timed out after <span class="hljs-number">30000</span> ms
</code></pre>
<p>You can configure the timeout using the <code>serverSelectionTimeoutMS</code> option
to <code>mongoose.connect()</code>:</p>
<pre><code class="language-javascript">mongoose.connect(uri, {
  <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">serverSelectionTimeoutMS</span>: <span class="hljs-number">5000</span> <span class="hljs-comment">// Timeout after 5s instead of 30s</span>
});
</code></pre>
<p>A <code>MongoTimeoutError</code> has a <code>reason</code> property that explains why
server selection timed out. For example, if you&#39;re connecting to
a standalone server with an incorrect password, <code>reason</code>
will contain an &quot;Authentication failed&quot; error.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb+srv://username:badpw@cluster0-OMITTED.mongodb.net/'</span> +
  <span class="hljs-string">'test?retryWrites=true&amp;w=majority'</span>;
<span class="hljs-comment">// Prints "MongoError: bad auth Authentication failed."</span>
mongoose.connect(uri, {
  <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">serverSelectionTimeoutMS</span>: <span class="hljs-number">5000</span>
}).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(err.reason));
</code></pre>
<h3 id="replicaset-hostnames"><a href="#replicaset-hostnames">Replica Set Host Names</a></h3>

<p>MongoDB replica sets rely on being able to reliably figure out the domain name
for each member. On Linux and OSX, the MongoDB server uses the output of the
<a href="https://linux.die.net/man/1/hostname"><code>hostname</code> command</a> to figure out the
domain name to report to the replica set. This can cause confusing errors
if you&#39;re connecting to a remote MongoDB replica set running on a machine that
reports its <code>hostname</code> as <code>localhost</code>:</p>
<pre><code><span class="hljs-comment">// Can get this error even if your connection string doesn't include</span>
<span class="hljs-comment">// `localhost` if `rs.conf()` reports that one replica set member has</span>
<span class="hljs-comment">// `localhost` as its host name.</span>
failed to connect to server [localhost:<span class="hljs-number">27017</span>] on first connect
</code></pre>
<p>If you&#39;re experiencing a similar error, connect to the replica set using the
<code>mongo</code> shell and run the
<a href="https://docs.mongodb.com/manual/reference/method/rs.conf/"><code>rs.conf()</code></a> command to check the host names of each replica set member. Follow
<a href="https://docs.mongodb.com/manual/tutorial/change-hostnames-in-a-replica-set/#change-hostnames-while-maintaining-replica-set-availability">this page&#39;s instructions to change a replica set member&#39;s host name</a>.</p>
<h3 id="mongos_connections"><a href="#mongos_connections">Multi-mongos support</a></h3>

<p>You can also connect to multiple <a href="https://docs.mongodb.com/manual/reference/program/mongos/">mongos</a> instances
for high availability in a sharded cluster. You do
<a href="http://mongodb.github.io/node-mongodb-native/3.0/tutorials/connect/#connect-to-sharded-cluster">not need to pass any special options to connect to multiple mongos</a> in mongoose 5.x.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Connect to 2 mongos servers</span>
mongoose.connect(<span class="hljs-string">'mongodb://mongosA:27501,mongosB:27501'</span>, cb);
</code></pre>
<h3 id="multiple_connections"><a href="#multiple_connections">Multiple connections</a></h3>

<p>So far we&#39;ve seen how to connect to MongoDB using Mongoose&#39;s default
connection. Mongoose creates a <em>default connection</em> when you call <code>mongoose.connect()</code>.
You can access the default connection using <code>mongoose.connection</code>.</p>
<p>You may need multiple connections to MongoDB for several reasons.
One reason is if you have multiple databases or multiple MongoDB clusters.
Another reason is to work around <a href="https://thecodebarbarian.com/slow-trains-in-mongodb-and-nodejs">slow trains</a>.
The <code>mongoose.createConnection()</code> function takes the same arguments as
<code>mongoose.connect()</code> and returns a new connection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> conn = mongoose.createConnection(<span class="hljs-string">'mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]'</span>, options);
</code></pre>
<p>This <a href="api.html#connection_Connection">connection</a> object is then used to
create and retrieve <a href="api.html#model_Model">models</a>. Models are
<strong>always</strong> scoped to a single connection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> UserModel = conn.model(<span class="hljs-string">'User'</span>, userSchema);
</code></pre>
<p>If you use multiple connections, you should make sure you export schemas,
<strong>not</strong> models. Exporting a model from a file is called the <em>export model pattern</em>.
The export model pattern is limited because you can only use one connection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>, <span class="hljs-attr">email</span>: <span class="hljs-built_in">String</span> });

<span class="hljs-comment">// The alternative to the export model pattern is the export schema pattern.</span>
<span class="hljs-built_in">module</span>.exports = userSchema;

<span class="hljs-comment">// Because if you export a model as shown below, the model will be scoped</span>
<span class="hljs-comment">// to Mongoose's default connection.</span>
<span class="hljs-comment">// module.exports = mongoose.model('User', userSchema);</span>
</code></pre>
<p>If you use the export schema pattern, you still need to create models
somewhere. There are two common patterns. First is to export a connection
and register the models on the connection in the file:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// connections/fast.js</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">const</span> conn = mongoose.createConnection(process.env.MONGODB_URI);
conn.model(<span class="hljs-string">'User'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'../schemas/user'</span>));

<span class="hljs-built_in">module</span>.exports = conn;

<span class="hljs-comment">// connections/slow.js</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-keyword">const</span> conn = mongoose.createConnection(process.env.MONGODB_URI);
conn.model(<span class="hljs-string">'User'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'../schemas/user'</span>));
conn.model(<span class="hljs-string">'PageView'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'../schemas/pageView'</span>));

<span class="hljs-built_in">module</span>.exports = conn;
</code></pre>
<p>Another alternative is to register connections with a dependency injector
or another <a href="https://thecodebarbarian.com/using-ramda-as-a-dependency-injector">inversion of control (IOC) pattern</a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectionFactory</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> conn = mongoose.createConnection(process.env.MONGODB_URI);

  conn.model(<span class="hljs-string">'User'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'../schemas/user'</span>));
  conn.model(<span class="hljs-string">'PageView'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'../schemas/pageView'</span>));

  <span class="hljs-keyword">return</span> conn; 
};
</code></pre>
<h3 id="connection_pools"><a href="#connection_pools">Connection Pools</a></h3>

<p>Each <code>connection</code>, whether created with <code>mongoose.connect</code> or
<code>mongoose.createConnection</code> are all backed by an internal configurable
connection pool defaulting to a maximum size of 5. Adjust the pool size
using your connection options:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// With object options</span>
mongoose.createConnection(uri, { <span class="hljs-attr">poolSize</span>: <span class="hljs-number">4</span> });

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb://localhost:27017/test?poolSize=4'</span>;
mongoose.createConnection(uri);
</code></pre>
<h3 id="v5-changes"><a href="#v5-changes">Option Changes in v5.x</a></h3>

<p>You may see the following deprecation warning if upgrading from 4.x to 5.x
and you didn&#39;t use the <code>useMongoClient</code> option in 4.x:</p>
<pre><code>the server/replset/mongos options are deprecated, all their options are supported at the top level <span class="hljs-keyword">of</span> the options object
</code></pre>
<p>In older version of the MongoDB driver you had to specify distinct options
for server connections, replica set connections, and mongos connections:</p>
<pre><code class="language-javascript">mongoose.connect(myUri, {
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">socketOptions</span>: {
      <span class="hljs-attr">socketTimeoutMS</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">reconnectTries</span>: <span class="hljs-number">30</span>
  },
  <span class="hljs-attr">replset</span>: {
    <span class="hljs-attr">socketOptions</span>: {
      <span class="hljs-attr">socketTimeoutMS</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">reconnectTries</span>: <span class="hljs-number">30</span>
  },
  <span class="hljs-attr">mongos</span>: {
    <span class="hljs-attr">socketOptions</span>: {
      <span class="hljs-attr">socketTimeoutMS</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-attr">reconnectTries</span>: <span class="hljs-number">30</span>
  }
});
</code></pre>
<p>In mongoose v5.x you can instead declare these options at the top level,
without all that extra nesting.
<a href="http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html">Here&#39;s the list of all supported options</a>.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Equivalent to the above code</span>
mongoose.connect(myUri, {
  <span class="hljs-attr">socketTimeoutMS</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">reconnectTries</span>: <span class="hljs-number">30</span>
});
</code></pre>
<h3 id="next">Next Up</h3>

<p>Now that we&#39;ve covered connections, let&#39;s take a look at <a href="../../models.html">models</a>.</p>
</div></div><script type="text/javascript">return;();
xhr.open('POST.html', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname,
  hash: window.location.hash
}));</script><script type="text/javascript" src="../../js/navbar-search.js"></script><script type="text/javascript">(function (window, document) {
  var layout   = document.getElementById('layout'),
      menu     = document.getElementById('menu'),
      menuLink = document.getElementById('menuLink'),
      content  = document.getElementById('content');

  function toggleClass(element, className) {
      var classes = element.className.split(/\s+/),
          length = classes.length,
          i = 0;

      for(; i < length; i++) {
        if (classes[i] === className) {
          classes.splice(i, 1);
          break;
        }
      }
      // The className is not found
      if (length === classes.length) {
          classes.push(className);
      }

      element.className = classes.join(' ');
  }

  function toggleAll(e) {
      var active = 'active';

      e.preventDefault();
      toggleClass(layout, active);
      toggleClass(menu, active);
      toggleClass(menuLink, active);
  }

  menuLink.onclick = function (e) {
      toggleAll(e);
  };

  content.onclick = function(e) {
      if (menu.className.indexOf('active') !== -1) {
          toggleAll(e);
      }
  };

}(this, this.document));</script></div></body>
<!-- Mirrored from mongoosejs.com/docs/5.x/docs/connections.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:51 GMT -->
</html>