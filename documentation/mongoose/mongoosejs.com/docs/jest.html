<!DOCTYPE html><html lang="en">
<!-- Mirrored from mongoosejs.com/docs/jest.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose v6.3.0: Testing Mongoose with Jest</title><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="stylesheet" href="../../unpkg.com/purecss%401.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous"><link rel="stylesheet" href="../../fonts.googleapis.com/cssd2d5.css?family=Open+Sans"><link rel="stylesheet" href="css/github.css"><link rel="stylesheet" href="css/mongoose5.css"><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="manifest" href="images/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="css/inlinecpc.css"><script type="text/javascript" src="../../m.servedby-buysellads.com/monetization.custom.js"></script><style>p { line-height: 1.5em }
</style></head><body><div id="layout"><div id="mobile-menu"><a class="menu-link" id="menuLink" href="#menu"><span></span></a><div id="mobile-logo-container"><a href="../index.html"><img id="logo" src="images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div></div><div id="menu"><div class="pure-menu"><div class="pure-menu-heading" id="logo-container"><a href="../index.html"><img id="logo" src="images/mongoose5_62x30_transparent.png"><span class="logo-text">mongoose</span></a></div><ul class="pure-menu-list" id="navbar"><li class="pure-menu-horizontal pure-menu-item pure-menu-has-children pure-menu-allow-hover version"><a class="pure-menu-link" href="#">Version 6.3.0</a><ul class="pure-menu-children"><li class="pure-menu-item"><a class="pure-menu-link" href="5.x/index.html">Version 5.13.14</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="4.x/index.html">Version 4.13.21</a></li></ul></li><li class="pure-menu-item search"><input id="search-input-nav" type="text" placeholder="Search"><button id="search-button-nav"><img src="images/search.svg"></button></li><li class="pure-menu-item"><a class="pure-menu-link" href="index.html">Quick Start</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="guides.html">Guides</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="guide.html">Schemas</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="schematypes.html">SchemaTypes</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="connections.html">Connections</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="models.html">Models</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="documents.html">Documents</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="subdocs.html">Subdocuments</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="queries.html">Queries</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="validation.html">Validation</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="middleware.html">Middleware</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="populate.html">Populate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="discriminators.html">Discriminators</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="plugins.html">Plugins</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="timestamps.html">Timestamps</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="transactions.html">Transactions</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="typescript.html">TypeScript</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="api.html">API</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/mongoose.html">Mongoose</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/schema.html">Schema</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/connection.html">Connection</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/document.html">Document</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/model.html">Model</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/query.html">Query</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/aggregate.html">Aggregate</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/schematype.html">SchemaType</a></li><li class="pure-menu-item sub-item"><a class="pure-menu-link" href="api/virtualtype.html">VirtualType</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="migrating_to_6.html">Migration Guide</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="compatibility.html">Version Compatibility</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="faq.html">FAQ</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="further_reading.html">Further Reading</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="enterprise.html">For Enterprise</a></li><li class="pure-menu-item"><a class="pure-menu-link" href="sponsors.html" >Sponsors</a></li></ul><div class="cpc-ad"><script async type="text/javascript" src="../../cdn.carbonads.com/carbona77d.js?serve=CKYIL27I&amp;placement=mongoosejscom" id="_carbonads_js"></script></div></div></div><div class="container"><div id="content"><a class="edit-docs-link" href="https://github.com/Automattic/mongoose/blob/master/docs/jest.md" target="_blank">
<img src="images/pencil.svg" />
</a><h1 id="testing-mongoose-with-jest">
      <a href="#testing-mongoose-with-jest">
        Testing Mongoose with <a href="https://www.npmjs.com/package/jest">Jest</a>
      </a>
    </h1>
<div id="native-direct"></div>
<script>
    (function() {
        if (typeof _bsa !== 'undefined' && _bsa) {
            _bsa.init('custom', 'CK7DT53U', 'placement:mongoosejscom', {
                target: '#native-direct',
                template: `
<div class="native-inline">
<a rel="sponsored noopener" target="_blank" href="##statlink##" title="##company## — ##tagline##"><span class="sponsor">Sponsor</span> ##company## — ##description##</a>
</div>
</a>
`
            });
        }
    })();
</script>

<p>Jest is a JavaScript runtime developed by Facebook that is usually used for testing.
Because Jest is designed primarily for testing React applications, using it to test Node.js server-side applications comes with a lot of caveats.
We strongly recommend using a different testing framework, like <a href="https://mochajs.org/">Mocha</a>.</p>
<p>If you choose to delve into dangerous waters and test Mongoose apps with Jest, here&#39;s what you need to know:</p>
<h2 id="recommended-testenvironment"><a href="#recommended-testenvironment">Recommended <code>testEnvironment</code></a></h2>

<p>If you are using Jest <code>&lt;=26</code>, do <strong>not</strong> use Jest&#39;s default <a href="https://jestjs.io/docs/en/configuration.html#testenvironment-string"><code>jsdom</code> test environment</a> when testing Mongoose apps, <em>unless</em> you are explicitly testing an application that only uses <a href="browser.html">Mongoose&#39;s browser library</a>. In Jest <code>&gt;=27</code>, <a href="https://jestjs.io/ro/blog/2021/05/25/jest-27#flipping-defaults">&quot;node&quot; is Jest&#39;s default <code>testEnvironment</code></a>, so this is no longer an issue.</p>
<p>The <code>jsdom</code> test environment attempts to create a browser-like test
environment in Node.js, and it comes with numerous nasty surprises like a
<a href="https://github.com/jsdom/jsdom/commit/3f306bea5362aceb2a219a2e98ff96a7464d2f19#commitcomment-31316213">stubbed <code>setTimeout()</code> function</a>
that silently fails after tests are finished. Mongoose does not support jsdom
in general and is not expected to function correctly in the <code>jsdom</code> test
environment.</p>
<p>To change your <code>testEnvironment</code> to Node.js, add <code>testEnvironment</code> to your
<code>jest.config.js</code> file:</p>
<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">testEnvironment</span>: <span class="hljs-string">&#x27;node&#x27;</span>
};
</code></pre>
<h2 id="timer-mocks"><a href="#timer-mocks">Timer Mocks</a></h2>

<p>Absolutely do <strong>not</strong> use <a href="https://jestjs.io/docs/en/timer-mocks.html">timer mocks</a> when testing Mongoose apps.
This is especially important if you&#39;re using Jest <code>&gt;=25</code>, which stubs out <code>process.nextTick()</code>.</p>
<p>Fake timers stub out global functions like <code>setTimeout()</code> and <code>setInterval()</code>, which causes problems when an underlying library uses these functions.
Mongoose and the MongoDB Node.js driver uses these functions for deferring work until the next tick of the event loop and for monitoring connections to the MongoDB server.</p>
<p>If you absolutely must use timer mocks, make sure you import Mongoose <strong>before</strong> calling <code>useFakeTimers()</code>:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Fine for basic cases, but may still cause issues:</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mongoose&#x27;</span>);

jest.<span class="hljs-title function_">useFakeTimers</span>();

<span class="hljs-comment">// Bad:</span>
jest.<span class="hljs-title function_">useFakeTimers</span>();

<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mongoose&#x27;</span>);
</code></pre>
<p>Mongoose devs have already refactored out code to <a href="https://github.com/Automattic/mongoose/issues/6074">avoid using <code>setImmediate()</code></a> to defer work to the next tick of the event loop, but we can&#39;t reasonably ensure that every library Mongoose depends on doesn&#39;t use <code>setImmediate()</code>.</p>
<p>A better alternative is to create your own wrapper around <code>setTimeout()</code> and
stub that instead using <a href="http://npmjs.com/package/sinon">sinon</a>.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// time.js</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">setTimeout</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">global</span>.<span class="hljs-property">setTimeout</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">global</span>, <span class="hljs-variable language_">arguments</span>);
};

<span class="hljs-comment">// Tests</span>
<span class="hljs-keyword">const</span> time = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../util/time&#x27;</span>);
<span class="hljs-keyword">const</span> sinon = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sinon&#x27;</span>);
sinon.<span class="hljs-title function_">stub</span>(time, <span class="hljs-string">&#x27;setTimeout&#x27;</span>);
</code></pre>
<h2 id="globalsetup-and-globalteardown"><a href="#globalsetup-and-globalteardown"><code>globalSetup</code> and <code>globalTeardown</code></a></h2>

<p>Do <strong>not</strong> use <code>globalSetup</code> to call <code>mongoose.connect()</code> or
<code>mongoose.createConnection()</code>. Jest runs <code>globalSetup</code> in
a <a href="https://github.com/facebook/jest/issues/7184">separate environment</a>,
so you cannot use any connections you create in <code>globalSetup</code>
in your tests.</p>
<h2 id="further-reading">
      <a href="#further-reading">
        Further Reading
      </a>
    </h2>
<p>Want to learn how to test Mongoose apps correctly? The
<a href="https://pluralsight.pxf.io/c/1321469/424552/7490?u=https%3A%2F%2Fapp.pluralsight.com%2Flibrary%2Fcourses%2Fnode-js-express-rest-web-services%2Ftable-of-contents">RESTful Web Services with Node.js and Express</a>
course on Pluralsight has a great section on testing Mongoose apps with <a href="http://npmjs.com/package/mocha">Mocha</a>.</p>
<a href="https://pluralsight.pxf.io/c/1321469/424552/7490?u=https%3A%2F%2Fapp.pluralsight.com%2Flibrary%2Fcourses%2Fnode-js-express-rest-web-services%2Ftable-of-contents">
  <img src="../../i.imgur.com/KouuaAZ.png">
</a></div></div><script type="text/javascript">return;();
xhr.open('POST.html', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname,
  hash: window.location.hash
}));</script><div id="jobs"><div class="job-listing"><a href="../jobs61f0b0402d893554bc3a247f.html"><div class="company-logo"><img src="../../images.ctfassets.net/3ouphkrynjol/3mfb7HH2YowrPxX9C6ik6H/723034bcb4e99349663c4bc8223fb8b6/localizejs.com.png"></div><div class="description"><div class="company">Localize</div><div class="title">Full Stack Engineer</div><div class="location">Anywhere</div></div></a></div><div class="button jobs-view-more"><a href="jobs.html">View more jobs!</a></div></div><script type="text/javascript" src="js/navbar-search.js"></script><script type="text/javascript">(function (window, document) {
  var layout   = document.getElementById('layout'),
      menu     = document.getElementById('menu'),
      menuLink = document.getElementById('menuLink'),
      content  = document.getElementById('content');

  function toggleClass(element, className) {
      var classes = element.className.split(/\s+/),
          length = classes.length,
          i = 0;

      for(; i < length; i++) {
        if (classes[i] === className) {
          classes.splice(i, 1);
          break;
        }
      }
      // The className is not found
      if (length === classes.length) {
          classes.push(className);
      }

      element.className = classes.join(' ');
  }

  function toggleAll(e) {
      var active = 'active';

      e.preventDefault();
      toggleClass(layout, active);
      toggleClass(menu, active);
      toggleClass(menuLink, active);
  }

  menuLink.onclick = function (e) {
      toggleAll(e);
  };

  content.onclick = function(e) {
      if (menu.className.indexOf('active') !== -1) {
          toggleAll(e);
      }
  };

}(this, this.document));</script></div></body>
<!-- Mirrored from mongoosejs.com/docs/jest.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:49 GMT -->
</html>