<!DOCTYPE html><html lang="en">
<!-- Mirrored from mongoosejs.com/docs/4.x/docs/api.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongoose API v4.13.20</title><link rel="apple-touch-icon" sizes="57x57" href="images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png"><link rel="stylesheet" href="../../../../maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"><link href="../../../../fonts.googleapis.com/css94d8.css?family=Anonymous+Pro:400,700|Droid+Sans+Mono|Open+Sans:400,700|Linden+Hill|Quattrocento:400,700|News+Cycle:400,700|Antic+Slab|Cabin+Condensed:400,700" rel="stylesheet" type="text/css"><link href="css/default.css" rel="stylesheet" type="text/css"><link href="css/api.css" rel="stylesheet" type="text/css"></head><body class="api"><a id="forkbanner" href="http://github.com/Automattic/mongoose"><img style="position: absolute; top: 0; right: 0; border: 0;" src="../../../../s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div id="links"><div id="header"><h1><a href="../index-2.html"><div class="mongoose">Mongoose</div></a></h1></div><ul><li class="home"><a href="../index-2.html">home</a></li><li class="faq"><a href="faq.html">FAQ</a></li><li class="plugins"><a href="http://plugins.mongoosejs.com/">plugins</a></li><li class="changelog"><a href="http://github.com/Automattic/mongoose/tree/master/History.md">change log</a></li><li class="support"><a href="../index-2.html#support">support</a></li><li class="fork"><a href="http://github.com/Automattic/mongoose">fork</a></li><li class="guide"><a href="guide.html">guide</a></li><li class="api"><a href="api.html">API docs</a></li><li class="quickstart"><a href="index.html">quick start</a></li><li class="contrib"><a href="http://github.com/Automattic/mongoose/contributors">contributors</a></li><li class="prior"><a href="prior.html">prior releases</a></li></ul><hr><div class="doclinks"><div class="file "><span class="toggle-item"><a href="#index-js" class="section">index.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#index_Mongoose-_applyPlugins">_applyPlugins</a></li><li class=""><a href="#index_Mongoose-Aggregate">Aggregate</a></li><li class=""><a href="#index_Mongoose-CastError">CastError</a></li><li class="private"><a href="#index_MongooseThenable-catch">catch</a></li><li class="private"><a href="#index_checkReplicaSetInUri">checkReplicaSetInUri</a></li><li class=""><a href="#index_Mongoose-Collection">Collection</a></li><li class=""><a href="#index_Mongoose-connect">connect</a></li><li class=""><a href="#index_Mongoose-Connection">Connection</a></li><li class=""><a href="#index_Mongoose-createConnection">createConnection</a></li><li class=""><a href="#index_Mongoose-disconnect">disconnect</a></li><li class=""><a href="#index_Mongoose-Document">Document</a></li><li class=""><a href="#index_Mongoose-DocumentProvider">DocumentProvider</a></li><li class=""><a href="#index_Mongoose-Error">Error</a></li><li class=""><a href="#index_Mongoose-get">get</a></li><li class=""><a href="#index_Mongoose-getPromiseConstructor">getPromiseConstructor</a></li><li class=""><a href="#index_Mongoose-model">model</a></li><li class=""><a href="#index_Mongoose-Model">Model</a></li><li class=""><a href="#index_Mongoose-modelNames">modelNames</a></li><li class=""><a href="#index_Mongoose">Mongoose</a></li><li class=""><a href="#index_Mongoose-Mongoose">Mongoose</a></li><li class="private"><a href="#index_MongooseThenable">MongooseThenable</a></li><li class=""><a href="#index_Mongoose-plugin">plugin</a></li><li class=""><a href="#index_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise">Promise</a></li><li class=""><a href="#index_Mongoose-PromiseProvider">PromiseProvider</a></li><li class=""><a href="#index_Mongoose-Query">Query</a></li><li class=""><a href="#index_Mongoose-Schema">Schema</a></li><li class=""><a href="#index_Mongoose-SchemaType">SchemaType</a></li><li class=""><a href="#index_Mongoose-set">set</a></li><li class=""><a href="#index_">STATES</a></li><li class="private"><a href="#index_MongooseThenable-then">then</a></li><li class=""><a href="#index_Mongoose-VirtualType">VirtualType</a></li><li class=""><a href="#index_Mongoose-connection">connection</a></li><li class=""><a href="#index_Mongoose-mongo">mongo</a></li><li class=""><a href="#index_Mongoose-mquery">mquery</a></li><li class=""><a href="#index_Mongoose-SchemaTypes">SchemaTypes</a></li><li class=""><a href="#index_Mongoose-Types">Types</a></li><li class=""><a href="#index_Mongoose-version">version</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#virtualtype-js" class="section">virtualtype.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#virtualtype_VirtualType-applyGetters">applyGetters</a></li><li class=""><a href="#virtualtype_VirtualType-applySetters">applySetters</a></li><li class=""><a href="#virtualtype_VirtualType-get">get</a></li><li class=""><a href="#virtualtype_VirtualType-set">set</a></li><li class=""><a href="#virtualtype_VirtualType">VirtualType</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#browserDocument-js" class="section">browserDocument.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#browserDocument_Document">Document</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-documentarray-js" class="section">types/documentarray.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#types_documentarray_MongooseDocumentArray">MongooseDocumentArray</a></li><li class="private"><a href="#types_documentarray_MongooseDocumentArray._cast">_cast</a></li><li class=""><a href="#types_documentarray_MongooseDocumentArray.id">id</a></li><li class=""><a href="#types_documentarray_MongooseDocumentArray.toObject">toObject</a></li><li class=""><a href="#types_documentarray_MongooseDocumentArray.inspect">inspect</a></li><li class=""><a href="#types_documentarray_MongooseDocumentArray.create">create</a></li><li class="private"><a href="#types_documentarray_MongooseDocumentArray.notify">notify</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-array-js" class="section">types/array.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#types_array_MongooseArray-%24__getAtomics">$__getAtomics</a></li><li class=""><a href="#types_array_MongooseArray-%24shift">$shift</a></li><li class="private"><a href="#types_array_MongooseArray">MongooseArray</a></li><li class=""><a href="#types_array_MongooseArray-remove">remove</a></li><li class="private"><a href="#types_array_MongooseArray._cast">_cast</a></li><li class="private"><a href="#types_array_MongooseArray._mapCast">_mapCast</a></li><li class="private"><a href="#types_array_MongooseArray._markModified">_markModified</a></li><li class="private"><a href="#types_array_MongooseArray._registerAtomic">_registerAtomic</a></li><li class=""><a href="#types_array_MongooseArray.%24pop">$pop</a></li><li class=""><a href="#types_array_MongooseArray.addToSet">addToSet</a></li><li class="private"><a href="#types_array_MongooseArray.hasAtomics">hasAtomics</a></li><li class=""><a href="#types_array_MongooseArray.indexOf">indexOf</a></li><li class=""><a href="#types_array_MongooseArray.inspect">inspect</a></li><li class=""><a href="#types_array_MongooseArray.nonAtomicPush">nonAtomicPush</a></li><li class=""><a href="#types_array_MongooseArray.pop">pop</a></li><li class=""><a href="#types_array_MongooseArray.pull">pull</a></li><li class=""><a href="#types_array_MongooseArray.push">push</a></li><li class=""><a href="#types_array_MongooseArray.set">set</a></li><li class=""><a href="#types_array_MongooseArray.shift">shift</a></li><li class=""><a href="#types_array_MongooseArray.sort">sort</a></li><li class=""><a href="#types_array_MongooseArray.splice">splice</a></li><li class=""><a href="#types_array_MongooseArray.toObject">toObject</a></li><li class=""><a href="#types_array_MongooseArray.unshift">unshift</a></li><li class="private"><a href="#types_array_MongooseArray-_atomics">_atomics</a></li><li class="private"><a href="#types_array_MongooseArray-_parent">_parent</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-decimal128-js" class="section">types/decimal128.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#types_decimal128_exports">exports</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-objectid-js" class="section">types/objectid.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#types_objectid_ObjectId">ObjectId</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-subdocument-js" class="section">types/subdocument.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#types_subdocument_Subdocument-ownerDocument">ownerDocument</a></li><li class=""><a href="#types_subdocument_Subdocument-parent">parent</a></li><li class=""><a href="#types_subdocument_Subdocument-remove">remove</a></li><li class="private"><a href="#types_subdocument_Subdocument-save">save</a></li><li class="private"><a href="#types_subdocument_Subdocument">Subdocument</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-embedded-js" class="section">types/embedded.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#types_embedded_EmbeddedDocument-%24__fullPath">$__fullPath</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-inspect">inspect</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-invalidate">invalidate</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-ownerDocument">ownerDocument</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-parent">parent</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-parentArray">parentArray</a></li><li class=""><a href="#types_embedded_EmbeddedDocument-remove">remove</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument-save">save</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument-update">update</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument.%24isValid">$isValid</a></li><li class="private"><a href="#types_embedded_EmbeddedDocument.%24markValid">$markValid</a></li><li class=""><a href="#types_embedded_EmbeddedDocument.markModified">markModified</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#types-buffer-js" class="section">types/buffer.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#types_buffer_MongooseBuffer">MongooseBuffer</a></li><li class="private"><a href="#types_buffer_MongooseBuffer._markModified">_markModified</a></li><li class=""><a href="#types_buffer_MongooseBuffer.copy">copy</a></li><li class=""><a href="#types_buffer_MongooseBuffer.equals">equals</a></li><li class=""><a href="#types_buffer_MongooseBuffer.subtype">subtype</a></li><li class=""><a href="#types_buffer_MongooseBuffer.toBSON">toBSON</a></li><li class=""><a href="#types_buffer_MongooseBuffer.toObject">toObject</a></li><li class=""><a href="#types_buffer_MongooseBuffer.write">write</a></li><li class="private"><a href="#types_buffer_MongooseBuffer-_parent">_parent</a></li><li class="private"><a href="#types_buffer_MongooseBuffer-_subtype">_subtype</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#document_provider-js" class="section">document_provider.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#document_provider_module.exports">exports</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#cast-js" class="section">cast.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#cast_module.exports">exports</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#document-js" class="section">document.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#document_Document-%24__buildDoc">$__buildDoc</a></li><li class="private"><a href="#document_Document-%24__dirty">$__dirty</a></li><li class="private"><a href="#document_Document-%24__fullPath">$__fullPath</a></li><li class="private"><a href="#document_Document-%24__getAllSubdocs">$__getAllSubdocs</a></li><li class="private"><a href="#document_Document-%24__getArrayPathsToValidate">$__getArrayPathsToValidate</a></li><li class="private"><a href="#document_Document-%24__path">$__path</a></li><li class="private"><a href="#document_Document-%24__reset">$__reset</a></li><li class="private"><a href="#document_Document-%24__set">$__set</a></li><li class="private"><a href="#document_Document-%24__setSchema">$__setSchema</a></li><li class="private"><a href="#document_Document-%24__shouldModify">$__shouldModify</a></li><li class=""><a href="#document_Document-%24ignore">$ignore</a></li><li class=""><a href="#document_Document-%24isDefault">$isDefault</a></li><li class=""><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24isDeleted">$isDeleted</a></li><li class=""><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24set">$set</a></li><li class="private"><a href="#document_Document-%24toObject">$toObject</a></li><li class=""><a href="#document_Document-depopulate">depopulate</a></li><li class="private"><a href="#document_Document">Document</a></li><li class=""><a href="#document_Document-equals">equals</a></li><li class=""><a href="#document_Document-execPopulate">execPopulate</a></li><li class=""><a href="#document_Document-get">get</a></li><li class="private"><a href="#document_Document-getValue">getValue</a></li><li class=""><a href="#document_Document-init">init</a></li><li class=""><a href="#document_Document-inspect">inspect</a></li><li class=""><a href="#document_Document-invalidate">invalidate</a></li><li class=""><a href="#document_Document-isDirectModified">isDirectModified</a></li><li class=""><a href="#document_Document-isDirectSelected">isDirectSelected</a></li><li class=""><a href="#document_Document-isInit">isInit</a></li><li class=""><a href="#document_Document-isModified">isModified</a></li><li class=""><a href="#document_Document-isSelected">isSelected</a></li><li class=""><a href="#document_Document-markModified">markModified</a></li><li class=""><a href="#document_Document-modifiedPaths">modifiedPaths</a></li><li class=""><a href="#document_Document-populate">populate</a></li><li class=""><a href="#document_Document-populated">populated</a></li><li class=""><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-save">save</a></li><li class=""><a href="#document_">set</a></li><li class="private"><a href="#document_Document-setValue">setValue</a></li><li class=""><a href="#document_Document-toJSON">toJSON</a></li><li class=""><a href="#document_Document-toObject">toObject</a></li><li class=""><a href="#document_Document-toString">toString</a></li><li class=""><a href="#document_Document-unmarkModified">unmarkModified</a></li><li class=""><a href="#document_Document-update">update</a></li><li class=""><a href="#document_Document-validate">validate</a></li><li class=""><a href="#document_Document-validateSync">validateSync</a></li><li class="private"><a href="#document_Document.%24isValid">$isValid</a></li><li class=""><a href="#document_Document.%24markValid">$markValid</a></li><li class=""><a href="#document_Document-errors">errors</a></li><li class=""><a href="#document_Document-id">id</a></li><li class=""><a href="#document_Document-isNew">isNew</a></li><li class=""><a href="#document_Document-schema">schema</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#cursor-QueryCursor-js" class="section">cursor/QueryCursor.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#cursor_QueryCursor_QueryCursor-addCursorFlag">addCursorFlag</a></li><li class=""><a href="#cursor_QueryCursor_QueryCursor-close">close</a></li><li class=""><a href="#cursor_QueryCursor_QueryCursor-eachAsync">eachAsync</a></li><li class=""><a href="#cursor_QueryCursor_QueryCursor-map">map</a></li><li class=""><a href="#cursor_QueryCursor_QueryCursor-next">next</a></li><li class=""><a href="#cursor_QueryCursor_QueryCursor">QueryCursor</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#cursor-AggregationCursor-js" class="section">cursor/AggregationCursor.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#cursor_AggregationCursor_AggregationCursor-addCursorFlag">addCursorFlag</a></li><li class=""><a href="#cursor_AggregationCursor_AggregationCursor">AggregationCursor</a></li><li class=""><a href="#cursor_AggregationCursor_AggregationCursor-close">close</a></li><li class=""><a href="#cursor_AggregationCursor_AggregationCursor-eachAsync">eachAsync</a></li><li class=""><a href="#cursor_AggregationCursor_AggregationCursor-map">map</a></li><li class=""><a href="#cursor_AggregationCursor_AggregationCursor-next">next</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-boolean-js" class="section">schema/boolean.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_boolean_SchemaBoolean-cast">cast</a></li><li class="private"><a href="#schema_boolean_SchemaBoolean-castForQuery">castForQuery</a></li><li class=""><a href="#schema_boolean_SchemaBoolean-checkRequired">checkRequired</a></li><li class=""><a href="#schema_boolean_SchemaBoolean">SchemaBoolean</a></li><li class=""><a href="#schema_boolean_SchemaBoolean.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-documentarray-js" class="section">schema/documentarray.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_documentarray_DocumentArray-cast">cast</a></li><li class=""><a href="#schema_documentarray_DocumentArray">DocumentArray</a></li><li class="private"><a href="#schema_documentarray_DocumentArray-doValidate">doValidate</a></li><li class="private"><a href="#schema_documentarray_DocumentArray-doValidateSync">doValidateSync</a></li><li class=""><a href="#schema_documentarray_DocumentArray.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-array-js" class="section">schema/array.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_array_SchemaArray-applyGetters">applyGetters</a></li><li class="private"><a href="#schema_array_SchemaArray-cast">cast</a></li><li class="private"><a href="#schema_array_SchemaArray-castForQuery">castForQuery</a></li><li class=""><a href="#schema_array_SchemaArray-checkRequired">checkRequired</a></li><li class=""><a href="#schema_array_SchemaArray">SchemaArray</a></li><li class=""><a href="#schema_array_SchemaArray.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-decimal128-js" class="section">schema/decimal128.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_decimal128_Decimal128-cast">cast</a></li><li class=""><a href="#schema_decimal128_Decimal128-checkRequired">checkRequired</a></li><li class=""><a href="#schema_decimal128_Decimal128">Decimal128</a></li><li class=""><a href="#schema_decimal128_Decimal128.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-number-js" class="section">schema/number.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_number_SchemaNumber-cast">cast</a></li><li class="private"><a href="#schema_number_SchemaNumber-castForQuery">castForQuery</a></li><li class=""><a href="#schema_number_SchemaNumber-checkRequired">checkRequired</a></li><li class=""><a href="#schema_number_SchemaNumber-max">max</a></li><li class=""><a href="#schema_number_SchemaNumber-min">min</a></li><li class=""><a href="#schema_number_SchemaNumber">SchemaNumber</a></li><li class=""><a href="#schema_number_SchemaNumber.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-objectid-js" class="section">schema/objectid.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#schema_objectid_ObjectId-auto">auto</a></li><li class="private"><a href="#schema_objectid_ObjectId-cast">cast</a></li><li class="private"><a href="#schema_objectid_ObjectId-castForQuery">castForQuery</a></li><li class=""><a href="#schema_objectid_ObjectId-checkRequired">checkRequired</a></li><li class=""><a href="#schema_objectid_ObjectId">ObjectId</a></li><li class=""><a href="#schema_objectid_ObjectId.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-string-js" class="section">schema/string.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_string_SchemaString-cast">cast</a></li><li class="private"><a href="#schema_string_SchemaString-castForQuery">castForQuery</a></li><li class=""><a href="#schema_string_SchemaString-checkRequired">checkRequired</a></li><li class=""><a href="#schema_string_SchemaString-enum">enum</a></li><li class=""><a href="#schema_string_SchemaString-lowercase">lowercase</a></li><li class=""><a href="#schema_string_SchemaString-match">match</a></li><li class=""><a href="#schema_string_SchemaString-maxlength">maxlength</a></li><li class=""><a href="#schema_string_SchemaString-minlength">minlength</a></li><li class=""><a href="#schema_string_SchemaString">SchemaString</a></li><li class=""><a href="#schema_string_SchemaString-trim">trim</a></li><li class=""><a href="#schema_string_SchemaString-uppercase">uppercase</a></li><li class=""><a href="#schema_string_SchemaString.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-date-js" class="section">schema/date.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_date_SchemaDate-cast">cast</a></li><li class="private"><a href="#schema_date_SchemaDate-castForQuery">castForQuery</a></li><li class=""><a href="#schema_date_SchemaDate-checkRequired">checkRequired</a></li><li class=""><a href="#schema_date_SchemaDate-expires">expires</a></li><li class=""><a href="#schema_date_SchemaDate-max">max</a></li><li class=""><a href="#schema_date_SchemaDate-min">min</a></li><li class=""><a href="#schema_date_SchemaDate">SchemaDate</a></li><li class=""><a href="#schema_date_SchemaDate.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-embedded-js" class="section">schema/embedded.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_embedded_Embedded-cast">cast</a></li><li class="private"><a href="#schema_embedded_Embedded-castForQuery">castForQuery</a></li><li class=""><a href="#schema_embedded_Embedded-discriminator">discriminator</a></li><li class="private"><a href="#schema_embedded_Embedded-doValidate">doValidate</a></li><li class="private"><a href="#schema_embedded_Embedded-doValidateSync">doValidateSync</a></li><li class=""><a href="#schema_embedded_Embedded">Embedded</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-buffer-js" class="section">schema/buffer.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_buffer_SchemaBuffer-cast">cast</a></li><li class="private"><a href="#schema_buffer_SchemaBuffer-castForQuery">castForQuery</a></li><li class=""><a href="#schema_buffer_SchemaBuffer-checkRequired">checkRequired</a></li><li class=""><a href="#schema_buffer_SchemaBuffer">SchemaBuffer</a></li><li class=""><a href="#schema_buffer_SchemaBuffer-subtype">subtype</a></li><li class=""><a href="#schema_buffer_SchemaBuffer.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-mixed-js" class="section">schema/mixed.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schema_mixed_Mixed-cast">cast</a></li><li class="private"><a href="#schema_mixed_Mixed-castForQuery">castForQuery</a></li><li class=""><a href="#schema_mixed_Mixed">Mixed</a></li><li class=""><a href="#schema_mixed_Mixed.schemaName">schemaName</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#services-cursor-eachAsync-js" class="section">services/cursor/eachAsync.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#services_cursor_eachAsync_module.exports">exports</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#services-updateValidators-js" class="section">services/updateValidators.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#services_updateValidators_module.exports">exports</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#services-setDefaultsOnInsert-js" class="section">services/setDefaultsOnInsert.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#services_setDefaultsOnInsert_module.exports">exports</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#connection-js" class="section">connection.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#connection_Connection-_close">_close</a></li><li class="private"><a href="#connection_Connection-_open">_open</a></li><li class="private"><a href="#connection_Connection-authMechanismDoesNotRequirePassword">authMechanismDoesNotRequirePassword</a></li><li class=""><a href="#connection_Connection-close">close</a></li><li class=""><a href="#connection_Connection-collection">collection</a></li><li class=""><a href="#connection_Connection">Connection</a></li><li class=""><a href="#connection_">createCollection</a></li><li class=""><a href="#connection_">dropCollection</a></li><li class=""><a href="#connection_">dropDatabase</a></li><li class="private"><a href="#connection_Connection-error">error</a></li><li class=""><a href="#connection_Connection-model">model</a></li><li class=""><a href="#connection_Connection-modelNames">modelNames</a></li><li class="private"><a href="#connection_Connection-onClose">onClose</a></li><li class="private"><a href="#connection_Connection-onOpen">onOpen</a></li><li class=""><a href="#connection_">open</a></li><li class=""><a href="#connection_">openSet</a></li><li class="private"><a href="#connection_Connection-openUri">openUri</a></li><li class="private"><a href="#connection_Connection-optionsProvideAuthenticationData">optionsProvideAuthenticationData</a></li><li class="private"><a href="#connection_Connection-shouldAuthenticate">shouldAuthenticate</a></li><li class=""><a href="#connection_Connection-collections">collections</a></li><li class=""><a href="#connection_Connection-config">config</a></li><li class=""><a href="#connection_Connection-db">db</a></li><li class=""><a href="#connection_Connection-readyState">readyState</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#drivers-node-mongodb-native-collection-js" class="section">drivers/node-mongodb-native/collection.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24format">$format</a></li><li class=""><a href="#drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24print">$print</a></li><li class=""><a href="#drivers_node-mongodb-native_collection_NativeCollection-getIndexes">getIndexes</a></li><li class="private"><a href="#drivers_node-mongodb-native_collection_NativeCollection">NativeCollection</a></li><li class="private"><a href="#drivers_node-mongodb-native_collection_NativeCollection-onClose">onClose</a></li><li class="private"><a href="#drivers_node-mongodb-native_collection_NativeCollection-onOpen">onOpen</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#drivers-node-mongodb-native-connection-js" class="section">drivers/node-mongodb-native/connection.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doClose">doClose</a></li><li class="private"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doOpen">doOpen</a></li><li class="private"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doOpenSet">doOpenSet</a></li><li class="private"><a href="#drivers_node-mongodb-native_connection_NativeConnection">NativeConnection</a></li><li class="private"><a href="#drivers_node-mongodb-native_connection_NativeConnection-parseOptions">parseOptions</a></li><li class=""><a href="#drivers_node-mongodb-native_connection_NativeConnection-useDb">useDb</a></li><li class=""><a href="#drivers_node-mongodb-native_connection_NativeConnection.STATES">STATES</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#error-messages-js" class="section">error/messages.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#error_messages_undefined">messages</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-cast-js" class="section">error/cast.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_cast_CastError">CastError</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-objectExpected-js" class="section">error/objectExpected.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_objectExpected_ObjectExpectedError">ObjectExpectedError</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-disconnected-js" class="section">error/disconnected.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_disconnected_DisconnectedError">DisconnectedError</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-objectParameter-js" class="section">error/objectParameter.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_objectParameter_ObjectParameterError">ObjectParameterError</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#error-validation-js" class="section">error/validation.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#error_validation_ValidationError-toString">toString</a></li><li class="private"><a href="#error_validation_ValidationError">ValidationError</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-validator-js" class="section">error/validator.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_validator_ValidatorError">ValidatorError</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#error-index-js" class="section">error/index.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#error_index_MongooseError">MongooseError</a></li><li class=""><a href="#error_index_MongooseError.DocumentNotFoundError">DocumentNotFoundError</a></li><li class=""><a href="#error_index_MongooseError.messages">messages</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-version-js" class="section">error/version.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_version_VersionError">VersionError</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#error-strict-js" class="section">error/strict.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#error_strict_StrictModeError">StrictModeError</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#aggregate-js" class="section">aggregate.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#aggregate_Aggregate-addCursorFlag">addCursorFlag</a></li><li class=""><a href="#aggregate_Aggregate-addFields">addFields</a></li><li class=""><a href="#aggregate_Aggregate">Aggregate</a></li><li class=""><a href="#aggregate_Aggregate-allowDiskUse">allowDiskUse</a></li><li class=""><a href="#aggregate_Aggregate-append">append</a></li><li class=""><a href="#aggregate_Aggregate-collation">collation</a></li><li class=""><a href="#aggregate_Aggregate-cursor">cursor</a></li><li class=""><a href="#aggregate_Aggregate-exec">exec</a></li><li class=""><a href="#aggregate_Aggregate-explain">explain</a></li><li class=""><a href="#aggregate_Aggregate-facet">facet</a></li><li class=""><a href="#aggregate_Aggregate-graphLookup">graphLookup</a></li><li class=""><a href="#aggregate_Aggregate-group">group</a></li><li class="private"><a href="#aggregate_isOperator">isOperator</a></li><li class=""><a href="#aggregate_Aggregate-limit">limit</a></li><li class=""><a href="#aggregate_Aggregate-lookup">lookup</a></li><li class=""><a href="#aggregate_Aggregate-match">match</a></li><li class=""><a href="#aggregate_Aggregate-model">model</a></li><li class=""><a href="#aggregate_Aggregate-near">near</a></li><li class=""><a href="#aggregate_Aggregate-option">option</a></li><li class=""><a href="#aggregate_Aggregate-pipeline">pipeline</a></li><li class=""><a href="#aggregate_Aggregate-project">project</a></li><li class=""><a href="#aggregate_Aggregate-read">read</a></li><li class=""><a href="#aggregate_Aggregate-sample">sample</a></li><li class=""><a href="#aggregate_Aggregate-skip">skip</a></li><li class=""><a href="#aggregate_Aggregate-sort">sort</a></li><li class=""><a href="#aggregate_Aggregate-then">then</a></li><li class=""><a href="#aggregate_Aggregate-unwind">unwind</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#ES6Promise-js" class="section">ES6Promise.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#ES6Promise_ES6Promise">ES6Promise</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#utils-js" class="section">utils.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#utils_exports.each">each</a></li><li class="private"><a href="#utils_exports.mergeClone">mergeClone</a></li><li class=""><a href="#utils_exports.pluralization">pluralization</a></li><li class=""><a href="#utils_exports.uncountables">uncountables</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#browser-js" class="section">browser.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#browser_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise">Promise</a></li><li class=""><a href="#browser_exports.Document">Document</a></li><li class=""><a href="#browser_exports.Error">Error</a></li><li class=""><a href="#browser_exports.PromiseProvider">PromiseProvider</a></li><li class=""><a href="#browser_exports.Schema">Schema</a></li><li class=""><a href="#browser_exports.VirtualType">VirtualType</a></li><li class=""><a href="#browser_exports-SchemaTypes">SchemaTypes</a></li><li class=""><a href="#browser_exports-Types">Types</a></li><li class="private"><a href="#browser_exports-utils">utils</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#promise-js" class="section">promise.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#promise_Promise-addBack">addBack</a></li><li class=""><a href="#promise_Promise-addCallback">addCallback</a></li><li class=""><a href="#promise_Promise-addErrback">addErrback</a></li><li class=""><a href="#promise_Promise-catch">catch</a></li><li class=""><a href="#promise_Promise-end">end</a></li><li class=""><a href="#promise_Promise-error">error</a></li><li class=""><a href="#promise_Promise-on">on</a></li><li class=""><a href="#promise_Promise">Promise</a></li><li class=""><a href="#promise_Promise-reject">reject</a></li><li class=""><a href="#promise_Promise-resolve">resolve</a></li><li class=""><a href="#promise_Promise-then">then</a></li><li class=""><a href="#promise_Promise.complete">complete</a></li><li class=""><a href="#promise_Promise.ES6">ES6</a></li><li class=""><a href="#promise_Promise.fulfill">fulfill</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schematype-js" class="section">schematype.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#schematype_SchemaType-applyGetters">applyGetters</a></li><li class="private"><a href="#schematype_SchemaType-applySetters">applySetters</a></li><li class="private"><a href="#schematype_SchemaType-castForQuery">castForQuery</a></li><li class="private"><a href="#schematype_SchemaType-checkRequired">checkRequired</a></li><li class=""><a href="#schematype_SchemaType-default">default</a></li><li class="private"><a href="#schematype_SchemaType-doValidate">doValidate</a></li><li class="private"><a href="#schematype_SchemaType-doValidateSync">doValidateSync</a></li><li class=""><a href="#schematype_SchemaType-get">get</a></li><li class="private"><a href="#schematype_SchemaType-getDefault">getDefault</a></li><li class=""><a href="#schematype_SchemaType-index">index</a></li><li class=""><a href="#schematype_SchemaType-required">required</a></li><li class=""><a href="#schematype_SchemaType">SchemaType</a></li><li class=""><a href="#schematype_SchemaType-select">select</a></li><li class=""><a href="#schematype_SchemaType-set">set</a></li><li class=""><a href="#schematype_SchemaType-sparse">sparse</a></li><li class=""><a href="#schematype_SchemaType-text">text</a></li><li class=""><a href="#schematype_SchemaType-unique">unique</a></li><li class=""><a href="#schematype_SchemaType-validate">validate</a></li><li class="private"><a href="#schematype_SchemaType._isRef">_isRef</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#querystream-js" class="section">querystream.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#querystream_QueryStream-__next">__next</a></li><li class="private"><a href="#querystream_QueryStream-_init">_init</a></li><li class="private"><a href="#querystream_QueryStream-_next">_next</a></li><li class="private"><a href="#querystream_QueryStream-_onNextObject">_onNextObject</a></li><li class=""><a href="#querystream_QueryStream-destroy">destroy</a></li><li class=""><a href="#querystream_QueryStream-pause">pause</a></li><li class=""><a href="#querystream_QueryStream-pipe">pipe</a></li><li class=""><a href="#querystream_QueryStream">QueryStream</a></li><li class=""><a href="#querystream_QueryStream-resume">resume</a></li><li class=""><a href="#querystream_QueryStream-paused">paused</a></li><li class=""><a href="#querystream_QueryStream-readable">readable</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#model-js" class="section">model.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#model_Model-%24__delta">$__delta</a></li><li class="private"><a href="#model_Model-%24__version">$__version</a></li><li class="private"><a href="#model_Model-%24__where">$__where</a></li><li class=""><a href="#model_Model-%24where">$where</a></li><li class=""><a href="#model_Model-increment">increment</a></li><li class=""><a href="#model_Model-model">model</a></li><li class=""><a href="#model_Model">Model</a></li><li class=""><a href="#model_Model-remove">remove</a></li><li class=""><a href="#model_Model-save">save</a></li><li class=""><a href="#model_Model.aggregate">aggregate</a></li><li class=""><a href="#model_Model.bulkWrite">bulkWrite</a></li><li class=""><a href="#model_Model.count">count</a></li><li class=""><a href="#model_Model.create">create</a></li><li class=""><a href="#model_Model.createIndexes">createIndexes</a></li><li class=""><a href="#model_Model.deleteMany">deleteMany</a></li><li class=""><a href="#model_Model.deleteOne">deleteOne</a></li><li class=""><a href="#model_Model.discriminator">discriminator</a></li><li class=""><a href="#model_Model.distinct">distinct</a></li><li class=""><a href="#model_Model.ensureIndexes">ensureIndexes</a></li><li class=""><a href="#model_Model.find">find</a></li><li class=""><a href="#model_Model.findById">findById</a></li><li class=""><a href="#model_Model.findByIdAndRemove">findByIdAndRemove</a></li><li class=""><a href="#model_Model.findByIdAndUpdate">findByIdAndUpdate</a></li><li class=""><a href="#model_Model.findOne">findOne</a></li><li class=""><a href="#model_Model.findOneAndRemove">findOneAndRemove</a></li><li class=""><a href="#model_Model.findOneAndUpdate">findOneAndUpdate</a></li><li class=""><a href="#model_Model.geoNear">geoNear</a></li><li class=""><a href="#model_Model.geoSearch">geoSearch</a></li><li class=""><a href="#model_Model.hydrate">hydrate</a></li><li class=""><a href="#model_Model.init">init</a></li><li class=""><a href="#model_Model.insertMany">insertMany</a></li><li class=""><a href="#model_Model.mapReduce">mapReduce</a></li><li class=""><a href="#model_Model.populate">populate</a></li><li class=""><a href="#model_Model.remove">remove</a></li><li class=""><a href="#model_Model.replaceOne">replaceOne</a></li><li class=""><a href="#model_Model.translateAliases">translateAliases</a></li><li class=""><a href="#model_Model.update">update</a></li><li class=""><a href="#model_Model.updateMany">updateMany</a></li><li class=""><a href="#model_Model.updateOne">updateOne</a></li><li class=""><a href="#model_Model.where">where</a></li><li class=""><a href="#model_Model-%2524where">$where</a></li><li class=""><a href="#model_Model-base">base</a></li><li class=""><a href="#model_Model-baseModelName">baseModelName</a></li><li class=""><a href="#model_Model-collection">collection</a></li><li class=""><a href="#model_Model-db">db</a></li><li class=""><a href="#model_Model-discriminators">discriminators</a></li><li class=""><a href="#model_Model-modelName">modelName</a></li><li class=""><a href="#model_Model-schema">schema</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#query-js" class="section">query.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#query_Query-_applyPaths">_applyPaths</a></li><li class="private"><a href="#query_Query-_castFields">_castFields</a></li><li class="private"><a href="#query_Query-_count">_count</a></li><li class="private"><a href="#query_Query-_find">_find</a></li><li class="private"><a href="#query_Query-_findOne">_findOne</a></li><li class="private"><a href="#query_Query-_optionsForExec">_optionsForExec</a></li><li class=""><a href="#query_Query-%24where">$where</a></li><li class=""><a href="#query_Query-all">all</a></li><li class=""><a href="#query_Query-and">and</a></li><li class=""><a href="#query_Query-batchSize">batchSize</a></li><li class=""><a href="#query_Query-box">box</a></li><li class="private"><a href="#query_Query-canMerge">canMerge</a></li><li class=""><a href="#query_Query-cast">cast</a></li><li class=""><a href="#query_Query-catch">catch</a></li><li class=""><a href="#query_Query-center">center</a></li><li class=""><a href="#query_Query-centerSphere">centerSphere</a></li><li class=""><a href="#query_Query-circle">circle</a></li><li class=""><a href="#query_Query-collation">collation</a></li><li class=""><a href="#query_Query-comment">comment</a></li><li class=""><a href="#query_Query-count">count</a></li><li class=""><a href="#query_Query-cursor">cursor</a></li><li class=""><a href="#query_Query-deleteMany">deleteMany</a></li><li class=""><a href="#query_Query-deleteOne">deleteOne</a></li><li class=""><a href="#query_Query-distinct">distinct</a></li><li class=""><a href="#query_Query-elemMatch">elemMatch</a></li><li class=""><a href="#query_Query-equals">equals</a></li><li class=""><a href="#query_Query-error">error</a></li><li class=""><a href="#query_Query-exec">exec</a></li><li class=""><a href="#query_Query-exists">exists</a></li><li class=""><a href="#query_Query-find">find</a></li><li class=""><a href="#query_Query-findOne">findOne</a></li><li class=""><a href="#query_Query-findOneAndRemove">findOneAndRemove</a></li><li class=""><a href="#query_Query-findOneAndUpdate">findOneAndUpdate</a></li><li class=""><a href="#query_Query-geometry">geometry</a></li><li class=""><a href="#query_Query-getQuery">getQuery</a></li><li class=""><a href="#query_Query-getUpdate">getUpdate</a></li><li class=""><a href="#query_Query-gt">gt</a></li><li class=""><a href="#query_Query-gte">gte</a></li><li class=""><a href="#query_Query-hint">hint</a></li><li class=""><a href="#query_Query-in">in</a></li><li class=""><a href="#query_Query-intersects">intersects</a></li><li class=""><a href="#query_Query-lean">lean</a></li><li class=""><a href="#query_Query-limit">limit</a></li><li class=""><a href="#query_Query-lt">lt</a></li><li class=""><a href="#query_Query-lte">lte</a></li><li class=""><a href="#query_Query-maxDistance">maxDistance</a></li><li class=""><a href="#query_Query-maxscan">maxscan</a></li><li class=""><a href="#query_Query-maxScan">maxScan</a></li><li class=""><a href="#query_Query-merge">merge</a></li><li class=""><a href="#query_Query-merge">merge</a></li><li class=""><a href="#query_Query-mod">mod</a></li><li class=""><a href="#query_Query-mongooseOptions">mongooseOptions</a></li><li class=""><a href="#query_Query-ne">ne</a></li><li class=""><a href="#query_Query-near">near</a></li><li class=""><a href="#query_Query-nearSphere">nearSphere</a></li><li class=""><a href="#query_Query-nin">nin</a></li><li class=""><a href="#query_Query-nor">nor</a></li><li class=""><a href="#query_Query-or">or</a></li><li class=""><a href="#query_Query-polygon">polygon</a></li><li class=""><a href="#query_Query-populate">populate</a></li><li class="private"><a href="#query_Query">Query</a></li><li class=""><a href="#query_Query-read">read</a></li><li class=""><a href="#query_Query-regex">regex</a></li><li class=""><a href="#query_Query-remove">remove</a></li><li class=""><a href="#query_Query-replaceOne">replaceOne</a></li><li class=""><a href="#query_Query-select">select</a></li><li class=""><a href="#query_Query-selected">selected</a></li><li class=""><a href="#query_Query-selectedExclusively">selectedExclusively</a></li><li class=""><a href="#query_Query-selectedInclusively">selectedInclusively</a></li><li class=""><a href="#query_Query-setOptions">setOptions</a></li><li class=""><a href="#query_Query-size">size</a></li><li class=""><a href="#query_Query-skip">skip</a></li><li class=""><a href="#query_Query-slaveOk">slaveOk</a></li><li class=""><a href="#query_Query-slice">slice</a></li><li class=""><a href="#query_Query-slice">slice</a></li><li class=""><a href="#query_Query-snapshot">snapshot</a></li><li class=""><a href="#query_Query-sort">sort</a></li><li class=""><a href="#query_Query-stream">stream</a></li><li class=""><a href="#query_Query-tailable">tailable</a></li><li class=""><a href="#query_Query-then">then</a></li><li class=""><a href="#query_Query-toConstructor">toConstructor</a></li><li class=""><a href="#query_Query-update">update</a></li><li class=""><a href="#query_Query-updateMany">updateMany</a></li><li class=""><a href="#query_Query-updateOne">updateOne</a></li><li class=""><a href="#query_Query-within">within</a></li><li class="private"><a href="#query_Query._ensurePath">_ensurePath</a></li><li class="private"><a href="#query_Query._fieldsForExec">_fieldsForExec</a></li><li class="private"><a href="#query_Query._updateForExec">_updateForExec</a></li><li class=""><a href="#query_Query-use%2524geoWithin">use$geoWithin</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#promise_provider-js" class="section">promise_provider.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#promise_provider_">Promise</a></li><li class="private"><a href="#promise_provider_Promise.get">get</a></li><li class="private"><a href="#promise_provider_Promise.reset">reset</a></li><li class="private"><a href="#promise_provider_Promise.set">set</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#schema-js" class="section">schema.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class=""><a href="#schema_Schema-add">add</a></li><li class=""><a href="#schema_Schema-clone">clone</a></li><li class="private"><a href="#schema_Schema-defaultOptions">defaultOptions</a></li><li class=""><a href="#schema_Schema-eachPath">eachPath</a></li><li class=""><a href="#schema_Schema-get">get</a></li><li class="private"><a href="#schema_Schema-hasMixedParent">hasMixedParent</a></li><li class=""><a href="#schema_Schema-index">index</a></li><li class="private"><a href="#schema_Schema-indexedPaths">indexedPaths</a></li><li class=""><a href="#schema_Schema-indexes">indexes</a></li><li class=""><a href="#schema_Schema-loadClass">loadClass</a></li><li class=""><a href="#schema_Schema-method">method</a></li><li class=""><a href="#schema_Schema-path">path</a></li><li class=""><a href="#schema_Schema-pathType">pathType</a></li><li class=""><a href="#schema_Schema-plugin">plugin</a></li><li class=""><a href="#schema_Schema-post">post</a></li><li class=""><a href="#schema_Schema-pre">pre</a></li><li class=""><a href="#schema_Schema-queue">queue</a></li><li class=""><a href="#schema_Schema-remove">remove</a></li><li class=""><a href="#schema_Schema-requiredPaths">requiredPaths</a></li><li class=""><a href="#schema_Schema">Schema</a></li><li class=""><a href="#schema_Schema-set">set</a></li><li class="private"><a href="#schema_Schema-setupTimestamp">setupTimestamp</a></li><li class=""><a href="#schema_Schema-static">static</a></li><li class=""><a href="#schema_Schema-virtual">virtual</a></li><li class=""><a href="#schema_Schema-virtualpath">virtualpath</a></li><li class=""><a href="#schema_undefined">indexTypes</a></li><li class="private"><a href="#schema_Schema.interpretAsType">interpretAsType</a></li><li class=""><a href="#schema_Schema.reserved">reserved</a></li><li class=""><a href="#schema_Schema.Types">Types</a></li><li class="private"><a href="#schema_Schema-_defaultMiddleware">_defaultMiddleware</a></li><li class=""><a href="#schema_Schema-childSchemas">childSchemas</a></li><li class=""><a href="#schema_Schema-obj">obj</a></li><li class="private"><a href="#schema_Schema-paths">paths</a></li><li class="private"><a href="#schema_Schema-tree">tree</a></li></ul></div><div class="file private"><span class="toggle-item"><a href="#document_provider-web-js" class="section">document_provider.web.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#document_provider.web_module.exports">exports</a></li></ul></div><div class="file "><span class="toggle-item"><a href="#collection-js" class="section">collection.js</a>&nbsp;<i class="fa fa-caret-right"></i></span><ul><li class="private"><a href="#collection_Collection-addQueue">addQueue</a></li><li class=""><a href="#collection_Collection">Collection</a></li><li class=""><a href="#collection_Collection-createIndex">createIndex</a></li><li class="private"><a href="#collection_Collection-doQueue">doQueue</a></li><li class=""><a href="#collection_Collection-ensureIndex">ensureIndex</a></li><li class=""><a href="#collection_Collection-find">find</a></li><li class=""><a href="#collection_Collection-findAndModify">findAndModify</a></li><li class=""><a href="#collection_Collection-findOne">findOne</a></li><li class=""><a href="#collection_Collection-getIndexes">getIndexes</a></li><li class=""><a href="#collection_Collection-insert">insert</a></li><li class=""><a href="#collection_Collection-mapReduce">mapReduce</a></li><li class="private"><a href="#collection_Collection-onClose">onClose</a></li><li class="private"><a href="#collection_Collection-onOpen">onOpen</a></li><li class=""><a href="#collection_Collection-save">save</a></li><li class=""><a href="#collection_Collection-update">update</a></li><li class=""><a href="#collection_Collection-collectionName">collectionName</a></li><li class=""><a href="#collection_Collection-conn">conn</a></li><li class=""><a href="#collection_Collection-name">name</a></li></ul></div></div></div><div id="content"><div class="controls"><label><input type="checkbox">private</label></div><ul><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/index.js" id="index-js">index.js</a><div class="item method private"><h3 id="index_Mongoose-_applyPlugins"><a href="#index_Mongoose-_applyPlugins">Mongoose#_applyPlugins(<code>schema</code>)</a></h3><p>Applies global plugins to <code>schema</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype._applyPlugins = <span class="keyword">function</span>(schema) {
  <span class="keyword">if</span> (schema.$globalPluginsApplied) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> i;
  <span class="keyword">var</span> len;
  <span class="keyword">for</span> (i = <span class="number">0</span>, len = <span class="keyword">this</span>.plugins.length; i &lt; len; ++i) {
    schema.plugin(<span class="keyword">this</span>.plugins[i][<span class="number">0</span>], <span class="keyword">this</span>.plugins[i][<span class="number">1</span>]);
  }
  schema.$globalPluginsApplied = <span class="literal">true</span>;
  <span class="keyword">for</span> (i = <span class="number">0</span>, len = schema.childSchemas.length; i &lt; len; ++i) {
    <span class="keyword">this</span>._applyPlugins(schema.childSchemas[i].schema);
  }
};
Mongoose.prototype._applyPlugins.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="index_Mongoose-Aggregate"><a href="#index_Mongoose-Aggregate">Mongoose#Aggregate()</a></h3><p>The Mongoose Aggregate constructor</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-CastError"><a href="#index_Mongoose-CastError">Mongoose#CastError(<code>type</code>, <code>value</code>, <code>path</code>, <code>[reason]</code>)</a></h3><p>The Mongoose CastError constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>The name of the type</span></li><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span>The value that failed to cast</span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>The path <code>a.b.c</code> in the doc where this cast error occurred</span></li><li><code>[reason]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>The original error that was thrown</span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method private"><h3 id="index_MongooseThenable-catch"><a href="#index_MongooseThenable-catch">MongooseThenable#catch(<code>onFulfilled</code>, <code>onRejected</code>)</a></h3><p>Ability to use mongoose object as a pseudo-promise so <code>.connect().then()</code><br />and <code>.disconnect().then()</code> are viable.</p><div class="params"><h4>Parameters:</h4><ul><li><code>onFulfilled</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>onRejected</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseThenable.prototype.<span class="keyword">catch</span> = <span class="keyword">function</span>(onRejected) {
  <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">null</span>, onRejected);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="index_checkReplicaSetInUri"><a href="#index_checkReplicaSetInUri">checkReplicaSetInUri(<code>uri</code>)</a></h3><p>Checks if ?replicaSet query parameter is specified in URI</p><div class="params"><h4>Parameters:</h4><ul><li><code>uri</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#boolean">boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>checkReplicaSetInUri(<span class="string">'localhost:27000?replicaSet=rs0'</span>); <span class="comment">// true</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> checkReplicaSetInUri = <span class="keyword">function</span>(uri) {
  <span class="keyword">if</span> (!uri) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">var</span> queryStringStart = uri.indexOf(<span class="string">'?'</span>);
  <span class="keyword">var</span> isReplicaSet = <span class="literal">false</span>;
  <span class="keyword">if</span> (queryStringStart !== -<span class="number">1</span>) {
    <span class="keyword">try</span> {
      <span class="keyword">var</span> obj = querystring.parse(uri.substr(queryStringStart + <span class="number">1</span>));
      <span class="keyword">if</span> (obj &amp;&amp; obj.replicaSet) {
        isReplicaSet = <span class="literal">true</span>;
      }
    } <span class="keyword">catch</span> (e) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
  }

  <span class="keyword">return</span> isReplicaSet;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="index_Mongoose-Collection"><a href="#index_Mongoose-Collection">Mongoose#Collection()</a></h3><p>The Mongoose Collection constructor</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-connect"><a href="#index_Mongoose-connect">Mongoose#connect(<code>uri(s)</code>, <code>[options]</code>, <code>[options.useMongoClient]</code>, <code>[callback]</code>)</a></h3><p>Opens the default mongoose connection.</p><div class="params"><h4>Parameters:</h4><ul><li><code>uri(s)</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options.useMongoClient]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>false by default, set to true to use new mongoose connection logic</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#MongooseThenable">MongooseThenable</a>&gt; </span><span>pseudo-promise wrapper around this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#index_Mongoose-createConnection" title="Mongoose#createConnection">Mongoose#createConnection</a></li></ul></div><div class="description"><p>If arguments are passed, they are proxied to either<br /><a href="#connection_Connection-open">Connection#open</a> or<br /><a href="#connection_Connection-openSet">Connection#openSet</a> appropriately.</p>

<p><em>Options passed take precedence over options included in connection strings.</em></p>

<h4>Example:</h4>

<pre><code>mongoose.connect(<span class="string">'mongodb://user:pass@localhost:port/database'</span>);

<span class="comment">// replica sets</span>
<span class="keyword">var</span> uri = <span class="string">'mongodb://user:pass@localhost:port,anotherhost:port,yetanother:port/mydatabase'</span>;
mongoose.connect(uri);

<span class="comment">// with options</span>
mongoose.connect(uri, options);

<span class="comment">// connecting to multiple mongos</span>
<span class="keyword">var</span> uri = <span class="string">'mongodb://hostA:27501,hostB:27501'</span>;
<span class="keyword">var</span> opts = { mongos: <span class="literal">true</span> };
mongoose.connect(uri, opts);

<span class="comment">// optional callback that gets fired when initial connection completed</span>
<span class="keyword">var</span> uri = <span class="string">'mongodb://nonexistent.domain:27000'</span>;
mongoose.connect(uri, <span class="keyword">function</span>(error) {
  <span class="comment">// if error is truthy, the initial connection failed.</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.connect = <span class="keyword">function</span>() {
  <span class="keyword">var</span> conn = <span class="keyword">this</span>.connection;
  <span class="keyword">if</span> ((arguments.length === <span class="number">2</span> || arguments.length === <span class="number">3</span>) &amp;&amp;
      <span class="keyword">typeof</span> arguments[<span class="number">0</span>] === <span class="string">'string'</span> &amp;&amp;
      <span class="keyword">typeof</span> arguments[<span class="number">1</span>] === <span class="string">'object'</span> &amp;&amp;
      arguments[<span class="number">1</span>].useMongoClient === <span class="literal">true</span>) {
    <span class="keyword">return</span> conn.openUri(arguments[<span class="number">0</span>], arguments[<span class="number">1</span>], arguments[<span class="number">2</span>]);
  }
  <span class="keyword">if</span> (rgxReplSet.test(arguments[<span class="number">0</span>]) || checkReplicaSetInUri(arguments[<span class="number">0</span>])) {
    <span class="keyword">return</span> <span class="keyword">new</span> MongooseThenable(<span class="keyword">this</span>, conn.openSet.apply(conn, arguments));
  }

  <span class="keyword">return</span> <span class="keyword">new</span> MongooseThenable(<span class="keyword">this</span>, conn.open.apply(conn, arguments));
};
Mongoose.prototype.connect.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Connection"><a href="#index_Mongoose-Connection">Mongoose#Connection()</a></h3><p>The Mongoose <a href="#connection_Connection">Connection</a> constructor</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-createConnection"><a href="#index_Mongoose-createConnection">Mongoose#createConnection(<code>[uri]</code>, <code>[options]</code>, <code>[options.config]</code>, <code>[options.config.autoIndex]</code>, <code>[options.useMongoClient]</code>)</a></h3><p>Creates a Connection instance.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[uri]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>a mongodb:// URI</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options to pass to the driver</span></li><li><code>[options.config]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>mongoose-specific options</span></li><li><code>[options.config.autoIndex]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>set to false to disable automatic index creation for all models associated with this connection.</span></li><li><code>[options.useMongoClient]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>false by default, set to true to use new mongoose connection logic</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>, <a href="#promise_Promise">Promise</a>&gt; </span><span>the created Connection object, or promise that resolves to the connection if `useMongoClient` option specified.</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#connection_Connection-open" title="Connection#open">Connection#open</a></li><li><a href="#connection_Connection-openSet" title="Connection#openSet">Connection#openSet</a></li></ul></div><div class="description"><p>Each <code>connection</code> instance maps to a single database. This method is helpful when mangaging multiple db connections.</p>

<p>If arguments are passed, they are proxied to either <a href="#connection_Connection-open">Connection#open</a> or <a href="#connection_Connection-openSet">Connection#openSet</a> appropriately. This means we can pass <code>db</code>, <code>server</code>, and <code>replset</code> options to the driver. <em>Note that the <code>safe</code> option specified in your schema will overwrite the <code>safe</code> db option specified here unless you set your schemas <code>safe</code> option to <code>undefined</code>. See <a href="../../guide.html#safe">this</a> for more information.</em></p>

<p><em>Options passed take precedence over options included in connection strings.</em></p>

<h4>Example:</h4>

<pre><code><span class="comment">// with mongodb:// URI</span>
db = mongoose.createConnection(<span class="string">'mongodb://user:pass@localhost:port/database'</span>);

<span class="comment">// and options</span>
<span class="keyword">var</span> opts = { db: { native_parser: <span class="literal">true</span> }}
db = mongoose.createConnection(<span class="string">'mongodb://user:pass@localhost:port/database'</span>, opts);

<span class="comment">// replica sets</span>
db = mongoose.createConnection(<span class="string">'mongodb://user:pass@localhost:port,anotherhost:port,yetanother:port/database'</span>);

<span class="comment">// and options</span>
<span class="keyword">var</span> opts = { replset: { strategy: <span class="string">'ping'</span>, rs_name: <span class="string">'testSet'</span> }}
db = mongoose.createConnection(<span class="string">'mongodb://user:pass@localhost:port,anotherhost:port,yetanother:port/database'</span>, opts);

<span class="comment">// with [host, database_name[, port] signature</span>
db = mongoose.createConnection(<span class="string">'localhost'</span>, <span class="string">'database'</span>, port)

<span class="comment">// and options</span>
<span class="keyword">var</span> opts = { server: { auto_reconnect: <span class="literal">false</span> }, user: <span class="string">'username'</span>, pass: <span class="string">'mypassword'</span> }
db = mongoose.createConnection(<span class="string">'localhost'</span>, <span class="string">'database'</span>, port, opts)

<span class="comment">// initialize now, connect later</span>
db = mongoose.createConnection();
db.open(<span class="string">'localhost'</span>, <span class="string">'database'</span>, port, [opts]);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.createConnection = <span class="keyword">function</span>(uri, options, callback) {
  <span class="keyword">var</span> conn = <span class="keyword">new</span> Connection(<span class="keyword">this</span>);
  <span class="keyword">this</span>.connections.push(conn);

  <span class="keyword">var</span> rsOption = options &amp;&amp; (options.replset || options.replSet);

  <span class="keyword">if</span> (options &amp;&amp; options.useMongoClient) {
    <span class="keyword">return</span> conn.openUri(uri, options, callback);
  }

  <span class="keyword">if</span> (arguments.length) {
    <span class="keyword">if</span> (rgxReplSet.test(arguments[<span class="number">0</span>]) || checkReplicaSetInUri(arguments[<span class="number">0</span>])) {
      conn._openSetWithoutPromise.apply(conn, arguments);
    } <span class="keyword">else</span> <span class="keyword">if</span> (rsOption &amp;&amp;
        (rsOption.replicaSet || rsOption.rs_name)) {
      conn._openSetWithoutPromise.apply(conn, arguments);
    } <span class="keyword">else</span> {
      conn._openWithoutPromise.apply(conn, arguments);
    }
  }

  <span class="keyword">return</span> conn;
};
Mongoose.prototype.createConnection.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-disconnect"><a href="#index_Mongoose-disconnect">Mongoose#disconnect(<code>[fn]</code>)</a></h3><p>Disconnects all connections.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>called after all connection close.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#MongooseThenable">MongooseThenable</a>&gt; </span><span>pseudo-promise wrapper around this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.disconnect = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> MongooseThenable(<span class="keyword">this</span>, <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">var</span> remaining = _<span class="keyword">this</span>.connections.length;
    <span class="keyword">if</span> (remaining &lt;= <span class="number">0</span>) {
      fn &amp;&amp; fn();
      resolve();
      <span class="keyword">return</span>;
    }
    _<span class="keyword">this</span>.connections.forEach(<span class="keyword">function</span>(conn) {
      conn.close(<span class="keyword">function</span>(error) {
        <span class="keyword">if</span> (error) {
          fn &amp;&amp; fn(error);
          reject(error);
          <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (!--remaining) {
          fn &amp;&amp; fn();
          resolve();
        }
      });
    });
  }));
};
Mongoose.prototype.disconnect.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Document"><a href="#index_Mongoose-Document">Mongoose#Document()</a></h3><p>The Mongoose <a href="#document-js">Document</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-DocumentProvider"><a href="#index_Mongoose-DocumentProvider">Mongoose#DocumentProvider()</a></h3><p>The Mongoose DocumentProvider constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Error"><a href="#index_Mongoose-Error">Mongoose#Error()</a></h3><p>The <a href="#error_MongooseError">MongooseError</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-get"><a href="#index_Mongoose-get">Mongoose#get(<code>key</code>)</a></h3><p>Gets mongoose options</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>mongoose.get(<span class="string">'test'</span>) <span class="comment">// returns the 'test' value</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-getPromiseConstructor"><a href="#index_Mongoose-getPromiseConstructor">Mongoose#getPromiseConstructor()</a></h3><p>Returns the current ES6-style promise constructor. In Mongoose 4.x,<br />equivalent to <code>mongoose.Promise.ES6</code>, but will change once we get rid<br />of the <code>.ES6</code> bit.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-model"><a href="#index_Mongoose-model">Mongoose#model(<code>name</code>, <code>[schema]</code>, <code>[collection]</code>, <code>[skipInit]</code>)</a></h3><p>Defines a model or retrieves it.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>model name or class extending Model</span></li><li><code>[schema]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>[collection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name (optional, inferred from model name)</span></li><li><code>[skipInit]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether to skip initialization (defaults to false)</span></li></ul></div><div class="description"><p>Models defined on the <code>mongoose</code> instance are available to all connection created by the same <code>mongoose</code> instance.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);

<span class="comment">// define an Actor model with this mongoose instance</span>
mongoose.model(<span class="string">'Actor'</span>, <span class="keyword">new</span> Schema({ name: String }));

<span class="comment">// create a new connection</span>
<span class="keyword">var</span> conn = mongoose.createConnection(..);

<span class="comment">// retrieve the Actor model</span>
<span class="keyword">var</span> Actor = conn.model(<span class="string">'Actor'</span>);</code></pre>

<p><em>When no <code>collection</code> argument is passed, Mongoose produces a collection name by passing the model <code>name</code> to the <a href="#utils_exports.toCollectionName">utils.toCollectionName</a> method. This method pluralizes the name. If you don't like this behavior, either pass a collection name or set your schemas collection name option.</em></p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ name: String }, { collection: <span class="string">'actor'</span> });

<span class="comment">// or</span>

schema.set(<span class="string">'collection'</span>, <span class="string">'actor'</span>);

<span class="comment">// or</span>

<span class="keyword">var</span> collectionName = <span class="string">'actor'</span>
<span class="keyword">var</span> M = mongoose.model(<span class="string">'Actor'</span>, schema, collectionName)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.model = <span class="keyword">function</span>(name, schema, collection, skipInit) {
  <span class="keyword">var</span> model;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">'function'</span>) {
    model = name;
    name = model.name;
    <span class="keyword">if</span> (!(model.prototype <span class="keyword">instanceof</span> Model)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> mongoose.Error(<span class="string">'The provided class '</span> + name + <span class="string">' must extend Model'</span>);
    }
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> schema === <span class="string">'string'</span>) {
    collection = schema;
    schema = <span class="literal">false</span>;
  }

  <span class="keyword">if</span> (utils.isObject(schema) &amp;&amp; !(schema.instanceOfSchema)) {
    schema = <span class="keyword">new</span> Schema(schema);
  }
  <span class="keyword">if</span> (schema &amp;&amp; !schema.instanceOfSchema) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The 2nd parameter to `mongoose.model()` should be a '</span> +
      <span class="string">'schema or a POJO'</span>);
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> collection === <span class="string">'boolean'</span>) {
    skipInit = collection;
    collection = <span class="literal">null</span>;
  }

  <span class="comment">// handle internal options from connection.model()</span>
  <span class="keyword">var</span> options;
  <span class="keyword">if</span> (skipInit &amp;&amp; utils.isObject(skipInit)) {
    options = skipInit;
    skipInit = <span class="literal">true</span>;
  } <span class="keyword">else</span> {
    options = {};
  }

  <span class="comment">// look up schema for the collection.</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.modelSchemas[name]) {
    <span class="keyword">if</span> (schema) {
      <span class="comment">// cache it so we only apply plugins once</span>
      <span class="keyword">this</span>.modelSchemas[name] = schema;
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="keyword">new</span> mongoose.Error.MissingSchemaError(name);
    }
  }

  <span class="keyword">if</span> (schema) {
    <span class="keyword">this</span>._applyPlugins(schema);
  }

  <span class="keyword">var</span> sub;

  <span class="comment">// connection.model() may be passing a different schema for</span>
  <span class="comment">// an existing model name. in this case don't read from cache.</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.models[name] &amp;&amp; options.cache !== <span class="literal">false</span>) {
    <span class="keyword">if</span> (schema &amp;&amp; schema.instanceOfSchema &amp;&amp; schema !== <span class="keyword">this</span>.models[name].schema) {
      <span class="keyword">throw</span> <span class="keyword">new</span> mongoose.Error.OverwriteModelError(name);
    }

    <span class="keyword">if</span> (collection) {
      <span class="comment">// subclass current model with alternate collection</span>
      model = <span class="keyword">this</span>.models[name];
      schema = model.prototype.schema;
      sub = model.__subclass(<span class="keyword">this</span>.connection, schema, collection);
      <span class="comment">// do not cache the sub model</span>
      <span class="keyword">return</span> sub;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.models[name];
  }

  <span class="comment">// ensure a schema exists</span>
  <span class="keyword">if</span> (!schema) {
    schema = <span class="keyword">this</span>.modelSchemas[name];
    <span class="keyword">if</span> (!schema) {
      <span class="keyword">throw</span> <span class="keyword">new</span> mongoose.Error.MissingSchemaError(name);
    }
  }

  <span class="comment">// Apply relevant "global" options to the schema</span>
  <span class="keyword">if</span> (!(<span class="string">'pluralization'</span> <span class="keyword">in</span> schema.options)) schema.options.pluralization = <span class="keyword">this</span>.options.pluralization;


  <span class="keyword">if</span> (!collection) {
    collection = schema.get(<span class="string">'collection'</span>) || format(name, schema.options);
  }

  <span class="keyword">var</span> connection = options.connection || <span class="keyword">this</span>.connection;
  model = <span class="keyword">this</span>.Model.compile(model || name, schema, collection, connection, <span class="keyword">this</span>);

  <span class="keyword">if</span> (!skipInit) {
    model.init();
  }

  <span class="keyword">if</span> (options.cache === <span class="literal">false</span>) {
    <span class="keyword">return</span> model;
  }

  <span class="keyword">this</span>.models[name] = model;
  <span class="keyword">return</span> <span class="keyword">this</span>.models[name];
};
Mongoose.prototype.model.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Model"><a href="#index_Mongoose-Model">Mongoose#Model()</a></h3><p>The Mongoose <a href="#model_Model">Model</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-modelNames"><a href="#index_Mongoose-modelNames">Mongoose#modelNames()</a></h3><p>Returns an array of model names created on this instance of Mongoose.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Note:</h4>

<p><em>Does not include names of models created using <code>connection.model()</code>.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.modelNames = <span class="keyword">function</span>() {
  <span class="keyword">var</span> names = Object.keys(<span class="keyword">this</span>.models);
  <span class="keyword">return</span> names;
};
Mongoose.prototype.modelNames.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose"><a href="#index_Mongoose">Mongoose()</a></h3><p>Mongoose constructor.</p><div class="description"><p>The exports object of the <code>mongoose</code> module is an instance of this class.<br />Most apps will only use this one instance.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Mongoose</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.connections = [];
  <span class="keyword">this</span>.models = {};
  <span class="keyword">this</span>.modelSchemas = {};
  <span class="comment">// default global options</span>
  <span class="keyword">this</span>.options = {
    pluralization: <span class="literal">true</span>
  };
  <span class="keyword">var</span> conn = <span class="keyword">this</span>.createConnection(); <span class="comment">// default connection</span>
  conn.models = <span class="keyword">this</span>.models;

  Object.defineProperty(<span class="keyword">this</span>, <span class="string">'plugins'</span>, {
    configurable: <span class="literal">false</span>,
    enumerable: <span class="literal">true</span>,
    writable: <span class="literal">false</span>,
    value: [
      [saveSubdocs, { deduplicate: <span class="literal">true</span> }],
      [validateBeforeSave, { deduplicate: <span class="literal">true</span> }],
      [shardingPlugin, { deduplicate: <span class="literal">true</span> }]
    ]
  });
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Mongoose"><a href="#index_Mongoose-Mongoose">Mongoose#Mongoose()</a></h3><p>The Mongoose constructor</p><div class="description"><p>The exports of the mongoose module is an instance of this class.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> mongoose2 = <span class="keyword">new</span> mongoose.Mongoose();</code></pre></div><hr class=""></div><div class="item method private"><h3 id="index_MongooseThenable"><a href="#index_MongooseThenable">MongooseThenable()</a></h3><p>Wraps the given Mongoose instance into a thenable (pseudo-promise). This<br />is so <code>connect()</code> and <code>disconnect()</code> can return a thenable while maintaining<br />backwards compatibility.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseThenable</span><span class="params">(mongoose, promise)</span> {</span>
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> mongoose) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> mongoose[key] === <span class="string">'function'</span> &amp;&amp; mongoose[key].$hasSideEffects) {
      (<span class="keyword">function</span>(key) {
        _<span class="keyword">this</span>[key] = <span class="keyword">function</span>() {
          <span class="keyword">return</span> mongoose[key].apply(mongoose, arguments);
        };
      })(key);
    } <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="string">'connection'</span>, <span class="string">'connections'</span>].indexOf(key) !== -<span class="number">1</span>) {
      _<span class="keyword">this</span>[key] = mongoose[key];
    }
  }
  <span class="keyword">this</span>.$opPromise = promise;
}

MongooseThenable.prototype = <span class="keyword">new</span> Mongoose;</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="index_Mongoose-plugin"><a href="#index_Mongoose-plugin">Mongoose#plugin(<code>fn</code>, <code>[opts]</code>)</a></h3><p>Declares a global plugin executed on all Schemas.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>plugin callback</span></li><li><code>[opts]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional options</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#index_Mongoose">Mongoose</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="plugins.html" title="plugins">plugins</a></li></ul></div><div class="description"><p>Equivalent to calling <code>.plugin(fn)</code> on each Schema you create.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.plugin = <span class="keyword">function</span>(fn, opts) {
  <span class="keyword">this</span>.plugins.push([fn, opts]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};
Mongoose.prototype.plugin.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise"><a href="#index_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise">function Object() { [native code] }#Promise()</a></h3><p>The Mongoose <a href="#promise_Promise">Promise</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-PromiseProvider"><a href="#index_Mongoose-PromiseProvider">Mongoose#PromiseProvider()</a></h3><p>Storage layer for mongoose promises</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Query"><a href="#index_Mongoose-Query">Mongoose#Query()</a></h3><p>The Mongoose <a href="#query_Query">Query</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-Schema"><a href="#index_Mongoose-Schema">Mongoose#Schema()</a></h3><p>The Mongoose <a href="#schema_Schema">Schema</a> constructor</p><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> Schema = mongoose.Schema;
<span class="keyword">var</span> CatSchema = <span class="keyword">new</span> Schema(..);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-SchemaType"><a href="#index_Mongoose-SchemaType">Mongoose#SchemaType()</a></h3><p>The Mongoose <a href="#schematype_SchemaType">SchemaType</a> constructor</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="index_Mongoose-set"><a href="#index_Mongoose-set">Mongoose#set(<code>key</code>, <code>value</code>)</a></h3><p>Sets mongoose options</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>mongoose.set(<span class="string">'test'</span>, value) <span class="comment">// sets the 'test' option to `value`</span>

mongoose.set(<span class="string">'debug'</span>, <span class="literal">true</span>) <span class="comment">// enable logging collection methods + arguments to the console</span>

mongoose.set(<span class="string">'debug'</span>, <span class="keyword">function</span>(collectionName, methodName, arg1, arg2...) {}); <span class="comment">// use custom function to log collection methods + arguments</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.set = <span class="keyword">function</span>(key, value) {
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>.options[key];
  }

  <span class="keyword">this</span>.options[key] = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};
Mongoose.prototype.set.$hasSideEffects = <span class="literal">true</span>;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="index_"><a href="#index_">()</a></h3><p>Expose connection states for user-land</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.STATES = STATES;</code></pre></div><hr class=""></div><div class="item method private"><h3 id="index_MongooseThenable-then"><a href="#index_MongooseThenable-then">MongooseThenable#then(<code>onFulfilled</code>, <code>onRejected</code>)</a></h3><p>Ability to use mongoose object as a pseudo-promise so <code>.connect().then()</code><br />and <code>.disconnect().then()</code> are viable.</p><div class="params"><h4>Parameters:</h4><ul><li><code>onFulfilled</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>onRejected</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseThenable.prototype.then = <span class="keyword">function</span>(onFulfilled, onRejected) {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">if</span> (!<span class="keyword">this</span>.$opPromise) {
    <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
      reject(<span class="keyword">new</span> Error(<span class="string">'Can only call `.then()` if connect() or disconnect() '</span> +
        <span class="string">'has been called'</span>));
    }).then(onFulfilled, onRejected);
  }
  <span class="keyword">this</span>.$opPromise.$hasHandler = <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>.$opPromise.then(onFulfilled, onRejected);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="index_Mongoose-VirtualType"><a href="#index_Mongoose-VirtualType">Mongoose#VirtualType()</a></h3><p>The Mongoose <a href="#virtualtype_VirtualType">VirtualType</a> constructor</p><div class="description"></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-connection"><a href="#index_Mongoose-connection">Mongoose#<span>connection</span></a></h3><p>The default connection of the mongoose module.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
mongoose.connect(...);
mongoose.connection.on(<span class="string">'error'</span>, cb);</code></pre>

<p>This is the connection used by default for every model created using <a href="#index_Mongoose-model">mongoose.model</a>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.__defineGetter__(<span class="string">'connection'</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.connections[<span class="number">0</span>];
});

Mongoose.prototype.__defineSetter__(<span class="string">'connection'</span>, <span class="keyword">function</span>(v) {
  <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Connection) {
    <span class="keyword">this</span>.connections[<span class="number">0</span>] = v;
    <span class="keyword">this</span>.models = v.models;
  }
});</code></pre></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-mongo"><a href="#index_Mongoose-mongo">Mongoose#<span>mongo</span></a></h3><p>The <a href="https://github.com/mongodb/node-mongodb-native">node-mongodb-native</a> driver Mongoose uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.mongo = require(<span class="string">'mongodb'</span>);</code></pre></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-mquery"><a href="#index_Mongoose-mquery">Mongoose#<span>mquery</span></a></h3><p>The <a href="https://github.com/aheckmann/mquery">mquery</a> query builder Mongoose uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.mquery = require(<span class="string">'mquery'</span>);</code></pre></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-SchemaTypes"><a href="#index_Mongoose-SchemaTypes">Mongoose#<span>SchemaTypes</span></a></h3><p>The various Mongoose SchemaTypes.</p>

<h4>Note:</h4>

<p><em>Alias of mongoose.Schema.Types for backwards compatibility.</em></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.SchemaTypes = Schema.Types;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#schema_Schema.Types" title="Schema.SchemaTypes">Schema.SchemaTypes</a></li></ul></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-Types"><a href="#index_Mongoose-Types">Mongoose#<span>Types</span></a></h3><p>The various Mongoose Types.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> array = mongoose.Types.Array;</code></pre>

<h4>Types:</h4>

<ul>
<li><a href="#types-objectid-js">ObjectId</a></li>
<li><a href="#types-buffer-js">Buffer</a></li>
<li><a href="#types-embedded-js">SubDocument</a></li>
<li><a href="#types-array-js">Array</a></li>
<li><a href="#types-documentarray-js">DocumentArray</a></li>
</ul>

<p>Using this exposed access to the <code>ObjectId</code> type, we can construct ids on demand.</p>

<pre><code><span class="keyword">var</span> ObjectId = mongoose.Types.ObjectId;
<span class="keyword">var</span> id1 = <span class="keyword">new</span> ObjectId;</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.Types = Types;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="index_Mongoose-version"><a href="#index_Mongoose-version">Mongoose#<span>version</span></a></h3><p>The Mongoose version</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mongoose.prototype.version = pkg.version;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/virtualtype.js" id="virtualtype-js">virtualtype.js</a><div class="item method public"><h3 id="virtualtype_VirtualType-applyGetters"><a href="#virtualtype_VirtualType-applyGetters">VirtualType#applyGetters(<code>value</code>, <code>scope</code>)</a></h3><p>Applies getters to <code>value</code> using optional <code>scope</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;T&gt; </span><span>the value after applying all getters</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applyGetters = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">var</span> v = value;
  <span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="keyword">this</span>.getters.length - <span class="number">1</span>; l >= <span class="number">0</span>; l--) {
    v = <span class="keyword">this</span>.getters[l].call(scope, v, <span class="keyword">this</span>);
  }
  <span class="keyword">return</span> v;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="virtualtype_VirtualType-applySetters"><a href="#virtualtype_VirtualType-applySetters">VirtualType#applySetters(<code>value</code>, <code>scope</code>)</a></h3><p>Applies setters to <code>value</code> using optional <code>scope</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;T&gt; </span><span>the value after applying all setters</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.applySetters = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">var</span> v = value;
  <span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="keyword">this</span>.setters.length - <span class="number">1</span>; l >= <span class="number">0</span>; l--) {
    v = <span class="keyword">this</span>.setters[l].call(scope, v, <span class="keyword">this</span>);
  }
  <span class="keyword">return</span> v;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="virtualtype_VirtualType-get"><a href="#virtualtype_VirtualType-get">VirtualType#get(<code>fn</code>)</a></h3><p>Defines a getter.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> virtual = schema.virtual(<span class="string">'fullname'</span>);
virtual.get(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.name.first + <span class="string">' '</span> + <span class="keyword">this</span>.name.last;
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.get = <span class="keyword">function</span>(fn) {
  <span class="keyword">this</span>.getters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="virtualtype_VirtualType-set"><a href="#virtualtype_VirtualType-set">VirtualType#set(<code>fn</code>)</a></h3><p>Defines a setter.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> virtual = schema.virtual(<span class="string">'fullname'</span>);
virtual.set(<span class="function"><span class="keyword">function</span> <span class="params">(v)</span> {</span>
  <span class="keyword">var</span> parts = v.split(<span class="string">' '</span>);
  <span class="keyword">this</span>.name.first = parts[<span class="number">0</span>];
  <span class="keyword">this</span>.name.last = parts[<span class="number">1</span>];
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">VirtualType.prototype.set = <span class="keyword">function</span>(fn) {
  <span class="keyword">this</span>.setters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="virtualtype_VirtualType"><a href="#virtualtype_VirtualType">VirtualType()</a></h3><p>VirtualType constructor</p><div class="description"><p>This is what mongoose uses to define virtual attributes via <code>Schema.prototype.virtual</code>.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> fullname = schema.virtual(<span class="string">'fullname'</span>);
fullname <span class="keyword">instanceof</span> mongoose.VirtualType <span class="comment">// true</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">VirtualType</span><span class="params">(options, name)</span> {</span>
  <span class="keyword">this</span>.path = name;
  <span class="keyword">this</span>.getters = [];
  <span class="keyword">this</span>.setters = [];
  <span class="keyword">this</span>.options = options || {};
}</code></pre></div><hr class=""></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/browserDocument.js" id="browserDocument-js">browserDocument.js</a><div class="item method private"><h3 id="browserDocument_Document"><a href="#browserDocument_Document">Document(<code>obj</code>, <code>[fields]</code>, <code>[skipId]</code>)</a></h3><p>Document constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the values to set</span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional object containing the fields which were selected in the query returning this document and any populated paths data</span></li><li><code>[skipId]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>bool, should we auto create an ObjectId _id</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/events.html#events_class_events_eventemitter" title="NodeJS EventEmitter">NodeJS EventEmitter</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>init</code>: Emitted on a document after it has was retrieved from the db and fully hydrated by Mongoose.</p></li><li><p><code>save</code>: Emitted when the document is successfully saved</p></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Document</span><span class="params">(obj, schema, fields, skipId, skipInit)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Document)) {
    <span class="keyword">return</span> <span class="keyword">new</span> Document(obj, schema, fields, skipId, skipInit);
  }


  <span class="keyword">if</span> (utils.isObject(schema) &amp;&amp; !schema.instanceOfSchema) {
    schema = <span class="keyword">new</span> Schema(schema);
  }

  <span class="comment">// When creating EmbeddedDocument, it already has the schema and he doesn't need the _id</span>
  schema = <span class="keyword">this</span>.schema || schema;

  <span class="comment">// Generate ObjectId if it is missing, but it requires a scheme</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.schema &amp;&amp; schema.options._id) {
    obj = obj || {};

    <span class="keyword">if</span> (obj._id === <span class="literal">undefined</span>) {
      obj._id = <span class="keyword">new</span> ObjectId();
    }
  }

  <span class="keyword">if</span> (!schema) {
    <span class="keyword">throw</span> <span class="keyword">new</span> MongooseError.MissingSchemaError();
  }

  <span class="keyword">this</span>.$__setSchema(schema);

  <span class="keyword">this</span>.$__ = <span class="keyword">new</span> InternalCache;
  <span class="keyword">this</span>.$__.emitter = <span class="keyword">new</span> EventEmitter();
  <span class="keyword">this</span>.isNew = <span class="literal">true</span>;
  <span class="keyword">this</span>.errors = <span class="literal">undefined</span>;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">'boolean'</span>) {
    <span class="keyword">this</span>.$__.strictMode = fields;
    fields = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.$__.strictMode = <span class="keyword">this</span>.schema.options &amp;&amp; <span class="keyword">this</span>.schema.options.strict;
    <span class="keyword">this</span>.$__.selected = fields;
  }

  <span class="keyword">var</span> required = <span class="keyword">this</span>.schema.requiredPaths();
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; required.length; ++i) {
    <span class="keyword">this</span>.$__.activePaths.require(required[i]);
  }

  <span class="keyword">this</span>.$__.emitter.setMaxListeners(<span class="number">0</span>);
  <span class="keyword">this</span>._doc = <span class="keyword">this</span>.$__buildDoc(obj, fields, skipId);

  <span class="keyword">if</span> (!skipInit &amp;&amp; obj) {
    <span class="keyword">this</span>.init(obj);
  }

  <span class="keyword">this</span>.$__registerHooksFromSchema();

  <span class="comment">// apply methods</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> m <span class="keyword">in</span> schema.methods) {
    <span class="keyword">this</span>[m] = schema.methods[m];
  }
  <span class="comment">// apply statics</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> s <span class="keyword">in</span> schema.statics) {
    <span class="keyword">this</span>[s] = schema.statics[s];
  }
}</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/documentarray.js" id="types-documentarray-js">types/documentarray.js</a><div class="item method private"><h3 id="types_documentarray_MongooseDocumentArray"><a href="#types_documentarray_MongooseDocumentArray">MongooseDocumentArray(<code>values</code>, <code>path</code>, <code>doc</code>)</a></h3><p>DocumentArray constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to this array</span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>parent document</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_documentarray_MongooseDocumentArray">MongooseDocumentArray</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#types_array_MongooseArray">MongooseArray</a></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseDocumentArray</span><span class="params">(values, path, doc)</span> {</span>
  <span class="keyword">var</span> arr = [].concat(values);
  arr._path = path;

  <span class="keyword">var</span> props = {
    isMongooseArray: <span class="literal">true</span>,
    isMongooseDocumentArray: <span class="literal">true</span>,
    validators: [],
    _atomics: {},
    _schema: <span class="keyword">void</span> <span class="number">0</span>,
    _handlers: <span class="keyword">void</span> <span class="number">0</span>
  };

  <span class="comment">// Values always have to be passed to the constructor to initialize, since</span>
  <span class="comment">// otherwise MongooseArray#push will mark the array as modified to the parent.</span>
  <span class="keyword">var</span> keysMA = Object.keys(MongooseArray.mixin);
  <span class="keyword">var</span> numKeys = keysMA.length;
  <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; numKeys; ++j) {
    arr[keysMA[j]] = MongooseArray.mixin[keysMA[j]];
  }

  <span class="keyword">var</span> keysMDA = Object.keys(MongooseDocumentArray.mixin);
  numKeys = keysMDA.length;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numKeys; ++i) {
    arr[keysMDA[i]] = MongooseDocumentArray.mixin[keysMDA[i]];
  }

  <span class="keyword">var</span> keysP = Object.keys(props);
  numKeys = keysP.length;
  <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; numKeys; ++k) {
    arr[keysP[k]] = props[keysP[k]];
  }

  <span class="comment">// Because doc comes from the context of another function, doc === global</span>
  <span class="comment">// can happen if there was a null somewhere up the chain (see #3020 &amp;&amp; #3034)</span>
  <span class="comment">// RB Jun 17, 2015 updated to check for presence of expected paths instead</span>
  <span class="comment">// to make more proof against unusual node environments</span>
  <span class="keyword">if</span> (doc &amp;&amp; doc <span class="keyword">instanceof</span> Document) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
    arr._handlers = {
      isNew: arr.notify(<span class="string">'isNew'</span>),
      save: arr.notify(<span class="string">'save'</span>)
    };

    doc.on(<span class="string">'save'</span>, arr._handlers.save);
    doc.on(<span class="string">'isNew'</span>, arr._handlers.isNew);
  }

  <span class="keyword">return</span> arr;
}</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="types_documentarray_MongooseDocumentArray._cast"><a href="#types_documentarray_MongooseDocumentArray._cast">MongooseDocumentArray._cast()</a></h3><p>Overrides MongooseArray#cast</p><hr class="private"></div><div class="item static public"><h3 id="types_documentarray_MongooseDocumentArray.id"><a href="#types_documentarray_MongooseDocumentArray.id">MongooseDocumentArray.id(<code>id</code>)</a></h3><p>Searches array items for the first document with a matching _id.</p><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="#types_objectid_ObjectId">ObjectId</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a>, <a href="#null">null</a>&gt; </span><span>the subdocument or null if not found.</span></li></ul></div><h4>Example:</h4>

<pre><code><span class="keyword">var</span> embeddedDoc = m.array.id(some_id);</code></pre><hr class=""></div><div class="item static public"><h3 id="types_documentarray_MongooseDocumentArray.toObject"><a href="#types_documentarray_MongooseDocumentArray.toObject">MongooseDocumentArray.toObject(<code>[options]</code>)</a></h3><p>Returns a native js Array of plain js objects</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional options to pass to each documents &lt;code&gt;toObject&lt;/code&gt; method call during conversion</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><h4>NOTE:</h4>

<p><em>Each sub-document is converted to a plain object by calling its <code>#toObject</code> method.</em></p><hr class=""></div><div class="item static public"><h3 id="types_documentarray_MongooseDocumentArray.inspect"><a href="#types_documentarray_MongooseDocumentArray.inspect">MongooseDocumentArray.inspect()</a></h3><p>Helper for console.log</p><hr class=""></div><div class="item static public"><h3 id="types_documentarray_MongooseDocumentArray.create"><a href="#types_documentarray_MongooseDocumentArray.create">MongooseDocumentArray.create(<code>obj</code>)</a></h3><p>Creates a subdocument casted to this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the value to cast to this arrays SubDocument schema</span></li></ul></div><p>This is the same subdocument constructor used for casting.</p><hr class=""></div><div class="item static private"><h3 id="types_documentarray_MongooseDocumentArray.notify"><a href="#types_documentarray_MongooseDocumentArray.notify">MongooseDocumentArray.notify(<code>event</code>)</a></h3><p>Creates a fn that notifies all child docs of <code>event</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>event</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/array.js" id="types-array-js">types/array.js</a><div class="item method private"><h3 id="types_array_MongooseArray-%24__getAtomics"><a href="#types_array_MongooseArray-%24__getAtomics">MongooseArray#$__getAtomics()</a></h3><p>Depopulates stored atomic operation values as necessary for direct insertion to MongoDB.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"><p>If no atomics exist, we return all array values after conversion.</p></div><hr class="private"></div><div class="item method public"><h3 id="types_array_MongooseArray-%24shift"><a href="#types_array_MongooseArray-%24shift">MongooseArray#$shift()</a></h3><p>Atomically shifts the array at most one time per document <code>save()</code>.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pop" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>NOTE:</h4>

<p><em>Calling this mulitple times on an array before saving sends the same command as calling it once.</em><br /><em>This update is implemented using the MongoDB <a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pop">$pop</a> method which enforces this restriction.</em></p>

<pre><code>doc.array = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];

 <span class="keyword">var</span> shifted = doc.array.$shift();
 console.log(shifted); <span class="comment">// 1</span>
 console.log(doc.array); <span class="comment">// [2,3]</span>

 <span class="comment">// no affect</span>
 shifted = doc.array.$shift();
 console.log(doc.array); <span class="comment">// [2,3]</span>

 doc.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
   <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);

   <span class="comment">// we saved, now $shift works again</span>
   shifted = doc.array.$shift();
   console.log(shifted ); <span class="comment">// 2</span>
   console.log(doc.array); <span class="comment">// [3]</span>
 })</code></pre></div><hr class=""></div><div class="item method private"><h3 id="types_array_MongooseArray"><a href="#types_array_MongooseArray">MongooseArray(<code>values</code>, <code>path</code>, <code>doc</code>)</a></h3><p>Mongoose Array constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>values</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>parent document</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div><div class="description"><h4>NOTE:</h4>

<p><em>Values always have to be passed to the constructor to initialize, otherwise <code>MongooseArray#push</code> will mark the array as modified.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseArray</span><span class="params">(values, path, doc)</span> {</span>
  <span class="keyword">var</span> arr = [].concat(values);

  <span class="keyword">var</span> keysMA = Object.keys(MongooseArray.mixin);
  <span class="keyword">var</span> numKeys = keysMA.length;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numKeys; ++i) {
    arr[keysMA[i]] = MongooseArray.mixin[keysMA[i]];
  }

  arr._path = path;
  arr.isMongooseArray = <span class="literal">true</span>;
  arr.validators = [];
  arr._atomics = {};
  arr._schema = <span class="keyword">void</span> <span class="number">0</span>;

  <span class="comment">// Because doc comes from the context of another function, doc === global</span>
  <span class="comment">// can happen if there was a null somewhere up the chain (see #3020)</span>
  <span class="comment">// RB Jun 17, 2015 updated to check for presence of expected paths instead</span>
  <span class="comment">// to make more proof against unusual node environments</span>
  <span class="keyword">if</span> (doc &amp;&amp; doc <span class="keyword">instanceof</span> Document) {
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
  }

  <span class="keyword">return</span> arr;
}

MongooseArray.mixin = {</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="types_array_MongooseArray-remove"><a href="#types_array_MongooseArray-remove">MongooseArray#remove()</a></h3><p>Alias of <a href="#types_array_MongooseArray-pull">pull</a></p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#types_array_MongooseArray-pull" title="MongooseArray#pull">MongooseArray#pull</a></li><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pull" title="mongodb">mongodb</a></li></ul></div><div class="description"></div><hr class=""></div><div class="item static private"><h3 id="types_array_MongooseArray._cast"><a href="#types_array_MongooseArray._cast">MongooseArray._cast(<code>value</code>)</a></h3><p>Casts a member based on this arrays schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#value">value</a>&gt; </span><span>the casted value</span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="types_array_MongooseArray._mapCast"><a href="#types_array_MongooseArray._mapCast">MongooseArray._mapCast()</a></h3><p>Internal helper for .map()</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="types_array_MongooseArray._markModified"><a href="#types_array_MongooseArray._markModified">MongooseArray._markModified(<code>embeddedDoc</code>, <code>embeddedPath</code>)</a></h3><p>Marks this array as modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>embeddedDoc</code><span class="types"> &lt;<a href="#types_embedded_EmbeddedDocument">EmbeddedDocument</a>&gt; </span><span>the embedded doc that invoked this method on the Array</span></li><li><code>embeddedPath</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path which changed in the embeddedDoc</span></li></ul></div><p>If it bubbles up from an embedded document change, then it takes the following arguments (otherwise, takes 0 arguments)</p><hr class="private"></div><div class="item static private"><h3 id="types_array_MongooseArray._registerAtomic"><a href="#types_array_MongooseArray._registerAtomic">MongooseArray._registerAtomic(<code>op</code>, <code>val</code>)</a></h3><p>Register an atomic operation with the parent.</p><div class="params"><h4>Parameters:</h4><ul><li><code>op</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>operation</span></li><li><code>val</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="types_array_MongooseArray.%24pop"><a href="#types_array_MongooseArray.%24pop">MongooseArray.$pop()</a></h3><p>Pops the array atomically at most one time per document <code>save()</code>.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pop" title="mongodb">mongodb</a></li></ul></div><h4>NOTE:</h4>

<p><em>Calling this mulitple times on an array before saving sends the same command as calling it once.</em><br /><em>This update is implemented using the MongoDB <a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pop">$pop</a> method which enforces this restriction.</em></p>

<pre><code>doc.array = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];

 <span class="keyword">var</span> popped = doc.array.$pop();
 console.log(popped); <span class="comment">// 3</span>
 console.log(doc.array); <span class="comment">// [1,2]</span>

 <span class="comment">// no affect</span>
 popped = doc.array.$pop();
 console.log(doc.array); <span class="comment">// [1,2]</span>

 doc.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
   <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);

   <span class="comment">// we saved, now $pop works again</span>
   popped = doc.array.$pop();
   console.log(popped); <span class="comment">// 2</span>
   console.log(doc.array); <span class="comment">// [1]</span>
 })</code></pre><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.addToSet"><a href="#types_array_MongooseArray.addToSet">MongooseArray.addToSet(<code>[args...]</code>)</a></h3><p>Adds values to the array if not already present.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>the values that were added</span></li></ul></div><h4>Example:</h4>

<pre><code>console.log(doc.array) <span class="comment">// [2,3,4]</span>
<span class="keyword">var</span> added = doc.array.addToSet(<span class="number">4</span>,<span class="number">5</span>);
console.log(doc.array) <span class="comment">// [2,3,4,5]</span>
console.log(added)     <span class="comment">// [5]</span></code></pre><hr class=""></div><div class="item static private"><h3 id="types_array_MongooseArray.hasAtomics"><a href="#types_array_MongooseArray.hasAtomics">MongooseArray.hasAtomics()</a></h3><p>Returns the number of pending atomic operations to send to the db for this array.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="types_array_MongooseArray.indexOf"><a href="#types_array_MongooseArray.indexOf">MongooseArray.indexOf(<code>obj</code>)</a></h3><p>Return the index of <code>obj</code> or <code>-1</code> if not found.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the item to look for</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.inspect"><a href="#types_array_MongooseArray.inspect">MongooseArray.inspect()</a></h3><p>Helper for console.log</p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.nonAtomicPush"><a href="#types_array_MongooseArray.nonAtomicPush">MongooseArray.nonAtomicPush(<code>[args...]</code>)</a></h3><p>Pushes items to the array non-atomically.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><h4>NOTE:</h4>

<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.pop"><a href="#types_array_MongooseArray.pop">MongooseArray.pop()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/pop"><code>Array#pop</code></a> with proper change tracking.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#types_array_MongooseArray-%24pop" title="MongooseArray#$pop">MongooseArray#$pop</a></li></ul></div><h4>Note:</h4>

<p><em>marks the entire array as modified which will pass the entire thing to $set potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.pull"><a href="#types_array_MongooseArray.pull">MongooseArray.pull(<code>[args...]</code>)</a></h3><p>Pulls items from the array atomically. Equality is determined by casting<br />the provided value to an embedded document and comparing using<br /><a href="api.html#document_Document-equals">the <code>Document.equals()</code> function.</a></p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Updating/#Updating-%24pull" title="mongodb">mongodb</a></li></ul></div><h4>Examples:</h4>

<pre><code>doc.array.pull(ObjectId)
doc.array.pull({ _id: <span class="string">'someId'</span> })
doc.array.pull(<span class="number">36</span>)
doc.array.pull(<span class="string">'tag 1'</span>, <span class="string">'tag 2'</span>)</code></pre>

<p>To remove a document from a subdocument array we may pass an object with a matching <code>_id</code>.</p>

<pre><code>doc.subdocs.push({ _id: <span class="number">4815162342</span> })
doc.subdocs.pull({ _id: <span class="number">4815162342</span> }) <span class="comment">// removed</span></code></pre>

<p>Or we may passing the _id directly and let mongoose take care of it.</p>

<pre><code>doc.subdocs.push({ _id: <span class="number">4815162342</span> })
doc.subdocs.pull(<span class="number">4815162342</span>); <span class="comment">// works</span></code></pre>

<p>The first pull call will result in a atomic operation on the database, if pull is called repeatedly without saving the document, a $set operation is used on the complete array instead, overwriting possible changes that happened on the database in the meantime.</p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.push"><a href="#types_array_MongooseArray.push">MongooseArray.push(<code>[args...]</code>)</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/push"><code>Array#push</code></a> with proper change tracking.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.set"><a href="#types_array_MongooseArray.set">MongooseArray.set()</a></h3><p>Sets the casted <code>val</code> at index <code>i</code> and marks the array modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>this</span></li></ul></div><h4>Example:</h4>

<pre><code><span class="comment">// given documents based on the following</span>
<span class="keyword">var</span> Doc = mongoose.model(<span class="string">'Doc'</span>, <span class="keyword">new</span> Schema({ array: [Number] }));

<span class="keyword">var</span> doc = <span class="keyword">new</span> Doc({ array: [<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>] })

console.log(doc.array) <span class="comment">// [2,3,4]</span>

doc.array.set(<span class="number">1</span>,<span class="string">"5"</span>);
console.log(doc.array); <span class="comment">// [2,5,4] // properly cast to number</span>
doc.save() <span class="comment">// the change is saved</span>

<span class="comment">// VS not using array#set</span>
doc.array[<span class="number">1</span>] = <span class="string">"5"</span>;
console.log(doc.array); <span class="comment">// [2,"5",4] // no casting</span>
doc.save() <span class="comment">// change is not saved</span></code></pre><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.shift"><a href="#types_array_MongooseArray.shift">MongooseArray.shift()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/unshift"><code>Array#shift</code></a> with proper change tracking.</p><h4>Example:</h4>

<pre><code>doc.array = [<span class="number">2</span>,<span class="number">3</span>];
<span class="keyword">var</span> res = doc.array.shift();
console.log(res) <span class="comment">// 2</span>
console.log(doc.array) <span class="comment">// [3]</span></code></pre>

<h4>Note:</h4>

<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.sort"><a href="#types_array_MongooseArray.sort">MongooseArray.sort()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/sort"><code>Array#sort</code></a> with proper change tracking.</p><h4>NOTE:</h4>

<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.splice"><a href="#types_array_MongooseArray.splice">MongooseArray.splice()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/splice"><code>Array#splice</code></a> with proper change tracking and casting.</p><h4>Note:</h4>

<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.toObject"><a href="#types_array_MongooseArray.toObject">MongooseArray.toObject(<code>options</code>)</a></h3><p>Returns a native js Array.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="types_array_MongooseArray.unshift"><a href="#types_array_MongooseArray.unshift">MongooseArray.unshift()</a></h3><p>Wraps <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/unshift"><code>Array#unshift</code></a> with proper change tracking.</p><h4>Note:</h4>

<p><em>marks the entire array as modified, which if saved, will store it as a <code>$set</code> operation, potentially overwritting any changes that happen between when you retrieved the object and when you save it.</em></p><hr class=""></div><div class="item property private"><h3 id="types_array_MongooseArray-_atomics"><a href="#types_array_MongooseArray-_atomics">MongooseArray#<span>_atomics</span></a></h3><p>Stores a queue of atomic operations to perform</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_atomics: <span class="literal">undefined</span>,</code></pre></div><hr class="private"></div><div class="item property private"><h3 id="types_array_MongooseArray-_parent"><a href="#types_array_MongooseArray-_parent">MongooseArray#<span>_parent</span></a></h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_parent: <span class="literal">undefined</span>,</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/decimal128.js" id="types-decimal128-js">types/decimal128.js</a><div class="item static public"><h3 id="types_decimal128_exports"><a href="#types_decimal128_exports">exports()</a></h3><p>ObjectId type constructor</p><h4>Example</h4>

<pre><code><span class="keyword">var</span> id = <span class="keyword">new</span> mongoose.Types.ObjectId;</code></pre><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/objectid.js" id="types-objectid-js">types/objectid.js</a><div class="item method public"><h3 id="types_objectid_ObjectId"><a href="#types_objectid_ObjectId">ObjectId()</a></h3><p>ObjectId type constructor</p><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> id = <span class="keyword">new</span> mongoose.Types.ObjectId;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/subdocument.js" id="types-subdocument-js">types/subdocument.js</a><div class="item method public"><h3 id="types_subdocument_Subdocument-ownerDocument"><a href="#types_subdocument_Subdocument-ownerDocument">Subdocument#ownerDocument()</a></h3><p>Returns the top level document of this sub-document.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Subdocument.prototype.ownerDocument = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.ownerDocument) {
    <span class="keyword">return</span> <span class="keyword">this</span>.$__.ownerDocument;
  }

  <span class="keyword">var</span> parent = <span class="keyword">this</span>.$parent;
  <span class="keyword">if</span> (!parent) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">while</span> (parent.$parent || parent.__parent) {
    parent = parent.$parent || parent.__parent;
  }
  <span class="keyword">this</span>.$__.ownerDocument = parent;
  <span class="keyword">return</span> <span class="keyword">this</span>.$__.ownerDocument;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_subdocument_Subdocument-parent"><a href="#types_subdocument_Subdocument-parent">Subdocument#parent()</a></h3><p>Returns this sub-documents parent document.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Subdocument.prototype.parent = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.$parent;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_subdocument_Subdocument-remove"><a href="#types_subdocument_Subdocument-remove">Subdocument#remove(<code>[options]</code>, <code>[callback]</code>)</a></h3><p>Null-out this subdoc</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback for compatibility with Document.prototype.remove</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Subdocument.prototype.remove = <span class="keyword">function</span>(options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  registerRemoveListener(<span class="keyword">this</span>);

  <span class="comment">// If removing entire doc, no need to remove subdoc</span>
  <span class="keyword">if</span> (!options || !options.noop) {
    <span class="keyword">this</span>.$parent.set(<span class="keyword">this</span>.$basePath, <span class="literal">null</span>);
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) {
    callback(<span class="literal">null</span>);
  }
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="types_subdocument_Subdocument-save"><a href="#types_subdocument_Subdocument-save">Subdocument#save(<code>[fn]</code>)</a></h3><p>Used as a stub for <a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3">hooks.js</a></p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>resolved Promise</span></li></ul></div><div class="description"><h4>NOTE:</h4>

<p><em>This is a no-op. Does not actually save the doc to the db.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Subdocument.prototype.save = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve) {
    fn &amp;&amp; fn();
    resolve();
  });
};

Subdocument.prototype.$isValid = <span class="keyword">function</span>(path) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$basePath) {
    <span class="keyword">return</span> <span class="keyword">this</span>.$parent.$isValid([<span class="keyword">this</span>.$basePath, path].join(<span class="string">'.'</span>));
  }
  <span class="keyword">return</span> Document.prototype.$isValid.call(<span class="keyword">this</span>, path);
};

Subdocument.prototype.markModified = <span class="keyword">function</span>(path) {
  Document.prototype.markModified.call(<span class="keyword">this</span>, path);
  <span class="keyword">if</span> (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$basePath) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.$parent.isDirectModified(<span class="keyword">this</span>.$basePath)) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>.$parent.markModified([<span class="keyword">this</span>.$basePath, path].join(<span class="string">'.'</span>), <span class="keyword">this</span>);
  }
};

Subdocument.prototype.$markValid = <span class="keyword">function</span>(path) {
  Document.prototype.$markValid.call(<span class="keyword">this</span>, path);
  <span class="keyword">if</span> (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$basePath) {
    <span class="keyword">this</span>.$parent.$markValid([<span class="keyword">this</span>.$basePath, path].join(<span class="string">'.'</span>));
  }
};

Subdocument.prototype.invalidate = <span class="keyword">function</span>(path, err, val) {
  <span class="comment">// Hack: array subdocuments' validationError is equal to the owner doc's,</span>
  <span class="comment">// so validating an array subdoc gives the top-level doc back. Temporary</span>
  <span class="comment">// workaround for #5208 so we don't have circular errors.</span>
  <span class="keyword">if</span> (err !== <span class="keyword">this</span>.ownerDocument().$__.validationError) {
    Document.prototype.invalidate.call(<span class="keyword">this</span>, path, err, val);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$basePath) {
    <span class="keyword">this</span>.$parent.invalidate([<span class="keyword">this</span>.$basePath, path].join(<span class="string">'.'</span>), err, val);
  } <span class="keyword">else</span> <span class="keyword">if</span> (err.kind === <span class="string">'cast'</span> || err.name === <span class="string">'CastError'</span>) {
    <span class="keyword">throw</span> err;
  }
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_subdocument_Subdocument"><a href="#types_subdocument_Subdocument">Subdocument()</a></h3><p>Subdocument constructor.</p><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#document_Document">Document</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Subdocument</span><span class="params">(value, fields, parent, skipId, options)</span> {</span>
  <span class="keyword">this</span>.$isSingleNested = <span class="literal">true</span>;
  Document.call(<span class="keyword">this</span>, value, fields, skipId, options);
}

Subdocument.prototype = Object.create(Document.prototype);

Subdocument.prototype.toBSON = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.toObject({
    transform: <span class="literal">false</span>,
    virtuals: <span class="literal">false</span>,
    _skipDepopulateTopLevel: <span class="literal">true</span>,
    depopulate: <span class="literal">true</span>,
    flattenDecimals: <span class="literal">false</span>
  });
};</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/embedded.js" id="types-embedded-js">types/embedded.js</a><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-%24__fullPath"><a href="#types_embedded_EmbeddedDocument-%24__fullPath">EmbeddedDocument#$__fullPath(<code>[path]</code>)</a></h3><p>Returns the full path to this document. If optional <code>path</code> is passed, it is appended to the full path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument"><a href="#types_embedded_EmbeddedDocument">EmbeddedDocument(<code>obj</code>, <code>parentArr</code>, <code>skipId</code>)</a></h3><p>EmbeddedDocument constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>js object returned from the db</span></li><li><code>parentArr</code><span class="types"> &lt;<a href="#types_documentarray_MongooseDocumentArray">MongooseDocumentArray</a>&gt; </span><span>the parent array of this document</span></li><li><code>skipId</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#document_Document">Document</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">EmbeddedDocument</span><span class="params">(obj, parentArr, skipId, fields, index)</span> {</span>
  <span class="keyword">if</span> (parentArr) {
    <span class="keyword">this</span>.__parentArray = parentArr;
    <span class="keyword">this</span>.__parent = parentArr._parent;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.__parentArray = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.__parent = <span class="literal">undefined</span>;
  }
  <span class="keyword">this</span>.__index = index;

  Document.call(<span class="keyword">this</span>, obj, fields, skipId);

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">this</span>.on(<span class="string">'isNew'</span>, <span class="keyword">function</span>(val) {
    _<span class="keyword">this</span>.isNew = val;
  });

  _<span class="keyword">this</span>.on(<span class="string">'save'</span>, <span class="keyword">function</span>() {
    _<span class="keyword">this</span>.constructor.emit(<span class="string">'save'</span>, _<span class="keyword">this</span>);
  });
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-inspect"><a href="#types_embedded_EmbeddedDocument-inspect">EmbeddedDocument#inspect()</a></h3><p>Helper for console.log</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.inspect = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.toObject({
    transform: <span class="literal">false</span>,
    retainKeyOrder: <span class="literal">true</span>,
    virtuals: <span class="literal">false</span>,
    flattenDecimals: <span class="literal">false</span>
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-invalidate"><a href="#types_embedded_EmbeddedDocument-invalidate">EmbeddedDocument#invalidate(<code>path</code>, <code>err</code>)</a></h3><p>Marks a path as invalid, causing validation to fail.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to invalidate</span></li><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>error which states the reason <code>path</code> was invalid</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.invalidate = <span class="keyword">function</span>(path, err, val, first) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parent) {
    Document.prototype.invalidate.call(<span class="keyword">this</span>, path, err, val);
    <span class="keyword">if</span> (err.$isValidatorError) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">throw</span> err;
  }

  <span class="keyword">var</span> index = <span class="keyword">this</span>.__index;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> index !== <span class="string">'undefined'</span>) {
    <span class="keyword">var</span> parentPath = <span class="keyword">this</span>.__parentArray._path;
    <span class="keyword">var</span> fullPath = [parentPath, index, path].join(<span class="string">'.'</span>);
    <span class="keyword">this</span>.__parent.invalidate(fullPath, err, val);
  }

  <span class="keyword">if</span> (first) {
    <span class="keyword">this</span>.$__.validationError = <span class="keyword">this</span>.ownerDocument().$__.validationError;
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-ownerDocument"><a href="#types_embedded_EmbeddedDocument-ownerDocument">EmbeddedDocument#ownerDocument()</a></h3><p>Returns the top level document of this sub-document.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.ownerDocument = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.ownerDocument) {
    <span class="keyword">return</span> <span class="keyword">this</span>.$__.ownerDocument;
  }

  <span class="keyword">var</span> parent = <span class="keyword">this</span>.__parent;
  <span class="keyword">if</span> (!parent) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">while</span> (parent.__parent || parent.$parent) {
    parent = parent.__parent || parent.$parent;
  }

  <span class="keyword">this</span>.$__.ownerDocument = parent;
  <span class="keyword">return</span> <span class="keyword">this</span>.$__.ownerDocument;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-parent"><a href="#types_embedded_EmbeddedDocument-parent">EmbeddedDocument#parent()</a></h3><p>Returns this sub-documents parent document.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.parent = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.__parent;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-parentArray"><a href="#types_embedded_EmbeddedDocument-parentArray">EmbeddedDocument#parentArray()</a></h3><p>Returns this sub-documents parent array.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.parentArray = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.__parentArray;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="types_embedded_EmbeddedDocument-remove"><a href="#types_embedded_EmbeddedDocument-remove">EmbeddedDocument#remove(<code>[options]</code>, <code>[fn]</code>)</a></h3><p>Removes the subdocument from its parent array.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.remove = <span class="keyword">function</span>(options, fn) {
  <span class="keyword">if</span> ( <span class="keyword">typeof</span> options === <span class="string">'function'</span> &amp;&amp; !fn ) {
    fn = options;
    options = <span class="literal">undefined</span>;
  }
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parentArray || (options &amp;&amp; options.noop)) {
    fn &amp;&amp; fn(<span class="literal">null</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> _id;
  <span class="keyword">if</span> (!<span class="keyword">this</span>.willRemove) {
    _id = <span class="keyword">this</span>._doc._id;
    <span class="keyword">if</span> (!_id) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'For your own good, Mongoose does not know '</span> +
          <span class="string">'how to remove an EmbeddedDocument that has no _id'</span>);
    }
    <span class="keyword">this</span>.__parentArray.pull({_id: _id});
    <span class="keyword">this</span>.willRemove = <span class="literal">true</span>;
    registerRemoveListener(<span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (fn) {
    fn(<span class="literal">null</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-save"><a href="#types_embedded_EmbeddedDocument-save">EmbeddedDocument#save(<code>[fn]</code>)</a></h3><p>Used as a stub for <a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3">hooks.js</a></p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>resolved Promise</span></li></ul></div><div class="description"><h4>NOTE:</h4>

<p><em>This is a no-op. Does not actually save the doc to the db.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.save = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve) {
    fn &amp;&amp; fn();
    resolve();
  });
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="types_embedded_EmbeddedDocument-update"><a href="#types_embedded_EmbeddedDocument-update">EmbeddedDocument#update()</a></h3><p>Override #update method of parent documents.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.update = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The #update method is not available on EmbeddedDocuments'</span>);
};</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="types_embedded_EmbeddedDocument.%24isValid"><a href="#types_embedded_EmbeddedDocument.%24isValid">EmbeddedDocument.$isValid(<code>path</code>)</a></h3><p>Checks if a path is invalid</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to check</span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="types_embedded_EmbeddedDocument.%24markValid"><a href="#types_embedded_EmbeddedDocument.%24markValid">EmbeddedDocument.$markValid(<code>path</code>)</a></h3><p>Marks a path as valid, removing existing validation errors.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to mark as valid</span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="types_embedded_EmbeddedDocument.markModified"><a href="#types_embedded_EmbeddedDocument.markModified">EmbeddedDocument.markModified(<code>path</code>)</a></h3><p>Marks the embedded doc modified.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">EmbeddedDocument.prototype.markModified = <span class="keyword">function</span>(path) {
  <span class="keyword">this</span>.$__.activePaths.modify(path);
  <span class="keyword">if</span> (!<span class="keyword">this</span>.__parentArray) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
    <span class="comment">// Mark the WHOLE parent array as modified</span>
    <span class="comment">// if this is a new document (i.e., we are initializing</span>
    <span class="comment">// a document),</span>
    <span class="keyword">this</span>.__parentArray._markModified();
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.__parentArray._markModified(<span class="keyword">this</span>, path);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path which changed</span></li></ul></div><h4>Example:</h4>

<pre><code><span class="keyword">var</span> doc = blogpost.comments.id(hexstring);
doc.mixed.type = <span class="string">'changed'</span>;
doc.markModified(<span class="string">'mixed.type'</span>);</code></pre><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/types/buffer.js" id="types-buffer-js">types/buffer.js</a><div class="item method private"><h3 id="types_buffer_MongooseBuffer"><a href="#types_buffer_MongooseBuffer">MongooseBuffer(<code>value</code>, <code>encode</code>, <code>offset</code>)</a></h3><p>Mongoose Buffer constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li><li><code>encode</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>offset</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/buffer.html">Buffer</a></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bit.ly/f6CnZU">http://bit.ly/f6CnZU</a></li></ul></div><div class="description"><p>Values always have to be passed to the constructor to initialize.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseBuffer</span><span class="params">(value, encode, offset)</span> {</span>
  <span class="keyword">var</span> length = arguments.length;
  <span class="keyword">var</span> val;

  <span class="keyword">if</span> (length === <span class="number">0</span> || arguments[<span class="number">0</span>] === <span class="literal">null</span> || arguments[<span class="number">0</span>] === <span class="literal">undefined</span>) {
    val = <span class="number">0</span>;
  } <span class="keyword">else</span> {
    val = value;
  }

  <span class="keyword">var</span> encoding;
  <span class="keyword">var</span> path;
  <span class="keyword">var</span> doc;

  <span class="keyword">if</span> (Array.isArray(encode)) {
    <span class="comment">// internal casting</span>
    path = encode[<span class="number">0</span>];
    doc = encode[<span class="number">1</span>];
  } <span class="keyword">else</span> {
    encoding = encode;
  }

  <span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(val, encoding, offset);
  utils.decorate(buf, MongooseBuffer.mixin);
  buf.isMongooseBuffer = <span class="literal">true</span>;

  <span class="comment">// make sure these internal props don't show up in Object.keys()</span>
  Object.defineProperties(buf, {
    validators: {
      value: [],
      enumerable: <span class="literal">false</span>
    },
    _path: {
      value: path,
      enumerable: <span class="literal">false</span>
    },
    _parent: {
      value: doc,
      enumerable: <span class="literal">false</span>
    }
  });

  <span class="keyword">if</span> (doc &amp;&amp; <span class="keyword">typeof</span> path === <span class="string">'string'</span>) {
    Object.defineProperty(buf, <span class="string">'_schema'</span>, {
      value: doc.schema.path(path)
    });
  }

  buf._subtype = <span class="number">0</span>;
  <span class="keyword">return</span> buf;
}</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="types_buffer_MongooseBuffer._markModified"><a href="#types_buffer_MongooseBuffer._markModified">MongooseBuffer._markModified()</a></h3><p>Marks this buffer as modified.</p><hr class="private"></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.copy"><a href="#types_buffer_MongooseBuffer.copy">MongooseBuffer.copy(<code>target</code>)</a></h3><p>Copies the buffer.</p><div class="params"><h4>Parameters:</h4><ul><li><code>target</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>The number of bytes copied.</span></li></ul></div><h4>Note:</h4>

<p><code>Buffer#copy</code> does not mark <code>target</code> as modified so you must copy from a <code>MongooseBuffer</code> for it to work as expected. This is a work around since <code>copy</code> modifies the target, not this.</p><hr class=""></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.equals"><a href="#types_buffer_MongooseBuffer.equals">MongooseBuffer.equals(<code>other</code>)</a></h3><p>Determines if this buffer is equals to <code>other</code> buffer</p><div class="params"><h4>Parameters:</h4><ul><li><code>other</code><span class="types"> &lt;<a href="http://nodejs.org/api/buffer.html">Buffer</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.subtype"><a href="#types_buffer_MongooseBuffer.subtype">MongooseBuffer.subtype(<code>subtype</code>)</a></h3><p>Sets the subtype option and marks the buffer modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>subtype</code><span class="types"> &lt;<a href="#Hex">Hex</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bsonspec.org/#/specification">http://bsonspec.org/#/specification</a></li></ul></div><h4>SubTypes:</h4>

<p>var bson = require('bson')<br />  bson.BSON_BINARY_SUBTYPE_DEFAULT<br />  bson.BSON_BINARY_SUBTYPE_FUNCTION<br />  bson.BSON_BINARY_SUBTYPE_BYTE_ARRAY<br />  bson.BSON_BINARY_SUBTYPE_UUID<br />  bson.BSON_BINARY_SUBTYPE_MD5<br />  bson.BSON_BINARY_SUBTYPE_USER_DEFINED</p>

<p>doc.buffer.subtype(bson.BSON_BINARY_SUBTYPE_UUID);</p><hr class=""></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.toBSON"><a href="#types_buffer_MongooseBuffer.toBSON">MongooseBuffer.toBSON()</a></h3><p>Converts this buffer for storage in MongoDB, including subtype</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://github.com/mongodb/js-bson/blob/master/lib/bson/binary.js">Binary</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.toObject"><a href="#types_buffer_MongooseBuffer.toObject">MongooseBuffer.toObject(<code>[subtype]</code>)</a></h3><p>Converts this buffer to its Binary type representation.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[subtype]</code><span class="types"> &lt;<a href="#Hex">Hex</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://github.com/mongodb/js-bson/blob/master/lib/bson/binary.js">Binary</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://bsonspec.org/#/specification">http://bsonspec.org/#/specification</a></li></ul></div><h4>SubTypes:</h4>

<p>var bson = require('bson')<br />  bson.BSON_BINARY_SUBTYPE_DEFAULT<br />  bson.BSON_BINARY_SUBTYPE_FUNCTION<br />  bson.BSON_BINARY_SUBTYPE_BYTE_ARRAY<br />  bson.BSON_BINARY_SUBTYPE_UUID<br />  bson.BSON_BINARY_SUBTYPE_MD5<br />  bson.BSON_BINARY_SUBTYPE_USER_DEFINED</p>

<p>doc.buffer.toObject(bson.BSON_BINARY_SUBTYPE_USER_DEFINED);</p><hr class=""></div><div class="item static public"><h3 id="types_buffer_MongooseBuffer.write"><a href="#types_buffer_MongooseBuffer.write">MongooseBuffer.write()</a></h3><p>Writes the buffer.</p><hr class=""></div><div class="item property private"><h3 id="types_buffer_MongooseBuffer-_parent"><a href="#types_buffer_MongooseBuffer-_parent">MongooseBuffer#<span>_parent</span></a></h3><p>Parent owner document</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_parent: <span class="literal">undefined</span>,</code></pre></div><hr class="private"></div><div class="item property private"><h3 id="types_buffer_MongooseBuffer-_subtype"><a href="#types_buffer_MongooseBuffer-_subtype">MongooseBuffer#<span>_subtype</span></a></h3><p>Default subtype for the Binary representing this Buffer</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">_subtype: <span class="literal">undefined</span>,</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/document_provider.js" id="document_provider-js">document_provider.js</a><div class="item static private"><h3 id="document_provider_module.exports"><a href="#document_provider_module.exports">module.exports()</a></h3><p>Returns the Document constructor for the current context</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (isBrowser) {
    <span class="keyword">return</span> BrowserDocument;
  }
  <span class="keyword">return</span> Document;
};</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/cast.js" id="cast-js">cast.js</a><div class="item static private"><h3 id="cast_module.exports"><a href="#cast_module.exports">module.exports(<code>schema</code>, <code>obj</code>, <code>options</code>, <code>context</code>)</a></h3><p>Handles internal casting for query filters.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = <span class="function"><span class="keyword">function</span> <span class="title">cast</span><span class="params">(schema, obj, options, context)</span> {</span>
  <span class="keyword">if</span> (Array.isArray(obj)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Query filter must be an object, got an array '</span>, util.inspect(obj));
  }

  <span class="keyword">var</span> paths = Object.keys(obj);
  <span class="keyword">var</span> i = paths.length;
  <span class="keyword">var</span> _keys;
  <span class="keyword">var</span> any$conditionals;
  <span class="keyword">var</span> schematype;
  <span class="keyword">var</span> nested;
  <span class="keyword">var</span> path;
  <span class="keyword">var</span> type;
  <span class="keyword">var</span> val;

  <span class="keyword">while</span> (i--) {
    path = paths[i];
    val = obj[path];

    <span class="keyword">if</span> (path === <span class="string">'$or'</span> || path === <span class="string">'$nor'</span> || path === <span class="string">'$and'</span>) {
      <span class="keyword">var</span> k = val.length;

      <span class="keyword">while</span> (k--) {
        val[k] = cast(schema, val[k], options, context);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">'$where'</span>) {
      type = <span class="keyword">typeof</span> val;

      <span class="keyword">if</span> (type !== <span class="string">'string'</span> &amp;&amp; type !== <span class="string">'function'</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Must have a string or function for $where'</span>);
      }

      <span class="keyword">if</span> (type === <span class="string">'function'</span>) {
        obj[path] = val.toString();
      }

      <span class="keyword">continue</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">'$elemMatch'</span>) {
      val = cast(schema, val, options, context);
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (!schema) {
        <span class="comment">// no casting for Mixed types</span>
        <span class="keyword">continue</span>;
      }

      schematype = schema.path(path);

      <span class="keyword">if</span> (!schematype) {
        <span class="comment">// Handle potential embedded array queries</span>
        <span class="keyword">var</span> split = path.split(<span class="string">'.'</span>),
            j = split.length,
            pathFirstHalf,
            pathLastHalf,
            remainingConds;

        <span class="comment">// Find the part of the var path that is a path of the Schema</span>
        <span class="keyword">while</span> (j--) {
          pathFirstHalf = split.slice(<span class="number">0</span>, j).join(<span class="string">'.'</span>);
          schematype = schema.path(pathFirstHalf);
          <span class="keyword">if</span> (schematype) {
            <span class="keyword">break</span>;
          }
        }

        <span class="comment">// If a substring of the input path resolves to an actual real path...</span>
        <span class="keyword">if</span> (schematype) {
          <span class="comment">// Apply the casting; similar code for $elemMatch in schema/array.js</span>
          <span class="keyword">if</span> (schematype.caster &amp;&amp; schematype.caster.schema) {
            remainingConds = {};
            pathLastHalf = split.slice(j).join(<span class="string">'.'</span>);
            remainingConds[pathLastHalf] = val;
            obj[path] = cast(schematype.caster.schema, remainingConds, options, context)[pathLastHalf];
          } <span class="keyword">else</span> {
            obj[path] = val;
          }
          <span class="keyword">continue</span>;
        }

        <span class="keyword">if</span> (utils.isObject(val)) {
          <span class="comment">// handle geo schemas that use object notation</span>
          <span class="comment">// { loc: { long: Number, lat: Number }</span>

          <span class="keyword">var</span> geo = <span class="string">''</span>;
          <span class="keyword">if</span> (val.$near) {
            geo = <span class="string">'$near'</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (val.$nearSphere) {
            geo = <span class="string">'$nearSphere'</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (val.$within) {
            geo = <span class="string">'$within'</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (val.$geoIntersects) {
            geo = <span class="string">'$geoIntersects'</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (val.$geoWithin) {
            geo = <span class="string">'$geoWithin'</span>;
          }

          <span class="keyword">if</span> (geo) {
            <span class="keyword">var</span> numbertype = <span class="keyword">new</span> Types.Number(<span class="string">'__QueryCasting__'</span>);
            <span class="keyword">var</span> value = val[geo];

            <span class="keyword">if</span> (val.$maxDistance != <span class="literal">null</span>) {
              val.$maxDistance = numbertype.castForQueryWrapper({
                val: val.$maxDistance,
                context: context
              });
            }
            <span class="keyword">if</span> (val.$minDistance != <span class="literal">null</span>) {
              val.$minDistance = numbertype.castForQueryWrapper({
                val: val.$minDistance,
                context: context
              });
            }

            <span class="keyword">if</span> (geo === <span class="string">'$within'</span>) {
              <span class="keyword">var</span> withinType = value.$center
                  || value.$centerSphere
                  || value.$box
                  || value.$polygon;

              <span class="keyword">if</span> (!withinType) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Bad $within paramater: '</span> + JSON.stringify(val));
              }

              value = withinType;
            } <span class="keyword">else</span> <span class="keyword">if</span> (geo === <span class="string">'$near'</span> &amp;&amp;
                <span class="keyword">typeof</span> value.type === <span class="string">'string'</span> &amp;&amp; Array.isArray(value.coordinates)) {
              <span class="comment">// geojson; cast the coordinates</span>
              value = value.coordinates;
            } <span class="keyword">else</span> <span class="keyword">if</span> ((geo === <span class="string">'$near'</span> || geo === <span class="string">'$nearSphere'</span> || geo === <span class="string">'$geoIntersects'</span>) &amp;&amp;
                value.$geometry &amp;&amp; <span class="keyword">typeof</span> value.$geometry.type === <span class="string">'string'</span> &amp;&amp;
                Array.isArray(value.$geometry.coordinates)) {
              <span class="keyword">if</span> (value.$maxDistance != <span class="literal">null</span>) {
                value.$maxDistance = numbertype.castForQueryWrapper({
                  val: value.$maxDistance,
                  context: context
                });
              }
              <span class="keyword">if</span> (value.$minDistance != <span class="literal">null</span>) {
                value.$minDistance = numbertype.castForQueryWrapper({
                  val: value.$minDistance,
                  context: context
                });
              }
              <span class="keyword">if</span> (utils.isMongooseObject(value.$geometry)) {
                value.$geometry = value.$geometry.toObject({
                  transform: <span class="literal">false</span>,
                  virtuals: <span class="literal">false</span>
                });
              }
              value = value.$geometry.coordinates;
            } <span class="keyword">else</span> <span class="keyword">if</span> (geo === <span class="string">'$geoWithin'</span>) {
              <span class="keyword">if</span> (value.$geometry) {
                <span class="keyword">if</span> (utils.isMongooseObject(value.$geometry)) {
                  value.$geometry = value.$geometry.toObject({ virtuals: <span class="literal">false</span> });
                }
                <span class="keyword">var</span> geoWithinType = value.$geometry.type;
                <span class="keyword">if</span> (ALLOWED_GEOWITHIN_GEOJSON_TYPES.indexOf(geoWithinType) === -<span class="number">1</span>) {
                  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid geoJSON type for $geoWithin "'</span> +
                    geoWithinType + <span class="string">'", must be "Polygon" or "MultiPolygon"'</span>);
                }
                value = value.$geometry.coordinates;
              } <span class="keyword">else</span> {
                value = value.$box || value.$polygon || value.$center ||
                  value.$centerSphere;
                <span class="keyword">if</span> (utils.isMongooseObject(value)) {
                  value = value.toObject({ virtuals: <span class="literal">false</span> });
                }
              }
            }

            _cast(value, numbertype, context);
            <span class="keyword">continue</span>;
          }
        }

        <span class="keyword">if</span> (options &amp;&amp; options.upsert &amp;&amp; options.strict &amp;&amp; !schema.nested[path]) {
          <span class="keyword">if</span> (options.strict === <span class="string">'throw'</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> StrictModeError(path);
          }
          <span class="keyword">throw</span> <span class="keyword">new</span> StrictModeError(path, <span class="string">'Path "'</span> + path + <span class="string">'" is not in '</span> +
            <span class="string">'schema, strict mode is `true`, and upsert is `true`.'</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (options &amp;&amp; options.strictQuery === <span class="string">'throw'</span>) {
          <span class="keyword">throw</span> <span class="keyword">new</span> StrictModeError(path, <span class="string">'Path "'</span> + path + <span class="string">'" is not in '</span> +
            <span class="string">'schema and strictQuery is true.'</span>);
        }
      } <span class="keyword">else</span> <span class="keyword">if</span> (val === <span class="literal">null</span> || val === <span class="literal">undefined</span>) {
        obj[path] = <span class="literal">null</span>;
        <span class="keyword">continue</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (val.constructor.name === <span class="string">'Object'</span>) {
        any$conditionals = Object.keys(val).some(<span class="keyword">function</span>(k) {
          <span class="keyword">return</span> k.charAt(<span class="number">0</span>) === <span class="string">'$'</span> &amp;&amp; k !== <span class="string">'$id'</span> &amp;&amp; k !== <span class="string">'$ref'</span>;
        });

        <span class="keyword">if</span> (!any$conditionals) {
          obj[path] = schematype.castForQueryWrapper({
            val: val,
            context: context
          });
        } <span class="keyword">else</span> {
          <span class="keyword">var</span> ks = Object.keys(val),
              $cond;

          k = ks.length;

          <span class="keyword">while</span> (k--) {
            $cond = ks[k];
            nested = val[$cond];

            <span class="keyword">if</span> ($cond === <span class="string">'$not'</span>) {
              <span class="keyword">if</span> (nested &amp;&amp; schematype &amp;&amp; !schematype.caster) {
                _keys = Object.keys(nested);
                <span class="keyword">if</span> (_keys.length &amp;&amp; _keys[<span class="number">0</span>].charAt(<span class="number">0</span>) === <span class="string">'$'</span>) {
                  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> nested) {
                    nested[key] = schematype.castForQueryWrapper({
                      $conditional: key,
                      val: nested[key],
                      context: context
                    });
                  }
                } <span class="keyword">else</span> {
                  val[$cond] = schematype.castForQueryWrapper({
                    $conditional: $cond,
                    val: nested,
                    context: context
                  });
                }
                <span class="keyword">continue</span>;
              }
              cast(schematype.caster ? schematype.caster.schema : schema, nested, options, context);
            } <span class="keyword">else</span> {
              val[$cond] = schematype.castForQueryWrapper({
                $conditional: $cond,
                val: nested,
                context: context
              });
            }
          }
        }
      } <span class="keyword">else</span> <span class="keyword">if</span> (Array.isArray(val) &amp;&amp; [<span class="string">'Buffer'</span>, <span class="string">'Array'</span>].indexOf(schematype.instance) === -<span class="number">1</span>) {
        <span class="keyword">var</span> casted = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> valIndex = <span class="number">0</span>; valIndex &lt; val.length; valIndex++) {
          casted.push(schematype.castForQueryWrapper({
            val: val[valIndex],
            context: context
          }));
        }

        obj[path] = { $<span class="keyword">in</span>: casted };
      } <span class="keyword">else</span> {
        obj[path] = schematype.castForQueryWrapper({
          val: val,
          context: context
        });
      }
    }
  }

  <span class="keyword">return</span> obj;
};

<span class="function"><span class="keyword">function</span> <span class="title">_cast</span><span class="params">(val, numbertype, context)</span> {</span>
  <span class="keyword">if</span> (Array.isArray(val)) {
    val.forEach(<span class="keyword">function</span>(item, i) {
      <span class="keyword">if</span> (Array.isArray(item) || utils.isObject(item)) {
        <span class="keyword">return</span> _cast(item, numbertype, context);
      }
      val[i] = numbertype.castForQueryWrapper({ val: item, context: context });
    });
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> nearKeys = Object.keys(val);
    <span class="keyword">var</span> nearLen = nearKeys.length;
    <span class="keyword">while</span> (nearLen--) {
      <span class="keyword">var</span> nkey = nearKeys[nearLen];
      <span class="keyword">var</span> item = val[nkey];
      <span class="keyword">if</span> (Array.isArray(item) || utils.isObject(item)) {
        _cast(item, numbertype, context);
        val[nkey] = item;
      } <span class="keyword">else</span> {
        val[nkey] = numbertype.castForQuery({ val: item, context: context });
      }
    }
  }
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Object to cast</span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the query options</span></li><li><code>context</code><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>passed to setters</span></li></ul></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/document.js" id="document-js">document.js</a><div class="item method private"><h3 id="document_Document-%24__buildDoc"><a href="#document_Document-%24__buildDoc">Document#$__buildDoc(<code>obj</code>, <code>[fields]</code>, <code>[skipId]</code>)</a></h3><p>Builds the default doc structure</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[skipId]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__dirty"><a href="#document_Document-%24__dirty">Document#$__dirty()</a></h3><p>Returns this documents dirty paths / vals.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__fullPath"><a href="#document_Document-%24__fullPath">Document#$__fullPath(<code>[path]</code>)</a></h3><p>Returns the full path to this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__getAllSubdocs"><a href="#document_Document-%24__getAllSubdocs">Document#$__getAllSubdocs()</a></h3><p>Get all subdocs (by bfs)</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__getArrayPathsToValidate"><a href="#document_Document-%24__getArrayPathsToValidate">Document#$__getArrayPathsToValidate()</a></h3><p>Get active path that were changed and are arrays</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__path"><a href="#document_Document-%24__path">Document#$__path(<code>path</code>)</a></h3><p>Returns the schematype for the given <code>path</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__reset"><a href="#document_Document-%24__reset">Document#$__reset()</a></h3><p>Resets the internal modified state of this document.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__set"><a href="#document_Document-%24__set">Document#$__set()</a></h3><p>Handles the actual setting of the value and marking the path modified if appropriate.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__setSchema"><a href="#document_Document-%24__setSchema">Document#$__setSchema(<code>schema</code>)</a></h3><p>Assigns/compiles <code>schema</code> into this documents prototype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="document_Document-%24__shouldModify"><a href="#document_Document-%24__shouldModify">Document#$__shouldModify()</a></h3><p>Determine if we should mark this change as modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-%24ignore"><a href="#document_Document-%24ignore">Document#$ignore(<code>path</code>)</a></h3><p>Don't run validation on this path or persist changes to this path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to ignore</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>doc.foo = <span class="literal">null</span>;
doc.$ignore(<span class="string">'foo'</span>);
doc.save() <span class="comment">// changes to foo will not be persisted and validators won't be run</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-%24isDefault"><a href="#document_Document-%24isDefault">Document#$isDefault(<code>[path]</code>)</a></h3><p>Checks if a path is set to its default.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>MyModel = mongoose.model(<span class="string">'test'</span>, { name: { type: String, <span class="keyword">default</span>: <span class="string">'Val '</span>} });
<span class="keyword">var</span> m = <span class="keyword">new</span> MyModel();
m.$isDefault(<span class="string">'name'</span>); <span class="comment">// true</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24isDeleted"><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24isDeleted">function Object() { [native code] }#$isDeleted(<code>[val]</code>)</a></h3><p>Getter/setter, determines whether the document was removed or not.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[val]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>optional, overrides whether mongoose thinks the doc is deleted</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether mongoose thinks this doc is deleted.</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>product.remove(<span class="function"><span class="keyword">function</span> <span class="params">(err, product)</span> {</span>
  product.isDeleted(); <span class="comment">// true</span>
  product.remove(); <span class="comment">// no-op, doesn't send anything to the db</span>

  product.isDeleted(<span class="literal">false</span>);
  product.isDeleted(); <span class="comment">// false</span>
  product.remove(); <span class="comment">// will execute a remove against the db</span>
})</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24set"><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24set">function Object() { [native code] }#$set(<code>path</code>, <code>val</code>, <code>[type]</code>, <code>[options]</code>)</a></h3><p>Alias for <code>set()</code>, used internally to avoid conflicts</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>path or object of key/vals to set</span></li><li><code>val</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span>the value to set</span></li><li><code>[type]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="#*">*</a>&gt; </span><span>optionally specify a type for &quot;on-the-fly&quot; attributes</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optionally specify options that modify the behavior of the set</span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method private"><h3 id="document_Document-%24toObject"><a href="#document_Document-%24toObject">Document#$toObject()</a></h3><p>Internal helper for toObject() and toJSON() that doesn't manipulate options</p><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-depopulate"><a href="#document_Document-depopulate">Document#depopulate(<code>path</code>)</a></h3><p>Takes a populated field and returns it to its unpopulated state.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#document_Document-populate" title="Document.populate">Document.populate</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.findOne().populate(<span class="string">'author'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  console.log(doc.author.name); <span class="comment">// Dr.Seuss</span>
  console.log(doc.depopulate(<span class="string">'author'</span>));
  console.log(doc.author); <span class="comment">// '5144cf8050f071d979c118a7'</span>
})</code></pre>

<p>If the path was not populated, this is a no-op.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.depopulate = <span class="keyword">function</span>(path) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) {
    path = path.split(<span class="string">' '</span>);
  }
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; path.length; i++) {
    <span class="keyword">var</span> populatedIds = <span class="keyword">this</span>.populated(path[i]);
    <span class="keyword">if</span> (!populatedIds) {
      <span class="keyword">continue</span>;
    }
    <span class="keyword">delete</span> <span class="keyword">this</span>.$__.populated[path[i]];
    <span class="keyword">this</span>.$set(path[i], populatedIds);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="document_Document"><a href="#document_Document">Document(<code>obj</code>, <code>[fields]</code>, <code>[skipId]</code>)</a></h3><p>Document constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the values to set</span></li><li><code>[fields]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional object containing the fields which were selected in the query returning this document and any populated paths data</span></li><li><code>[skipId]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>bool, should we auto create an ObjectId _id</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/events.html#events_class_events_eventemitter" title="NodeJS EventEmitter">NodeJS EventEmitter</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>init</code>: Emitted on a document after it has was retreived from the db and fully hydrated by Mongoose.</p></li><li><p><code>save</code>: Emitted when the document is successfully saved</p></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Document</span><span class="params">(obj, fields, skipId, options)</span> {</span>
  <span class="keyword">this</span>.$__ = <span class="keyword">new</span> InternalCache;
  <span class="keyword">this</span>.$__.emitter = <span class="keyword">new</span> EventEmitter();
  <span class="keyword">this</span>.isNew = <span class="literal">true</span>;
  <span class="keyword">this</span>.errors = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.$__.$options = options || {};

  <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> obj !== <span class="string">'object'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> ObjectParameterError(obj, <span class="string">'obj'</span>, <span class="string">'Document'</span>);
  }

  <span class="keyword">var</span> schema = <span class="keyword">this</span>.schema;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">'boolean'</span>) {
    <span class="keyword">this</span>.$__.strictMode = fields;
    fields = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.$__.strictMode = schema.options &amp;&amp; schema.options.strict;
    <span class="keyword">this</span>.$__.selected = fields;
  }

  <span class="keyword">var</span> required = schema.requiredPaths(<span class="literal">true</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; required.length; ++i) {
    <span class="keyword">this</span>.$__.activePaths.require(required[i]);
  }

  <span class="keyword">this</span>.$__.emitter.setMaxListeners(<span class="number">0</span>);
  <span class="keyword">this</span>._doc = <span class="keyword">this</span>.$__buildDoc(obj, fields, skipId);

  <span class="keyword">if</span> (obj) {
    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Document) {
      <span class="keyword">this</span>.isNew = obj.isNew;
    }
    <span class="comment">// Skip set hooks</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.$__original_set) {
      <span class="keyword">this</span>.$__original_set(obj, <span class="literal">undefined</span>, <span class="literal">true</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.$set(obj, <span class="literal">undefined</span>, <span class="literal">true</span>);
    }
  }

  <span class="keyword">this</span>.$__._id = <span class="keyword">this</span>._id;

  <span class="keyword">if</span> (!schema.options.strict &amp;&amp; obj) {
    <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>,
        keys = Object.keys(<span class="keyword">this</span>._doc);

    keys.forEach(<span class="keyword">function</span>(key) {
      <span class="keyword">if</span> (!(key <span class="keyword">in</span> schema.tree)) {
        defineKey(key, <span class="literal">null</span>, _<span class="keyword">this</span>);
      }
    });
  }

  applyQueue(<span class="keyword">this</span>);
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-equals"><a href="#document_Document-equals">Document#equals(<code>doc</code>)</a></h3><p>Returns true if the Document stores the same data as doc.</p><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>a document to compare</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Documents are considered equal when they have matching <code>_id</code>s, unless neither<br />document has an <code>_id</code>, in which case this function falls back to using<br /><code>deepEqual()</code>.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.equals = <span class="keyword">function</span>(doc) {
  <span class="keyword">if</span> (!doc) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">var</span> tid = <span class="keyword">this</span>.get(<span class="string">'_id'</span>);
  <span class="keyword">var</span> docid = doc.get ? doc.get(<span class="string">'_id'</span>) : doc;
  <span class="keyword">if</span> (!tid &amp;&amp; !docid) {
    <span class="keyword">return</span> deepEqual(<span class="keyword">this</span>, doc);
  }
  <span class="keyword">return</span> tid &amp;&amp; tid.equals
      ? tid.equals(docid)
      : tid === docid;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-execPopulate"><a href="#document_Document-execPopulate">Document#execPopulate()</a></h3><p>Explicitly executes population and returns a promise. Useful for ES2015<br />integration.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>promise that resolves to the document when population is done</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#document_Document-populate" title="Document.populate">Document.populate</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> promise = doc.
  populate(<span class="string">'company'</span>).
  populate({
    path: <span class="string">'notes'</span>,
    match: <span class="regexp">/airline/</span>,
    select: <span class="string">'text'</span>,
    model: <span class="string">'modelName'</span>
    options: opts
  }).
  execPopulate();

<span class="comment">// summary</span>
doc.execPopulate().then(resolve, reject);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.execPopulate = <span class="keyword">function</span>() {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    _<span class="keyword">this</span>.populate(<span class="keyword">function</span>(error, res) {
      <span class="keyword">if</span> (error) {
        reject(error);
      } <span class="keyword">else</span> {
        resolve(res);
      }
    });
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-get"><a href="#document_Document-get">Document#get(<code>path</code>, <code>[type]</code>)</a></h3><p>Returns the value of a path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[type]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="#*">*</a>&gt; </span><span>optionally specify a type for on-the-fly attributes</span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// path</span>
doc.get(<span class="string">'age'</span>) <span class="comment">// 47</span>

<span class="comment">// dynamic casting to a string</span>
doc.get(<span class="string">'age'</span>, String) <span class="comment">// "47"</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.get = <span class="keyword">function</span>(path, type) {
  <span class="keyword">var</span> adhoc;
  <span class="keyword">if</span> (type) {
    adhoc = Schema.interpretAsType(path, type, <span class="keyword">this</span>.schema.options);
  }

  <span class="keyword">var</span> schema = <span class="keyword">this</span>.$__path(path) || <span class="keyword">this</span>.schema.virtualpath(path);
  <span class="keyword">var</span> pieces = path.split(<span class="string">'.'</span>);
  <span class="keyword">var</span> obj = <span class="keyword">this</span>._doc;

  <span class="keyword">if</span> (schema <span class="keyword">instanceof</span> VirtualType) {
    <span class="keyword">if</span> (schema.getters.length === <span class="number">0</span>) {
      <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
    }
    <span class="keyword">return</span> schema.applyGetters(<span class="literal">null</span>, <span class="keyword">this</span>);
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = pieces.length; i &lt; l; i++) {
    obj = obj === <span class="literal">null</span> || obj === <span class="keyword">void</span> <span class="number">0</span>
        ? <span class="literal">undefined</span>
        : obj[pieces[i]];
  }

  <span class="keyword">if</span> (adhoc) {
    obj = adhoc.cast(obj);
  }

  <span class="keyword">if</span> (schema) {
    obj = schema.applyGetters(obj, <span class="keyword">this</span>);
  }

  <span class="keyword">return</span> obj;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="document_Document-getValue"><a href="#document_Document-getValue">Document#getValue(<code>path</code>)</a></h3><p>Gets a raw value from a path (no getters)</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.getValue = <span class="keyword">function</span>(path) {
  <span class="keyword">return</span> utils.getValue(path, <span class="keyword">this</span>._doc);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-init"><a href="#document_Document-init">Document#init(<code>doc</code>, <code>fn</code>)</a></h3><p>Initializes the document without setters or marking anything modified.</p><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>document returned by mongo</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li></ul></div><div class="description"><p>Called internally after a document is returned from mongodb.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.init = <span class="keyword">function</span>(doc, opts, fn) {
  <span class="comment">// do not prefix this method with $__ since its</span>
  <span class="comment">// used by public hooks</span>

  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">'function'</span>) {
    fn = opts;
    opts = <span class="literal">null</span>;
  }

  <span class="keyword">this</span>.isNew = <span class="literal">false</span>;
  <span class="keyword">this</span>.$init = <span class="literal">true</span>;

  <span class="comment">// handle docs with populated paths</span>
  <span class="comment">// If doc._id is not null or undefined</span>
  <span class="keyword">if</span> (doc._id !== <span class="literal">null</span> &amp;&amp; doc._id !== <span class="literal">undefined</span> &amp;&amp;
    opts &amp;&amp; opts.populated &amp;&amp; opts.populated.length) {
    <span class="keyword">var</span> id = String(doc._id);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; opts.populated.length; ++i) {
      <span class="keyword">var</span> item = opts.populated[i];
      <span class="keyword">if</span> (item.isVirtual) {
        <span class="keyword">this</span>.populated(item.path, utils.getValue(item.path, doc), item);
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.populated(item.path, item._docs[id], item);
      }
    }
  }

  init(<span class="keyword">this</span>, doc, <span class="keyword">this</span>._doc);

  <span class="keyword">this</span>.emit(<span class="string">'init'</span>, <span class="keyword">this</span>);
  <span class="keyword">this</span>.constructor.emit(<span class="string">'init'</span>, <span class="keyword">this</span>);

  <span class="keyword">this</span>.$__._id = <span class="keyword">this</span>._id;

  <span class="keyword">if</span> (fn) {
    fn(<span class="literal">null</span>);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-inspect"><a href="#document_Document-inspect">Document#inspect()</a></h3><p>Helper for console.log</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.inspect = <span class="keyword">function</span>(options) {
  <span class="keyword">var</span> isPOJO = options &amp;&amp;
    utils.getFunctionName(options.constructor) === <span class="string">'Object'</span>;
  <span class="keyword">var</span> opts;
  <span class="keyword">if</span> (isPOJO) {
    opts = options;
    opts.minimize = <span class="literal">false</span>;
    opts.retainKeyOrder = <span class="literal">true</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.toObject(opts);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-invalidate"><a href="#document_Document-invalidate">Document#invalidate(<code>path</code>, <code>errorMsg</code>, <code>value</code>, <code>[kind]</code>)</a></h3><p>Marks a path as invalid, causing validation to fail.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to invalidate</span></li><li><code>errorMsg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>the error which states the reason <code>path</code> was invalid</span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, T&gt; </span><span>optional invalid value</span></li><li><code>[kind]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional <code>kind</code> property for the error</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#ValidationError">ValidationError</a>&gt; </span><span>the current ValidationError, with all currently invalidated paths</span></li></ul></div><div class="description"><p>The <code>errorMsg</code> argument will become the message of the <code>ValidationError</code>.</p>

<p>The <code>value</code> argument (if passed) will be available through the <code>ValidationError.value</code> property.</p>

<pre><code>doc.invalidate(<span class="string">'size'</span>, <span class="string">'must be less than 20'</span>, <span class="number">14</span>);

doc.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(err)
  <span class="comment">// prints</span>
  { message: <span class="string">'Validation failed'</span>,
    name: <span class="string">'ValidationError'</span>,
    errors:
     { size:
        { message: <span class="string">'must be less than 20'</span>,
          name: <span class="string">'ValidatorError'</span>,
          path: <span class="string">'size'</span>,
          type: <span class="string">'user defined'</span>,
          value: <span class="number">14</span> } } }
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.invalidate = <span class="keyword">function</span>(path, err, val, kind) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.$__.validationError) {
    <span class="keyword">this</span>.$__.validationError = <span class="keyword">new</span> ValidationError(<span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.validationError.errors[path]) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (!err || <span class="keyword">typeof</span> err === <span class="string">'string'</span>) {
    err = <span class="keyword">new</span> ValidatorError({
      path: path,
      message: err,
      type: kind || <span class="string">'user defined'</span>,
      value: val
    });
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.validationError === err) {
    <span class="keyword">return</span> <span class="keyword">this</span>.$__.validationError;
  }

  <span class="keyword">this</span>.$__.validationError.addError(path, err);
  <span class="keyword">return</span> <span class="keyword">this</span>.$__.validationError;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-isDirectModified"><a href="#document_Document-isDirectModified">Document#isDirectModified(<code>path</code>)</a></h3><p>Returns true if <code>path</code> was directly set and modified, else false.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>doc.set(<span class="string">'documents.0.title'</span>, <span class="string">'changed'</span>);
doc.isDirectModified(<span class="string">'documents.0.title'</span>) <span class="comment">// true</span>
doc.isDirectModified(<span class="string">'documents'</span>) <span class="comment">// false</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isDirectModified = <span class="keyword">function</span>(path) {
  <span class="keyword">return</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.$__.activePaths.states.modify);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-isDirectSelected"><a href="#document_Document-isDirectSelected">Document#isDirectSelected(<code>path</code>)</a></h3><p>Checks if <code>path</code> was explicitly selected. If no projection, always returns<br />true.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>Thing.findOne().select(<span class="string">'nested.name'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
   doc.isDirectSelected(<span class="string">'nested.name'</span>) <span class="comment">// true</span>
   doc.isDirectSelected(<span class="string">'nested.otherName'</span>) <span class="comment">// false</span>
   doc.isDirectSelected(<span class="string">'nested'</span>)  <span class="comment">// false</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isDirectSelected = <span class="function"><span class="keyword">function</span> <span class="title">isDirectSelected</span><span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.selected) {
    <span class="keyword">if</span> (path === <span class="string">'_id'</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>.$__.selected._id !== <span class="number">0</span>;
    }

    <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>.$__.selected);
    <span class="keyword">var</span> i = paths.length;
    <span class="keyword">var</span> inclusive = <span class="literal">null</span>;
    <span class="keyword">var</span> cur;

    <span class="keyword">if</span> (i === <span class="number">1</span> &amp;&amp; paths[<span class="number">0</span>] === <span class="string">'_id'</span>) {
      <span class="comment">// only _id was selected.</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.$__.selected._id === <span class="number">0</span>;
    }

    <span class="keyword">while</span> (i--) {
      cur = paths[i];
      <span class="keyword">if</span> (cur === <span class="string">'_id'</span>) {
        <span class="keyword">continue</span>;
      }
      <span class="keyword">if</span> (!isDefiningProjection(<span class="keyword">this</span>.$__.selected[cur])) {
        <span class="keyword">continue</span>;
      }
      inclusive = !!<span class="keyword">this</span>.$__.selected[cur];
      <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (inclusive === <span class="literal">null</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.$__.selected) {
      <span class="keyword">return</span> inclusive;
    }

    <span class="keyword">return</span> !inclusive;
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-isInit"><a href="#document_Document-isInit">Document#isInit(<code>path</code>)</a></h3><p>Checks if <code>path</code> was initialized.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isInit = <span class="keyword">function</span>(path) {
  <span class="keyword">return</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.$__.activePaths.states.init);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-isModified"><a href="#document_Document-isModified">Document#isModified(<code>[path]</code>)</a></h3><p>Returns true if this document was modified, else false.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><p>If <code>path</code> is given, checks if a path or any full path containing <code>path</code> as part of its path chain has been modified.</p>

<h4>Example</h4>

<pre><code>doc.set(<span class="string">'documents.0.title'</span>, <span class="string">'changed'</span>);
doc.isModified()                      <span class="comment">// true</span>
doc.isModified(<span class="string">'documents'</span>)           <span class="comment">// true</span>
doc.isModified(<span class="string">'documents.0.title'</span>)   <span class="comment">// true</span>
doc.isModified(<span class="string">'documents otherProp'</span>) <span class="comment">// true</span>
doc.isDirectModified(<span class="string">'documents'</span>)     <span class="comment">// false</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isModified = <span class="keyword">function</span>(paths) {
  <span class="keyword">if</span> (paths) {
    <span class="keyword">if</span> (!Array.isArray(paths)) {
      paths = paths.split(<span class="string">' '</span>);
    }
    <span class="keyword">var</span> modified = <span class="keyword">this</span>.modifiedPaths();
    <span class="keyword">var</span> directModifiedPaths = Object.keys(<span class="keyword">this</span>.$__.activePaths.states.modify);
    <span class="keyword">var</span> isModifiedChild = paths.some(<span class="keyword">function</span>(path) {
      <span class="keyword">return</span> !!~modified.indexOf(path);
    });
    <span class="keyword">return</span> isModifiedChild || paths.some(<span class="keyword">function</span>(path) {
      <span class="keyword">return</span> directModifiedPaths.some(<span class="keyword">function</span>(mod) {
        <span class="keyword">return</span> mod === path || path.indexOf(mod + <span class="string">'.'</span>) === <span class="number">0</span>;
      });
    });
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.$__.activePaths.some(<span class="string">'modify'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-isSelected"><a href="#document_Document-isSelected">Document#isSelected(<code>path</code>)</a></h3><p>Checks if <code>path</code> was selected in the source query which initialized this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>Thing.findOne().select(<span class="string">'name'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
   doc.isSelected(<span class="string">'name'</span>) <span class="comment">// true</span>
   doc.isSelected(<span class="string">'age'</span>)  <span class="comment">// false</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isSelected = <span class="function"><span class="keyword">function</span> <span class="title">isSelected</span><span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.selected) {
    <span class="keyword">if</span> (path === <span class="string">'_id'</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>.$__.selected._id !== <span class="number">0</span>;
    }

    <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>.$__.selected);
    <span class="keyword">var</span> i = paths.length;
    <span class="keyword">var</span> inclusive = <span class="literal">null</span>;
    <span class="keyword">var</span> cur;

    <span class="keyword">if</span> (i === <span class="number">1</span> &amp;&amp; paths[<span class="number">0</span>] === <span class="string">'_id'</span>) {
      <span class="comment">// only _id was selected.</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.$__.selected._id === <span class="number">0</span>;
    }

    <span class="keyword">while</span> (i--) {
      cur = paths[i];
      <span class="keyword">if</span> (cur === <span class="string">'_id'</span>) {
        <span class="keyword">continue</span>;
      }
      <span class="keyword">if</span> (!isDefiningProjection(<span class="keyword">this</span>.$__.selected[cur])) {
        <span class="keyword">continue</span>;
      }
      inclusive = !!<span class="keyword">this</span>.$__.selected[cur];
      <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (inclusive === <span class="literal">null</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.$__.selected) {
      <span class="keyword">return</span> inclusive;
    }

    i = paths.length;
    <span class="keyword">var</span> pathDot = path + <span class="string">'.'</span>;

    <span class="keyword">while</span> (i--) {
      cur = paths[i];
      <span class="keyword">if</span> (cur === <span class="string">'_id'</span>) {
        <span class="keyword">continue</span>;
      }

      <span class="keyword">if</span> (cur.indexOf(pathDot) === <span class="number">0</span>) {
        <span class="keyword">return</span> inclusive || cur !== pathDot;
      }

      <span class="keyword">if</span> (pathDot.indexOf(cur + <span class="string">'.'</span>) === <span class="number">0</span>) {
        <span class="keyword">return</span> inclusive;
      }
    }

    <span class="keyword">return</span> !inclusive;
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-markModified"><a href="#document_Document-markModified">Document#markModified(<code>path</code>, <code>[scope]</code>)</a></h3><p>Marks the path as having pending changes to write to the db.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to mark modified</span></li><li><code>[scope]</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>the scope to run validators with</span></li></ul></div><div class="description"><p><em>Very helpful when using <a href="schematypes.html#mixed">Mixed</a> types.</em></p>

<h4>Example:</h4>

<pre><code>doc.mixed.type = <span class="string">'changed'</span>;
doc.markModified(<span class="string">'mixed.type'</span>);
doc.save() <span class="comment">// changes to mixed.type are now persisted</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.markModified = <span class="keyword">function</span>(path, scope) {
  <span class="keyword">this</span>.$__.activePaths.modify(path);
  <span class="keyword">if</span> (scope != <span class="literal">null</span> &amp;&amp; !<span class="keyword">this</span>.ownerDocument) {
    <span class="keyword">this</span>.$__.pathsToScopes[path] = scope;
  }
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-modifiedPaths"><a href="#document_Document-modifiedPaths">Document#modifiedPaths()</a></h3><p>Returns the list of paths that have been modified.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.modifiedPaths = <span class="keyword">function</span>() {
  <span class="keyword">var</span> directModifiedPaths = Object.keys(<span class="keyword">this</span>.$__.activePaths.states.modify);
  <span class="keyword">return</span> directModifiedPaths.reduce(<span class="keyword">function</span>(list, path) {
    <span class="keyword">var</span> parts = path.split(<span class="string">'.'</span>);
    <span class="keyword">return</span> list.concat(parts.reduce(<span class="keyword">function</span>(chains, part, i) {
      <span class="keyword">return</span> chains.concat(parts.slice(<span class="number">0</span>, i).concat(part).join(<span class="string">'.'</span>));
    }, []).filter(<span class="keyword">function</span>(chain) {
      <span class="keyword">return</span> (list.indexOf(chain) === -<span class="number">1</span>);
    }));
  }, []);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-populate"><a href="#document_Document-populate">Document#populate(<code>[path]</code>, <code>[callback]</code>)</a></h3><p>Populates document references, executing the <code>callback</code> when complete.<br />If you want to use promises instead, use this function with<br /><a href="#document_Document-execPopulate"><code>execPopulate()</code></a></p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>The path to populate or an options object</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>When passed, population is invoked</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.populate" title="Model.populate">Model.populate</a></li><li><a href="#document_Document-execPopulate" title="Document.execPopulate">Document.execPopulate</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>doc
.populate(<span class="string">'company'</span>)
.populate({
  path: <span class="string">'notes'</span>,
  match: <span class="regexp">/airline/</span>,
  select: <span class="string">'text'</span>,
  model: <span class="string">'modelName'</span>
  options: opts
}, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> {</span>
  assert(doc._id === user._id) <span class="comment">// the document itself is passed</span>
})

<span class="comment">// summary</span>
doc.populate(path)                   <span class="comment">// not executed</span>
doc.populate(options);               <span class="comment">// not executed</span>
doc.populate(path, callback)         <span class="comment">// executed</span>
doc.populate(options, callback);     <span class="comment">// executed</span>
doc.populate(callback);              <span class="comment">// executed</span>
doc.populate(options).execPopulate() <span class="comment">// executed, returns promise</span></code></pre>

<h4>NOTE:</h4>

<p>Population does not occur unless a <code>callback</code> is passed <em>or</em> you explicitly<br />call <code>execPopulate()</code>.<br />Passing the same path a second time will overwrite the previous path options.<br />See <a href="#model_Model.populate">Model.populate()</a> for explaination of options.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.populate = <span class="function"><span class="keyword">function</span> <span class="title">populate</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">0</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> pop = <span class="keyword">this</span>.$__.populate || (<span class="keyword">this</span>.$__.populate = {});
  <span class="keyword">var</span> args = utils.args(arguments);
  <span class="keyword">var</span> fn;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> args[args.length - <span class="number">1</span>] === <span class="string">'function'</span>) {
    fn = args.pop();
  }

  <span class="comment">// allow `doc.populate(callback)`</span>
  <span class="keyword">if</span> (args.length) {
    <span class="comment">// use hash to remove duplicate paths</span>
    <span class="keyword">var</span> res = utils.populate.apply(<span class="literal">null</span>, args);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; res.length; ++i) {
      pop[res[i].path] = res[i];
    }
  }

  <span class="keyword">if</span> (fn) {
    <span class="keyword">var</span> paths = utils.object.vals(pop);
    <span class="keyword">this</span>.$__.populate = <span class="literal">undefined</span>;
    paths.__noPromise = <span class="literal">true</span>;
    <span class="keyword">var</span> topLevelModel = <span class="keyword">this</span>.constructor;
    <span class="keyword">if</span> (<span class="keyword">this</span>.$__isNested) {
      topLevelModel = <span class="keyword">this</span>.$__.scope.constructor;
      <span class="keyword">var</span> nestedPath = <span class="keyword">this</span>.$__.nestedPath;
      paths.forEach(<span class="keyword">function</span>(populateOptions) {
        populateOptions.path = nestedPath + <span class="string">'.'</span> + populateOptions.path;
      });
    }
    topLevelModel.populate(<span class="keyword">this</span>, paths, fn);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-populated"><a href="#document_Document-populated">Document#populated(<code>path</code>)</a></h3><p>Gets _id(s) used during population of the given <code>path</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="#types_objectid_ObjectId">ObjectId</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.findOne().populate(<span class="string">'author'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  console.log(doc.author.name)         <span class="comment">// Dr.Seuss</span>
  console.log(doc.populated(<span class="string">'author'</span>)) <span class="comment">// '5144cf8050f071d979c118a7'</span>
})</code></pre>

<p>If the path was not populated, undefined is returned.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.populated = <span class="keyword">function</span>(path, val, options) {
  <span class="comment">// val and options are internal</span>

  <span class="keyword">if</span> (val === <span class="literal">null</span> || val === <span class="keyword">void</span> <span class="number">0</span>) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.$__.populated) {
      <span class="keyword">return</span> <span class="literal">undefined</span>;
    }
    <span class="keyword">var</span> v = <span class="keyword">this</span>.$__.populated[path];
    <span class="keyword">if</span> (v) {
      <span class="keyword">return</span> v.value;
    }
    <span class="keyword">return</span> <span class="literal">undefined</span>;
  }

  <span class="comment">// internal</span>

  <span class="keyword">if</span> (val === <span class="literal">true</span>) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.$__.populated) {
      <span class="keyword">return</span> <span class="literal">undefined</span>;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.$__.populated[path];
  }

  <span class="keyword">this</span>.$__.populated || (<span class="keyword">this</span>.$__.populated = {});
  <span class="keyword">this</span>.$__.populated[path] = {value: val, options: options};
  <span class="keyword">return</span> val;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-save"><a href="#document_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-save">function Object() { [native code] }#save(<code>[options]</code>, <code>[options.safe]</code>, <code>[options.validateBeforeSave]</code>, <code>[fn]</code>)</a></h3><p>Saves this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options optional options</span></li><li><code>[options.safe]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>overrides <a href="../../guide.html#safe">schema&#39;s safe option</a></span></li><li><code>[options.validateBeforeSave]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>set to false to save without validating.</span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>Promise</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../middleware.html" title="middleware">middleware</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>product.sold = Date.now();
product.save(<span class="function"><span class="keyword">function</span> <span class="params">(err, product, numAffected)</span> {</span>
  <span class="keyword">if</span> (err) ..
})</code></pre>

<p>The callback will receive three parameters</p>

<ol>
<li><code>err</code> if an error occurred</li>
<li><code>product</code> which is the saved <code>product</code></li>
<li><code>numAffected</code> will be 1 when the document was successfully persisted to MongoDB, otherwise 0. Unless you tweak mongoose's internals, you don't need to worry about checking this parameter for errors - checking <code>err</code> is sufficient to make sure your document was properly saved.</li>
</ol>

<p>As an extra measure of flow control, save will return a Promise.</p>

<h4>Example:</h4>

<pre><code>product.save().then(<span class="keyword">function</span>(product) {
   ...
});</code></pre>

<p>For legacy reasons, mongoose stores object keys in reverse order on initial<br />save. That is, <code>{ a: 1, b: 2 }</code> will be saved as <code>{ b: 2, a: 1 }</code> in<br />MongoDB. To override this behavior, set<br /><a href="../../api.html#document_Document-toObject">the <code>toObject.retainKeyOrder</code> option</a><br />to true on your schema.</p></div><hr class=""></div><div class="item method public"><h3 id="document_"><a href="#document_">(<code>path</code>, <code>val</code>, <code>[type]</code>, <code>[options]</code>)</a></h3><p>Sets the value of a path, or many paths.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>path or object of key/vals to set</span></li><li><code>val</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span>the value to set</span></li><li><code>[type]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="http://nodejs.org/api/buffer.html">Buffer</a>, <a href="#*">*</a>&gt; </span><span>optionally specify a type for &quot;on-the-fly&quot; attributes</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optionally specify options that modify the behavior of the set</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="comment">// path, value</span>
doc.set(path, value)

<span class="comment">// object</span>
doc.set({
    path  : value
  , path2 : {
       path  : value
    }
})

<span class="comment">// on-the-fly cast to number</span>
doc.set(path, value, Number)

<span class="comment">// on-the-fly cast to string</span>
doc.set(path, value, String)

<span class="comment">// changing strict mode behavior</span>
doc.set(path, value, { strict: <span class="literal">false</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.set = Document.prototype.$set;</code></pre></div><hr class=""></div><div class="item method private"><h3 id="document_Document-setValue"><a href="#document_Document-setValue">Document#setValue(<code>path</code>, <code>value</code>)</a></h3><p>Sets a raw value for a path (no casting, setters, transformations)</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.setValue = <span class="keyword">function</span>(path, val) {
  utils.setValue(path, val, <span class="keyword">this</span>._doc);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="document_Document-toJSON"><a href="#document_Document-toJSON">Document#toJSON(<code>options</code>)</a></h3><p>The return value of this method is used in calls to JSON.stringify(doc).</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#document_Document-toObject" title="Document#toObject">Document#toObject</a></li></ul></div><div class="description"><p>This method accepts the same options as <a href="#document_Document-toObject">Document#toObject</a>. To apply the options to every document of your schema by default, set your <a href="#schema_Schema">schemas</a> <code>toJSON</code> option to the same argument.</p>

<pre><code>schema.set(<span class="string">'toJSON'</span>, { virtuals: <span class="literal">true</span> })</code></pre>

<p>See <a href="../../guide.html#toJSON">schema options</a> for details.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toJSON = <span class="keyword">function</span>(options) {
  <span class="keyword">return</span> <span class="keyword">this</span>.$toObject(options, <span class="literal">true</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-toObject"><a href="#document_Document-toObject">Document#toObject(<code>[options]</code>)</a></h3><p>Converts this document into a plain javascript object, ready for storage in MongoDB.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>js object</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.com/node-mongodb-native/api-bson-generated/binary.html" title="mongodb.Binary">mongodb.Binary</a></li></ul></div><div class="description"><p>Buffers are converted to instances of <a href="http://mongodb.github.com/node-mongodb-native/api-bson-generated/binary.html">mongodb.Binary</a> for proper storage.</p>

<h4>Options:</h4>

<ul>
<li><code>getters</code> apply all getters (path and virtual getters)</li>
<li><code>virtuals</code> apply virtual getters (can override <code>getters</code> option)</li>
<li><code>minimize</code> remove empty objects (defaults to true)</li>
<li><code>transform</code> a transform function to apply to the resulting document before returning</li>
<li><code>depopulate</code> depopulate any populated paths, replacing them with their original refs (defaults to false)</li>
<li><code>versionKey</code> whether to include the version key (defaults to true)</li>
<li><code>retainKeyOrder</code> keep the order of object keys. If this is set to true, <code>Object.keys(new Doc({ a: 1, b: 2}).toObject())</code> will always produce <code>['a', 'b']</code> (defaults to false)</li>
</ul>

<h4>Getters/Virtuals</h4>

<p>Example of only applying path getters</p>

<pre><code>doc.toObject({ getters: <span class="literal">true</span>, virtuals: <span class="literal">false</span> })</code></pre>

<p>Example of only applying virtual getters</p>

<pre><code>doc.toObject({ virtuals: <span class="literal">true</span> })</code></pre>

<p>Example of applying both path and virtual getters</p>

<pre><code>doc.toObject({ getters: <span class="literal">true</span> })</code></pre>

<p>To apply these options to every document of your schema by default, set your <a href="#schema_Schema">schemas</a> <code>toObject</code> option to the same argument.</p>

<pre><code>schema.set(<span class="string">'toObject'</span>, { virtuals: <span class="literal">true</span> })</code></pre>

<h4>Transform</h4>

<p>We may need to perform a transformation of the resulting object based on some criteria, say to remove some sensitive information or return a custom object. In this case we set the optional <code>transform</code> function.</p>

<p>Transform functions receive three arguments</p>

<pre><code><span class="function"><span class="keyword">function</span> <span class="params">(doc, ret, options)</span> {</span>}</code></pre>

<ul>
<li><code>doc</code> The mongoose document which is being converted</li>
<li><code>ret</code> The plain object representation which has been converted</li>
<li><code>options</code> The options in use (either schema options or the options passed inline)</li>
</ul>

<h4>Example</h4>

<pre><code><span class="comment">// specify the transform schema option</span>
<span class="keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.transform = <span class="function"><span class="keyword">function</span> <span class="params">(doc, ret, options)</span> {</span>
  <span class="comment">// remove the _id of every document before returning the result</span>
  <span class="keyword">delete</span> ret._id;
  <span class="keyword">return</span> ret;
}

<span class="comment">// without the transformation in the schema</span>
doc.toObject(); <span class="comment">// { _id: 'anId', name: 'Wreck-it Ralph' }</span>

<span class="comment">// with the transformation</span>
doc.toObject(); <span class="comment">// { name: 'Wreck-it Ralph' }</span></code></pre>

<p>With transformations we can do a lot more than remove properties. We can even return completely new customized objects:</p>

<pre><code><span class="keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.transform = <span class="function"><span class="keyword">function</span> <span class="params">(doc, ret, options)</span> {</span>
  <span class="keyword">return</span> { movie: ret.name }
}

<span class="comment">// without the transformation in the schema</span>
doc.toObject(); <span class="comment">// { _id: 'anId', name: 'Wreck-it Ralph' }</span>

<span class="comment">// with the transformation</span>
doc.toObject(); <span class="comment">// { movie: 'Wreck-it Ralph' }</span></code></pre>

<p><em>Note: if a transform function returns <code>undefined</code>, the return value will be ignored.</em></p>

<p>Transformations may also be applied inline, overridding any transform set in the options:</p>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">xform</span> <span class="params">(doc, ret, options)</span> {</span>
  <span class="keyword">return</span> { inline: ret.name, custom: <span class="literal">true</span> }
}

<span class="comment">// pass the transform as an inline option</span>
doc.toObject({ transform: xform }); <span class="comment">// { inline: 'Wreck-it Ralph', custom: true }</span></code></pre>

<p>If you want to skip transformations, use <code>transform: false</code>:</p>

<pre><code><span class="keyword">if</span> (!schema.options.toObject) schema.options.toObject = {};
schema.options.toObject.hide = <span class="string">'_id'</span>;
schema.options.toObject.transform = <span class="function"><span class="keyword">function</span> <span class="params">(doc, ret, options)</span> {</span>
  <span class="keyword">if</span> (options.hide) {
    options.hide.split(<span class="string">' '</span>).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(prop)</span> {</span>
      <span class="keyword">delete</span> ret[prop];
    });
  }
  <span class="keyword">return</span> ret;
}

<span class="keyword">var</span> doc = <span class="keyword">new</span> Doc({ _id: <span class="string">'anId'</span>, secret: <span class="number">47</span>, name: <span class="string">'Wreck-it Ralph'</span> });
doc.toObject();                                        <span class="comment">// { secret: 47, name: 'Wreck-it Ralph' }</span>
doc.toObject({ hide: <span class="string">'secret _id'</span>, transform: <span class="literal">false</span> });<span class="comment">// { _id: 'anId', secret: 47, name: 'Wreck-it Ralph' }</span>
doc.toObject({ hide: <span class="string">'secret _id'</span>, transform: <span class="literal">true</span> }); <span class="comment">// { name: 'Wreck-it Ralph' }</span></code></pre>

<p>Transforms are applied <em>only to the document and are not applied to sub-documents</em>.</p>

<p>Transforms, like all of these options, are also available for <code>toJSON</code>.</p>

<p>See <a href="../../guide.html#toObject">schema options</a> for some more details.</p>

<p><em>During save, no custom options are applied to the document before being sent to the database.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.toObject = <span class="keyword">function</span>(options) {
  <span class="keyword">return</span> <span class="keyword">this</span>.$toObject(options);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-toString"><a href="#document_Document-toString">Document#toString()</a></h3><p>Helper for console.log</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="document_Document-unmarkModified"><a href="#document_Document-unmarkModified">Document#unmarkModified(<code>path</code>)</a></h3><p>Clears the modified state on the specified path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the path to unmark modified</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>doc.foo = <span class="string">'bar'</span>;
doc.unmarkModified(<span class="string">'foo'</span>);
doc.save() <span class="comment">// changes to foo will not be persisted</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.unmarkModified = <span class="keyword">function</span>(path) {
  <span class="keyword">this</span>.$__.activePaths.init(path);
  <span class="keyword">delete</span> <span class="keyword">this</span>.$__.pathsToScopes[path];
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-update"><a href="#document_Document-update">Document#update(<code>doc</code>, <code>options</code>, <code>callback</code>)</a></h3><p>Sends an update command with this document <code>_id</code> as the query selector.</p><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.update" title="Model.update">Model.update</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>weirdCar.update({$inc: {wheels:<span class="number">1</span>}}, { w: <span class="number">1</span> }, callback);</code></pre>

<h4>Valid options:</h4>

<ul>
<li>same as in <a href="#model_Model.update">Model.update</a></li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> args = utils.args(arguments);
  args.unshift({_id: <span class="keyword">this</span>._id});
  <span class="keyword">return</span> <span class="keyword">this</span>.constructor.update.apply(<span class="keyword">this</span>.constructor, args);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-validate"><a href="#document_Document-validate">Document#validate(<code>optional</code>, <code>callback</code>)</a></h3><p>Executes registered validation rules for this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>optional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options internal options</span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback called after validation completes, passing an error if one occurred</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>Promise</span></li></ul></div><div class="description"><h4>Note:</h4>

<p>This method is called <code>pre</code> save and if a validation rule is violated, <a href="#model_Model-save">save</a> is aborted and the error is returned to your <code>callback</code>.</p>

<h4>Example:</h4>

<pre><code>doc.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (err) handleError(err);
  <span class="keyword">else</span> <span class="comment">// validation passed</span>
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.validate = <span class="keyword">function</span>(options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">this</span>.$__validate(callback || <span class="keyword">function</span>() {});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="document_Document-validateSync"><a href="#document_Document-validateSync">Document#validateSync(<code>pathsToValidate</code>)</a></h3><p>Executes registered validation rules (skipping asynchronous validators) for this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>pathsToValidate</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="#string">string</a>&gt; </span><span>only validate the given paths</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#error_MongooseError">MongooseError</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span>MongooseError if there are errors during validation, or undefined if there is no error.</span></li></ul></div><div class="description"><h4>Note:</h4>

<p>This method is useful if you need synchronous validation.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> err = doc.validateSync();
<span class="keyword">if</span> ( err ){
  handleError( err );
} <span class="keyword">else</span> {
  <span class="comment">// validation passed</span>
}</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.validateSync = <span class="keyword">function</span>(pathsToValidate) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> pathsToValidate === <span class="string">'string'</span>) {
    pathsToValidate = pathsToValidate.split(<span class="string">' '</span>);
  }

  <span class="comment">// only validate required fields when necessary</span>
  <span class="keyword">var</span> paths = _getPathsToValidate(<span class="keyword">this</span>);

  <span class="keyword">if</span> (pathsToValidate &amp;&amp; pathsToValidate.length) {
    <span class="keyword">var</span> tmp = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; paths.length; ++i) {
      <span class="keyword">if</span> (pathsToValidate.indexOf(paths[i]) !== -<span class="number">1</span>) {
        tmp.push(paths[i]);
      }
    }
    paths = tmp;
  }

  <span class="keyword">var</span> validating = {};

  paths.forEach(<span class="keyword">function</span>(path) {
    <span class="keyword">if</span> (validating[path]) {
      <span class="keyword">return</span>;
    }

    validating[path] = <span class="literal">true</span>;

    <span class="keyword">var</span> p = _<span class="keyword">this</span>.schema.path(path);
    <span class="keyword">if</span> (!p) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (!_<span class="keyword">this</span>.$isValid(path)) {
      <span class="keyword">return</span>;
    }

    <span class="keyword">var</span> val = _<span class="keyword">this</span>.getValue(path);
    <span class="keyword">var</span> err = p.doValidateSync(val, _<span class="keyword">this</span>);
    <span class="keyword">if</span> (err) {
      _<span class="keyword">this</span>.invalidate(path, err, <span class="literal">undefined</span>, <span class="literal">true</span>);
    }
  });

  <span class="keyword">var</span> err = _<span class="keyword">this</span>.$__.validationError;
  _<span class="keyword">this</span>.$__.validationError = <span class="literal">undefined</span>;
  _<span class="keyword">this</span>.emit(<span class="string">'validate'</span>, _<span class="keyword">this</span>);
  _<span class="keyword">this</span>.constructor.emit(<span class="string">'validate'</span>, _<span class="keyword">this</span>);

  <span class="keyword">if</span> (err) {
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> err.errors) {
      <span class="comment">// Make sure cast errors persist</span>
      <span class="keyword">if</span> (err.errors[key] <span class="keyword">instanceof</span> MongooseError.CastError) {
        _<span class="keyword">this</span>.invalidate(key, err.errors[key]);
      }
    }
  }

  <span class="keyword">return</span> err;
};</code></pre></div><hr class=""></div><div class="item static private"><h3 id="document_Document.%24isValid"><a href="#document_Document.%24isValid">Document.$isValid(<code>path</code>)</a></h3><p>Checks if a path is invalid</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to check</span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="document_Document.%24markValid"><a href="#document_Document.%24markValid">Document.$markValid(<code>path</code>)</a></h3><p>Marks a path as valid, removing existing validation errors.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field to mark as valid</span></li></ul></div><hr class=""></div><div class="item property public"><h3 id="document_Document-errors"><a href="#document_Document-errors">Document#<span>errors</span></a></h3><p>Hash containing current validation errors.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.errors;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="document_Document-id"><a href="#document_Document-id">Document#<span>id</span></a></h3><p>The string version of this documents _id.</p>

<h4>Note:</h4>

<p>This getter exists on all documents by default. The getter can be disabled by setting the <code>id</code> <a href="../../guide.html#id">option</a> of its <code>Schema</code> to false at construction time.</p>

<pre><code><span class="keyword">new</span> Schema({ name: String }, { id: <span class="literal">false</span> });</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.id;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../guide.html#options" title="Schema options">Schema options</a></li></ul></div><hr class=""></div><div class="item property public"><h3 id="document_Document-isNew"><a href="#document_Document-isNew">Document#<span>isNew</span></a></h3><p>Boolean flag specifying if the document is new.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.isNew;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="document_Document-schema"><a href="#document_Document-schema">Document#<span>schema</span></a></h3><p>The documents schema.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Document.prototype.schema;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/cursor/QueryCursor.js" id="cursor-QueryCursor-js">cursor/QueryCursor.js</a><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor-addCursorFlag"><a href="#cursor_QueryCursor_QueryCursor-addCursorFlag">QueryCursor#addCursorFlag(<code>flag</code>, <code>value</code>)</a></h3><p>Adds a <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Cursor.html#addCursorFlag">cursor flag</a>.<br />Useful for setting the <code>noCursorTimeout</code> and <code>tailable</code> flags.</p><div class="params"><h4>Parameters:</h4><ul><li><code>flag</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#AggregationCursor">AggregationCursor</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor-close"><a href="#cursor_QueryCursor_QueryCursor-close">QueryCursor#close(<code>callback</code>)</a></h3><p>Marks this cursor as closed. Will stop streaming and subsequent calls to<br /><code>next()</code> will error.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="driver%20cursor.html#close http://mongodb.github.io/node-mongodb-native/2.1/api/Cursor.html#close" title="MongoDB">MongoDB</a></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor-eachAsync"><a href="#cursor_QueryCursor_QueryCursor-eachAsync">QueryCursor#eachAsync(<code>fn</code>, <code>[options]</code>, <code>[options.parallel]</code>, <code>[callback]</code>)</a></h3><p>Execute <code>fn</code> for every document in the cursor. If <code>fn</code> returns a promise,<br />will wait for the promise to resolve before iterating on to the next one.<br />Returns a promise that resolves when done.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options.parallel]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the number of promises to execute in parallel. Defaults to 1.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>executed when all docs have been processed</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor-map"><a href="#cursor_QueryCursor_QueryCursor-map">QueryCursor#map(<code>fn</code>)</a></h3><p>Registers a transform function which subsequently maps documents retrieved<br />via the streams interface or <code>.next()</code></p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#QueryCursor">QueryCursor</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// Map documents returned by `data` events</span>
Thing.
  find({ name: <span class="regexp">/^hello/</span> }).
  cursor().
  map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
   doc.foo = <span class="string">"bar"</span>;
   <span class="keyword">return</span> doc;
  })
  on(<span class="string">'data'</span>, <span class="keyword">function</span>(doc) { console.log(doc.foo); });

<span class="comment">// Or map documents returned by `.next()`</span>
<span class="keyword">var</span> cursor = Thing.find({ name: <span class="regexp">/^hello/</span> }).
  cursor().
  map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    doc.foo = <span class="string">"bar"</span>;
    <span class="keyword">return</span> doc;
  });
cursor.next(<span class="keyword">function</span>(error, doc) {
  console.log(doc.foo);
});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor-next"><a href="#cursor_QueryCursor_QueryCursor-next">QueryCursor#next(<code>callback</code>)</a></h3><p>Get the next document from this cursor. Will return <code>null</code> when there are<br />no documents left.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_QueryCursor_QueryCursor"><a href="#cursor_QueryCursor_QueryCursor">QueryCursor(<code>query</code>, <code>options</code>)</a></h3><p>A QueryCursor is a concurrency primitive for processing query results<br />one document at a time. A QueryCursor fulfills the <a href="https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/">Node.js streams3 API</a>,<br />in addition to several other mechanisms for loading documents from MongoDB<br />one at a time.</p><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>query options passed to <code>.find()</code></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#Readable">Readable</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>cursor</code>: Emitted when the cursor is created</p></li><li><p><code>error</code>: Emitted when an error occurred</p></li><li><p><code>data</code>: Emitted when the stream is flowing and the next doc is ready</p></li><li><p><code>end</code>: Emitted when the stream is exhausted</p></li></ul></div><div class="description"><p>QueryCursors execute the model's pre find hooks, but <strong>not</strong> the model's<br />post find hooks.</p>

<p>Unless you're an advanced user, do <strong>not</strong> instantiate this class directly.<br />Use <a href="../../api.html#query_Query-cursor"><code>Query#cursor()</code></a> instead.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">QueryCursor</span><span class="params">(query, options)</span> {</span>
  Readable.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>.cursor = <span class="literal">null</span>;
  <span class="keyword">this</span>.query = query;
  <span class="keyword">this</span>._transforms = options.transform ? [options.transform] : [];
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> model = query.model;
  model.hooks.execPre(<span class="string">'find'</span>, query, <span class="keyword">function</span>() {
    model.collection.find(query._conditions, options, <span class="keyword">function</span>(err, cursor) {
      <span class="keyword">if</span> (_<span class="keyword">this</span>._error) {
        cursor.close(<span class="keyword">function</span>() {});
        _<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length > <span class="number">0</span> &amp;&amp; _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, _<span class="keyword">this</span>._error);
      }
      <span class="keyword">if</span> (err) {
        <span class="keyword">return</span> _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);
      }
      _<span class="keyword">this</span>.cursor = cursor;
      _<span class="keyword">this</span>.emit(<span class="string">'cursor'</span>, cursor);
    });
  });
}

util.inherits(QueryCursor, Readable);</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/cursor/AggregationCursor.js" id="cursor-AggregationCursor-js">cursor/AggregationCursor.js</a><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor-addCursorFlag"><a href="#cursor_AggregationCursor_AggregationCursor-addCursorFlag">AggregationCursor#addCursorFlag(<code>flag</code>, <code>value</code>)</a></h3><p>Adds a <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Cursor.html#addCursorFlag">cursor flag</a>.<br />Useful for setting the <code>noCursorTimeout</code> and <code>tailable</code> flags.</p><div class="params"><h4>Parameters:</h4><ul><li><code>flag</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#AggregationCursor">AggregationCursor</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor"><a href="#cursor_AggregationCursor_AggregationCursor">AggregationCursor(<code>agg</code>, <code>options</code>)</a></h3><p>An AggregationCursor is a concurrency primitive for processing aggregation<br />results one document at a time. It is analogous to QueryCursor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>agg</code><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#Readable">Readable</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>cursor</code>: Emitted when the cursor is created</p></li><li><p><code>error</code>: Emitted when an error occurred</p></li><li><p><code>data</code>: Emitted when the stream is flowing and the next doc is ready</p></li><li><p><code>end</code>: Emitted when the stream is exhausted</p></li></ul></div><div class="description"><p>An AggregationCursor fulfills the <a href="https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/">Node.js streams3 API</a>,<br />in addition to several other mechanisms for loading documents from MongoDB<br />one at a time.</p>

<p>Creating an AggregationCursor executes the model's pre aggregate hooks,<br />but <strong>not</strong> the model's post aggregate hooks.</p>

<p>Unless you're an advanced user, do <strong>not</strong> instantiate this class directly.<br />Use <a href="../../api.html#aggregate_Aggregate-cursor"><code>Aggregate#cursor()</code></a> instead.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">AggregationCursor</span><span class="params">(agg)</span> {</span>
  Readable.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>.cursor = <span class="literal">null</span>;
  <span class="keyword">this</span>.agg = agg;
  <span class="keyword">this</span>._transforms = [];
  <span class="keyword">var</span> model = agg._model;
  <span class="keyword">delete</span> agg.options.cursor.useMongooseAggCursor;

  _init(model, <span class="keyword">this</span>, agg);
}

util.inherits(AggregationCursor, Readable);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor-close"><a href="#cursor_AggregationCursor_AggregationCursor-close">AggregationCursor#close(<code>callback</code>)</a></h3><p>Marks this cursor as closed. Will stop streaming and subsequent calls to<br /><code>next()</code> will error.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="driver%20cursor.html#close http://mongodb.github.io/node-mongodb-native/2.1/api/Cursor.html#close" title="MongoDB">MongoDB</a></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor-eachAsync"><a href="#cursor_AggregationCursor_AggregationCursor-eachAsync">AggregationCursor#eachAsync(<code>fn</code>, <code>[callback]</code>)</a></h3><p>Execute <code>fn</code> for every document in the cursor. If <code>fn</code> returns a promise,<br />will wait for the promise to resolve before iterating on to the next one.<br />Returns a promise that resolves when done.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>executed when all docs have been processed</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor-map"><a href="#cursor_AggregationCursor_AggregationCursor-map">AggregationCursor#map(<code>fn</code>)</a></h3><p>Registers a transform function which subsequently maps documents retrieved<br />via the streams interface or <code>.next()</code></p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#QueryCursor">QueryCursor</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// Map documents returned by `data` events</span>
Thing.
  find({ name: <span class="regexp">/^hello/</span> }).
  cursor().
  map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
   doc.foo = <span class="string">"bar"</span>;
   <span class="keyword">return</span> doc;
  })
  on(<span class="string">'data'</span>, <span class="keyword">function</span>(doc) { console.log(doc.foo); });

<span class="comment">// Or map documents returned by `.next()`</span>
<span class="keyword">var</span> cursor = Thing.find({ name: <span class="regexp">/^hello/</span> }).
  cursor().
  map(<span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
    doc.foo = <span class="string">"bar"</span>;
    <span class="keyword">return</span> doc;
  });
cursor.next(<span class="keyword">function</span>(error, doc) {
  console.log(doc.foo);
});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="cursor_AggregationCursor_AggregationCursor-next"><a href="#cursor_AggregationCursor_AggregationCursor-next">AggregationCursor#next(<code>callback</code>)</a></h3><p>Get the next document from this cursor. Will return <code>null</code> when there are<br />no documents left.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/boolean.js" id="schema-boolean-js">schema/boolean.js</a><div class="item method private"><h3 id="schema_boolean_SchemaBoolean-cast"><a href="#schema_boolean_SchemaBoolean-cast">SchemaBoolean#cast(<code>value</code>, <code>model</code>)</a></h3><p>Casts to boolean</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>model</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span><ul><li>this value is optional</li></ul></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.cast = <span class="keyword">function</span>(value, model) {
  <span class="keyword">if</span> (value === <span class="literal">null</span>) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.options.strictBool || (model &amp;&amp; model.schema.options.strictBool &amp;&amp; <span class="keyword">this</span>.options.strictBool !== <span class="literal">false</span>)) {
    <span class="comment">// strict mode (throws if value is not a boolean, instead of converting)</span>
    <span class="keyword">if</span> (value === <span class="literal">true</span> || value === <span class="string">'true'</span> || value === <span class="number">1</span> || value === <span class="string">'1'</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (value === <span class="literal">false</span> || value === <span class="string">'false'</span> || value === <span class="number">0</span> || value === <span class="string">'0'</span>) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'boolean'</span>, value, <span class="keyword">this</span>.path);
  } <span class="keyword">else</span> {
    <span class="comment">// legacy mode</span>
    <span class="keyword">if</span> (value === <span class="string">'0'</span>) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">if</span> (value === <span class="string">'true'</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (value === <span class="string">'false'</span>) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> !!value;
  }
};

SchemaBoolean.$conditionalHandlers =
    utils.options(SchemaType.prototype.$conditionalHandlers, {});</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_boolean_SchemaBoolean-castForQuery"><a href="#schema_boolean_SchemaBoolean-castForQuery">SchemaBoolean#castForQuery(<code>$conditional</code>, <code>val</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = SchemaBoolean.$conditionalHandlers[$conditional];

    <span class="keyword">if</span> (handler) {
      <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
    }

    <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery(val);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery($conditional);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_boolean_SchemaBoolean-checkRequired"><a href="#schema_boolean_SchemaBoolean-checkRequired">SchemaBoolean#checkRequired(<code>value</code>)</a></h3><p>Check if the given value satisfies a required validator. For a boolean<br />to satisfy a required validator, it must be strictly equal to true or to<br />false.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.prototype.checkRequired = <span class="keyword">function</span>(value) {
  <span class="keyword">return</span> value === <span class="literal">true</span> || value === <span class="literal">false</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_boolean_SchemaBoolean"><a href="#schema_boolean_SchemaBoolean">SchemaBoolean(<code>path</code>, <code>options</code>)</a></h3><p>Boolean SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaBoolean</span><span class="params">(path, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, path, options, <span class="string">'Boolean'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_boolean_SchemaBoolean.schemaName"><a href="#schema_boolean_SchemaBoolean.schemaName">SchemaBoolean.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBoolean.schemaName = <span class="string">'Boolean'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/documentarray.js" id="schema-documentarray-js">schema/documentarray.js</a><div class="item method private"><h3 id="schema_documentarray_DocumentArray-cast"><a href="#schema_documentarray_DocumentArray-cast">DocumentArray#cast(<code>value</code>, <code>document</code>)</a></h3><p>Casts contents</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>document</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>that triggers the casting</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.cast = <span class="keyword">function</span>(value, doc, init, prev, options) {
  <span class="comment">// lazy load</span>
  MongooseDocumentArray || (MongooseDocumentArray = require(<span class="string">'../types/documentarray'</span>));

  <span class="keyword">var</span> selected;
  <span class="keyword">var</span> subdoc;
  <span class="keyword">var</span> i;
  <span class="keyword">var</span> _opts = { transform: <span class="literal">false</span>, virtuals: <span class="literal">false</span> };

  <span class="keyword">if</span> (!Array.isArray(value)) {
    <span class="comment">// gh-2442 mark whole array as modified if we're initializing a doc from</span>
    <span class="comment">// the db and the path isn't an array in the document</span>
    <span class="keyword">if</span> (!!doc &amp;&amp; init) {
      doc.markModified(<span class="keyword">this</span>.path);
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.cast([value], doc, init, prev);
  }

  <span class="keyword">if</span> (!(value &amp;&amp; value.isMongooseDocumentArray) &amp;&amp;
      (!options || !options.skipDocumentArrayCast)) {
    value = <span class="keyword">new</span> MongooseDocumentArray(value, <span class="keyword">this</span>.path, doc);
    <span class="keyword">if</span> (prev &amp;&amp; prev._handlers) {
      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> prev._handlers) {
        doc.removeListener(key, prev._handlers[key]);
      }
    }
  } <span class="keyword">else</span> <span class="keyword">if</span> (value &amp;&amp; value.isMongooseDocumentArray) {
    <span class="comment">// We need to create a new array, otherwise change tracking will</span>
    <span class="comment">// update the old doc (gh-4449)</span>
    value = <span class="keyword">new</span> MongooseDocumentArray(value, <span class="keyword">this</span>.path, doc);
  }

  i = value.length;

  <span class="keyword">while</span> (i--) {
    <span class="keyword">if</span> (!value[i]) {
      <span class="keyword">continue</span>;
    }

    <span class="keyword">var</span> Constructor = <span class="keyword">this</span>.casterConstructor;
    <span class="keyword">if</span> (Constructor.discriminators &amp;&amp;
        <span class="keyword">typeof</span> value[i][Constructor.schema.options.discriminatorKey] === <span class="string">'string'</span> &amp;&amp;
        Constructor.discriminators[value[i][Constructor.schema.options.discriminatorKey]]) {
      Constructor = Constructor.discriminators[value[i][Constructor.schema.options.discriminatorKey]];
    }

    <span class="comment">// Check if the document has a different schema (re gh-3701)</span>
    <span class="keyword">if</span> ((value[i] <span class="keyword">instanceof</span> Document) &amp;&amp;
        value[i].schema !== Constructor.schema) {
      value[i] = value[i].toObject({ transform: <span class="literal">false</span>, virtuals: <span class="literal">false</span> });
    }
    <span class="keyword">if</span> (!(value[i] <span class="keyword">instanceof</span> Subdocument) &amp;&amp; value[i]) {
      <span class="keyword">if</span> (init) {
        <span class="keyword">if</span> (doc) {
          selected || (selected = scopePaths(<span class="keyword">this</span>, doc.$__.selected, init));
        } <span class="keyword">else</span> {
          selected = <span class="literal">true</span>;
        }

        subdoc = <span class="keyword">new</span> Constructor(<span class="literal">null</span>, value, <span class="literal">true</span>, selected, i);
        value[i] = subdoc.init(value[i]);
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (prev &amp;&amp; (subdoc = prev.id(value[i]._id))) {
          subdoc = prev.id(value[i]._id);
        }

        <span class="keyword">if</span> (prev &amp;&amp; subdoc &amp;&amp; utils.deepEqual(subdoc.toObject(_opts), value[i])) {
          <span class="comment">// handle resetting doc with existing id and same data</span>
          subdoc.set(value[i]);
          <span class="comment">// if set() is hooked it will have no return value</span>
          <span class="comment">// see gh-746</span>
          value[i] = subdoc;
        } <span class="keyword">else</span> {
          <span class="keyword">try</span> {
            subdoc = <span class="keyword">new</span> Constructor(value[i], value, <span class="literal">undefined</span>,
                <span class="literal">undefined</span>, i);
            <span class="comment">// if set() is hooked it will have no return value</span>
            <span class="comment">// see gh-746</span>
            value[i] = subdoc;
          } <span class="keyword">catch</span> (error) {
            <span class="keyword">var</span> valueInErrorMessage = util.inspect(value[i]);
            <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'embedded'</span>, valueInErrorMessage,
              value._path, error);
          }
        }
      }
    }
  }

  <span class="keyword">return</span> value;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_documentarray_DocumentArray"><a href="#schema_documentarray_DocumentArray">DocumentArray(<code>key</code>, <code>schema</code>, <code>options</code>)</a></h3><p>SubdocsArray SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schema_array_SchemaArray">SchemaArray</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">DocumentArray</span><span class="params">(key, schema, options)</span> {</span>
  <span class="keyword">var</span> EmbeddedDocument = _createConstructor(schema, options);
  EmbeddedDocument.prototype.$basePath = key;

  ArrayType.call(<span class="keyword">this</span>, key, EmbeddedDocument, options);

  <span class="keyword">this</span>.schema = schema;
  <span class="keyword">this</span>.$isMongooseDocumentArray = <span class="literal">true</span>;
  <span class="keyword">var</span> fn = <span class="keyword">this</span>.defaultValue;

  <span class="keyword">if</span> (!(<span class="string">'defaultValue'</span> <span class="keyword">in</span> <span class="keyword">this</span>) || fn !== <span class="keyword">void</span> <span class="number">0</span>) {
    <span class="keyword">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>() {
      <span class="keyword">var</span> arr = fn.call(<span class="keyword">this</span>);
      <span class="keyword">if</span> (!Array.isArray(arr)) {
        arr = [arr];
      }
      <span class="comment">// Leave it up to `cast()` to convert this to a documentarray</span>
      <span class="keyword">return</span> arr;
    });
  }
}</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_documentarray_DocumentArray-doValidate"><a href="#schema_documentarray_DocumentArray-doValidate">DocumentArray#doValidate()</a></h3><p>Performs local validations first, then validations on each embedded doc</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.doValidate = <span class="keyword">function</span>(array, fn, scope, options) {
  <span class="comment">// lazy load</span>
  MongooseDocumentArray || (MongooseDocumentArray = require(<span class="string">'../types/documentarray'</span>));

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  SchemaType.prototype.doValidate.call(<span class="keyword">this</span>, array, <span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> fn(err);
    }

    <span class="keyword">var</span> count = array &amp;&amp; array.length;
    <span class="keyword">var</span> error;

    <span class="keyword">if</span> (!count) {
      <span class="keyword">return</span> fn();
    }
    <span class="keyword">if</span> (options &amp;&amp; options.updateValidator) {
      <span class="keyword">return</span> fn();
    }
    <span class="keyword">if</span> (!array.isMongooseDocumentArray) {
      array = <span class="keyword">new</span> MongooseDocumentArray(array, _<span class="keyword">this</span>.path, scope);
    }

    <span class="comment">// handle sparse arrays, do not use array.forEach which does not</span>
    <span class="comment">// iterate over sparse elements yet reports array.length including</span>
    <span class="comment">// them :(</span>

    <span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) {
        error = err;
      }
      --count || fn(error);
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = count; i &lt; len; ++i) {
      <span class="comment">// sidestep sparse entries</span>
      <span class="keyword">var</span> doc = array[i];
      <span class="keyword">if</span> (!doc) {
        --count || fn(error);
        <span class="keyword">continue</span>;
      }

      <span class="comment">// If you set the array index directly, the doc might not yet be</span>
      <span class="comment">// a full fledged mongoose subdoc, so make it into one.</span>
      <span class="keyword">if</span> (!(doc <span class="keyword">instanceof</span> Subdocument)) {
        doc = array[i] = <span class="keyword">new</span> _<span class="keyword">this</span>.casterConstructor(doc, array, <span class="literal">undefined</span>,
            <span class="literal">undefined</span>, i);
      }

      <span class="comment">// HACK: use $__original_validate to avoid promises so bluebird doesn't</span>
      <span class="comment">// complain</span>
      <span class="keyword">if</span> (doc.$__original_validate) {
        doc.$__original_validate({__noPromise: <span class="literal">true</span>}, callback);
      } <span class="keyword">else</span> {
        doc.validate({__noPromise: <span class="literal">true</span>}, callback);
      }
    }
  }, scope);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_documentarray_DocumentArray-doValidateSync"><a href="#schema_documentarray_DocumentArray-doValidateSync">DocumentArray#doValidateSync()</a></h3><p>Performs local validations first, then validations on each embedded doc.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#error_MongooseError">MongooseError</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Note:</h4>

<p>This method ignores the asynchronous validators.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.prototype.doValidateSync = <span class="keyword">function</span>(array, scope) {
  <span class="keyword">var</span> schemaTypeError = SchemaType.prototype.doValidateSync.call(<span class="keyword">this</span>, array, scope);
  <span class="keyword">if</span> (schemaTypeError) {
    <span class="keyword">return</span> schemaTypeError;
  }

  <span class="keyword">var</span> count = array &amp;&amp; array.length,
      resultError = <span class="literal">null</span>;

  <span class="keyword">if</span> (!count) {
    <span class="keyword">return</span>;
  }

  <span class="comment">// handle sparse arrays, do not use array.forEach which does not</span>
  <span class="comment">// iterate over sparse elements yet reports array.length including</span>
  <span class="comment">// them :(</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = count; i &lt; len; ++i) {
    <span class="comment">// only first error</span>
    <span class="keyword">if</span> (resultError) {
      <span class="keyword">break</span>;
    }
    <span class="comment">// sidestep sparse entries</span>
    <span class="keyword">var</span> doc = array[i];
    <span class="keyword">if</span> (!doc) {
      <span class="keyword">continue</span>;
    }

    <span class="comment">// If you set the array index directly, the doc might not yet be</span>
    <span class="comment">// a full fledged mongoose subdoc, so make it into one.</span>
    <span class="keyword">if</span> (!(doc <span class="keyword">instanceof</span> Subdocument)) {
      doc = array[i] = <span class="keyword">new</span> <span class="keyword">this</span>.casterConstructor(doc, array, <span class="literal">undefined</span>,
        <span class="literal">undefined</span>, i);
    }

    <span class="keyword">var</span> subdocValidateError = doc.validateSync();

    <span class="keyword">if</span> (subdocValidateError) {
      resultError = subdocValidateError;
    }
  }

  <span class="keyword">return</span> resultError;
};</code></pre></div><hr class="private"></div><div class="item static public"><h3 id="schema_documentarray_DocumentArray.schemaName"><a href="#schema_documentarray_DocumentArray.schemaName">DocumentArray.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">DocumentArray.schemaName = <span class="string">'DocumentArray'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/array.js" id="schema-array-js">schema/array.js</a><div class="item method private"><h3 id="schema_array_SchemaArray-applyGetters"><a href="#schema_array_SchemaArray-applyGetters">SchemaArray#applyGetters(<code>value</code>, <code>scope</code>)</a></h3><p>Overrides the getters application for the population special-case</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.applyGetters = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.caster.options &amp;&amp; <span class="keyword">this</span>.caster.options.ref) {
    <span class="comment">// means the object id was populated</span>
    <span class="keyword">return</span> value;
  }

  <span class="keyword">return</span> SchemaType.prototype.applyGetters.call(<span class="keyword">this</span>, value, scope);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_array_SchemaArray-cast"><a href="#schema_array_SchemaArray-cast">SchemaArray#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts values for set().</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>document that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether this is an initialization cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="comment">// lazy load</span>
  MongooseArray || (MongooseArray = require(<span class="string">'../types'</span>).Array);

  <span class="keyword">if</span> (Array.isArray(value)) {
    <span class="keyword">if</span> (!value.length &amp;&amp; doc) {
      <span class="keyword">var</span> indexes = doc.schema.indexedPaths();

      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = indexes.length; i &lt; l; ++i) {
        <span class="keyword">var</span> pathIndex = indexes[i][<span class="number">0</span>][<span class="keyword">this</span>.path];
        <span class="keyword">if</span> (pathIndex === <span class="string">'2dsphere'</span> || pathIndex === <span class="string">'2d'</span>) {
          <span class="keyword">return</span>;
        }
      }
    }

    <span class="keyword">if</span> (!(value &amp;&amp; value.isMongooseArray)) {
      value = <span class="keyword">new</span> MongooseArray(value, <span class="keyword">this</span>.path, doc);
    } <span class="keyword">else</span> <span class="keyword">if</span> (value &amp;&amp; value.isMongooseArray) {
      <span class="comment">// We need to create a new array, otherwise change tracking will</span>
      <span class="comment">// update the old doc (gh-4449)</span>
      value = <span class="keyword">new</span> MongooseArray(value, <span class="keyword">this</span>.path, doc);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.caster) {
      <span class="keyword">try</span> {
        <span class="keyword">for</span> (i = <span class="number">0</span>, l = value.length; i &lt; l; i++) {
          value[i] = <span class="keyword">this</span>.caster.cast(value[i], doc, init);
        }
      } <span class="keyword">catch</span> (e) {
        <span class="comment">// rethrow</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'['</span> + e.kind + <span class="string">']'</span>, util.inspect(value), <span class="keyword">this</span>.path, e);
      }
    }

    <span class="keyword">return</span> value;
  }
  <span class="comment">// gh-2442: if we're loading this from the db and its not an array, mark</span>
  <span class="comment">// the whole array as modified.</span>
  <span class="keyword">if</span> (!!doc &amp;&amp; !!init) {
    doc.markModified(<span class="keyword">this</span>.path);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.cast([value], doc, init);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_array_SchemaArray-castForQuery"><a href="#schema_array_SchemaArray-castForQuery">SchemaArray#castForQuery(<code>$conditional</code>, <code>[value]</code>)</a></h3><p>Casts values for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[value]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.castForQuery = <span class="keyword">function</span>($conditional, value) {
  <span class="keyword">var</span> handler,
      val;

  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];

    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with Array.'</span>);
    }

    val = handler.call(<span class="keyword">this</span>, value);
  } <span class="keyword">else</span> {
    val = $conditional;
    <span class="keyword">var</span> Constructor = <span class="keyword">this</span>.casterConstructor;

    <span class="keyword">if</span> (val &amp;&amp;
        Constructor.discriminators &amp;&amp;
        Constructor.schema.options.discriminatorKey &amp;&amp;
        <span class="keyword">typeof</span> val[Constructor.schema.options.discriminatorKey] === <span class="string">'string'</span> &amp;&amp;
        Constructor.discriminators[val[Constructor.schema.options.discriminatorKey]]) {
      Constructor = Constructor.discriminators[val[Constructor.schema.options.discriminatorKey]];
    }

    <span class="keyword">var</span> proto = <span class="keyword">this</span>.casterConstructor.prototype;
    <span class="keyword">var</span> method = proto &amp;&amp; (proto.castForQuery || proto.cast);
    <span class="keyword">if</span> (!method &amp;&amp; Constructor.castForQuery) {
      method = Constructor.castForQuery;
    }
    <span class="keyword">var</span> caster = <span class="keyword">this</span>.caster;

    <span class="keyword">if</span> (Array.isArray(val)) {
      val = val.map(<span class="keyword">function</span>(v) {
        <span class="keyword">if</span> (utils.isObject(v) &amp;&amp; v.$elemMatch) {
          <span class="keyword">return</span> v;
        }
        <span class="keyword">if</span> (method) {
          v = method.call(caster, v);
          <span class="keyword">return</span> v;
        }
        <span class="keyword">if</span> (v != <span class="literal">null</span>) {
          v = <span class="keyword">new</span> Constructor(v);
          <span class="keyword">return</span> v;
        }
        <span class="keyword">return</span> v;
      });
    } <span class="keyword">else</span> <span class="keyword">if</span> (method) {
      val = method.call(caster, val);
    } <span class="keyword">else</span> <span class="keyword">if</span> (val != <span class="literal">null</span>) {
      val = <span class="keyword">new</span> Constructor(val);
    }
  }

  <span class="keyword">return</span> val;
};

<span class="function"><span class="keyword">function</span> <span class="title">cast$all</span><span class="params">(val)</span> {</span>
  <span class="keyword">if</span> (!Array.isArray(val)) {
    val = [val];
  }

  val = val.map(<span class="keyword">function</span>(v) {
    <span class="keyword">if</span> (utils.isObject(v)) {
      <span class="keyword">var</span> o = {};
      o[<span class="keyword">this</span>.path] = v;
      <span class="keyword">return</span> cast(<span class="keyword">this</span>.casterConstructor.schema, o)[<span class="keyword">this</span>.path];
    }
    <span class="keyword">return</span> v;
  }, <span class="keyword">this</span>);

  <span class="keyword">return</span> <span class="keyword">this</span>.castForQuery(val);
}

<span class="function"><span class="keyword">function</span> <span class="title">cast$elemMatch</span><span class="params">(val)</span> {</span>
  <span class="keyword">var</span> keys = Object.keys(val);
  <span class="keyword">var</span> numKeys = keys.length;
  <span class="keyword">var</span> key;
  <span class="keyword">var</span> value;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numKeys; ++i) {
    key = keys[i];
    value = val[key];
    <span class="keyword">if</span> (key.indexOf(<span class="string">'$'</span>) === <span class="number">0</span> &amp;&amp; value) {
      val[key] = <span class="keyword">this</span>.castForQuery(key, value);
    }
  }

  <span class="keyword">return</span> cast(<span class="keyword">this</span>.casterConstructor.schema, val);
}

<span class="keyword">var</span> handle = SchemaArray.prototype.$conditionalHandlers = {};

handle.$all = cast$all;
handle.$options = String;
handle.$elemMatch = cast$elemMatch;
handle.$geoIntersects = geospatial.cast$geoIntersects;
handle.$or = handle.$and = <span class="keyword">function</span>(val) {
  <span class="keyword">if</span> (!Array.isArray(val)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'conditional $or/$and require array'</span>);
  }

  <span class="keyword">var</span> ret = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; val.length; ++i) {
    ret.push(cast(<span class="keyword">this</span>.casterConstructor.schema, val[i]));
  }

  <span class="keyword">return</span> ret;
};

handle.$near =
handle.$nearSphere = geospatial.cast$near;

handle.$within =
handle.$geoWithin = geospatial.cast$within;

handle.$size =
handle.$minDistance =
handle.$maxDistance = castToNumber;

handle.$exists = $exists;
handle.$type = $type;

handle.$eq =
handle.$gt =
handle.$gte =
handle.$<span class="keyword">in</span> =
handle.$lt =
handle.$lte =
handle.$ne =
handle.$nin =
handle.$regex = SchemaArray.prototype.castForQuery;</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_array_SchemaArray-checkRequired"><a href="#schema_array_SchemaArray-checkRequired">SchemaArray#checkRequired(<code>value</code>)</a></h3><p>Check if the given value satisfies a required validator. The given value<br />must be not null nor undefined, and have a positive length.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.prototype.checkRequired = <span class="keyword">function</span>(value) {
  <span class="keyword">return</span> !!(value &amp;&amp; value.length);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_array_SchemaArray"><a href="#schema_array_SchemaArray">SchemaArray(<code>key</code>, <code>cast</code>, <code>options</code>)</a></h3><p>Array SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>cast</code><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaArray</span><span class="params">(key, cast, options, schemaOptions)</span> {</span>
  <span class="comment">// lazy load</span>
  EmbeddedDoc || (EmbeddedDoc = require(<span class="string">'../types'</span>).Embedded);

  <span class="keyword">var</span> typeKey = <span class="string">'type'</span>;
  <span class="keyword">if</span> (schemaOptions &amp;&amp; schemaOptions.typeKey) {
    typeKey = schemaOptions.typeKey;
  }

  <span class="keyword">if</span> (cast) {
    <span class="keyword">var</span> castOptions = {};

    <span class="keyword">if</span> (utils.getFunctionName(cast.constructor) === <span class="string">'Object'</span>) {
      <span class="keyword">if</span> (cast[typeKey]) {
        <span class="comment">// support { type: Woot }</span>
        castOptions = utils.clone(cast); <span class="comment">// do not alter user arguments</span>
        <span class="keyword">delete</span> castOptions[typeKey];
        cast = cast[typeKey];
      } <span class="keyword">else</span> {
        cast = Mixed;
      }
    }

    <span class="comment">// support { type: 'String' }</span>
    <span class="keyword">var</span> name = <span class="keyword">typeof</span> cast === <span class="string">'string'</span>
        ? cast
        : utils.getFunctionName(cast);

    <span class="keyword">var</span> caster = name <span class="keyword">in</span> Types
        ? Types[name]
        : cast;

    <span class="keyword">this</span>.casterConstructor = caster;
    <span class="keyword">if</span> (<span class="keyword">typeof</span> caster === <span class="string">'function'</span> &amp;&amp; !caster.$isArraySubdocument) {
      <span class="keyword">this</span>.caster = <span class="keyword">new</span> caster(<span class="literal">null</span>, castOptions);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.caster = caster;
    }

    <span class="keyword">if</span> (!(<span class="keyword">this</span>.caster <span class="keyword">instanceof</span> EmbeddedDoc)) {
      <span class="keyword">this</span>.caster.path = key;
    }
  }

  <span class="keyword">this</span>.$isMongooseArray = <span class="literal">true</span>;

  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Array'</span>);

  <span class="keyword">var</span> defaultArr;
  <span class="keyword">var</span> fn;

  <span class="keyword">if</span> (<span class="keyword">this</span>.defaultValue != <span class="literal">null</span>) {
    defaultArr = <span class="keyword">this</span>.defaultValue;
    fn = <span class="keyword">typeof</span> defaultArr === <span class="string">'function'</span>;
  }

  <span class="keyword">if</span> (!(<span class="string">'defaultValue'</span> <span class="keyword">in</span> <span class="keyword">this</span>) || <span class="keyword">this</span>.defaultValue !== <span class="keyword">void</span> <span class="number">0</span>) {
    <span class="keyword">this</span>.<span class="keyword">default</span>(<span class="keyword">function</span>() {
      <span class="keyword">var</span> arr = [];
      <span class="keyword">if</span> (fn) {
        arr = defaultArr();
      } <span class="keyword">else</span> <span class="keyword">if</span> (defaultArr != <span class="literal">null</span>) {
        arr = arr.concat(defaultArr);
      }
      <span class="comment">// Leave it up to `cast()` to convert the array</span>
      <span class="keyword">return</span> arr;
    });
  }
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_array_SchemaArray.schemaName"><a href="#schema_array_SchemaArray.schemaName">SchemaArray.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaArray.schemaName = <span class="string">'Array'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/decimal128.js" id="schema-decimal128-js">schema/decimal128.js</a><div class="item method private"><h3 id="schema_decimal128_Decimal128-cast"><a href="#schema_decimal128_Decimal128-cast">Decimal128#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts to Decimal128</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether this is an initialization cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Decimal128.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, init)) {
    <span class="comment">// wait! we may need to cast this to a document</span>

    <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
      <span class="keyword">return</span> value;
    }

    <span class="comment">// lazy load</span>
    Document || (Document = require(<span class="string">'./../document'</span>));

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="literal">true</span>;
      <span class="keyword">return</span> value;
    }

    <span class="comment">// setting a populated path</span>
    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Decimal128Type) {
      <span class="keyword">return</span> value;
    } <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(value) || !utils.isObject(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'Decimal128'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="comment">// Handle the case where user directly sets a populated</span>
    <span class="comment">// path to a plain object; cast to the Model used in</span>
    <span class="comment">// the population query.</span>
    <span class="keyword">var</span> path = doc.$__fullPath(<span class="keyword">this</span>.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="keyword">var</span> pop = owner.populated(path, <span class="literal">true</span>);
    <span class="keyword">var</span> ret = value;
    <span class="keyword">if</span> (!doc.$__.populated ||
        !doc.$__.populated[path] ||
        !doc.$__.populated[path].options ||
        !doc.$__.populated[path].options.options ||
        !doc.$__.populated[path].options.options.lean) {
      ret = <span class="keyword">new</span> pop.options.model(value);
      ret.$__.wasPopulated = <span class="literal">true</span>;
    }

    <span class="keyword">return</span> ret;
  }

  <span class="keyword">if</span> (value == <span class="literal">null</span>) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> value.$numberDecimal === <span class="string">'string'</span>) {
    <span class="keyword">return</span> Decimal128Type.fromString(value.$numberDecimal);
  }

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Decimal128Type) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) {
    <span class="keyword">return</span> Decimal128Type.fromString(value);
  }

  <span class="keyword">if</span> (Buffer.isBuffer(value)) {
    <span class="keyword">return</span> <span class="keyword">new</span> Decimal128Type(value);
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'Decimal128'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_decimal128_Decimal128-checkRequired"><a href="#schema_decimal128_Decimal128-checkRequired">Decimal128#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies a required validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Decimal128.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span><span class="params">(value, doc)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, <span class="literal">true</span>)) {
    <span class="keyword">return</span> !!value;
  }
  <span class="keyword">return</span> value <span class="keyword">instanceof</span> Decimal128Type;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_decimal128_Decimal128"><a href="#schema_decimal128_Decimal128">Decimal128(<code>key</code>, <code>options</code>)</a></h3><p>Decimal128 SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Decimal128</span><span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Decimal128'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_decimal128_Decimal128.schemaName"><a href="#schema_decimal128_Decimal128.schemaName">Decimal128.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Decimal128.schemaName = <span class="string">'Decimal128'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/number.js" id="schema-number-js">schema/number.js</a><div class="item method private"><h3 id="schema_number_SchemaNumber-cast"><a href="#schema_number_SchemaNumber-cast">SchemaNumber#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts to number</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>value to cast</span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>document that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, init)) {
    <span class="comment">// wait! we may need to cast this to a document</span>

    <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
      <span class="keyword">return</span> value;
    }

    <span class="comment">// lazy load</span>
    Document || (Document = require(<span class="string">'./../document'</span>));

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="literal">true</span>;
      <span class="keyword">return</span> value;
    }

    <span class="comment">// setting a populated path</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'number'</span>) {
      <span class="keyword">return</span> value;
    } <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(value) || !utils.isObject(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'number'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="comment">// Handle the case where user directly sets a populated</span>
    <span class="comment">// path to a plain object; cast to the Model used in</span>
    <span class="comment">// the population query.</span>
    <span class="keyword">var</span> path = doc.$__fullPath(<span class="keyword">this</span>.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="keyword">var</span> pop = owner.populated(path, <span class="literal">true</span>);
    <span class="keyword">var</span> ret = <span class="keyword">new</span> pop.options.model(value);
    ret.$__.wasPopulated = <span class="literal">true</span>;
    <span class="keyword">return</span> ret;
  }

  <span class="keyword">var</span> val = value &amp;&amp; <span class="keyword">typeof</span> value._id !== <span class="string">'undefined'</span> ?
    value._id : <span class="comment">// documents</span>
    value;

  <span class="keyword">if</span> (!isNaN(val)) {
    <span class="keyword">if</span> (val === <span class="literal">null</span>) {
      <span class="keyword">return</span> val;
    }
    <span class="keyword">if</span> (val === <span class="string">''</span>) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'string'</span> || <span class="keyword">typeof</span> val === <span class="string">'boolean'</span>) {
      val = Number(val);
    }
    <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Number) {
      <span class="keyword">return</span> val;
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'number'</span>) {
      <span class="keyword">return</span> val;
    }
    <span class="keyword">if</span> (val.toString &amp;&amp; !Array.isArray(val) &amp;&amp; val.toString() == Number(val)) {
      <span class="keyword">return</span> <span class="keyword">new</span> Number(val);
    }
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'number'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_number_SchemaNumber-castForQuery"><a href="#schema_number_SchemaNumber-castForQuery">SchemaNumber#castForQuery(<code>$conditional</code>, <code>[value]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[value]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with Number.'</span>);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  val = <span class="keyword">this</span>._castForQuery($conditional);
  <span class="keyword">return</span> val;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_number_SchemaNumber-checkRequired"><a href="#schema_number_SchemaNumber-checkRequired">SchemaNumber#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies a required validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span><span class="params">(value, doc)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, <span class="literal">true</span>)) {
    <span class="keyword">return</span> !!value;
  }
  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'number'</span> || value <span class="keyword">instanceof</span> Number;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_number_SchemaNumber-max"><a href="#schema_number_SchemaNumber-max">SchemaNumber#max(<code>maximum</code>, <code>[message]</code>)</a></h3><p>Sets a maximum number validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>maximum</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ n: { type: Number, max: <span class="number">10</span> })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ n: <span class="number">11</span> })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  m.n = <span class="number">10</span>;
  m.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MAX} token which will be replaced with the invalid value</span>
<span class="keyword">var</span> max = [<span class="number">10</span>, <span class="string">'The value of path `{PATH}` ({VALUE}) exceeds the limit ({MAX}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ n: { type: Number, max: max })
<span class="keyword">var</span> M = mongoose.model(<span class="string">'Measurement'</span>, schema);
<span class="keyword">var</span> s= <span class="keyword">new</span> M({ n: <span class="number">4</span> });
s.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `n` (4) exceeds the limit (10).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.max = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.maxValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.maxValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value !== <span class="literal">null</span> &amp;&amp; value !== <span class="literal">undefined</span>) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.Number.max;
    msg = msg.replace(<span class="regexp">/{MAX}/</span>, value);
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.maxValidator = <span class="keyword">function</span>(v) {
        <span class="keyword">return</span> v == <span class="literal">null</span> || v &lt;= value;
      },
      message: msg,
      type: <span class="string">'max'</span>,
      max: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_number_SchemaNumber-min"><a href="#schema_number_SchemaNumber-min">SchemaNumber#min(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a minimum number validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>minimum number</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ n: { type: Number, min: <span class="number">10</span> })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ n: <span class="number">9</span> })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  m.n = <span class="number">10</span>;
  m.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MIN} token which will be replaced with the invalid value</span>
<span class="keyword">var</span> min = [<span class="number">10</span>, <span class="string">'The value of path `{PATH}` ({VALUE}) is beneath the limit ({MIN}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ n: { type: Number, min: min })
<span class="keyword">var</span> M = mongoose.model(<span class="string">'Measurement'</span>, schema);
<span class="keyword">var</span> s= <span class="keyword">new</span> M({ n: <span class="number">4</span> });
s.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `n` (4) is beneath the limit (10).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.prototype.min = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.minValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.minValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value !== <span class="literal">null</span> &amp;&amp; value !== <span class="literal">undefined</span>) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.Number.min;
    msg = msg.replace(<span class="regexp">/{MIN}/</span>, value);
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.minValidator = <span class="keyword">function</span>(v) {
        <span class="keyword">return</span> v == <span class="literal">null</span> || v >= value;
      },
      message: msg,
      type: <span class="string">'min'</span>,
      min: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_number_SchemaNumber"><a href="#schema_number_SchemaNumber">SchemaNumber(<code>key</code>, <code>options</code>)</a></h3><p>Number SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaNumber</span><span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Number'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_number_SchemaNumber.schemaName"><a href="#schema_number_SchemaNumber.schemaName">SchemaNumber.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaNumber.schemaName = <span class="string">'Number'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/objectid.js" id="schema-objectid-js">schema/objectid.js</a><div class="item method public"><h3 id="schema_objectid_ObjectId-auto"><a href="#schema_objectid_ObjectId-auto">ObjectId#auto(<code>turnOn</code>)</a></h3><p>Adds an auto-generated ObjectId default if turnOn is true.</p><div class="params"><h4>Parameters:</h4><ul><li><code>turnOn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>auto generated ObjectId defaults</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.auto = <span class="keyword">function</span>(turnOn) {
  <span class="keyword">if</span> (turnOn) {
    <span class="keyword">this</span>.<span class="keyword">default</span>(defaultId);
    <span class="keyword">this</span>.set(resetId);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_objectid_ObjectId-cast"><a href="#schema_objectid_ObjectId-cast">ObjectId#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts to ObjectId</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>whether this is an initialization cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, init)) {
    <span class="comment">// wait! we may need to cast this to a document</span>

    <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
      <span class="keyword">return</span> value;
    }

    <span class="comment">// lazy load</span>
    Document || (Document = require(<span class="string">'./../document'</span>));

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="literal">true</span>;
      <span class="keyword">return</span> value;
    }

    <span class="comment">// setting a populated path</span>
    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> oid) {
      <span class="keyword">return</span> value;
    } <span class="keyword">else</span> <span class="keyword">if</span> ((value.constructor.name || <span class="string">''</span>).toLowerCase() === <span class="string">'objectid'</span>) {
      <span class="keyword">return</span> <span class="keyword">new</span> oid(value.toHexString());
    } <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(value) || !utils.isObject(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'ObjectId'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="comment">// Handle the case where user directly sets a populated</span>
    <span class="comment">// path to a plain object; cast to the Model used in</span>
    <span class="comment">// the population query.</span>
    <span class="keyword">var</span> path = doc.$__fullPath(<span class="keyword">this</span>.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="keyword">var</span> pop = owner.populated(path, <span class="literal">true</span>);
    <span class="keyword">var</span> ret = value;
    <span class="keyword">if</span> (!doc.$__.populated ||
        !doc.$__.populated[path] ||
        !doc.$__.populated[path].options ||
        !doc.$__.populated[path].options.options ||
        !doc.$__.populated[path].options.options.lean) {
      ret = <span class="keyword">new</span> pop.options.model(value);
      ret.$__.wasPopulated = <span class="literal">true</span>;
    }

    <span class="keyword">return</span> ret;
  }

  <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> oid) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (value._id) {
    <span class="keyword">if</span> (value._id <span class="keyword">instanceof</span> oid) {
      <span class="keyword">return</span> value._id;
    }
    <span class="keyword">if</span> (value._id.toString <span class="keyword">instanceof</span> Function) {
      <span class="keyword">try</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> oid(value._id.toString());
      } <span class="keyword">catch</span> (e) {
      }
    }
  }

  <span class="keyword">if</span> (value.toString <span class="keyword">instanceof</span> Function) {
    <span class="keyword">try</span> {
      <span class="keyword">return</span> <span class="keyword">new</span> oid(value.toString());
    } <span class="keyword">catch</span> (err) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'ObjectId'</span>, value, <span class="keyword">this</span>.path);
    }
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'ObjectId'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_objectid_ObjectId-castForQuery"><a href="#schema_objectid_ObjectId-castForQuery">ObjectId#castForQuery(<code>$conditional</code>, <code>[val]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with ObjectId.'</span>);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery($conditional);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_objectid_ObjectId-checkRequired"><a href="#schema_objectid_ObjectId-checkRequired">ObjectId#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies a required validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span><span class="params">(value, doc)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, <span class="literal">true</span>)) {
    <span class="keyword">return</span> !!value;
  }
  <span class="keyword">return</span> value <span class="keyword">instanceof</span> oid;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_objectid_ObjectId"><a href="#schema_objectid_ObjectId">ObjectId(<code>key</code>, <code>options</code>)</a></h3><p>ObjectId SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ObjectId</span><span class="params">(key, options)</span> {</span>
  <span class="keyword">var</span> isKeyHexStr = <span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp; key.length === <span class="number">24</span> &amp;&amp; <span class="regexp">/^a-f0-9$/i</span>.test(key);
  <span class="keyword">var</span> suppressWarning = options &amp;&amp; options.suppressWarning;
  <span class="keyword">if</span> ((isKeyHexStr || <span class="keyword">typeof</span> key === <span class="string">'undefined'</span>) &amp;&amp; !suppressWarning) {
    console.warn(<span class="string">'mongoose: To create a new ObjectId please try '</span> +
      <span class="string">'`Mongoose.Types.ObjectId` instead of using '</span> +
      <span class="string">'`Mongoose.Schema.ObjectId`. Set the `suppressWarning` option if '</span> +
      <span class="string">'you\'re trying to create a hex char path in your schema.'</span>);
    console.trace();
  }
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'ObjectID'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_objectid_ObjectId.schemaName"><a href="#schema_objectid_ObjectId.schemaName">ObjectId.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ObjectId.schemaName = <span class="string">'ObjectId'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/string.js" id="schema-string-js">schema/string.js</a><div class="item method private"><h3 id="schema_string_SchemaString-cast"><a href="#schema_string_SchemaString-cast">SchemaString#cast()</a></h3><p>Casts to String</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, init)) {
    <span class="comment">// wait! we may need to cast this to a document</span>

    <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
      <span class="keyword">return</span> value;
    }

    <span class="comment">// lazy load</span>
    Document || (Document = require(<span class="string">'./../document'</span>));

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="literal">true</span>;
      <span class="keyword">return</span> value;
    }

    <span class="comment">// setting a populated path</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) {
      <span class="keyword">return</span> value;
    } <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(value) || !utils.isObject(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'string'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="comment">// Handle the case where user directly sets a populated</span>
    <span class="comment">// path to a plain object; cast to the Model used in</span>
    <span class="comment">// the population query.</span>
    <span class="keyword">var</span> path = doc.$__fullPath(<span class="keyword">this</span>.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="keyword">var</span> pop = owner.populated(path, <span class="literal">true</span>);
    <span class="keyword">var</span> ret = <span class="keyword">new</span> pop.options.model(value);
    ret.$__.wasPopulated = <span class="literal">true</span>;
    <span class="keyword">return</span> ret;
  }

  <span class="comment">// If null or undefined</span>
  <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'undefined'</span>) {
    <span class="comment">// handle documents being passed</span>
    <span class="keyword">if</span> (value._id &amp;&amp; <span class="keyword">typeof</span> value._id === <span class="string">'string'</span>) {
      <span class="keyword">return</span> value._id;
    }

    <span class="comment">// Re: gh-647 and gh-3030, we're ok with casting using `toString()`</span>
    <span class="comment">// **unless** its the default Object.toString, because "[object Object]"</span>
    <span class="comment">// doesn't really qualify as useful data</span>
    <span class="keyword">if</span> (value.toString &amp;&amp; value.toString !== Object.prototype.toString) {
      <span class="keyword">return</span> value.toString();
    }
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'string'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_string_SchemaString-castForQuery"><a href="#schema_string_SchemaString-castForQuery">SchemaString#castForQuery(<code>$conditional</code>, <code>[val]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with String.'</span>);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  val = $conditional;
  <span class="keyword">if</span> (Object.prototype.toString.call(val) === <span class="string">'[object RegExp]'</span>) {
    <span class="keyword">return</span> val;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery(val);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_string_SchemaString-checkRequired"><a href="#schema_string_SchemaString-checkRequired">SchemaString#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies the <code>required</code> validator. The value is<br />considered valid if it is a string (that is, not <code>null</code> or <code>undefined</code>) and<br />has positive length. The <code>required</code> validator <strong>will</strong> fail for empty<br />strings.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.checkRequired = <span class="function"><span class="keyword">function</span> <span class="title">checkRequired</span><span class="params">(value, doc)</span> {</span>
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, <span class="literal">true</span>)) {
    <span class="keyword">return</span> !!value;
  }
  <span class="keyword">return</span> (value <span class="keyword">instanceof</span> String || <span class="keyword">typeof</span> value === <span class="string">'string'</span>) &amp;&amp; value.length;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-enum"><a href="#schema_string_SchemaString-enum">SchemaString#enum(<code>[args...]</code>)</a></h3><p>Adds an enum validator</p><div class="params"><h4>Parameters:</h4><ul><li><code>[args...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>enumeration values</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> states = [<span class="string">'opening'</span>, <span class="string">'open'</span>, <span class="string">'closing'</span>, <span class="string">'closed'</span>]
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ state: { type: String, enum: states }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ state: <span class="string">'invalid'</span> })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(String(err)) <span class="comment">// ValidationError: `invalid` is not a valid enum value for path `state`.</span>
  m.state = <span class="string">'open'</span>
  m.save(callback) <span class="comment">// success</span>
})

<span class="comment">// or with custom error messages</span>
<span class="keyword">var</span> enum = {
  values: [<span class="string">'opening'</span>, <span class="string">'open'</span>, <span class="string">'closing'</span>, <span class="string">'closed'</span>],
  message: <span class="string">'enum validator failed for path `{PATH}` with value `{VALUE}`'</span>
}
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ state: { type: String, enum: enum })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ state: <span class="string">'invalid'</span> })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(String(err)) <span class="comment">// ValidationError: enum validator failed for path `state` with value `invalid`</span>
  m.state = <span class="string">'open'</span>
  m.save(callback) <span class="comment">// success</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.enum = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>.enumValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.enumValidator;
    }, <span class="keyword">this</span>);
    <span class="keyword">this</span>.enumValidator = <span class="literal">false</span>;
  }

  <span class="keyword">if</span> (arguments[<span class="number">0</span>] === <span class="keyword">void</span> <span class="number">0</span> || arguments[<span class="number">0</span>] === <span class="literal">false</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> values;
  <span class="keyword">var</span> errorMessage;

  <span class="keyword">if</span> (utils.isObject(arguments[<span class="number">0</span>])) {
    values = arguments[<span class="number">0</span>].values;
    errorMessage = arguments[<span class="number">0</span>].message;
  } <span class="keyword">else</span> {
    values = arguments;
    errorMessage = MongooseError.messages.String.enum;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) {
    <span class="keyword">if</span> (<span class="literal">undefined</span> !== values[i]) {
      <span class="keyword">this</span>.enumValues.push(<span class="keyword">this</span>.cast(values[i]));
    }
  }

  <span class="keyword">var</span> vals = <span class="keyword">this</span>.enumValues;
  <span class="keyword">this</span>.enumValidator = <span class="keyword">function</span>(v) {
    <span class="keyword">return</span> <span class="literal">undefined</span> === v || ~vals.indexOf(v);
  };
  <span class="keyword">this</span>.validators.push({
    validator: <span class="keyword">this</span>.enumValidator,
    message: errorMessage,
    type: <span class="string">'enum'</span>,
    enumValues: vals
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-lowercase"><a href="#schema_string_SchemaString-lowercase">SchemaString#lowercase()</a></h3><p>Adds a lowercase <a href="../../api.html#schematype_SchemaType-set">setter</a>.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>var s = new Schema({ email: { type: String, lowercase: true }})
var M = db.model('M', s);
var m = new M({ email: '<a href='mailto:SomeEmail@example.COM'>SomeEmail@example.COM</a>' });
console.log(m.email) // <a href='mailto:someemail@example.com'>someemail@example.com</a>
</code></pre>

<p>NOTE: Setters do not run on queries by default. Use the <code>runSettersOnQuery</code> option:</p>

<pre><code> // Must use `runSettersOnQuery` as shown below, otherwise `email` will
 // **not** be lowercased.
 M.updateOne({}, { $set: { email: '<a href='mailto:SomeEmail@example.COM'>SomeEmail@example.COM</a>' } }, { runSettersOnQuery: true });
</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.lowercase = <span class="keyword">function</span>(shouldApply) {
  <span class="keyword">if</span> (arguments.length > <span class="number">0</span> &amp;&amp; !shouldApply) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="keyword">function</span>(v, self) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> v !== <span class="string">'string'</span>) {
      v = self.cast(v);
    }
    <span class="keyword">if</span> (v) {
      <span class="keyword">return</span> v.toLowerCase();
    }
    <span class="keyword">return</span> v;
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-match"><a href="#schema_string_SchemaString-match">SchemaString#match(<code>regExp</code>, <code>[message]</code>)</a></h3><p>Sets a regexp validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>regExp</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>&gt; </span><span>regular expression to test against</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><p>Any value that does not pass <code>regExp</code>.test(val) will fail validation.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, match: <span class="regexp">/^a/</span> }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ name: <span class="string">'I am invalid'</span> })
m.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(String(err)) <span class="comment">// "ValidationError: Path `name` is invalid (I am invalid)."</span>
  m.name = <span class="string">'apples'</span>
  m.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    assert.ok(err) <span class="comment">// success</span>
  })
})

<span class="comment">// using a custom error message</span>
<span class="keyword">var</span> match = [ <span class="regexp">/\.html$/</span>, <span class="string">"That file doesn't end in .html ({VALUE})"</span> ];
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ file: { type: String, match: match }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s);
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ file: <span class="string">'invalid'</span> });
m.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// "ValidationError: That file doesn't end in .html (invalid)"</span>
})</code></pre>

<p>Empty strings, <code>undefined</code>, and <code>null</code> values always pass the match validator. If you require these values, enable the <code>required</code> validator also.</p>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, match: <span class="regexp">/^a/</span>, required: <span class="literal">true</span> }})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.match = <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(regExp, message)</span> {</span>
  <span class="comment">// yes, we allow multiple match validators</span>

  <span class="keyword">var</span> msg = message || MongooseError.messages.String.match;

  <span class="keyword">var</span> matchValidator = <span class="keyword">function</span>(v) {
    <span class="keyword">if</span> (!regExp) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }

    <span class="keyword">var</span> ret = ((v != <span class="literal">null</span> &amp;&amp; v !== <span class="string">''</span>)
        ? regExp.test(v)
        : <span class="literal">true</span>);
    <span class="keyword">return</span> ret;
  };

  <span class="keyword">this</span>.validators.push({
    validator: matchValidator,
    message: msg,
    type: <span class="string">'regexp'</span>,
    regexp: regExp
  });
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-maxlength"><a href="#schema_string_SchemaString-maxlength">SchemaString#maxlength(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a maximum length validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>maximum string length</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ postalCode: { type: String, maxlength: <span class="number">9</span> })
<span class="keyword">var</span> Address = db.model(<span class="string">'Address'</span>, schema)
<span class="keyword">var</span> address = <span class="keyword">new</span> Address({ postalCode: <span class="string">'9512512345'</span> })
address.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  address.postalCode = <span class="string">'95125'</span>;
  address.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MAXLENGTH} token which will be replaced with the maximum allowed length</span>
<span class="keyword">var</span> maxlength = [<span class="number">9</span>, <span class="string">'The value of path `{PATH}` (`{VALUE}`) exceeds the maximum allowed length ({MAXLENGTH}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ postalCode: { type: String, maxlength: maxlength })
<span class="keyword">var</span> Address = mongoose.model(<span class="string">'Address'</span>, schema);
<span class="keyword">var</span> address = <span class="keyword">new</span> Address({ postalCode: <span class="string">'9512512345'</span> });
address.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `postalCode` (`9512512345`) exceeds the maximum allowed length (9).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.maxlength = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.maxlengthValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.maxlengthValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value !== <span class="literal">null</span> &amp;&amp; value !== <span class="literal">undefined</span>) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.String.maxlength;
    msg = msg.replace(<span class="regexp">/{MAXLENGTH}/</span>, value);
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.maxlengthValidator = <span class="keyword">function</span>(v) {
        <span class="keyword">return</span> v === <span class="literal">null</span> || v.length &lt;= value;
      },
      message: msg,
      type: <span class="string">'maxlength'</span>,
      maxlength: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-minlength"><a href="#schema_string_SchemaString-minlength">SchemaString#minlength(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a minimum length validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>minimum string length</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ postalCode: { type: String, minlength: <span class="number">5</span> })
<span class="keyword">var</span> Address = db.model(<span class="string">'Address'</span>, schema)
<span class="keyword">var</span> address = <span class="keyword">new</span> Address({ postalCode: <span class="string">'9512'</span> })
address.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  address.postalCode = <span class="string">'95125'</span>;
  address.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MINLENGTH} token which will be replaced with the minimum allowed length</span>
<span class="keyword">var</span> minlength = [<span class="number">5</span>, <span class="string">'The value of path `{PATH}` (`{VALUE}`) is shorter than the minimum allowed length ({MINLENGTH}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ postalCode: { type: String, minlength: minlength })
<span class="keyword">var</span> Address = mongoose.model(<span class="string">'Address'</span>, schema);
<span class="keyword">var</span> address = <span class="keyword">new</span> Address({ postalCode: <span class="string">'9512'</span> });
address.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `postalCode` (`9512`) is shorter than the minimum length (5).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.minlength = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.minlengthValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.minlengthValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value !== <span class="literal">null</span> &amp;&amp; value !== <span class="literal">undefined</span>) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.String.minlength;
    msg = msg.replace(<span class="regexp">/{MINLENGTH}/</span>, value);
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.minlengthValidator = <span class="keyword">function</span>(v) {
        <span class="keyword">return</span> v === <span class="literal">null</span> || v.length >= value;
      },
      message: msg,
      type: <span class="string">'minlength'</span>,
      minlength: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString"><a href="#schema_string_SchemaString">SchemaString(<code>key</code>, <code>options</code>)</a></h3><p>String SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaString</span><span class="params">(key, options)</span> {</span>
  <span class="keyword">this</span>.enumValues = [];
  <span class="keyword">this</span>.regExp = <span class="literal">null</span>;
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'String'</span>);
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-trim"><a href="#schema_string_SchemaString-trim">SchemaString#trim()</a></h3><p>Adds a trim <a href="../../api.html#schematype_SchemaType-set">setter</a>.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>The string value will be trimmed when set.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, trim: <span class="literal">true</span> }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> string = <span class="string">' some name '</span>
console.log(string.length) <span class="comment">// 11</span>
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ name: string })
console.log(m.name.length) <span class="comment">// 9</span></code></pre>

<p>NOTE: Setters do not run on queries by default. Use the <code>runSettersOnQuery</code> option:</p>

<pre><code> // Must use `runSettersOnQuery` as shown below, otherwise `email` will
 // **not** be lowercased.
 M.updateOne({}, { $set: { email: '<a href='mailto:SomeEmail@example.COM'>SomeEmail@example.COM</a>' } }, { runSettersOnQuery: true });
</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.trim = <span class="keyword">function</span>(shouldTrim) {
  <span class="keyword">if</span> (arguments.length > <span class="number">0</span> &amp;&amp; !shouldTrim) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="keyword">function</span>(v, self) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> v !== <span class="string">'string'</span>) {
      v = self.cast(v);
    }
    <span class="keyword">if</span> (v) {
      <span class="keyword">return</span> v.trim();
    }
    <span class="keyword">return</span> v;
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_string_SchemaString-uppercase"><a href="#schema_string_SchemaString-uppercase">SchemaString#uppercase()</a></h3><p>Adds an uppercase <a href="../../api.html#schematype_SchemaType-set">setter</a>.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ caps: { type: String, uppercase: <span class="literal">true</span> }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s);
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ caps: <span class="string">'an example'</span> });
console.log(m.caps) <span class="comment">// AN EXAMPLE</span></code></pre>

<p>NOTE: Setters do not run on queries by default. Use the <code>runSettersOnQuery</code> option:</p>

<pre><code> // Must use `runSettersOnQuery` as shown below, otherwise `email` will
 // **not** be lowercased.
 M.updateOne({}, { $set: { email: '<a href='mailto:SomeEmail@example.COM'>SomeEmail@example.COM</a>' } }, { runSettersOnQuery: true });
</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.prototype.uppercase = <span class="keyword">function</span>(shouldApply) {
  <span class="keyword">if</span> (arguments.length > <span class="number">0</span> &amp;&amp; !shouldApply) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.set(<span class="keyword">function</span>(v, self) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> v !== <span class="string">'string'</span>) {
      v = self.cast(v);
    }
    <span class="keyword">if</span> (v) {
      <span class="keyword">return</span> v.toUpperCase();
    }
    <span class="keyword">return</span> v;
  });
};</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_string_SchemaString.schemaName"><a href="#schema_string_SchemaString.schemaName">SchemaString.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaString.schemaName = <span class="string">'String'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/date.js" id="schema-date-js">schema/date.js</a><div class="item method private"><h3 id="schema_date_SchemaDate-cast"><a href="#schema_date_SchemaDate-cast">SchemaDate#cast(<code>value</code>)</a></h3><p>Casts to date</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.cast = <span class="keyword">function</span>(value) {
  <span class="comment">// If null or undefined</span>
  <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="keyword">void</span> <span class="number">0</span> || value === <span class="string">''</span>) {
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Date) {
    <span class="keyword">if</span> (isNaN(value.valueOf())) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'date'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="keyword">return</span> value;
  }

  <span class="keyword">var</span> date;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'boolean'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'date'</span>, value, <span class="keyword">this</span>.path);
  }

  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number || <span class="keyword">typeof</span> value === <span class="string">'number'</span>
      || String(value) == Number(value)) {
    <span class="comment">// support for timestamps</span>
    date = <span class="keyword">new</span> Date(Number(value));
  } <span class="keyword">else</span> <span class="keyword">if</span> (value.valueOf) {
    <span class="comment">// support for moment.js</span>
    date = <span class="keyword">new</span> Date(value.valueOf());
  }

  <span class="keyword">if</span> (!isNaN(date.valueOf())) {
    <span class="keyword">return</span> date;
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'date'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_date_SchemaDate-castForQuery"><a href="#schema_date_SchemaDate-castForQuery">SchemaDate#castForQuery(<code>$conditional</code>, <code>[value]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[value]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;

  <span class="keyword">if</span> (arguments.length !== <span class="number">2</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery($conditional);
  }

  handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];

  <span class="keyword">if</span> (!handler) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with Date.'</span>);
  }

  <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_date_SchemaDate-checkRequired"><a href="#schema_date_SchemaDate-checkRequired">SchemaDate#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies a required validator. To satisfy<br />a required validator, the given value must be an instance of <code>Date</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.checkRequired = <span class="keyword">function</span>(value) {
  <span class="keyword">return</span> value <span class="keyword">instanceof</span> Date;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_date_SchemaDate-expires"><a href="#schema_date_SchemaDate-expires">SchemaDate#expires(<code>when</code>)</a></h3><p>Declares a TTL index (rounded to the nearest second) for <em>Date</em> types only.</p><div class="params"><h4>Parameters:</h4><ul><li><code>when</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>This sets the <code>expireAfterSeconds</code> index option available in MongoDB >= 2.1.2.<br />This index type is only compatible with Date types.</p>

<h4>Example:</h4>

<pre><code><span class="comment">// expire in 24 hours</span>
<span class="keyword">new</span> Schema({ createdAt: { type: Date, expires: <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span> }});</code></pre>

<p><code>expires</code> utilizes the <code>ms</code> module from <a href="https://github.com/guille/">guille</a> allowing us to use a friendlier syntax:</p>

<h4>Example:</h4>

<pre><code><span class="comment">// expire in 24 hours</span>
<span class="keyword">new</span> Schema({ createdAt: { type: Date, expires: <span class="string">'24h'</span> }});

<span class="comment">// expire in 1.5 hours</span>
<span class="keyword">new</span> Schema({ createdAt: { type: Date, expires: <span class="string">'1.5h'</span> }});

<span class="comment">// expire in 7 days</span>
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ createdAt: Date });
schema.path(<span class="string">'createdAt'</span>).expires(<span class="string">'7d'</span>);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.expires = <span class="keyword">function</span>(when) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>._index || <span class="keyword">this</span>._index.constructor.name !== <span class="string">'Object'</span>) {
    <span class="keyword">this</span>._index = {};
  }

  <span class="keyword">this</span>._index.expires = when;
  utils.expires(<span class="keyword">this</span>._index);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_date_SchemaDate-max"><a href="#schema_date_SchemaDate-max">SchemaDate#max(<code>maximum</code>, <code>[message]</code>)</a></h3><p>Sets a maximum date validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>maximum</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Date</a>&gt; </span><span>date</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ d: { type: Date, max: Date(<span class="string">'2014-01-01'</span>) })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ d: Date(<span class="string">'2014-12-08'</span>) })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  m.d = Date(<span class="string">'2013-12-31'</span>);
  m.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MAX} token which will be replaced with the invalid value</span>
<span class="keyword">var</span> max = [Date(<span class="string">'2014-01-01'</span>), <span class="string">'The value of path `{PATH}` ({VALUE}) exceeds the limit ({MAX}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ d: { type: Date, max: max })
<span class="keyword">var</span> M = mongoose.model(<span class="string">'M'</span>, schema);
<span class="keyword">var</span> s= <span class="keyword">new</span> M({ d: Date(<span class="string">'2014-12-08'</span>) });
s.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `d` (2014-12-08) exceeds the limit (2014-01-01).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.max = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.maxValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.maxValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.Date.max;
    msg = msg.replace(<span class="regexp">/{MAX}/</span>, (value === Date.now ? <span class="string">'Date.now()'</span> : <span class="keyword">this</span>.cast(value).toString()));
    <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.maxValidator = <span class="keyword">function</span>(val) {
        <span class="keyword">var</span> max = (value === Date.now ? value() : _<span class="keyword">this</span>.cast(value));
        <span class="keyword">return</span> val === <span class="literal">null</span> || val.valueOf() &lt;= max.valueOf();
      },
      message: msg,
      type: <span class="string">'max'</span>,
      max: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_date_SchemaDate-min"><a href="#schema_date_SchemaDate-min">SchemaDate#min(<code>value</code>, <code>[message]</code>)</a></h3><p>Sets a minimum date validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">Date</a>&gt; </span><span>minimum date</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ d: { type: Date, min: Date(<span class="string">'1970-01-01'</span>) })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s)
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ d: Date(<span class="string">'1969-12-31'</span>) })
m.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.error(err) <span class="comment">// validator error</span>
  m.d = Date(<span class="string">'2014-12-08'</span>);
  m.save() <span class="comment">// success</span>
})

<span class="comment">// custom error messages</span>
<span class="comment">// We can also use the special {MIN} token which will be replaced with the invalid value</span>
<span class="keyword">var</span> min = [Date(<span class="string">'1970-01-01'</span>), <span class="string">'The value of path `{PATH}` ({VALUE}) is beneath the limit ({MIN}).'</span>];
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ d: { type: Date, min: min })
<span class="keyword">var</span> M = mongoose.model(<span class="string">'M'</span>, schema);
<span class="keyword">var</span> s= <span class="keyword">new</span> M({ d: Date(<span class="string">'1969-12-31'</span>) });
s.validate(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  console.log(String(err)) <span class="comment">// ValidationError: The value of path `d` (1969-12-31) is before the limit (1970-01-01).</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.prototype.min = <span class="keyword">function</span>(value, message) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.minValidator) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.minValidator;
    }, <span class="keyword">this</span>);
  }

  <span class="keyword">if</span> (value) {
    <span class="keyword">var</span> msg = message || MongooseError.messages.Date.min;
    msg = msg.replace(<span class="regexp">/{MIN}/</span>, (value === Date.now ? <span class="string">'Date.now()'</span> : <span class="keyword">this</span>.cast(value).toString()));
    <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
    <span class="keyword">this</span>.validators.push({
      validator: <span class="keyword">this</span>.minValidator = <span class="keyword">function</span>(val) {
        <span class="keyword">var</span> min = (value === Date.now ? value() : _<span class="keyword">this</span>.cast(value));
        <span class="keyword">return</span> val === <span class="literal">null</span> || val.valueOf() >= min.valueOf();
      },
      message: msg,
      type: <span class="string">'min'</span>,
      min: value
    });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_date_SchemaDate"><a href="#schema_date_SchemaDate">SchemaDate(<code>key</code>, <code>options</code>)</a></h3><p>Date SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaDate</span><span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Date'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_date_SchemaDate.schemaName"><a href="#schema_date_SchemaDate.schemaName">SchemaDate.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaDate.schemaName = <span class="string">'Date'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/embedded.js" id="schema-embedded-js">schema/embedded.js</a><div class="item method private"><h3 id="schema_embedded_Embedded-cast"><a href="#schema_embedded_Embedded-cast">Embedded#cast(<code>value</code>)</a></h3><p>Casts contents</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Embedded.prototype.cast = <span class="keyword">function</span>(val, doc, init, priorVal) {
  <span class="keyword">if</span> (val &amp;&amp; val.$isSingleNested) {
    <span class="keyword">return</span> val;
  }

  <span class="keyword">var</span> Constructor = <span class="keyword">this</span>.caster;
  <span class="keyword">var</span> discriminatorKey = Constructor.schema.options.discriminatorKey;
  <span class="keyword">if</span> (val != <span class="literal">null</span> &amp;&amp;
      Constructor.discriminators &amp;&amp;
      <span class="keyword">typeof</span> val[discriminatorKey] === <span class="string">'string'</span> &amp;&amp;
      Constructor.discriminators[val[discriminatorKey]]) {
    Constructor = Constructor.discriminators[val[discriminatorKey]];
  }

  <span class="keyword">var</span> subdoc;
  <span class="keyword">if</span> (init) {
    subdoc = <span class="keyword">new</span> Constructor(<span class="keyword">void</span> <span class="number">0</span>, doc ? doc.$__.selected : <span class="keyword">void</span> <span class="number">0</span>, doc);
    subdoc.init(val);
  } <span class="keyword">else</span> {
    <span class="keyword">if</span> (Object.keys(val).length === <span class="number">0</span>) {
      <span class="keyword">return</span> <span class="keyword">new</span> Constructor({}, doc ? doc.$__.selected : <span class="keyword">void</span> <span class="number">0</span>, doc);
    }

    <span class="keyword">return</span> <span class="keyword">new</span> Constructor(val, doc ? doc.$__.selected : <span class="keyword">void</span> <span class="number">0</span>, doc, <span class="literal">undefined</span>, {
      priorDoc: priorVal
    });
  }

  <span class="keyword">return</span> subdoc;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_embedded_Embedded-castForQuery"><a href="#schema_embedded_Embedded-castForQuery">Embedded#castForQuery(<code>[$conditional]</code>, <code>value</code>)</a></h3><p>Casts contents for query</p><div class="params"><h4>Parameters:</h4><ul><li><code>[$conditional]</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>optional query operator (like <code>$eq</code> or <code>$in</code>)</span></li><li><code>value</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Embedded.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  val = $conditional;
  <span class="keyword">if</span> (val == <span class="literal">null</span>) {
    <span class="keyword">return</span> val;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.options.runSetters) {
    val = <span class="keyword">this</span>._applySetters(val);
  }

  <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>.caster(val);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_embedded_Embedded-discriminator"><a href="#schema_embedded_Embedded-discriminator">Embedded#discriminator(<code>name</code>, <code>schema</code>)</a></h3><p>Adds a discriminator to this property</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>fields to add to the schema for instances of this sub-class</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Embedded.prototype.discriminator = <span class="keyword">function</span>(name, schema) {
  discriminator(<span class="keyword">this</span>.caster, name, schema);

  <span class="keyword">this</span>.caster.discriminators[name] = _createConstructor(schema);

  <span class="keyword">return</span> <span class="keyword">this</span>.caster.discriminators[name];
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_embedded_Embedded-doValidate"><a href="#schema_embedded_Embedded-doValidate">Embedded#doValidate()</a></h3><p>Async validation on this single nested doc.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Embedded.prototype.doValidate = <span class="keyword">function</span>(value, fn, scope) {
  <span class="keyword">var</span> Constructor = <span class="keyword">this</span>.caster;
  <span class="keyword">var</span> discriminatorKey = Constructor.schema.options.discriminatorKey;
  <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp;
      Constructor.discriminators &amp;&amp;
      <span class="keyword">typeof</span> value[discriminatorKey] === <span class="string">'string'</span> &amp;&amp;
      Constructor.discriminators[value[discriminatorKey]]) {
    Constructor = Constructor.discriminators[value[discriminatorKey]];
  }

  SchemaType.prototype.doValidate.call(<span class="keyword">this</span>, value, <span class="keyword">function</span>(error) {
    <span class="keyword">if</span> (error) {
      <span class="keyword">return</span> fn(error);
    }
    <span class="keyword">if</span> (!value) {
      <span class="keyword">return</span> fn(<span class="literal">null</span>);
    }

    <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Constructor)) {
      value = <span class="keyword">new</span> Constructor(value);
    }
    value.validate({__noPromise: <span class="literal">true</span>}, fn);
  }, scope);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_embedded_Embedded-doValidateSync"><a href="#schema_embedded_Embedded-doValidateSync">Embedded#doValidateSync()</a></h3><p>Synchronously validate this single nested doc</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Embedded.prototype.doValidateSync = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">var</span> schemaTypeError = SchemaType.prototype.doValidateSync.call(<span class="keyword">this</span>, value, scope);
  <span class="keyword">if</span> (schemaTypeError) {
    <span class="keyword">return</span> schemaTypeError;
  }
  <span class="keyword">if</span> (!value) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">return</span> value.validateSync();
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_embedded_Embedded"><a href="#schema_embedded_Embedded">Embedded(<code>schema</code>, <code>key</code>, <code>options</code>)</a></h3><p>Sub-schema schematype constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Embedded</span><span class="params">(schema, path, options)</span> {</span>
  <span class="keyword">this</span>.caster = _createConstructor(schema);
  <span class="keyword">this</span>.caster.prototype.$basePath = path;
  <span class="keyword">this</span>.schema = schema;
  <span class="keyword">this</span>.$isSingleNested = <span class="literal">true</span>;
  SchemaType.call(<span class="keyword">this</span>, path, options, <span class="string">'Embedded'</span>);
}</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/buffer.js" id="schema-buffer-js">schema/buffer.js</a><div class="item method private"><h3 id="schema_buffer_SchemaBuffer-cast"><a href="#schema_buffer_SchemaBuffer-cast">SchemaBuffer#cast(<code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Casts contents</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span>document that triggers the casting</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.cast = <span class="keyword">function</span>(value, doc, init) {
  <span class="keyword">var</span> ret;
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, init)) {
    <span class="comment">// wait! we may need to cast this to a document</span>

    <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) {
      <span class="keyword">return</span> value;
    }

    <span class="comment">// lazy load</span>
    Document || (Document = require(<span class="string">'./../document'</span>));

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Document) {
      value.$__.wasPopulated = <span class="literal">true</span>;
      <span class="keyword">return</span> value;
    }

    <span class="comment">// setting a populated path</span>
    <span class="keyword">if</span> (Buffer.isBuffer(value)) {
      <span class="keyword">return</span> value;
    } <span class="keyword">else</span> <span class="keyword">if</span> (!utils.isObject(value)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'buffer'</span>, value, <span class="keyword">this</span>.path);
    }

    <span class="comment">// Handle the case where user directly sets a populated</span>
    <span class="comment">// path to a plain object; cast to the Model used in</span>
    <span class="comment">// the population query.</span>
    <span class="keyword">var</span> path = doc.$__fullPath(<span class="keyword">this</span>.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    <span class="keyword">var</span> pop = owner.populated(path, <span class="literal">true</span>);
    ret = <span class="keyword">new</span> pop.options.model(value);
    ret.$__.wasPopulated = <span class="literal">true</span>;
    <span class="keyword">return</span> ret;
  }

  <span class="comment">// documents</span>
  <span class="keyword">if</span> (value &amp;&amp; value._id) {
    value = value._id;
  }

  <span class="keyword">if</span> (value &amp;&amp; value.isMongooseBuffer) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">if</span> (Buffer.isBuffer(value)) {
    <span class="keyword">if</span> (!value || !value.isMongooseBuffer) {
      value = <span class="keyword">new</span> MongooseBuffer(value, [<span class="keyword">this</span>.path, doc]);
      <span class="keyword">if</span> (<span class="keyword">this</span>.options.subtype != <span class="literal">null</span>) {
        value._subtype = <span class="keyword">this</span>.options.subtype;
      }
    }

    <span class="keyword">return</span> value;
  } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Binary) {
    ret = <span class="keyword">new</span> MongooseBuffer(value.value(<span class="literal">true</span>), [<span class="keyword">this</span>.path, doc]);
    <span class="keyword">if</span> (<span class="keyword">typeof</span> value.sub_type !== <span class="string">'number'</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'buffer'</span>, value, <span class="keyword">this</span>.path);
    }
    ret._subtype = value.sub_type;
    <span class="keyword">return</span> ret;
  }

  <span class="keyword">if</span> (value === <span class="literal">null</span>) {
    <span class="keyword">return</span> value;
  }

  <span class="keyword">var</span> type = <span class="keyword">typeof</span> value;
  <span class="keyword">if</span> (type === <span class="string">'string'</span> || type === <span class="string">'number'</span> || Array.isArray(value)) {
    <span class="keyword">if</span> (type === <span class="string">'number'</span>) {
      value = [value];
    }
    ret = <span class="keyword">new</span> MongooseBuffer(value, [<span class="keyword">this</span>.path, doc]);
    <span class="keyword">if</span> (<span class="keyword">this</span>.options.subtype != <span class="literal">null</span>) {
      ret._subtype = <span class="keyword">this</span>.options.subtype;
    }
    <span class="keyword">return</span> ret;
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> CastError(<span class="string">'buffer'</span>, value, <span class="keyword">this</span>.path);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_buffer_SchemaBuffer-castForQuery"><a href="#schema_buffer_SchemaBuffer-castForQuery">SchemaBuffer#castForQuery(<code>$conditional</code>, <code>[value]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$conditional</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[value]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional + <span class="string">' with Buffer.'</span>);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  val = $conditional;
  <span class="keyword">var</span> casted = <span class="keyword">this</span>._castForQuery(val);
  <span class="keyword">return</span> casted ? casted.toObject({ transform: <span class="literal">false</span>, virtuals: <span class="literal">false</span> }) : casted;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_buffer_SchemaBuffer-checkRequired"><a href="#schema_buffer_SchemaBuffer-checkRequired">SchemaBuffer#checkRequired(<code>value</code>, <code>doc</code>)</a></h3><p>Check if the given value satisfies a required validator. To satisfy a<br />required validator, a buffer must not be null or undefined and have<br />non-zero length.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.checkRequired = <span class="keyword">function</span>(value, doc) {
  <span class="keyword">if</span> (SchemaType._isRef(<span class="keyword">this</span>, value, doc, <span class="literal">true</span>)) {
    <span class="keyword">return</span> !!value;
  }
  <span class="keyword">return</span> !!(value &amp;&amp; value.length);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_buffer_SchemaBuffer"><a href="#schema_buffer_SchemaBuffer">SchemaBuffer(<code>key</code>, <code>options</code>)</a></h3><p>Buffer SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaBuffer</span><span class="params">(key, options)</span> {</span>
  SchemaType.call(<span class="keyword">this</span>, key, options, <span class="string">'Buffer'</span>);
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_buffer_SchemaBuffer-subtype"><a href="#schema_buffer_SchemaBuffer-subtype">SchemaBuffer#subtype(<code>subtype</code>)</a></h3><p>Sets the default <a href="https://studio3t.com/whats-new/best-practices-uuid-mongodb/">subtype</a><br />for this buffer. You can find a <a href="http://api.mongodb.com/python/current/api/bson/binary.html">list of allowed subtypes here</a>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>subtype</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>the default subtype</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ uuid: { type: Buffer, subtype: <span class="number">4</span> });
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, s);
<span class="keyword">var</span> m = <span class="keyword">new</span> M({ uuid: <span class="string">'test string'</span> });
m.uuid._subtype; <span class="comment">// 4</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.prototype.subtype = <span class="keyword">function</span>(subtype) {
  <span class="keyword">this</span>.options.subtype = subtype;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_buffer_SchemaBuffer.schemaName"><a href="#schema_buffer_SchemaBuffer.schemaName">SchemaBuffer.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaBuffer.schemaName = <span class="string">'Buffer'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema/mixed.js" id="schema-mixed-js">schema/mixed.js</a><div class="item method private"><h3 id="schema_mixed_Mixed-cast"><a href="#schema_mixed_Mixed-cast">Mixed#cast(<code>value</code>)</a></h3><p>Casts <code>val</code> for Mixed.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to cast</span></li></ul></div><div class="description"><p><em>this is a no-op</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.cast = <span class="keyword">function</span>(val) {
  <span class="keyword">return</span> val;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schema_mixed_Mixed-castForQuery"><a href="#schema_mixed_Mixed-castForQuery">Mixed#castForQuery(<code>$cond</code>, <code>[val]</code>)</a></h3><p>Casts contents for queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>$cond</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.prototype.castForQuery = <span class="keyword">function</span>($cond, val) {
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    <span class="keyword">return</span> val;
  }
  <span class="keyword">return</span> $cond;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_mixed_Mixed"><a href="#schema_mixed_Mixed">Mixed(<code>path</code>, <code>options</code>)</a></h3><p>Mixed SchemaType constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#schematype_SchemaType">SchemaType</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Mixed</span><span class="params">(path, options)</span> {</span>
  <span class="keyword">if</span> (options &amp;&amp; options.<span class="keyword">default</span>) {
    <span class="keyword">var</span> def = options.<span class="keyword">default</span>;
    <span class="keyword">if</span> (Array.isArray(def) &amp;&amp; def.length === <span class="number">0</span>) {
      <span class="comment">// make sure empty array defaults are handled</span>
      options.<span class="keyword">default</span> = Array;
    } <span class="keyword">else</span> <span class="keyword">if</span> (!options.shared &amp;&amp; utils.isObject(def) &amp;&amp; Object.keys(def).length === <span class="number">0</span>) {
      <span class="comment">// prevent odd "shared" objects between documents</span>
      options.<span class="keyword">default</span> = <span class="keyword">function</span>() {
        <span class="keyword">return</span> {};
      };
    }
  }

  SchemaType.call(<span class="keyword">this</span>, path, options, <span class="string">'Mixed'</span>);
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_mixed_Mixed.schemaName"><a href="#schema_mixed_Mixed.schemaName">Mixed.schemaName</a></h3><p>This schema type's name, to defend against minifiers that mangle<br />function names.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Mixed.schemaName = <span class="string">'Mixed'</span>;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/services/cursor/eachAsync.js" id="services-cursor-eachAsync-js">services/cursor/eachAsync.js</a><div class="item static public"><h3 id="services_cursor_eachAsync_module.exports"><a href="#services_cursor_eachAsync_module.exports">module.exports(<code>next</code>, <code>fn</code>, <code>options</code>, <code>[callback]</code>)</a></h3><p>Execute <code>fn</code> for every document in the cursor. If <code>fn</code> returns a promise,<br />will wait for the promise to resolve before iterating on to the next one.<br />Returns a promise that resolves when done.</p><div class="params"><h4>Parameters:</h4><ul><li><code>next</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>the thunk to call to get the next document</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>executed when all docs have been processed</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><hr class=""></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/services/updateValidators.js" id="services-updateValidators-js">services/updateValidators.js</a><div class="item static private"><h3 id="services_updateValidators_module.exports"><a href="#services_updateValidators_module.exports">module.exports(<code>query</code>, <code>schema</code>, <code>castedDoc</code>, <code>options</code>)</a></h3><p>Applies validators and defaults to update and findOneAndUpdate operations,<br />specifically passing a null doc as <code>this</code> to validators and defaults</p><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>castedDoc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/services/setDefaultsOnInsert.js" id="services-setDefaultsOnInsert-js">services/setDefaultsOnInsert.js</a><div class="item static private"><h3 id="services_setDefaultsOnInsert_module.exports"><a href="#services_setDefaultsOnInsert_module.exports">module.exports(<code>filter</code>, <code>schema</code>, <code>castedDoc</code>, <code>options</code>)</a></h3><p>Applies defaults to update and findOneAndUpdate operations.</p><div class="params"><h4>Parameters:</h4><ul><li><code>filter</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span></span></li><li><code>castedDoc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/connection.js" id="connection-js">connection.js</a><div class="item method private"><h3 id="connection_Connection-_close"><a href="#connection_Connection-_close">Connection#_close(<code>force</code>, <code>callback</code>)</a></h3><p>Handles closing the connection</p><div class="params"><h4>Parameters:</h4><ul><li><code>force</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype._close = <span class="keyword">function</span>(force, callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">this</span>._closeCalled = <span class="literal">true</span>;

  <span class="keyword">switch</span> (<span class="keyword">this</span>.readyState) {
    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// disconnected</span>
      callback &amp;&amp; callback();
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// connected</span>
    <span class="keyword">case</span> <span class="number">4</span>: <span class="comment">// unauthorized</span>
      <span class="keyword">this</span>.readyState = STATES.disconnecting;
      <span class="keyword">this</span>.doClose(force, <span class="keyword">function</span>(err) {
        <span class="keyword">if</span> (err) {
          _<span class="keyword">this</span>.error(err, callback);
        } <span class="keyword">else</span> {
          _<span class="keyword">this</span>.onClose(force);
          callback &amp;&amp; callback();
        }
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// connecting</span>
      <span class="keyword">this</span>.once(<span class="string">'open'</span>, <span class="keyword">function</span>() {
        _<span class="keyword">this</span>.close(callback);
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// disconnecting</span>
      <span class="keyword">if</span> (!callback) {
        <span class="keyword">break</span>;
      }
      <span class="keyword">this</span>.once(<span class="string">'close'</span>, <span class="keyword">function</span>() {
        callback();
      });
      <span class="keyword">break</span>;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="connection_Connection-_open"><a href="#connection_Connection-_open">Connection#_open(<code>callback</code>)</a></h3><p>Handles opening the connection with the appropriate method based on connection type.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype._open = <span class="keyword">function</span>(emit, callback) {
  <span class="keyword">this</span>.readyState = STATES.connecting;
  <span class="keyword">this</span>._closeCalled = <span class="literal">false</span>;

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">var</span> method = <span class="keyword">this</span>.replica
      ? <span class="string">'doOpenSet'</span>
      : <span class="string">'doOpen'</span>;

  <span class="comment">// open connection</span>
  <span class="keyword">this</span>[method](<span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err) {
      _<span class="keyword">this</span>.readyState = STATES.disconnected;
      <span class="keyword">if</span> (_<span class="keyword">this</span>._hasOpened) {
        <span class="keyword">if</span> (callback) {
          callback(err);
        }
      } <span class="keyword">else</span> {
        _<span class="keyword">this</span>.error(err, emit &amp;&amp; callback);
      }
      <span class="keyword">return</span>;
    }

    _<span class="keyword">this</span>.onOpen(callback);
  });
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="connection_Connection-authMechanismDoesNotRequirePassword"><a href="#connection_Connection-authMechanismDoesNotRequirePassword">Connection#authMechanismDoesNotRequirePassword()</a></h3><p>@brief Returns a boolean value that specifies if the current authentication mechanism needs a<br />password to authenticate according to the auth objects passed into the open/openSet methods.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>true if the authentication mechanism specified in the options object requires</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.authMechanismDoesNotRequirePassword = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>.options &amp;&amp; <span class="keyword">this</span>.options.auth) {
    <span class="keyword">return</span> authMechanismsWhichDontRequirePassword.indexOf(<span class="keyword">this</span>.options.auth.authMechanism) >= <span class="number">0</span>;
  }
  <span class="keyword">return</span> <span class="literal">true</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="connection_Connection-close"><a href="#connection_Connection-close">Connection#close(<code>[force]</code>, <code>[callback]</code>)</a></h3><p>Closes the connection</p><div class="params"><h4>Parameters:</h4><ul><li><code>[force]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>self</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.close = <span class="keyword">function</span>(force, callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();

  <span class="keyword">if</span> (<span class="keyword">typeof</span> force === <span class="string">'function'</span>) {
    callback = force;
    force = <span class="literal">false</span>;
  }

  <span class="keyword">this</span>.$wasForceClosed = !!force;

  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    _<span class="keyword">this</span>._close(force, <span class="keyword">function</span>(error) {
      callback &amp;&amp; callback(error);
      <span class="keyword">if</span> (error) {
        reject(error);
        <span class="keyword">return</span>;
      }
      resolve();
    });
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_Connection-collection"><a href="#connection_Connection-collection">Connection#collection(<code>name</code>, <code>[options]</code>)</a></h3><p>Retrieves a collection, creating it if not cached.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>of the collection</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional collection options</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#collection_Collection">Collection</a>&gt; </span><span>collection instance</span></li></ul></div><div class="description"><p>Not typically needed by applications. Just talk to your collection through your model.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.collection = <span class="keyword">function</span>(name, options) {
  options = options ? utils.clone(options, { retainKeyOrder: <span class="literal">true</span> }) : {};
  options.$wasForceClosed = <span class="keyword">this</span>.$wasForceClosed;
  <span class="keyword">if</span> (!(name <span class="keyword">in</span> <span class="keyword">this</span>.collections)) {
    <span class="keyword">this</span>.collections[name] = <span class="keyword">new</span> Collection(name, <span class="keyword">this</span>, options);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.collections[name];
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_Connection"><a href="#connection_Connection">Connection(<code>base</code>)</a></h3><p>Connection constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>base</code><span class="types"> &lt;<a href="#index_Mongoose">Mongoose</a>&gt; </span><span>a mongoose instance</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/events.html#events_class_events_eventemitter" title="NodeJS EventEmitter">NodeJS EventEmitter</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>connecting</code>: Emitted when <code>connection.{open,openSet}()</code> is executed on this connection.</p></li><li><p><code>connected</code>: Emitted when this connection successfully connects to the db. May be emitted <em>multiple</em> times in <code>reconnected</code> scenarios.</p></li><li><p><code>open</code>: Emitted after we <code>connected</code> and <code>onOpen</code> is executed on all of this connections models.</p></li><li><p><code>disconnecting</code>: Emitted when <code>connection.close()</code> was executed.</p></li><li><p><code>disconnected</code>: Emitted after getting disconnected from the db.</p></li><li><p><code>close</code>: Emitted after we <code>disconnected</code> and <code>onClose</code> executed on all of this connections models.</p></li><li><p><code>reconnected</code>: Emitted after we <code>connected</code> and subsequently <code>disconnected</code>, followed by successfully another successfull connection.</p></li><li><p><code>error</code>: Emitted when an error occurs on this connection.</p></li><li><p><code>fullsetup</code>: Emitted in a replica-set scenario, when primary and at least one seconaries specified in the connection string are connected.</p></li><li><p><code>all</code>: Emitted in a replica-set scenario, when all nodes specified in the connection string are connected.</p></li></ul></div><div class="description"><p>For practical reasons, a Connection equals a Db.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Connection</span><span class="params">(base)</span> {</span>
  <span class="keyword">this</span>.base = base;
  <span class="keyword">this</span>.collections = {};
  <span class="keyword">this</span>.models = {};
  <span class="keyword">this</span>.config = {autoIndex: <span class="literal">true</span>};
  <span class="keyword">this</span>.replica = <span class="literal">false</span>;
  <span class="keyword">this</span>.hosts = <span class="literal">null</span>;
  <span class="keyword">this</span>.host = <span class="literal">null</span>;
  <span class="keyword">this</span>.port = <span class="literal">null</span>;
  <span class="keyword">this</span>.user = <span class="literal">null</span>;
  <span class="keyword">this</span>.pass = <span class="literal">null</span>;
  <span class="keyword">this</span>.name = <span class="literal">null</span>;
  <span class="keyword">this</span>.options = <span class="literal">null</span>;
  <span class="keyword">this</span>.otherDbs = [];
  <span class="keyword">this</span>.states = STATES;
  <span class="keyword">this</span>._readyState = STATES.disconnected;
  <span class="keyword">this</span>._closeCalled = <span class="literal">false</span>;
  <span class="keyword">this</span>._hasOpened = <span class="literal">false</span>;
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_"><a href="#connection_">(<code>collection</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Helper for <code>createCollection()</code>. Will explicitly create the given collection<br />with specified options. Used to create <a href="https://docs.mongodb.com/manual/core/capped-collections/">capped collections</a><br />and <a href="https://docs.mongodb.com/manual/core/views/">views</a> from mongoose.</p><div class="params"><h4>Parameters:</h4><ul><li><code>collection</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>The collection to delete</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>see <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Db.html#createCollection">MongoDB driver docs</a></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Options are passed down without modification to the <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Db.html#createCollection">MongoDB driver's <code>createCollection()</code> function</a></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.createCollection = _wrapConnHelper(<span class="function"><span class="keyword">function</span> <span class="title">createCollection</span><span class="params">(collection, options, cb)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    cb = options;
    options = {};
  }
  <span class="keyword">this</span>.db.createCollection(collection, options, cb);
});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_"><a href="#connection_">(<code>collection</code>, <code>[callback]</code>)</a></h3><p>Helper for <code>dropCollection()</code>. Will delete the given collection, including<br />all documents and indexes.</p><div class="params"><h4>Parameters:</h4><ul><li><code>collection</code><span class="types"> &lt;<a href="#string">string</a>&gt; </span><span>The collection to delete</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.dropCollection = _wrapConnHelper(<span class="function"><span class="keyword">function</span> <span class="title">dropCollection</span><span class="params">(collection, cb)</span> {</span>
  <span class="keyword">this</span>.db.dropCollection(collection, cb);
});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_"><a href="#connection_">(<code>[callback]</code>)</a></h3><p>Helper for <code>dropDatabase()</code>. Deletes the given database, including all<br />collections, documents, and indexes.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.dropDatabase = _wrapConnHelper(<span class="function"><span class="keyword">function</span> <span class="title">dropDatabase</span><span class="params">(cb)</span> {</span>
  <span class="keyword">this</span>.db.dropDatabase(cb);
});</code></pre></div><hr class=""></div><div class="item method private"><h3 id="connection_Connection-error"><a href="#connection_Connection-error">Connection#error(<code>err</code>, <code>callback</code>)</a></h3><p>error</p><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional</span></li></ul></div><div class="description"><p>Graceful error handling, passes error to callback<br />if available, else emits error on the connection.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.error = <span class="keyword">function</span>(err, callback) {
  <span class="keyword">if</span> (callback) {
    <span class="keyword">return</span> callback(err);
  }
  <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="connection_Connection-model"><a href="#connection_Connection-model">Connection#model(<code>name</code>, <code>[schema]</code>, <code>[collection]</code>)</a></h3><p>Defines or retrieves a model.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the model name</span></li><li><code>[schema]</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>a schema. necessary when defining a model</span></li><li><code>[collection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of mongodb collection (optional) if not given it will be induced from model name</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#model_Model">Model</a>&gt; </span><span>The compiled model</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#index_Mongoose-model" title="Mongoose#model">Mongoose#model</a></li></ul></div><div class="description"><pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> db = mongoose.createConnection(..);
db.model(<span class="string">'Venue'</span>, <span class="keyword">new</span> Schema(..));
<span class="keyword">var</span> Ticket = db.model(<span class="string">'Ticket'</span>, <span class="keyword">new</span> Schema(..));
<span class="keyword">var</span> Venue = db.model(<span class="string">'Venue'</span>);</code></pre>

<p><em>When no <code>collection</code> argument is passed, Mongoose produces a collection name by passing the model <code>name</code> to the <a href="#utils_exports.toCollectionName">utils.toCollectionName</a> method. This method pluralizes the name. If you don't like this behavior, either pass a collection name or set your schemas collection name option.</em></p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ name: String }, { collection: <span class="string">'actor'</span> });

<span class="comment">// or</span>

schema.set(<span class="string">'collection'</span>, <span class="string">'actor'</span>);

<span class="comment">// or</span>

<span class="keyword">var</span> collectionName = <span class="string">'actor'</span>
<span class="keyword">var</span> M = conn.model(<span class="string">'Actor'</span>, schema, collectionName)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.model = <span class="keyword">function</span>(name, schema, collection) {
  <span class="comment">// collection name discovery</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> schema === <span class="string">'string'</span>) {
    collection = schema;
    schema = <span class="literal">false</span>;
  }

  <span class="keyword">if</span> (utils.isObject(schema) &amp;&amp; !schema.instanceOfSchema) {
    schema = <span class="keyword">new</span> Schema(schema);
  }
  <span class="keyword">if</span> (schema &amp;&amp; !schema.instanceOfSchema) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The 2nd parameter to `mongoose.model()` should be a '</span> +
      <span class="string">'schema or a POJO'</span>);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.models[name] &amp;&amp; !collection) {
    <span class="comment">// model exists but we are not subclassing with custom collection</span>
    <span class="keyword">if</span> (schema &amp;&amp; schema.instanceOfSchema &amp;&amp; schema !== <span class="keyword">this</span>.models[name].schema) {
      <span class="keyword">throw</span> <span class="keyword">new</span> MongooseError.OverwriteModelError(name);
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.models[name];
  }

  <span class="keyword">var</span> opts = {cache: <span class="literal">false</span>, connection: <span class="keyword">this</span>};
  <span class="keyword">var</span> model;

  <span class="keyword">if</span> (schema &amp;&amp; schema.instanceOfSchema) {
    <span class="comment">// compile a model</span>
    model = <span class="keyword">this</span>.base.model(name, schema, collection, opts);

    <span class="comment">// only the first model with this name is cached to allow</span>
    <span class="comment">// for one-offs with custom collection names etc.</span>
    <span class="keyword">if</span> (!<span class="keyword">this</span>.models[name]) {
      <span class="keyword">this</span>.models[name] = model;
    }

    model.init();
    <span class="keyword">return</span> model;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.models[name] &amp;&amp; collection) {
    <span class="comment">// subclassing current model with alternate collection</span>
    model = <span class="keyword">this</span>.models[name];
    schema = model.prototype.schema;
    <span class="keyword">var</span> sub = model.__subclass(<span class="keyword">this</span>, schema, collection);
    <span class="comment">// do not cache the sub model</span>
    <span class="keyword">return</span> sub;
  }

  <span class="comment">// lookup model in mongoose module</span>
  model = <span class="keyword">this</span>.base.models[name];

  <span class="keyword">if</span> (!model) {
    <span class="keyword">throw</span> <span class="keyword">new</span> MongooseError.MissingSchemaError(name);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span> === model.prototype.db
      &amp;&amp; (!collection || collection === model.collection.name)) {
    <span class="comment">// model already uses this connection.</span>

    <span class="comment">// only the first model with this name is cached to allow</span>
    <span class="comment">// for one-offs with custom collection names etc.</span>
    <span class="keyword">if</span> (!<span class="keyword">this</span>.models[name]) {
      <span class="keyword">this</span>.models[name] = model;
    }

    <span class="keyword">return</span> model;
  }
  <span class="keyword">this</span>.models[name] = model.__subclass(<span class="keyword">this</span>, schema, collection);
  <span class="keyword">return</span> <span class="keyword">this</span>.models[name];
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_Connection-modelNames"><a href="#connection_Connection-modelNames">Connection#modelNames()</a></h3><p>Returns an array of model names created on this connection.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.modelNames = <span class="keyword">function</span>() {
  <span class="keyword">return</span> Object.keys(<span class="keyword">this</span>.models);
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="connection_Connection-onClose"><a href="#connection_Connection-onClose">Connection#onClose()</a></h3><p>Called when the connection closes</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.onClose = <span class="keyword">function</span>(force) {
  <span class="keyword">this</span>.readyState = STATES.disconnected;

  <span class="comment">// avoid having the collection subscribe to our event emitter</span>
  <span class="comment">// to prevent 0.3 warning</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.collections) {
    <span class="keyword">if</span> (utils.object.hasOwnProperty(<span class="keyword">this</span>.collections, i)) {
      <span class="keyword">this</span>.collections[i].onClose(force);
    }
  }

  <span class="keyword">this</span>.emit(<span class="string">'close'</span>, force);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="connection_Connection-onOpen"><a href="#connection_Connection-onOpen">Connection#onOpen()</a></h3><p>Called when the connection is opened</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.onOpen = <span class="keyword">function</span>(callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">(err, isAuth)</span> {</span>
    <span class="keyword">if</span> (err) {
      _<span class="keyword">this</span>.readyState = isAuth ? STATES.unauthorized : STATES.disconnected;
      _<span class="keyword">this</span>.error(err, callback);
      <span class="keyword">return</span>;
    }

    _<span class="keyword">this</span>.readyState = STATES.connected;

    <span class="comment">// avoid having the collection subscribe to our event emitter</span>
    <span class="comment">// to prevent 0.3 warning</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> _<span class="keyword">this</span>.collections) {
      <span class="keyword">if</span> (utils.object.hasOwnProperty(_<span class="keyword">this</span>.collections, i)) {
        _<span class="keyword">this</span>.collections[i].onOpen();
      }
    }

    callback &amp;&amp; callback();
    _<span class="keyword">this</span>.emit(<span class="string">'open'</span>);
  }

  <span class="comment">// re-authenticate if we're not already connected #3871</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._readyState !== STATES.connected &amp;&amp; <span class="keyword">this</span>.shouldAuthenticate()) {
    _<span class="keyword">this</span>.db.authenticate(_<span class="keyword">this</span>.user, _<span class="keyword">this</span>.pass, _<span class="keyword">this</span>.options.auth, <span class="keyword">function</span>(err) {
      open(err, <span class="literal">true</span>);
    });
  } <span class="keyword">else</span> {
    open();
  }
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="connection_"><a href="#connection_">(<code>connection_string</code>, <code>[database]</code>, <code>[port]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Opens the connection to MongoDB.</p><div class="params"><h4>Parameters:</h4><ul><li><code>connection_string</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>mongodb://uri or the host to which you are connecting</span></li><li><code>[database]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>database name</span></li><li><code>[port]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>database port</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/node-mongodb-native" title="node-mongodb-native">node-mongodb-native</a></li><li><a href="http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate">http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate</a></li></ul></div><div class="description"><p><code>options</code> is a hash with the following possible properties:</p>

<pre><code>config  - passed to the connection config instance
db      - passed to the connection db instance
server  - passed to the connection server instance(s)
replset - passed to the connection ReplSet instance
user    - username for authentication
pass    - password for authentication
auth    - options for authentication (see <a href='http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate'>http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate</a>)
</code></pre>

<h4>Notes:</h4>

<p>Mongoose forces the db option <code>forceServerObjectId</code> false and cannot be overridden.<br />Mongoose defaults the server <code>auto_reconnect</code> options to true which can be overridden.<br />See the node-mongodb-native driver instance for options that it understands.</p>

<p><em>Options passed take precedence over options included in connection strings.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.open = util.deprecate(<span class="keyword">function</span>() {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> callback;

  <span class="keyword">try</span> {
    callback = <span class="keyword">this</span>._handleOpenArgs.apply(<span class="keyword">this</span>, arguments);
  } <span class="keyword">catch</span> (error) {
    <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
      reject(error);
    });
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    _<span class="keyword">this</span>._open(<span class="literal">true</span>, <span class="keyword">function</span>(error) {
      callback &amp;&amp; callback(error);
      <span class="keyword">if</span> (error) {
        <span class="comment">// Error can be on same tick re: christkv/mongodb-core#157</span>
        setImmediate(<span class="keyword">function</span>() {
          reject(error);
          <span class="keyword">if</span> (!callback &amp;&amp; !promise.$hasHandler) {
            _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, error);
          }
        });
        <span class="keyword">return</span>;
      }
      resolve();
    });
  });

  <span class="comment">// Monkey-patch `.then()` so if the promise is handled, we don't emit an</span>
  <span class="comment">// `error` event.</span>
  <span class="keyword">var</span> _then = promise.then;
  promise.then = <span class="keyword">function</span>(resolve, reject) {
    promise.$hasHandler = <span class="literal">true</span>;
    <span class="keyword">return</span> _then.call(promise, resolve, reject);
  };

  <span class="keyword">return</span> promise;
}, <span class="string">'`open()` is deprecated in mongoose >= 4.11.0, use `openUri()` instead, or set the `useMongoClient` option if using `connect()` or `createConnection()`. See http://mongoosejs.com/docs/4.x/docs/connections.html#use-mongo-client'</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="connection_"><a href="#connection_">(<code>uris</code>, <code>[database]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Opens the connection to a replica set.</p><div class="params"><h4>Parameters:</h4><ul><li><code>uris</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>MongoDB connection string</span></li><li><code>[database]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>database name if not included in <code>uris</code></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>passed to the internal driver</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/mongodb/node-mongodb-native" title="node-mongodb-native">node-mongodb-native</a></li><li><a href="http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate">http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> db = mongoose.createConnection();
db.openSet(<span class="string">"mongodb://user:pwd@localhost:27020,localhost:27021,localhost:27012/mydb"</span>);</code></pre>

<p>The database name and/or auth need only be included in one URI.<br />The <code>options</code> is a hash which is passed to the internal driver connection object.</p>

<p>Valid <code>options</code></p>

<pre><code>db      - passed to the connection db instance
server  - passed to the connection server instance(s)
replset - passed to the connection ReplSetServer instance
user    - username for authentication
pass    - password for authentication
auth    - options for authentication (see <a href='http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate'>http://mongodb.github.com/node-mongodb-native/api-generated/db.html#authenticate</a>)
mongos  - Boolean - if true, enables High Availability support for mongos
</code></pre>

<p><em>Options passed take precedence over options included in connection strings.</em></p>

<h4>Notes:</h4>

<p><em>If connecting to multiple mongos servers, set the <code>mongos</code> option to true.</em></p>

<pre><code>conn.open(<span class="string">'mongodb://mongosA:27501,mongosB:27501'</span>, { mongos: <span class="literal">true</span> }, cb);</code></pre>

<p>Mongoose forces the db option <code>forceServerObjectId</code> false and cannot be overridden.<br />Mongoose defaults the server <code>auto_reconnect</code> options to true which can be overridden.<br />See the node-mongodb-native driver instance for options that it understands.</p>

<p><em>Options passed take precedence over options included in connection strings.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.openSet = util.deprecate(<span class="keyword">function</span>(uris, database, options, callback) {
  <span class="keyword">var</span> Promise = PromiseProvider.get();

  <span class="keyword">try</span> {
    callback = <span class="keyword">this</span>._handleOpenSetArgs.apply(<span class="keyword">this</span>, arguments);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
      reject(err);
    });
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> emitted = <span class="literal">false</span>;
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    _<span class="keyword">this</span>._open(<span class="literal">true</span>, <span class="keyword">function</span>(error) {
      callback &amp;&amp; callback(error);
      <span class="keyword">if</span> (error) {
        reject(error);
        <span class="keyword">if</span> (!callback &amp;&amp; !promise.$hasHandler &amp;&amp; !emitted) {
          emitted = <span class="literal">true</span>;
          _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, error);
        }
        <span class="keyword">return</span>;
      }
      resolve();
    });
  });

  <span class="comment">// Monkey-patch `.then()` so if the promise is handled, we don't emit an</span>
  <span class="comment">// `error` event.</span>
  <span class="keyword">var</span> _then = promise.then;
  promise.then = <span class="keyword">function</span>(resolve, reject) {
    promise.$hasHandler = <span class="literal">true</span>;
    <span class="keyword">return</span> _then.call(promise, resolve, reject);
  };

  <span class="keyword">return</span> promise;
}, <span class="string">'`openSet()` is deprecated in mongoose >= 4.11.0, use `openUri()` instead, or set the `useMongoClient` option if using `connect()` or `createConnection()`. See http://mongoosejs.com/docs/4.x/docs/connections.html#use-mongo-client'</span>);</code></pre></div><hr class=""></div><div class="item method private"><h3 id="connection_Connection-openUri"><a href="#connection_Connection-openUri">Connection#openUri(<code>uri</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Opens the connection with a URI using <code>MongoClient.connect()</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>uri</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>The URI to connect with.</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Passed on to http://mongodb.github.io/node-mongodb-native/2.2/api/MongoClient.html#connect</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.openUri = <span class="keyword">function</span>(uri, options, callback) {
  <span class="keyword">this</span>.readyState = STATES.connecting;
  <span class="keyword">this</span>._closeCalled = <span class="literal">false</span>;

  <span class="keyword">try</span> {
    <span class="keyword">var</span> parsed = muri(uri);
    <span class="keyword">this</span>.name = parsed.db;
    <span class="keyword">this</span>.host = parsed.hosts[<span class="number">0</span>].host || parsed.hosts[<span class="number">0</span>].ipc;
    <span class="keyword">this</span>.port = parsed.hosts[<span class="number">0</span>].port || <span class="number">27017</span>;
    <span class="keyword">if</span> (parsed.auth) {
      <span class="keyword">this</span>.user = parsed.auth.user;
      <span class="keyword">this</span>.pass = parsed.auth.pass;
    }
  } <span class="keyword">catch</span> (error) {
    <span class="keyword">this</span>.error(error, callback);
    <span class="keyword">throw</span> error;
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">if</span> (options) {
    options = utils.clone(options, { retainKeyOrder: <span class="literal">true</span> });
    <span class="keyword">delete</span> options.useMongoClient;
    <span class="keyword">var</span> autoIndex = options.config &amp;&amp; options.config.autoIndex != <span class="literal">null</span> ?
      options.config.autoIndex :
      options.autoIndex;
    <span class="keyword">if</span> (autoIndex != <span class="literal">null</span>) {
      <span class="keyword">this</span>.config.autoIndex = autoIndex !== <span class="literal">false</span>;
      <span class="keyword">delete</span> options.config;
      <span class="keyword">delete</span> options.autoIndex;
    }

    <span class="comment">// Backwards compat</span>
    <span class="keyword">if</span> (options.user || options.pass) {
      options.auth = options.auth || {};
      options.auth.user = options.user;
      options.auth.password = options.pass;
      <span class="keyword">delete</span> options.user;
      <span class="keyword">delete</span> options.pass;
      <span class="keyword">this</span>.user = options.auth.user;
      <span class="keyword">this</span>.pass = options.auth.password;
    }

    <span class="keyword">if</span> (options.bufferCommands != <span class="literal">null</span>) {
      options.bufferMaxEntries = <span class="number">0</span>;
      <span class="keyword">this</span>.config.bufferCommands = options.bufferCommands;
      <span class="keyword">delete</span> options.bufferCommands;
    }
  }

  <span class="keyword">this</span>._connectionOptions = options;

  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    mongodb.MongoClient.connect(uri, options, <span class="keyword">function</span>(error, db) {
      <span class="keyword">if</span> (error) {
        _<span class="keyword">this</span>.readyState = STATES.disconnected;
        <span class="keyword">if</span> (_<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length) {
          _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, error);
        }
        callback &amp;&amp; callback(error);
        <span class="keyword">return</span> reject(error);
      }
      <span class="comment">// Backwards compat for mongoose 4.x</span>
      db.on(<span class="string">'reconnect'</span>, <span class="keyword">function</span>() {
        _<span class="keyword">this</span>.readyState = STATES.connected;
        _<span class="keyword">this</span>.emit(<span class="string">'reconnect'</span>);
        _<span class="keyword">this</span>.emit(<span class="string">'reconnected'</span>);
      });
      db.s.topology.on(<span class="string">'reconnectFailed'</span>, <span class="keyword">function</span>() {
        _<span class="keyword">this</span>.emit(<span class="string">'reconnectFailed'</span>);
      });
      db.s.topology.on(<span class="string">'close'</span>, <span class="keyword">function</span>() {
        <span class="comment">// Implicitly emits 'disconnected'</span>
        _<span class="keyword">this</span>.readyState = STATES.disconnected;
      });
      db.on(<span class="string">'timeout'</span>, <span class="keyword">function</span>() {
        _<span class="keyword">this</span>.emit(<span class="string">'timeout'</span>);
      });

      <span class="keyword">delete</span> _<span class="keyword">this</span>.then;
      <span class="keyword">delete</span> _<span class="keyword">this</span>.<span class="keyword">catch</span>;

      _<span class="keyword">this</span>.db = db;
      _<span class="keyword">this</span>.readyState = STATES.connected;

      <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> _<span class="keyword">this</span>.collections) {
        <span class="keyword">if</span> (utils.object.hasOwnProperty(_<span class="keyword">this</span>.collections, i)) {
          _<span class="keyword">this</span>.collections[i].onOpen();
        }
      }

      callback &amp;&amp; callback(<span class="literal">null</span>, _<span class="keyword">this</span>);
      resolve(_<span class="keyword">this</span>);
      _<span class="keyword">this</span>.emit(<span class="string">'open'</span>);
    });
  });

  <span class="keyword">this</span>.then = <span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">return</span> promise.then(resolve, reject);
  };
  <span class="keyword">this</span>.<span class="keyword">catch</span> = <span class="keyword">function</span>(reject) {
    <span class="keyword">return</span> promise.<span class="keyword">catch</span>(reject);
  };

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="connection_Connection-optionsProvideAuthenticationData"><a href="#connection_Connection-optionsProvideAuthenticationData">Connection#optionsProvideAuthenticationData(<code>[options]</code>)</a></h3><p>@brief Returns a boolean value that specifies if the provided objects object provides enough<br />data to authenticate with. Generally this is true if the username and password are both specified<br />but in some authentication methods, a password is not required for authentication so only a username<br />is required.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the options object passed into the open/openSet methods.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>true if the provided options object provides enough data to authenticate with,</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.optionsProvideAuthenticationData = <span class="keyword">function</span>(options) {
  <span class="keyword">return</span> (options) &amp;&amp;
      (options.user) &amp;&amp;
      ((options.pass) || <span class="keyword">this</span>.authMechanismDoesNotRequirePassword());
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="connection_Connection-shouldAuthenticate"><a href="#connection_Connection-shouldAuthenticate">Connection#shouldAuthenticate()</a></h3><p>@brief Returns if the connection requires authentication after it is opened. Generally if a<br />username and password are both provided than authentication is needed, but in some cases a<br />password is not required.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>true if the connection should be authenticated after it is opened, otherwise false.</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.shouldAuthenticate = <span class="keyword">function</span>() {
  <span class="keyword">return</span> (<span class="keyword">this</span>.user !== <span class="literal">null</span> &amp;&amp; <span class="keyword">this</span>.user !== <span class="keyword">void</span> <span class="number">0</span>) &amp;&amp;
      ((<span class="keyword">this</span>.pass !== <span class="literal">null</span> || <span class="keyword">this</span>.pass !== <span class="keyword">void</span> <span class="number">0</span>) || <span class="keyword">this</span>.authMechanismDoesNotRequirePassword());
};</code></pre></div><hr class="private"></div><div class="item property public"><h3 id="connection_Connection-collections"><a href="#connection_Connection-collections">Connection#<span>collections</span></a></h3><p>A hash of the collections associated with this connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.collections;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="connection_Connection-config"><a href="#connection_Connection-config">Connection#<span>config</span></a></h3><p>A hash of the global options that are associated with this connection</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.config;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="connection_Connection-db"><a href="#connection_Connection-db">Connection#<span>db</span></a></h3><p>The mongodb.Db instance, set when the connection is opened</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Connection.prototype.db;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="connection_Connection-readyState"><a href="#connection_Connection-readyState">Connection#<span>readyState</span></a></h3><p>Connection ready state</p>

<ul>
<li>0 = disconnected</li>
<li>1 = connected</li>
<li>2 = connecting</li>
<li>3 = disconnecting</li>
</ul>

<p>Each state change emits its associated event name.</p>

<h4>Example</h4>

<pre><code>conn.on(<span class="string">'connected'</span>, callback);
conn.on(<span class="string">'disconnected'</span>, callback);</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Object.defineProperty(Connection.prototype, <span class="string">'readyState'</span>, {
  get: <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>._readyState;
  },
  set: <span class="keyword">function</span>(val) {
    <span class="keyword">if</span> (!(val <span class="keyword">in</span> STATES)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid connection state: '</span> + val);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>._readyState !== val) {
      <span class="keyword">this</span>._readyState = val;
      <span class="comment">// loop over the otherDbs on this connection and change their state</span>
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.otherDbs.length; i++) {
        <span class="keyword">this</span>.otherDbs[i].readyState = val;
      }

      <span class="keyword">if</span> (STATES.connected === val) {
        <span class="keyword">this</span>._hasOpened = <span class="literal">true</span>;
      }

      <span class="keyword">this</span>.emit(STATES[val]);
    }
  }
});</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/drivers/node-mongodb-native/collection.js" id="drivers-node-mongodb-native-collection-js">drivers/node-mongodb-native/collection.js</a><div class="item method public"><h3 id="drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24format"><a href="#drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24format">function Object() { [native code] }#$format()</a></h3><p>Formatter for debug print args</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24print"><a href="#drivers_node-mongodb-native_collection_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-%24print">function Object() { [native code] }#$print()</a></h3><p>Debug print helper</p><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="drivers_node-mongodb-native_collection_NativeCollection-getIndexes"><a href="#drivers_node-mongodb-native_collection_NativeCollection-getIndexes">NativeCollection#getIndexes(<code>callback</code>)</a></h3><p>Retreives information about this collections indexes.</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method private"><h3 id="drivers_node-mongodb-native_collection_NativeCollection"><a href="#drivers_node-mongodb-native_collection_NativeCollection">NativeCollection()</a></h3><p>A <a href="https://github.com/mongodb/node-mongodb-native">node-mongodb-native</a> collection implementation.</p><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#collection_Collection">Collection</a></li></ul></div><div class="description"><p>All methods methods from the <a href="https://github.com/mongodb/node-mongodb-native">node-mongodb-native</a> driver are copied and wrapped in queue management.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">NativeCollection</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.collection = <span class="literal">null</span>;
  MongooseCollection.apply(<span class="keyword">this</span>, arguments);
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_collection_NativeCollection-onClose"><a href="#drivers_node-mongodb-native_collection_NativeCollection-onClose">NativeCollection#onClose()</a></h3><p>Called when the connection closes</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeCollection.prototype.onClose = <span class="keyword">function</span>(force) {
  MongooseCollection.prototype.onClose.call(<span class="keyword">this</span>, force);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_collection_NativeCollection-onOpen"><a href="#drivers_node-mongodb-native_collection_NativeCollection-onOpen">NativeCollection#onOpen()</a></h3><p>Called when the connection opens.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeCollection.prototype.onOpen = function() {
  var _this = this;

  // always get a new collection in case the user changed host:port
  // of parent db instance when re-opening the connection.

  if (!_this.opts.capped.size) {
    // non-capped
    callback(null, _this.conn.db.collection(_this.name));
    return _this.collection;
  }

  // capped
  return _this.conn.db.collection(_this.name, function(err, c) {
    if (err) return callback(err);

    // discover if this collection exists and if it is capped
    _this.conn.db.listCollections({name: _this.name}).toArray(function(err, docs) {
      if (err) {
        return callback(err);
      }
      var doc = docs[0];
      var exists = !!doc;

      if (exists) {
        if (doc.options &amp;&amp; doc.options.capped) {
          callback(null, c);
        } else {
          var msg = 'A non-capped collection exists with the name: ' + _this.name + '

'
              + ' To use this collection as a capped collection, please '
              + 'first convert it.
'
              + ' http://www.mongodb.org/display/DOCS/Capped+Collections#CappedCollections-Convertingacollectiontocapped';
          err = new Error(msg);
          callback(err);
        }
      } else {
        // create
        var opts = utils.clone(_this.opts.capped);
        opts.capped = true;
        _this.conn.db.createCollection(_this.name, opts, callback);
      }
    });
  });

  function callback(err, collection) {
    if (err) {
      // likely a strict mode error
      _this.conn.emit('error', err);
    } else {
      _this.collection = collection;
      MongooseCollection.prototype.onOpen.call(_this);
    }
  }
};</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/drivers/node-mongodb-native/connection.js" id="drivers-node-mongodb-native-connection-js">drivers/node-mongodb-native/connection.js</a><div class="item method private"><h3 id="drivers_node-mongodb-native_connection_NativeConnection-doClose"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doClose">NativeConnection#doClose(<code>[force]</code>, <code>[fn]</code>)</a></h3><p>Closes the connection</p><div class="params"><h4>Parameters:</h4><ul><li><code>[force]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doClose = <span class="keyword">function</span>(force, fn) {
  <span class="keyword">this</span>.db.close(force, fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_connection_NativeConnection-doOpen"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doOpen">NativeConnection#doOpen(<code>fn</code>)</a></h3><p>Opens the connection to MongoDB.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doOpen = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> server = <span class="keyword">new</span> Server(<span class="keyword">this</span>.host, <span class="keyword">this</span>.port, <span class="keyword">this</span>.options.server);

  <span class="keyword">if</span> (<span class="keyword">this</span>.options &amp;&amp; <span class="keyword">this</span>.options.mongos) {
    <span class="keyword">var</span> mongos = <span class="keyword">new</span> Mongos([server], <span class="keyword">this</span>.options.mongos);
    <span class="keyword">this</span>.db = <span class="keyword">new</span> Db(<span class="keyword">this</span>.name, mongos, <span class="keyword">this</span>.options.db);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.db = <span class="keyword">new</span> Db(<span class="keyword">this</span>.name, server, <span class="keyword">this</span>.options.db);
  }

  <span class="keyword">this</span>.db.open(<span class="keyword">function</span>(err) {
    listen(_<span class="keyword">this</span>);

    <span class="keyword">if</span> (!mongos) {
      server.s.server.on(<span class="string">'error'</span>, <span class="keyword">function</span>(error) {
        <span class="keyword">if</span> (<span class="regexp">/after \d+ attempts/</span>.test(error.message)) {
          _<span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> DisconnectedError(server.s.server.name));
        }
      });
    }

    <span class="keyword">if</span> (err) <span class="keyword">return</span> fn(err);

    fn();
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_connection_NativeConnection-doOpenSet"><a href="#drivers_node-mongodb-native_connection_NativeConnection-doOpenSet">NativeConnection#doOpenSet(<code>fn</code>)</a></h3><p>Opens a connection to a MongoDB ReplicaSet.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>See description of <a href="#NativeConnection-doOpen">doOpen</a> for server options. In this case <code>options.replset</code> is also passed to ReplSetServers.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.doOpenSet = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> servers = [],
      _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">this</span>.hosts.forEach(<span class="keyword">function</span>(server) {
    <span class="keyword">var</span> host = server.host || server.ipc;
    <span class="keyword">var</span> port = server.port || <span class="number">27017</span>;
    servers.push(<span class="keyword">new</span> Server(host, port, _<span class="keyword">this</span>.options.server));
  });

  <span class="keyword">var</span> server = <span class="keyword">this</span>.options.mongos
    ? <span class="keyword">new</span> Mongos(servers, <span class="keyword">this</span>.options.mongos)
    : <span class="keyword">new</span> ReplSetServers(servers, <span class="keyword">this</span>.options.replset || <span class="keyword">this</span>.options.replSet);
  <span class="keyword">this</span>.db = <span class="keyword">new</span> Db(<span class="keyword">this</span>.name, server, <span class="keyword">this</span>.options.db);

  <span class="keyword">this</span>.db.s.topology.on(<span class="string">'left'</span>, <span class="keyword">function</span>(data) {
    _<span class="keyword">this</span>.emit(<span class="string">'left'</span>, data);
  });

  <span class="keyword">this</span>.db.s.topology.on(<span class="string">'joined'</span>, <span class="keyword">function</span>(data) {
    _<span class="keyword">this</span>.emit(<span class="string">'joined'</span>, data);
  });

  <span class="keyword">this</span>.db.on(<span class="string">'fullsetup'</span>, <span class="keyword">function</span>() {
    _<span class="keyword">this</span>.emit(<span class="string">'fullsetup'</span>);
  });

  <span class="keyword">this</span>.db.on(<span class="string">'all'</span>, <span class="keyword">function</span>() {
    _<span class="keyword">this</span>.emit(<span class="string">'all'</span>);
  });

  <span class="keyword">this</span>.db.open(<span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> fn(err);
    fn();
    listen(_<span class="keyword">this</span>);
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_connection_NativeConnection"><a href="#drivers_node-mongodb-native_connection_NativeConnection">NativeConnection()</a></h3><p>A <a href="https://github.com/mongodb/node-mongodb-native">node-mongodb-native</a> connection implementation.</p><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#connection_Connection">Connection</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">NativeConnection</span><span class="params">()</span> {</span>
  MongooseConnection.apply(<span class="keyword">this</span>, arguments);
  <span class="keyword">this</span>._listening = <span class="literal">false</span>;
}</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="drivers_node-mongodb-native_connection_NativeConnection-parseOptions"><a href="#drivers_node-mongodb-native_connection_NativeConnection-parseOptions">NativeConnection#parseOptions(<code>passed</code>, <code>[connStrOptions]</code>)</a></h3><p>Prepares default connection options for the node-mongodb-native driver.</p><div class="params"><h4>Parameters:</h4><ul><li><code>passed</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options that were passed directly during connection</span></li><li><code>[connStrOptions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options that were passed in the connection string</span></li></ul></div><div class="description"><p><em>NOTE: <code>passed</code> options take precedence over connection string options.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.parseOptions = <span class="keyword">function</span>(passed, connStrOpts) {
  <span class="keyword">var</span> o = passed ? require(<span class="string">'../../utils'</span>).clone(passed) : {};

  o.db || (o.db = {});
  o.auth || (o.auth = {});
  o.server || (o.server = {});
  o.replset || (o.replset = o.replSet) || (o.replset = {});
  o.server.socketOptions || (o.server.socketOptions = {});
  o.replset.socketOptions || (o.replset.socketOptions = {});
  o.mongos || (o.mongos = (connStrOpts &amp;&amp; connStrOpts.mongos));
  (o.mongos === <span class="literal">true</span>) &amp;&amp; (o.mongos = {});

  <span class="keyword">var</span> opts = connStrOpts || {};
  Object.keys(opts).forEach(<span class="keyword">function</span>(name) {
    <span class="keyword">switch</span> (name) {
      <span class="keyword">case</span> <span class="string">'ssl'</span>:
        o.server.ssl = opts.ssl;
        o.replset.ssl = opts.ssl;
        o.mongos &amp;&amp; (o.mongos.ssl = opts.ssl);
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'poolSize'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.server[name] === <span class="string">'undefined'</span>) {
          o.server[name] = o.replset[name] = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'slaveOk'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.server.slave_ok === <span class="string">'undefined'</span>) {
          o.server.slave_ok = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'autoReconnect'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.server.auto_reconnect === <span class="string">'undefined'</span>) {
          o.server.auto_reconnect = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'socketTimeoutMS'</span>:
      <span class="keyword">case</span> <span class="string">'connectTimeoutMS'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.server.socketOptions[name] === <span class="string">'undefined'</span>) {
          o.server.socketOptions[name] = o.replset.socketOptions[name] = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'authdb'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.auth.authdb === <span class="string">'undefined'</span>) {
          o.auth.authdb = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'authSource'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.auth.authSource === <span class="string">'undefined'</span>) {
          o.auth.authSource = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'authMechanism'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.auth.authMechanism === <span class="string">'undefined'</span>) {
          o.auth.authMechanism = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'retries'</span>:
      <span class="keyword">case</span> <span class="string">'reconnectWait'</span>:
      <span class="keyword">case</span> <span class="string">'rs_name'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.replset[name] === <span class="string">'undefined'</span>) {
          o.replset[name] = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'replicaSet'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.replset.rs_name === <span class="string">'undefined'</span>) {
          o.replset.rs_name = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'readSecondary'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.replset.read_secondary === <span class="string">'undefined'</span>) {
          o.replset.read_secondary = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'nativeParser'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.db.native_parser === <span class="string">'undefined'</span>) {
          o.db.native_parser = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'w'</span>:
      <span class="keyword">case</span> <span class="string">'safe'</span>:
      <span class="keyword">case</span> <span class="string">'fsync'</span>:
      <span class="keyword">case</span> <span class="string">'journal'</span>:
      <span class="keyword">case</span> <span class="string">'wtimeoutMS'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.db[name] === <span class="string">'undefined'</span>) {
          o.db[name] = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'readPreference'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.db.readPreference === <span class="string">'undefined'</span>) {
          o.db.readPreference = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'readPreferenceTags'</span>:
        <span class="keyword">if</span> (<span class="keyword">typeof</span> o.db.read_preference_tags === <span class="string">'undefined'</span>) {
          o.db.read_preference_tags = opts[name];
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'sslValidate'</span>:
        o.server.sslValidate = opts.sslValidate;
        o.replset.sslValidate = opts.sslValidate;
        o.mongos &amp;&amp; (o.mongos.sslValidate = opts.sslValidate);
    }
  });

  <span class="keyword">if</span> (!(<span class="string">'auto_reconnect'</span> <span class="keyword">in</span> o.server)) {
    o.server.auto_reconnect = <span class="literal">true</span>;
  }

  <span class="comment">// mongoose creates its own ObjectIds</span>
  o.db.forceServerObjectId = <span class="literal">false</span>;

  <span class="comment">// default safe using new nomenclature</span>
  <span class="keyword">if</span> (!(<span class="string">'journal'</span> <span class="keyword">in</span> o.db || <span class="string">'j'</span> <span class="keyword">in</span> o.db ||
        <span class="string">'fsync'</span> <span class="keyword">in</span> o.db || <span class="string">'safe'</span> <span class="keyword">in</span> o.db || <span class="string">'w'</span> <span class="keyword">in</span> o.db)) {
    o.db.w = <span class="number">1</span>;
  }

  <span class="keyword">if</span> (o.promiseLibrary) {
    o.db.promiseLibrary = o.promiseLibrary;
  }

  validate(o);
  <span class="keyword">return</span> o;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="drivers_node-mongodb-native_connection_NativeConnection-useDb"><a href="#drivers_node-mongodb-native_connection_NativeConnection-useDb">NativeConnection#useDb(<code>name</code>)</a></h3><p>Switches to a different database using the same connection pool.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>The database name</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>New Connection Object</span></li></ul></div><div class="description"><p>Returns a new connection object, with the new db.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.prototype.useDb = <span class="keyword">function</span>(name) {
  <span class="comment">// we have to manually copy all of the attributes...</span>
  <span class="keyword">var</span> newConn = <span class="keyword">new</span> <span class="keyword">this</span>.constructor();
  newConn.name = name;
  newConn.base = <span class="keyword">this</span>.base;
  newConn.collections = {};
  newConn.models = {};
  newConn.replica = <span class="keyword">this</span>.replica;
  newConn.hosts = <span class="keyword">this</span>.hosts;
  newConn.host = <span class="keyword">this</span>.host;
  newConn.port = <span class="keyword">this</span>.port;
  newConn.user = <span class="keyword">this</span>.user;
  newConn.pass = <span class="keyword">this</span>.pass;
  newConn.options = <span class="keyword">this</span>.options;
  newConn._readyState = <span class="keyword">this</span>._readyState;
  newConn._closeCalled = <span class="keyword">this</span>._closeCalled;
  newConn._hasOpened = <span class="keyword">this</span>._hasOpened;
  newConn._listening = <span class="literal">false</span>;

  <span class="comment">// First, when we create another db object, we are not guaranteed to have a</span>
  <span class="comment">// db object to work with. So, in the case where we have a db object and it</span>
  <span class="comment">// is connected, we can just proceed with setting everything up. However, if</span>
  <span class="comment">// we do not have a db or the state is not connected, then we need to wait on</span>
  <span class="comment">// the 'open' event of the connection before doing the rest of the setup</span>
  <span class="comment">// the 'connected' event is the first time we'll have access to the db object</span>

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>.db &amp;&amp; <span class="keyword">this</span>._readyState === STATES.connected) {
    wireup();
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.once(<span class="string">'connected'</span>, wireup);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">wireup</span><span class="params">()</span> {</span>
    newConn.db = _<span class="keyword">this</span>.db.db(name);
    newConn.onOpen();
    <span class="comment">// setup the events appropriately</span>
    listen(newConn);
  }

  newConn.name = name;

  <span class="comment">// push onto the otherDbs stack, this is used when state changes</span>
  <span class="keyword">this</span>.otherDbs.push(newConn);
  newConn.otherDbs.push(<span class="keyword">this</span>);

  <span class="keyword">return</span> newConn;
};</code></pre></div><hr class=""></div><div class="item static public"><h3 id="drivers_node-mongodb-native_connection_NativeConnection.STATES"><a href="#drivers_node-mongodb-native_connection_NativeConnection.STATES">NativeConnection.STATES</a></h3><p>Expose the possible connection states.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">NativeConnection.STATES = STATES;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/messages.js" id="error-messages-js">error/messages.js</a><div class="item static public"><h3 id="error_messages_MongooseError.messages"><a href="#error_messages_MongooseError.messages">MongooseError.messages()</a></h3><p>The default built-in validator error messages. These may be customized.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> msg = module.exports = exports = {};

msg.DocumentNotFoundError = <span class="literal">null</span>;

msg.general = {};
msg.general.<span class="keyword">default</span> = <span class="string">'Validator failed for path `{PATH}` with value `{VALUE}`'</span>;
msg.general.required = <span class="string">'Path `{PATH}` is required.'</span>;

msg.Number = {};
msg.Number.min = <span class="string">'Path `{PATH}` ({VALUE}) is less than minimum allowed value ({MIN}).'</span>;
msg.Number.max = <span class="string">'Path `{PATH}` ({VALUE}) is more than maximum allowed value ({MAX}).'</span>;

msg.Date = {};
msg.Date.min = <span class="string">'Path `{PATH}` ({VALUE}) is before minimum allowed value ({MIN}).'</span>;
msg.Date.max = <span class="string">'Path `{PATH}` ({VALUE}) is after maximum allowed value ({MAX}).'</span>;

msg.String = {};
msg.String.enum = <span class="string">'`{VALUE}` is not a valid enum value for path `{PATH}`.'</span>;
msg.String.match = <span class="string">'Path `{PATH}` is invalid ({VALUE}).'</span>;
msg.String.minlength = <span class="string">'Path `{PATH}` (`{VALUE}`) is shorter than the minimum allowed length ({MINLENGTH}).'</span>;
msg.String.maxlength = <span class="string">'Path `{PATH}` (`{VALUE}`) is longer than the maximum allowed length ({MAXLENGTH}).'</span>;</code></pre></div><pre><code><span class="comment">// customize within each schema or globally like so</span>
<span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
mongoose.Error.messages.String.enum  = <span class="string">"Your custom message for {PATH}."</span>;</code></pre>

<p>As you might have noticed, error messages support basic templating</p>

<ul>
<li><code>{PATH}</code> is replaced with the invalid document path</li>
<li><code>{VALUE}</code> is replaced with the invalid value</li>
<li><code>{TYPE}</code> is replaced with the validator type such as "regexp", "min", or "user defined"</li>
<li><code>{MIN}</code> is replaced with the declared min value for the Number.min validator</li>
<li><code>{MAX}</code> is replaced with the declared max value for the Number.max validator</li>
</ul>

<p>Click the "show code" link below to see all defaults.</p><hr class=""></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/cast.js" id="error-cast-js">error/cast.js</a><div class="item method private"><h3 id="error_cast_CastError"><a href="#error_cast_CastError">CastError(<code>type</code>, <code>value</code>)</a></h3><p>Casting Error constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">CastError</span><span class="params">(type, value, path, reason)</span> {</span>
  <span class="keyword">var</span> stringValue = util.inspect(value);
  stringValue = stringValue.replace(<span class="regexp">/^'/</span>, <span class="string">'"'</span>).replace(<span class="regexp">/'$/</span>, <span class="string">'"'</span>);
  <span class="keyword">if</span> (stringValue.charAt(<span class="number">0</span>) !== <span class="string">'"'</span>) {
    stringValue = <span class="string">'"'</span> + stringValue + <span class="string">'"'</span>;
  }
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Cast to '</span> + type + <span class="string">' failed for value '</span> +
    stringValue + <span class="string">' at path "'</span> + path + <span class="string">'"'</span>);
  <span class="keyword">this</span>.name = <span class="string">'CastError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">this</span>.stringValue = stringValue;
  <span class="keyword">this</span>.kind = type;
  <span class="keyword">this</span>.value = value;
  <span class="keyword">this</span>.path = path;
  <span class="keyword">this</span>.reason = reason;
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/objectExpected.js" id="error-objectExpected-js">error/objectExpected.js</a><div class="item method private"><h3 id="error_objectExpected_ObjectExpectedError"><a href="#error_objectExpected_ObjectExpectedError">ObjectExpectedError(<code>type</code>, <code>value</code>)</a></h3><p>Strict mode error constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ObjectExpectedError</span><span class="params">(path, val)</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Tried to set nested object field `'</span> + path +
    <span class="string">'` to primitive value `'</span> + val + <span class="string">'` and strict mode is set to throw.'</span>);
  <span class="keyword">this</span>.name = <span class="string">'ObjectExpectedError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">this</span>.path = path;
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/disconnected.js" id="error-disconnected-js">error/disconnected.js</a><div class="item method private"><h3 id="error_disconnected_DisconnectedError"><a href="#error_disconnected_DisconnectedError">DisconnectedError(<code>type</code>, <code>value</code>)</a></h3><p>Casting Error constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">DisconnectedError</span><span class="params">(connectionString)</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Ran out of retries trying to reconnect to "'</span> +
    connectionString + <span class="string">'". Try setting `server.reconnectTries` and '</span> +
    <span class="string">'`server.reconnectInterval` to something higher.'</span>);
  <span class="keyword">this</span>.name = <span class="string">'DisconnectedError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/objectParameter.js" id="error-objectParameter-js">error/objectParameter.js</a><div class="item method private"><h3 id="error_objectParameter_ObjectParameterError"><a href="#error_objectParameter_ObjectParameterError">ObjectParameterError(<code>value</code>, <code>paramName</code>, <code>fnName</code>)</a></h3><p>Constructor for errors that happen when a parameter that's expected to be<br />an object isn't an object</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="#Any">Any</a>&gt; </span><span></span></li><li><code>paramName</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>fnName</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ObjectParameterError</span><span class="params">(value, paramName, fnName)</span> {</span>
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'Parameter "'</span> + paramName + <span class="string">'" to '</span> + fnName +
    <span class="string">'() must be an object, got '</span> + value.toString());
  <span class="keyword">this</span>.name = <span class="string">'ObjectParameterError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
}</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/validation.js" id="error-validation-js">error/validation.js</a><div class="item method public"><h3 id="error_validation_ValidationError-toString"><a href="#error_validation_ValidationError-toString">ValidationError#toString()</a></h3><p>Console.log helper</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">ValidationError.prototype.toString = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">': '</span> + _generateMessage(<span class="keyword">this</span>);
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="error_validation_ValidationError"><a href="#error_validation_ValidationError">ValidationError(<code>instance</code>)</a></h3><p>Document Validation Error</p><div class="params"><h4>Parameters:</h4><ul><li><code>instance</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ValidationError</span><span class="params">(instance)</span> {</span>
  <span class="keyword">this</span>.errors = {};
  <span class="keyword">this</span>._message = <span class="string">''</span>;
  <span class="keyword">if</span> (instance &amp;&amp; instance.constructor.name === <span class="string">'model'</span>) {
    <span class="keyword">this</span>._message = instance.constructor.modelName + <span class="string">' validation failed'</span>;
    MongooseError.call(<span class="keyword">this</span>, <span class="keyword">this</span>._message);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>._message = <span class="string">'Validation failed'</span>;
    MongooseError.call(<span class="keyword">this</span>, <span class="keyword">this</span>._message);
  }
  <span class="keyword">this</span>.name = <span class="string">'ValidationError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">if</span> (instance) {
    instance.errors = <span class="keyword">this</span>.errors;
  }
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/validator.js" id="error-validator-js">error/validator.js</a><div class="item method private"><h3 id="error_validator_ValidatorError"><a href="#error_validator_ValidatorError">ValidatorError(<code>properties</code>)</a></h3><p>Schema validator error</p><div class="params"><h4>Parameters:</h4><ul><li><code>properties</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ValidatorError</span><span class="params">(properties)</span> {</span>
  <span class="keyword">var</span> msg = properties.message;
  <span class="keyword">if</span> (!msg) {
    msg = MongooseError.messages.general.<span class="keyword">default</span>;
  }

  <span class="keyword">var</span> message = <span class="keyword">this</span>.formatMessage(msg, properties);
  MongooseError.call(<span class="keyword">this</span>, message);
  <span class="keyword">this</span>.name = <span class="string">'ValidatorError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">this</span>.properties = properties;
  <span class="keyword">this</span>.kind = properties.type;
  <span class="keyword">this</span>.path = properties.path;
  <span class="keyword">this</span>.value = properties.value;
  <span class="keyword">this</span>.reason = properties.reason;
}</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/index.js" id="error-index-js">error/index.js</a><div class="item method public"><h3 id="error_index_MongooseError"><a href="#error_index_MongooseError">MongooseError(<code>msg</code>)</a></h3><p>MongooseError constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>msg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>Error message</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error" title="Error">Error</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">MongooseError</span><span class="params">(msg)</span> {</span>
  Error.call(<span class="keyword">this</span>);
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">this</span>.message = msg;
  <span class="keyword">this</span>.name = <span class="string">'MongooseError'</span>;
}</code></pre></div><hr class=""></div><div class="item static public"><h3 id="error_index_MongooseError.DocumentNotFoundError"><a href="#error_index_MongooseError.DocumentNotFoundError">MongooseError.DocumentNotFoundError</a></h3><p>This error will be called when <code>save()</code> fails because the underlying<br />document was not found. The constructor takes one parameter, the<br />conditions that mongoose passed to <code>update()</code> when trying to update<br />the document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseError.DocumentNotFoundError = require(<span class="string">'./notFound'</span>);</code></pre></div><hr class=""></div><div class="item static public"><h3 id="error_index_MongooseError.messages"><a href="#error_index_MongooseError.messages">MongooseError.messages</a></h3><p>The default built-in validator error messages.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">MongooseError.messages = require(<span class="string">'./messages'</span>);

<span class="comment">// backward compat</span>
MongooseError.Messages = MongooseError.messages;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Error.messages">Error.messages</a></li></ul></div><hr class=""></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/version.js" id="error-version-js">error/version.js</a><div class="item method private"><h3 id="error_version_VersionError"><a href="#error_version_VersionError">VersionError()</a></h3><p>Version Error constructor.</p><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">VersionError</span><span class="params">(doc, currentVersion, modifiedPaths)</span> {</span>
  <span class="keyword">var</span> modifiedPathsStr = modifiedPaths.join(<span class="string">', '</span>);
  MongooseError.call(<span class="keyword">this</span>, <span class="string">'No matching document found for id "'</span> + doc._id +
    <span class="string">'" version '</span> + currentVersion + <span class="string">' modifiedPaths "'</span> + modifiedPathsStr + <span class="string">'"'</span>);
  <span class="keyword">this</span>.name = <span class="string">'VersionError'</span>;
  <span class="keyword">this</span>.version = currentVersion;
  <span class="keyword">this</span>.modifiedPaths = modifiedPaths;
}</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/error/strict.js" id="error-strict-js">error/strict.js</a><div class="item method private"><h3 id="error_strict_StrictModeError"><a href="#error_strict_StrictModeError">StrictModeError(<code>type</code>, <code>value</code>)</a></h3><p>Strict mode error constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>type</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="#error_MongooseError">MongooseError</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">StrictModeError</span><span class="params">(path, msg)</span> {</span>
  msg = msg || <span class="string">'Field `'</span> + path + <span class="string">'` is not in schema and strict '</span> +
    <span class="string">'mode is set to throw.'</span>;
  MongooseError.call(<span class="keyword">this</span>, msg);
  <span class="keyword">this</span>.name = <span class="string">'StrictModeError'</span>;
  <span class="keyword">if</span> (Error.captureStackTrace) {
    Error.captureStackTrace(<span class="keyword">this</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.stack = <span class="keyword">new</span> Error().stack;
  }
  <span class="keyword">this</span>.path = path;
}</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/aggregate.js" id="aggregate-js">aggregate.js</a><div class="item method public"><h3 id="aggregate_Aggregate-addCursorFlag"><a href="#aggregate_Aggregate-addCursorFlag">Aggregate#addCursorFlag(<code>flag</code>, <code>value</code>)</a></h3><p>Adds a <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Cursor.html#addCursorFlag">cursor flag</a></p><div class="params"><h4>Parameters:</h4><ul><li><code>flag</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Cursor.html#addCursorFlag" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).addCursorFlag(<span class="string">'noCursorTimeout'</span>, <span class="literal">true</span>).exec();</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.addCursorFlag = <span class="keyword">function</span>(flag, value) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.options) {
    <span class="keyword">this</span>.options = {};
  }
  <span class="keyword">this</span>.options[flag] = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-addFields"><a href="#aggregate_Aggregate-addFields">Aggregate#addFields(<code>arg</code>)</a></h3><p>Appends a new $addFields operator to this aggregate pipeline.<br />Requires MongoDB v3.4+ to work</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>field specification</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/addFields/" title="$addFields">$addFields</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code><span class="comment">// adding new fields based on existing fields</span>
aggregate.addFields({
    newField: <span class="string">'$b.nested'</span>
  , plusTen: { $add: [<span class="string">'$val'</span>, <span class="number">10</span>]}
  , sub: {
       name: <span class="string">'$a'</span>
    }
})

<span class="comment">// etc</span>
aggregate.addFields({ salary_k: { $divide: [ <span class="string">"$salary"</span>, <span class="number">1000</span> ] } });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.addFields = <span class="keyword">function</span>(arg) {
  <span class="keyword">var</span> fields = {};
  <span class="keyword">if</span> (<span class="keyword">typeof</span> arg === <span class="string">'object'</span> &amp;&amp; !util.isArray(arg)) {
    Object.keys(arg).forEach(<span class="keyword">function</span>(field) {
      fields[field] = arg[field];
    });
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid addFields() argument. Must be an object'</span>);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.append({$addFields: fields});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate"><a href="#aggregate_Aggregate">Aggregate(<code>[ops]</code>)</a></h3><p>Aggregate constructor used for building aggregation pipelines.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[ops]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>aggregation operator(s) or operator array</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/applications/aggregation/" title="MongoDB">MongoDB</a></li><li><a href="http://mongodb.github.com/node-mongodb-native/api-generated/collection.html#aggregate" title="driver">driver</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">new</span> Aggregate();
<span class="keyword">new</span> Aggregate({ $project: { a: <span class="number">1</span>, b: <span class="number">1</span> } });
<span class="keyword">new</span> Aggregate({ $project: { a: <span class="number">1</span>, b: <span class="number">1</span> } }, { $skip: <span class="number">5</span> });
<span class="keyword">new</span> Aggregate([{ $project: { a: <span class="number">1</span>, b: <span class="number">1</span> } }, { $skip: <span class="number">5</span> }]);</code></pre>

<p>Returned when calling Model.aggregate().</p>

<h4>Example:</h4>

<pre><code>Model
.aggregate({ $match: { age: { $gte: <span class="number">21</span> }}})
.unwind(<span class="string">'tags'</span>)
.exec(callback)</code></pre>

<h4>Note:</h4>

<ul>
<li>The documents returned are plain javascript objects, not mongoose documents (since any shape of document can be returned).</li>
<li>Requires MongoDB >= 2.1</li>
<li>Mongoose does <strong>not</strong> cast pipeline stages. <code>new Aggregate({ $match: { _id: '00000000000000000000000a' } });</code> will not work unless <code>_id</code> is a string in the database. Use <code>new Aggregate({ $match: { _id: mongoose.Types.ObjectId('00000000000000000000000a') } });</code> instead.</li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Aggregate</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>._pipeline = [];
  <span class="keyword">this</span>._model = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.options = {};

  <span class="keyword">if</span> (arguments.length === <span class="number">1</span> &amp;&amp; util.isArray(arguments[<span class="number">0</span>])) {
    <span class="keyword">this</span>.append.apply(<span class="keyword">this</span>, arguments[<span class="number">0</span>]);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.append.apply(<span class="keyword">this</span>, arguments);
  }
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-allowDiskUse"><a href="#aggregate_Aggregate-allowDiskUse">Aggregate#allowDiskUse(<code>value</code>, <code>[tags]</code>)</a></h3><p>Sets the allowDiskUse option for the aggregation query (ignored for &lt; 2.6.0)</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>Should tell server it can use hard drive to store data during aggregation.</span></li><li><code>[tags]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>optional tags for this query</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/command/aggregate/" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).allowDiskUse(<span class="literal">true</span>).exec(callback)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.allowDiskUse = <span class="keyword">function</span>(value) {
  <span class="keyword">this</span>.options.allowDiskUse = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-append"><a href="#aggregate_Aggregate-append">Aggregate#append(<code>ops</code>)</a></h3><p>Appends new operators to this aggregate pipeline</p><div class="params"><h4>Parameters:</h4><ul><li><code>ops</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>operator(s) to append</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.append({ $project: { field: <span class="number">1</span> }}, { $limit: <span class="number">2</span> });

<span class="comment">// or pass an array</span>
<span class="keyword">var</span> pipeline = [{ $match: { daw: <span class="string">'Logic Audio X'</span> }} ];
aggregate.append(pipeline);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.append = <span class="keyword">function</span>() {
  <span class="keyword">var</span> args = (arguments.length === <span class="number">1</span> &amp;&amp; util.isArray(arguments[<span class="number">0</span>]))
      ? arguments[<span class="number">0</span>]
      : utils.args(arguments);

  <span class="keyword">if</span> (!args.every(isOperator)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Arguments must be aggregate pipeline operators'</span>);
  }

  <span class="keyword">this</span>._pipeline = <span class="keyword">this</span>._pipeline.concat(args);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-collation"><a href="#aggregate_Aggregate-collation">Aggregate#collation(<code>collation</code>)</a></h3><p>Adds a collation</p><div class="params"><h4>Parameters:</h4><ul><li><code>collation</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#aggregate" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).collation({ locale: <span class="string">'en_US'</span>, strength: <span class="number">1</span> }).exec();</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.collation = <span class="keyword">function</span>(collation) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.options) {
    <span class="keyword">this</span>.options = {};
  }
  <span class="keyword">this</span>.options.collation = collation;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-cursor"><a href="#aggregate_Aggregate-cursor">Aggregate#cursor(<code>options</code>, <code>options.batchSize</code>, <code>[options.useMongooseAggCursor]</code>)</a></h3><p>Sets the cursor option option for the aggregation query (ignored for &lt; 2.6.0).<br />Note the different syntax below: .exec() returns a cursor object, and no callback<br />is necessary.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>options.batchSize</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>set the cursor batch size</span></li><li><code>[options.useMongooseAggCursor]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>use experimental mongoose-specific aggregation cursor (for <code>eachAsync()</code> and other query cursor semantics)</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.0/api/AggregationCursor.html" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> cursor = Model.aggregate(..).cursor({ batchSize: <span class="number">1000</span>, useMongooseAggCursor: <span class="literal">true</span> }).exec();
cursor.each(<span class="keyword">function</span>(error, doc) {
  <span class="comment">// use doc</span>
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.cursor = <span class="keyword">function</span>(options) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.options) {
    <span class="keyword">this</span>.options = {};
  }
  <span class="keyword">this</span>.options.cursor = options || {};
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-exec"><a href="#aggregate_Aggregate-exec">Aggregate#exec(<code>[callback]</code>)</a></h3><p>Executes the aggregate pipeline on the currently bound Model.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#promise_Promise" title="Promise">Promise</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>aggregate.exec(callback);

<span class="comment">// Because a promise is returned, the `callback` is optional.</span>
<span class="keyword">var</span> promise = aggregate.exec();
promise.then(..);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.exec = <span class="keyword">function</span>(callback) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>._model) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Aggregate not bound to any Model'</span>);
  }
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> model = <span class="keyword">this</span>._model;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> options = utils.clone(<span class="keyword">this</span>.options || {});
  <span class="keyword">var</span> pipeline = <span class="keyword">this</span>._pipeline;
  <span class="keyword">var</span> collection = <span class="keyword">this</span>._model.collection;

  <span class="keyword">if</span> (options &amp;&amp; options.cursor) {
    <span class="keyword">if</span> (options.cursor.async) {
      <span class="keyword">delete</span> options.cursor.async;
      <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve) {
        <span class="keyword">if</span> (!collection.buffer) {
          process.nextTick(<span class="keyword">function</span>() {
            <span class="keyword">var</span> cursor = collection.aggregate(pipeline, options);
            decorateCursor(cursor);
            resolve(cursor);
            callback &amp;&amp; callback(<span class="literal">null</span>, cursor);
          });
          <span class="keyword">return</span>;
        }
        collection.emitter.once(<span class="string">'queue'</span>, <span class="keyword">function</span>() {
          <span class="keyword">var</span> cursor = collection.aggregate(pipeline, options);
          decorateCursor(cursor);
          resolve(cursor);
          callback &amp;&amp; callback(<span class="literal">null</span>, cursor);
        });
      });
    } <span class="keyword">else</span> <span class="keyword">if</span> (options.cursor.useMongooseAggCursor) {
      <span class="keyword">delete</span> options.cursor.useMongooseAggCursor;
      <span class="keyword">return</span> <span class="keyword">new</span> AggregationCursor(<span class="keyword">this</span>);
    }
    <span class="keyword">var</span> cursor = collection.aggregate(pipeline, options);
    decorateCursor(cursor);
    <span class="keyword">return</span> cursor;
  }

  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> (!pipeline.length) {
      <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">'Aggregate has empty pipeline'</span>);
      <span class="keyword">if</span> (callback) {
        callback(err);
      }
      reject(err);
      <span class="keyword">return</span>;
    }

    prepareDiscriminatorPipeline(_<span class="keyword">this</span>);

    model.hooks.execPre(<span class="string">'aggregate'</span>, _<span class="keyword">this</span>, <span class="keyword">function</span>(error) {
      <span class="keyword">if</span> (error) {
        <span class="keyword">var</span> _opts = { error: error };
        <span class="keyword">return</span> model.hooks.execPost(<span class="string">'aggregate'</span>, _<span class="keyword">this</span>, [<span class="literal">null</span>], _opts, <span class="keyword">function</span>(error) {
          <span class="keyword">if</span> (callback) {
            callback(error);
          }
          reject(error);
        });
      }

      collection.aggregate(pipeline, options, <span class="keyword">function</span>(error, result) {
        <span class="keyword">var</span> _opts = { error: error };
        model.hooks.execPost(<span class="string">'aggregate'</span>, _<span class="keyword">this</span>, [result], _opts, <span class="keyword">function</span>(error, result) {
          <span class="keyword">if</span> (error) {
            <span class="keyword">if</span> (callback) {
              callback(error);
            }
            reject(error);
            <span class="keyword">return</span>;
          }

          <span class="keyword">if</span> (callback) {
            callback(<span class="literal">null</span>, result);
          }
          resolve(result);
        });
      });
    });
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-explain"><a href="#aggregate_Aggregate-explain">Aggregate#explain(<code>callback</code>)</a></h3><p>Execute the aggregation with explain</p><div class="params"><h4>Parameters:</h4><ul><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).explain(callback)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.explain = <span class="keyword">function</span>(callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> (!_<span class="keyword">this</span>._pipeline.length) {
      <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">'Aggregate has empty pipeline'</span>);
      <span class="keyword">if</span> (callback) {
        callback(err);
      }
      reject(err);
      <span class="keyword">return</span>;
    }

    prepareDiscriminatorPipeline(_<span class="keyword">this</span>);

    _<span class="keyword">this</span>._model
        .collection
        .aggregate(_<span class="keyword">this</span>._pipeline, _<span class="keyword">this</span>.options || {})
        .explain(<span class="keyword">function</span>(error, result) {
          <span class="keyword">if</span> (error) {
            <span class="keyword">if</span> (callback) {
              callback(error);
            }
            reject(error);
            <span class="keyword">return</span>;
          }

          <span class="keyword">if</span> (callback) {
            callback(<span class="literal">null</span>, result);
          }
          resolve(result);
        });
  });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-facet"><a href="#aggregate_Aggregate-facet">Aggregate#facet(<code>facet</code>)</a></h3><p>Combines multiple aggregation pipelines.</p><div class="params"><h4>Parameters:</h4><ul><li><code>facet</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://docs.mongodb.com/v3.4/reference/operator/aggregation/facet/" title="$facet">$facet</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(...)
 .facet({
   books: [{ groupBy: <span class="string">'$author'</span> }],
   price: [{ $bucketAuto: { groupBy: <span class="string">'$price'</span>, buckets: <span class="number">2</span> } }]
 })
 .exec();

<span class="comment">// Output: { books: [...], price: [{...}, {...}] }</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.facet = <span class="keyword">function</span>(options) {
  <span class="keyword">return</span> <span class="keyword">this</span>.append({$facet: options});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-graphLookup"><a href="#aggregate_Aggregate-graphLookup">Aggregate#graphLookup(<code>options</code>)</a></h3><p>Appends new custom $graphLookup operator(s) to this aggregate pipeline, performing a recursive search on a collection.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to $graphLookup as described in the above link</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup" title="$graphLookup">$graphLookup</a></li></ul></div><div class="description"><p>Note that graphLookup can only consume at most 100MB of memory, and does not allow disk use even if <code>{ allowDiskUse: true }</code> is specified.</p>

<h4>Examples:</h4>

<pre><code><span class="comment">// Suppose we have a collection of courses, where a document might look like `{ _id: 0, name: 'Calculus', prerequisite: 'Trigonometry'}` and `{ _id: 0, name: 'Trigonometry', prerequisite: 'Algebra' }`</span>
 aggregate.graphLookup({ from: <span class="string">'courses'</span>, startWith: <span class="string">'$prerequisite'</span>, connectFromField: <span class="string">'prerequisite'</span>, connectToField: <span class="string">'name'</span>, as: <span class="string">'prerequisites'</span>, maxDepth: <span class="number">3</span> }) <span class="comment">// this will recursively search the 'courses' collection up to 3 prerequisites</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.graphLookup = <span class="keyword">function</span>(options) {
  <span class="keyword">var</span> cloneOptions = {};
  <span class="keyword">if</span> (options) {
    <span class="keyword">if</span> (!utils.isObject(options)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid graphLookup() argument. Must be an object.'</span>);
    }

    utils.mergeClone(cloneOptions, options);
    <span class="keyword">var</span> startWith = cloneOptions.startWith;

    <span class="keyword">if</span> (startWith &amp;&amp; <span class="keyword">typeof</span> startWith === <span class="string">'string'</span>) {
      cloneOptions.startWith = cloneOptions.startWith.charAt(<span class="number">0</span>) === <span class="string">'$'</span> ?
        cloneOptions.startWith :
        <span class="string">'$'</span> + cloneOptions.startWith;
    }

  }
  <span class="keyword">return</span> <span class="keyword">this</span>.append({ $graphLookup: cloneOptions });
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-group"><a href="#aggregate_Aggregate-group">Aggregate#group(<code>arg</code>)</a></h3><p>Appends a new custom $group operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>$group operator contents</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/group/" title="$group">$group</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.group({ _id: <span class="string">"$department"</span> });</code></pre></div><hr class=""></div><div class="item method private"><h3 id="aggregate_isOperator"><a href="#aggregate_isOperator">isOperator(<code>obj</code>)</a></h3><p>Checks whether an object is likely a pipeline operator</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>object to check</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">isOperator</span><span class="params">(obj)</span> {</span>
  <span class="keyword">var</span> k;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">'object'</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  k = Object.keys(obj);

  <span class="keyword">return</span> k.length === <span class="number">1</span> &amp;&amp; k
          .some(<span class="keyword">function</span>(key) {
            <span class="keyword">return</span> key[<span class="number">0</span>] === <span class="string">'$'</span>;
          });
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="aggregate_Aggregate-limit"><a href="#aggregate_Aggregate-limit">Aggregate#limit(<code>num</code>)</a></h3><p>Appends a new $limit operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>num</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>maximum number of records to pass to the next stage</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/limit/" title="$limit">$limit</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.limit(<span class="number">10</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-lookup"><a href="#aggregate_Aggregate-lookup">Aggregate#lookup(<code>options</code>)</a></h3><p>Appends new custom $lookup operator(s) to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>to $lookup as described in the above link</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/lookup/#pipe._S_lookup" title="$lookup">$lookup</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.lookup({ from: <span class="string">'users'</span>, localField: <span class="string">'userId'</span>, foreignField: <span class="string">'_id'</span>, as: <span class="string">'users'</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.lookup = <span class="keyword">function</span>(options) {
  <span class="keyword">return</span> <span class="keyword">this</span>.append({$lookup: options});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-match"><a href="#aggregate_Aggregate-match">Aggregate#match(<code>arg</code>)</a></h3><p>Appends a new custom $match operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>$match operator contents</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/match/" title="$match">$match</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.match({ department: { $<span class="keyword">in</span>: [ <span class="string">"sales"</span>, <span class="string">"engineering"</span> ] } });</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-model"><a href="#aggregate_Aggregate-model">Aggregate#model(<code>model</code>)</a></h3><p>Binds this aggregate to a model.</p><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#model_Model">Model</a>&gt; </span><span>the model to which the aggregate is to be bound</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.model = <span class="keyword">function</span>(model) {
  <span class="keyword">this</span>._model = model;
  <span class="keyword">if</span> (model.schema != <span class="literal">null</span>) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.options.readPreference == <span class="literal">null</span> &amp;&amp;
        model.schema.options.read != <span class="literal">null</span>) {
      <span class="keyword">this</span>.options.readPreference = model.schema.options.read;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.options.collation == <span class="literal">null</span> &amp;&amp;
        model.schema.options.collation != <span class="literal">null</span>) {
      <span class="keyword">this</span>.options.collation = model.schema.options.collation;
    }
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-near"><a href="#aggregate_Aggregate-near">Aggregate#near(<code>parameters</code>)</a></h3><p>Appends a new $geoNear operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>parameters</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/geoNear/" title="$geoNear">$geoNear</a></li></ul></div><div class="description"><h4>NOTE:</h4>

<p><strong>MUST</strong> be used as the first operator in the pipeline.</p>

<h4>Examples:</h4>

<pre><code>aggregate.near({
  near: [<span class="number">40.724</span>, -<span class="number">73.997</span>],
  distanceField: <span class="string">"dist.calculated"</span>, <span class="comment">// required</span>
  maxDistance: <span class="number">0.008</span>,
  query: { type: <span class="string">"public"</span> },
  includeLocs: <span class="string">"dist.location"</span>,
  uniqueDocs: <span class="literal">true</span>,
  num: <span class="number">5</span>
});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-option"><a href="#aggregate_Aggregate-option">Aggregate#option(<code>options</code>, <code>number</code>, <code>boolean</code>, <code>object</code>)</a></h3><p>Lets you set arbitrary options, for middleware or plugins.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>keys to merge into current options</span></li><li><code>number</code><span class="types"> &lt;<a href="#[options.maxTimeMS]">[options.maxTimeMS]</a>&gt; </span><span>limits the time this aggregation will run, see <a href="https://docs.mongodb.com/manual/reference/operator/meta/maxTimeMS/">MongoDB docs on <code>maxTimeMS</code></a></span></li><li><code>boolean</code><span class="types"> &lt;<a href="#[options.allowDiskUse]">[options.allowDiskUse]</a>&gt; </span><span>if true, the MongoDB server will use the hard drive to store data during this aggregation</span></li><li><code>object</code><span class="types"> &lt;<a href="#[options.collation]">[options.collation]</a>&gt; </span><span>see <a href="docs/api.html#aggregate_Aggregate-collation"><code>Aggregate.prototype.collation()</code></a></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/command/aggregate/" title="mongodb">mongodb</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> agg = Model.aggregate(..).option({ allowDiskUse: <span class="literal">true</span> }); <span class="comment">// Set the `allowDiskUse` option</span>
agg.options; <span class="comment">// `{ allowDiskUse: true }`</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.option = <span class="keyword">function</span>(value) {
  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> value) {
    <span class="keyword">this</span>.options[key] = value[key];
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-pipeline"><a href="#aggregate_Aggregate-pipeline">Aggregate#pipeline()</a></h3><p>Returns the current pipeline</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>MyModel.aggregate().match({ test: <span class="number">1</span> }).pipeline(); <span class="comment">// [{ $match: { test: 1 } }]</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.pipeline = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._pipeline;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-project"><a href="#aggregate_Aggregate-project">Aggregate#project(<code>arg</code>)</a></h3><p>Appends a new $project operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>field specification</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/project/" title="projection">projection</a></li></ul></div><div class="description"><p>Mongoose query <a href="#query_Query-select">selection syntax</a> is also supported.</p>

<h4>Examples:</h4>

<pre><code><span class="comment">// include a, include b, exclude _id</span>
aggregate.project(<span class="string">"a b -_id"</span>);

<span class="comment">// or you may use object notation, useful when</span>
<span class="comment">// you have keys already prefixed with a "-"</span>
aggregate.project({a: <span class="number">1</span>, b: <span class="number">1</span>, _id: <span class="number">0</span>});

<span class="comment">// reshaping documents</span>
aggregate.project({
    newField: <span class="string">'$b.nested'</span>
  , plusTen: { $add: [<span class="string">'$val'</span>, <span class="number">10</span>]}
  , sub: {
       name: <span class="string">'$a'</span>
    }
})

<span class="comment">// etc</span>
aggregate.project({ salary_k: { $divide: [ <span class="string">"$salary"</span>, <span class="number">1000</span> ] } });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.project = <span class="keyword">function</span>(arg) {
  <span class="keyword">var</span> fields = {};

  <span class="keyword">if</span> (<span class="keyword">typeof</span> arg === <span class="string">'object'</span> &amp;&amp; !util.isArray(arg)) {
    Object.keys(arg).forEach(<span class="keyword">function</span>(field) {
      fields[field] = arg[field];
    });
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">1</span> &amp;&amp; <span class="keyword">typeof</span> arg === <span class="string">'string'</span>) {
    arg.split(<span class="regexp">/\s+/</span>).forEach(<span class="keyword">function</span>(field) {
      <span class="keyword">if</span> (!field) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> include = field[<span class="number">0</span>] === <span class="string">'-'</span> ? <span class="number">0</span> : <span class="number">1</span>;
      <span class="keyword">if</span> (include === <span class="number">0</span>) {
        field = field.substring(<span class="number">1</span>);
      }
      fields[field] = include;
    });
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid project() argument. Must be string or object'</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.append({$project: fields});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-read"><a href="#aggregate_Aggregate-read">Aggregate#read(<code>pref</code>, <code>[tags]</code>)</a></h3><p>Sets the readPreference option for the aggregation query.</p><div class="params"><h4>Parameters:</h4><ul><li><code>pref</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>one of the listed preference options or their aliases</span></li><li><code>[tags]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>optional tags for this query</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/applications/replication/#read-preference" title="mongodb">mongodb</a></li><li><a href="http://mongodb.github.com/node-mongodb-native/driver-articles/anintroductionto1_1and2_2.html#read-preferences" title="driver">driver</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).read(<span class="string">'primaryPreferred'</span>).exec(callback)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.read = <span class="keyword">function</span>(pref, tags) {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.options) {
    <span class="keyword">this</span>.options = {};
  }
  read.call(<span class="keyword">this</span>, pref, tags);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-sample"><a href="#aggregate_Aggregate-sample">Aggregate#sample(<code>size</code>)</a></h3><p>Appepnds new custom $sample operator(s) to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>size</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number of random documents to pick</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://docs.mongodb.org/manual/reference/operator/aggregation/sample/#pipe._S_sample" title="$sample">$sample</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.sample(<span class="number">3</span>); <span class="comment">// Add a pipeline that picks 3 random documents</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.sample = <span class="keyword">function</span>(size) {
  <span class="keyword">return</span> <span class="keyword">this</span>.append({$sample: {size: size}});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-skip"><a href="#aggregate_Aggregate-skip">Aggregate#skip(<code>num</code>)</a></h3><p>Appends a new $skip operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>num</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number of records to skip before next stage</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/skip/" title="$skip">$skip</a></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code>aggregate.skip(<span class="number">10</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-sort"><a href="#aggregate_Aggregate-sort">Aggregate#sort(<code>arg</code>)</a></h3><p>Appends a new $sort operator to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/sort/" title="$sort">$sort</a></li></ul></div><div class="description"><p>If an object is passed, values allowed are <code>asc</code>, <code>desc</code>, <code>ascending</code>, <code>descending</code>, <code>1</code>, and <code>-1</code>.</p>

<p>If a string is passed, it must be a space delimited list of path names. The sort order of each path is ascending unless the path name is prefixed with <code>-</code> which will be treated as descending.</p>

<h4>Examples:</h4>

<pre><code><span class="comment">// these are equivalent</span>
aggregate.sort({ field: <span class="string">'asc'</span>, test: -<span class="number">1</span> });
aggregate.sort(<span class="string">'field -test'</span>);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.sort = <span class="keyword">function</span>(arg) {
  <span class="comment">// TODO refactor to reuse the query builder logic</span>

  <span class="keyword">var</span> sort = {};

  <span class="keyword">if</span> (arg.constructor.name === <span class="string">'Object'</span>) {
    <span class="keyword">var</span> desc = [<span class="string">'desc'</span>, <span class="string">'descending'</span>, -<span class="number">1</span>];
    Object.keys(arg).forEach(<span class="keyword">function</span>(field) {
      <span class="comment">// If sorting by text score, skip coercing into 1/-1</span>
      <span class="keyword">if</span> (arg[field] <span class="keyword">instanceof</span> Object &amp;&amp; arg[field].$meta) {
        sort[field] = arg[field];
        <span class="keyword">return</span>;
      }
      sort[field] = desc.indexOf(arg[field]) === -<span class="number">1</span> ? <span class="number">1</span> : -<span class="number">1</span>;
    });
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length === <span class="number">1</span> &amp;&amp; <span class="keyword">typeof</span> arg === <span class="string">'string'</span>) {
    arg.split(<span class="regexp">/\s+/</span>).forEach(<span class="keyword">function</span>(field) {
      <span class="keyword">if</span> (!field) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> ascend = field[<span class="number">0</span>] === <span class="string">'-'</span> ? -<span class="number">1</span> : <span class="number">1</span>;
      <span class="keyword">if</span> (ascend === -<span class="number">1</span>) {
        field = field.substring(<span class="number">1</span>);
      }
      sort[field] = ascend;
    });
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid sort() argument. Must be a string or object.'</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.append({$sort: sort});
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-then"><a href="#aggregate_Aggregate-then">Aggregate#then(<code>[resolve]</code>, <code>[reject]</code>)</a></h3><p>Provides promise for aggregate.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[resolve]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>successCallback</span></li><li><code>[reject]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>errorCallback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#promise_Promise" title="Promise">Promise</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.aggregate(..).then(successCallback, errorCallback);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.then = <span class="keyword">function</span>(resolve, reject) {
  <span class="keyword">return</span> <span class="keyword">this</span>.exec().then(resolve, reject);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="aggregate_Aggregate-unwind"><a href="#aggregate_Aggregate-unwind">Aggregate#unwind(<code>fields</code>)</a></h3><p>Appends new custom $unwind operator(s) to this aggregate pipeline.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fields</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>the field(s) to unwind</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/aggregation/unwind/" title="$unwind">$unwind</a></li></ul></div><div class="description"><p>Note that the <code>$unwind</code> operator requires the path name to start with '$'.<br />Mongoose will prepend '$' if the specified field doesn't start '$'.</p>

<h4>Examples:</h4>

<pre><code>aggregate.unwind(<span class="string">"tags"</span>);
aggregate.unwind(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Aggregate.prototype.unwind = <span class="keyword">function</span>() {
  <span class="keyword">var</span> args = utils.args(arguments);

  <span class="keyword">var</span> res = [];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.length; ++i) {
    <span class="keyword">var</span> arg = args[i];
    <span class="keyword">if</span> (arg &amp;&amp; <span class="keyword">typeof</span> arg === <span class="string">'object'</span>) {
      res.push({ $unwind: arg });
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> arg === <span class="string">'string'</span>) {
      res.push({
        $unwind: (arg &amp;&amp; arg.charAt(<span class="number">0</span>) === <span class="string">'$'</span>) ? arg : <span class="string">'$'</span> + arg
      });
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Invalid arg "'</span> + arg + <span class="string">'" to unwind(), '</span> +
        <span class="string">'must be string or object'</span>);
    }
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.append.apply(<span class="keyword">this</span>, res);
};</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/ES6Promise.js" id="ES6Promise-js">ES6Promise.js</a><div class="item method public"><h3 id="ES6Promise_ES6Promise"><a href="#ES6Promise_ES6Promise">ES6Promise(<code>fn</code>)</a></h3><p>ES6 Promise wrapper constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>a function which will be called when the promise is resolved that accepts <code>fn(err, ...){}</code> as signature</span></li></ul></div><div class="description"><p>Promises are returned from executed queries. Example:</p>

<pre><code><span class="keyword">var</span> query = Candy.find({ bar: <span class="literal">true</span> });
<span class="keyword">var</span> promise = query.exec();</code></pre>

<p>DEPRECATED. Mongoose 5.0 will use native promises by default (or bluebird,<br />if native promises are not present) but still<br />support plugging in your own ES6-compatible promises library. Mongoose 5.0<br />will <strong>not</strong> support mpromise.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ES6Promise</span><span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use ES6 promise with mpromise style constructor'</span>);
}

ES6Promise.use = <span class="keyword">function</span>(Promise) {
  ES6Promise.ES6 = Promise;
};

module.exports = ES6Promise;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/utils.js" id="utils-js">utils.js</a><div class="item static private"><h3 id="utils_exports.each"><a href="#utils_exports.each">exports.each(<code>arr</code>, <code>fn</code>)</a></h3><p>Executes a function on each element of an array (like _.each)</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.each = <span class="keyword">function</span>(arr, fn) {
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; ++i) {
    fn(arr[i]);
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>arr</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="utils_exports.mergeClone"><a href="#utils_exports.mergeClone">exports.mergeClone(<code>to</code>, <code>fromObj</code>)</a></h3><p>merges to with a copy of from</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.mergeClone = <span class="keyword">function</span>(to, fromObj) {
  <span class="keyword">var</span> keys = Object.keys(fromObj);
  <span class="keyword">var</span> len = keys.length;
  <span class="keyword">var</span> i = <span class="number">0</span>;
  <span class="keyword">var</span> key;

  <span class="keyword">while</span> (i &lt; len) {
    key = keys[i++];
    <span class="keyword">if</span> (<span class="keyword">typeof</span> to[key] === <span class="string">'undefined'</span>) {
      <span class="comment">// make sure to retain key order here because of a bug handling the $each</span>
      <span class="comment">// operator in mongodb 2.4.4</span>
      to[key] = exports.clone(fromObj[key], {
        retainKeyOrder: <span class="number">1</span>,
        flattenDecimals: <span class="literal">false</span>
      });
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (exports.isObject(fromObj[key])) {
        <span class="keyword">var</span> obj = fromObj[key];
        <span class="keyword">if</span> (isMongooseObject(fromObj[key]) &amp;&amp; !fromObj[key].isMongooseBuffer) {
          obj = obj.toObject({ transform: <span class="literal">false</span>, virtuals: <span class="literal">false</span> });
        }
        <span class="keyword">if</span> (fromObj[key].isMongooseBuffer) {
          obj = <span class="keyword">new</span> Buffer(obj);
        }
        exports.mergeClone(to[key], obj);
      } <span class="keyword">else</span> {
        <span class="comment">// make sure to retain key order here because of a bug handling the</span>
        <span class="comment">// $each operator in mongodb 2.4.4</span>
        to[key] = exports.clone(fromObj[key], {
          retainKeyOrder: <span class="number">1</span>,
          flattenDecimals: <span class="literal">false</span>
        });
      }
    }
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>to</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>fromObj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="utils_exports.pluralization"><a href="#utils_exports.pluralization">exports.pluralization</a></h3><p>Pluralization rules.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.pluralization = [
  [<span class="regexp">/(m)an$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(pe)rson$/gi</span>, <span class="string">'$1ople'</span>],
  [<span class="regexp">/(child)$/gi</span>, <span class="string">'$1ren'</span>],
  [<span class="regexp">/^(ox)$/gi</span>, <span class="string">'$1en'</span>],
  [<span class="regexp">/(ax|test)is$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(octop|vir)us$/gi</span>, <span class="string">'$1i'</span>],
  [<span class="regexp">/(alias|status)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(bu)s$/gi</span>, <span class="string">'$1ses'</span>],
  [<span class="regexp">/(buffal|tomat|potat)o$/gi</span>, <span class="string">'$1oes'</span>],
  [<span class="regexp">/([ti])um$/gi</span>, <span class="string">'$1a'</span>],
  [<span class="regexp">/sis$/gi</span>, <span class="string">'ses'</span>],
  [<span class="regexp">/(?:([^f])fe|([lr])f)$/gi</span>, <span class="string">'$1$2ves'</span>],
  [<span class="regexp">/(hive)$/gi</span>, <span class="string">'$1s'</span>],
  [<span class="regexp">/([^aeiouy]|qu)y$/gi</span>, <span class="string">'$1ies'</span>],
  [<span class="regexp">/(x|ch|ss|sh)$/gi</span>, <span class="string">'$1es'</span>],
  [<span class="regexp">/(matr|vert|ind)ix|ex$/gi</span>, <span class="string">'$1ices'</span>],
  [<span class="regexp">/([m|l])ouse$/gi</span>, <span class="string">'$1ice'</span>],
  [<span class="regexp">/(kn|w|l)ife$/gi</span>, <span class="string">'$1ives'</span>],
  [<span class="regexp">/(quiz)$/gi</span>, <span class="string">'$1zes'</span>],
  [<span class="regexp">/s$/gi</span>, <span class="string">'s'</span>],
  [<span class="regexp">/([^a-z])$/</span>, <span class="string">'$1'</span>],
  [<span class="regexp">/$/gi</span>, <span class="string">'s'</span>]
];
<span class="keyword">var</span> rules = exports.pluralization;</code></pre></div><p>These rules are applied while processing the argument to <code>toCollectionName</code>.</p><hr class=""></div><div class="item static public"><h3 id="utils_exports.uncountables"><a href="#utils_exports.uncountables">exports.uncountables</a></h3><p>Uncountable words.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.uncountables = [
  <span class="string">'advice'</span>,
  <span class="string">'energy'</span>,
  <span class="string">'excretion'</span>,
  <span class="string">'digestion'</span>,
  <span class="string">'cooperation'</span>,
  <span class="string">'health'</span>,
  <span class="string">'justice'</span>,
  <span class="string">'labour'</span>,
  <span class="string">'machinery'</span>,
  <span class="string">'equipment'</span>,
  <span class="string">'information'</span>,
  <span class="string">'pollution'</span>,
  <span class="string">'sewage'</span>,
  <span class="string">'paper'</span>,
  <span class="string">'money'</span>,
  <span class="string">'species'</span>,
  <span class="string">'series'</span>,
  <span class="string">'rain'</span>,
  <span class="string">'rice'</span>,
  <span class="string">'fish'</span>,
  <span class="string">'sheep'</span>,
  <span class="string">'moose'</span>,
  <span class="string">'deer'</span>,
  <span class="string">'news'</span>,
  <span class="string">'expertise'</span>,
  <span class="string">'status'</span>,
  <span class="string">'media'</span>
];
<span class="keyword">var</span> uncountables = exports.uncountables;</code></pre></div><p>These words are applied while processing the argument to <code>toCollectionName</code>.</p><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/browser.js" id="browser-js">browser.js</a><div class="item method public"><h3 id="browser_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise"><a href="#browser_function%20Object()%20%7B%20%5Bnative%20code%5D%20%7D-Promise">function Object() { [native code] }#Promise()</a></h3><p>The Mongoose <a href="#promise_Promise">Promise</a> constructor.</p><div class="description"></div><hr class=""></div><div class="item static public"><h3 id="browser_exports.Document"><a href="#browser_exports.Document">exports.Document()</a></h3><p>The Mongoose browser <a href="#document-js">Document</a> constructor.</p><hr class=""></div><div class="item static public"><h3 id="browser_exports.Error"><a href="#browser_exports.Error">exports.Error()</a></h3><p>The <a href="#error_MongooseError">MongooseError</a> constructor.</p><hr class=""></div><div class="item static public"><h3 id="browser_exports.PromiseProvider"><a href="#browser_exports.PromiseProvider">exports.PromiseProvider()</a></h3><p>Storage layer for mongoose promises</p><hr class=""></div><div class="item static public"><h3 id="browser_exports.Schema"><a href="#browser_exports.Schema">exports.Schema()</a></h3><p>The Mongoose <a href="#schema_Schema">Schema</a> constructor</p><h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> Schema = mongoose.Schema;
<span class="keyword">var</span> CatSchema = <span class="keyword">new</span> Schema(..);</code></pre><hr class=""></div><div class="item static public"><h3 id="browser_exports.VirtualType"><a href="#browser_exports.VirtualType">exports.VirtualType()</a></h3><p>The Mongoose <a href="#virtualtype_VirtualType">VirtualType</a> constructor</p><hr class=""></div><div class="item property public"><h3 id="browser_exports-SchemaTypes"><a href="#browser_exports-SchemaTypes">exports#<span>SchemaTypes</span></a></h3><p>The various Mongoose SchemaTypes.</p>

<h4>Note:</h4>

<p><em>Alias of mongoose.Schema.Types for backwards compatibility.</em></p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.SchemaType = require(<span class="string">'./schematype.js'</span>);</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#schema_Schema.Types" title="Schema.SchemaTypes">Schema.SchemaTypes</a></li></ul></div><hr class=""></div><div class="item property public"><h3 id="browser_exports-Types"><a href="#browser_exports-Types">exports#<span>Types</span></a></h3><p>The various Mongoose Types.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> array = mongoose.Types.Array;</code></pre>

<h4>Types:</h4>

<ul>
<li><a href="#types-objectid-js">ObjectId</a></li>
<li><a href="#types-buffer-js">Buffer</a></li>
<li><a href="#types-embedded-js">SubDocument</a></li>
<li><a href="#types-array-js">Array</a></li>
<li><a href="#types-documentarray-js">DocumentArray</a></li>
</ul>

<p>Using this exposed access to the <code>ObjectId</code> type, we can construct ids on demand.</p>

<pre><code><span class="keyword">var</span> ObjectId = mongoose.Types.ObjectId;
<span class="keyword">var</span> id1 = <span class="keyword">new</span> ObjectId;</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.Types = require(<span class="string">'./types'</span>);</code></pre></div><hr class=""></div><div class="item property private"><h3 id="browser_exports-utils"><a href="#browser_exports-utils">exports#<span>utils</span></a></h3><p>Internal utils</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">exports.utils = require(<span class="string">'./utils.js'</span>);</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/promise.js" id="promise-js">promise.js</a><div class="item method public"><h3 id="promise_Promise-addBack"><a href="#promise_Promise-addBack">Promise#addBack(<code>listener</code>)</a></h3><p>Adds a single function as a listener to both err and complete.</p><div class="params"><h4>Parameters:</h4><ul><li><code>listener</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>It will be executed with traditional node.js argument position when the promise is resolved.</p>

<pre><code>promise.addBack(<span class="function"><span class="keyword">function</span> <span class="params">(err, args...)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  console.log(<span class="string">'success'</span>);
})</code></pre>

<p>Alias of <a href="https://github.com/aheckmann/mpromise#onresolve">mpromise#onResolve</a>.</p>

<p><em>Deprecated. Use <code>onResolve</code> instead.</em></p></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-addCallback"><a href="#promise_Promise-addCallback">Promise#addCallback(<code>listener</code>)</a></h3><p>Adds a listener to the <code>complete</code> (success) event.</p><div class="params"><h4>Parameters:</h4><ul><li><code>listener</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Alias of <a href="https://github.com/aheckmann/mpromise#onfulfill">mpromise#onFulfill</a>.</p>

<p><em>Deprecated. Use <code>onFulfill</code> instead.</em></p></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-addErrback"><a href="#promise_Promise-addErrback">Promise#addErrback(<code>listener</code>)</a></h3><p>Adds a listener to the <code>err</code> (rejected) event.</p><div class="params"><h4>Parameters:</h4><ul><li><code>listener</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Alias of <a href="https://github.com/aheckmann/mpromise#onreject">mpromise#onReject</a>.</p>

<p><em>Deprecated. Use <code>onReject</code> instead.</em></p></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-catch"><a href="#promise_Promise-catch">Promise#catch(<code>onReject</code>)</a></h3><p>ES6-style <code>.catch()</code> shorthand</p><div class="params"><h4>Parameters:</h4><ul><li><code>onReject</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-end"><a href="#promise_Promise-end">Promise#end()</a></h3><p>Signifies that this promise was the last in a chain of <code>then()s</code>: if a handler passed to the call to <code>then</code> which produced this promise throws, the exception will go uncaught.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/aheckmann/mpromise#end" title="mpromise#end">mpromise#end</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> p = <span class="keyword">new</span> Promise;
p.then(<span class="keyword">function</span>(){ <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'shucks'</span>) });
setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  p.fulfill();
  <span class="comment">// error was caught and swallowed by the promise returned from</span>
  <span class="comment">// p.then(). we either have to always register handlers on</span>
  <span class="comment">// the returned promises or we can do the following...</span>
}, <span class="number">10</span>);

<span class="comment">// this time we use .end() which prevents catching thrown errors</span>
<span class="keyword">var</span> p = <span class="keyword">new</span> Promise;
<span class="keyword">var</span> p2 = p.then(<span class="keyword">function</span>(){ <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'shucks'</span>) }).end(); <span class="comment">// &amp;lt;--</span>
setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  p.fulfill(); <span class="comment">// throws "shucks"</span>
}, <span class="number">10</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-error"><a href="#promise_Promise-error">Promise#error(<code>err</code>)</a></h3><p>Rejects this promise with <code>err</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>If the promise has already been fulfilled or rejected, not action is taken.</p>

<p>Differs from <a href="#promise_Promise-reject">#reject</a> by first casting <code>err</code> to an <code>Error</code> if it is not <code>instanceof Error</code>.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.error = <span class="keyword">function</span>(err) {
  <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> Error)) {
    <span class="keyword">if</span> (err <span class="keyword">instanceof</span> Object) {
      err = util.inspect(err);
    }
    err = <span class="keyword">new</span> Error(err);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.reject(err);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-on"><a href="#promise_Promise-on">Promise#on(<code>event</code>, <code>listener</code>)</a></h3><p>Adds <code>listener</code> to the <code>event</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>event</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>listener</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/aheckmann/mpromise#on" title="mpromise#on">mpromise#on</a></li></ul></div><div class="description"><p>If <code>event</code> is either the success or failure event and the event has already been emitted, the<code>listener</code> is called immediately and passed the results of the original emitted event.</p></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise"><a href="#promise_Promise">Promise(<code>fn</code>)</a></h3><p>Promise constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>a function which will be called when the promise is resolved that accepts <code>fn(err, ...){}</code> as signature</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="https://github.com/aheckmann/mpromise" title="mpromise">mpromise</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>err</code>: Emits when the promise is rejected</p></li><li><p><code>complete</code>: Emits when the promise is fulfilled</p></li></ul></div><div class="description"><p>Promises are returned from executed queries. Example:</p>

<pre><code><span class="keyword">var</span> query = Candy.find({ bar: <span class="literal">true</span> });
<span class="keyword">var</span> promise = query.exec();</code></pre>

<p>DEPRECATED. Mongoose 5.0 will use native promises by default (or bluebird,<br />if native promises are not present) but still<br />support plugging in your own ES6-compatible promises library. Mongoose 5.0<br />will <strong>not</strong> support mpromise.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span><span class="params">(fn)</span> {</span>
  MPromise.call(<span class="keyword">this</span>, fn);
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-reject"><a href="#promise_Promise-reject">Promise#reject(<code>reason</code>)</a></h3><p>Rejects this promise with <code>reason</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>reason</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/aheckmann/mpromise#reject" title="mpromise#reject">mpromise#reject</a></li></ul></div><div class="description"><p>If the promise has already been fulfilled or rejected, not action is taken.</p></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-resolve"><a href="#promise_Promise-resolve">Promise#resolve(<code>[err]</code>, <code>[val]</code>)</a></h3><p>Resolves this promise to a rejected state if <code>err</code> is passed or a fulfilled state if no <code>err</code> is passed.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[err]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span>error or null</span></li><li><code>[val]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>value to fulfill the promise with</span></li></ul></div><div class="description"><p>If the promise has already been fulfilled or rejected, not action is taken.</p>

<p><code>err</code> will be cast to an Error if not already instanceof Error.</p>

<p><em>NOTE: overrides <a href="https://github.com/aheckmann/mpromise#resolve">mpromise#resolve</a> to provide error casting.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.prototype.resolve = <span class="keyword">function</span>(err) {
  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">this</span>.error(err);
  <span class="keyword">return</span> <span class="keyword">this</span>.fulfill.apply(<span class="keyword">this</span>, Array.prototype.slice.call(arguments, <span class="number">1</span>));
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="promise_Promise-then"><a href="#promise_Promise-then">Promise#then(<code>onFulFill</code>, <code>onReject</code>)</a></h3><p>Creates a new promise and returns it. If <code>onFulfill</code> or <code>onReject</code> are passed, they are added as SUCCESS/ERROR callbacks to this promise after the nextTick.</p><div class="params"><h4>Parameters:</h4><ul><li><code>onFulFill</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>onReject</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>newPromise</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/promises-aplus/promises-spec" title="promises-A+">promises-A+</a></li><li><a href="https://github.com/aheckmann/mpromise#then" title="mpromise#then">mpromise#then</a></li></ul></div><div class="description"><p>Conforms to <a href="https://github.com/promises-aplus/promises-spec">promises/A+</a> specification.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> promise = Meetups.find({ tags: <span class="string">'javascript'</span> }).select(<span class="string">'_id'</span>).exec();
promise.then(<span class="function"><span class="keyword">function</span> <span class="params">(meetups)</span> {</span>
  <span class="keyword">var</span> ids = meetups.map(<span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="keyword">return</span> m._id;
  });
  <span class="keyword">return</span> People.find({ meetups: { $<span class="keyword">in</span>: ids } }).exec();
}).then(<span class="function"><span class="keyword">function</span> <span class="params">(people)</span> {</span>
  <span class="keyword">if</span> (people.length &amp;lt; <span class="number">10000</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Too few people!!!'</span>);
  } <span class="keyword">else</span> {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Still need more people!!!'</span>);
  }
}).then(<span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  assert.ok(err <span class="keyword">instanceof</span> Error);
});</code></pre></div><hr class=""></div><div class="item static public"><h3 id="promise_Promise.complete"><a href="#promise_Promise.complete">Promise.complete(<code>args</code>)</a></h3><p>Fulfills this promise with passed arguments.</p><div class="params"><h4>Parameters:</h4><ul><li><code>args</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><p>Alias of <a href="https://github.com/aheckmann/mpromise#fulfill">mpromise#fulfill</a>.</p>

<p><em>Deprecated. Use <code>fulfill</code> instead.</em></p><hr class=""></div><div class="item static public"><h3 id="promise_Promise.ES6"><a href="#promise_Promise.ES6">Promise.ES6(<code>resolver</code>)</a></h3><p>ES6-style promise constructor wrapper around mpromise.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.ES6 = <span class="keyword">function</span>(resolver) {
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise();

  <span class="comment">// No try/catch for backwards compatibility</span>
  resolver(
    <span class="keyword">function</span>() {
      promise.complete.apply(promise, arguments);
    },
    <span class="keyword">function</span>(e) {
      promise.error(e);
    });

  <span class="keyword">return</span> promise;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>resolver</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>new promise</span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="promise_Promise.fulfill"><a href="#promise_Promise.fulfill">Promise.fulfill(<code>args</code>)</a></h3><p>Fulfills this promise with passed arguments.</p><div class="params"><h4>Parameters:</h4><ul><li><code>args</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/aheckmann/mpromise#fulfill">https://github.com/aheckmann/mpromise#fulfill</a></li></ul></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schematype.js" id="schematype-js">schematype.js</a><div class="item method private"><h3 id="schematype_SchemaType-applyGetters"><a href="#schematype_SchemaType-applyGetters">SchemaType#applyGetters(<code>value</code>, <code>scope</code>)</a></h3><p>Applies getters to a value</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.applyGetters = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">var</span> v = value,
      getters = <span class="keyword">this</span>.getters,
      len = getters.length;

  <span class="keyword">if</span> (!len) {
    <span class="keyword">return</span> v;
  }

  <span class="keyword">while</span> (len--) {
    v = getters[len].call(scope, v, <span class="keyword">this</span>);
  }

  <span class="keyword">return</span> v;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schematype_SchemaType-applySetters"><a href="#schematype_SchemaType-applySetters">SchemaType#applySetters(<code>value</code>, <code>scope</code>, <code>init</code>)</a></h3><p>Applies setters</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.applySetters = <span class="keyword">function</span>(value, scope, init, priorVal, options) {
  <span class="keyword">var</span> v = <span class="keyword">this</span>._applySetters(value, scope, init, priorVal, options);

  <span class="keyword">if</span> (v == <span class="literal">null</span>) {
    <span class="keyword">return</span> v;
  }

  <span class="comment">// do not cast until all setters are applied #665</span>
  v = <span class="keyword">this</span>.cast(v, scope, init, priorVal, options);

  <span class="keyword">return</span> v;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schematype_SchemaType-castForQuery"><a href="#schematype_SchemaType-castForQuery">SchemaType#castForQuery(<code>[$conditional]</code>, <code>val</code>)</a></h3><p>Cast the given value with the given optional query operator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[$conditional]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>query operator, like <code>$eq</code> or <code>$in</code></span></li><li><code>val</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.castForQuery = <span class="keyword">function</span>($conditional, val) {
  <span class="keyword">var</span> handler;
  <span class="keyword">if</span> (arguments.length === <span class="number">2</span>) {
    handler = <span class="keyword">this</span>.$conditionalHandlers[$conditional];
    <span class="keyword">if</span> (!handler) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Can\'t use '</span> + $conditional);
    }
    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, val);
  }
  val = $conditional;
  <span class="keyword">return</span> <span class="keyword">this</span>._castForQuery(val);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schematype_SchemaType-checkRequired"><a href="#schematype_SchemaType-checkRequired">SchemaType#checkRequired(<code>val</code>)</a></h3><p>Default check for if this path satisfies the <code>required</code> validator.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.checkRequired = <span class="keyword">function</span>(val) {
  <span class="keyword">return</span> val != <span class="literal">null</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schematype_SchemaType-default"><a href="#schematype_SchemaType-default">SchemaType#default(<code>val</code>)</a></h3><p>Sets a default value for this SchemaType.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, T&gt; </span><span>the default value</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#defaultValue">defaultValue</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ n: { type: Number, <span class="keyword">default</span>: <span class="number">10</span> })
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, schema)
<span class="keyword">var</span> m = <span class="keyword">new</span> M;
console.log(m.n) <span class="comment">// 10</span></code></pre>

<p>Defaults can be either <code>functions</code> which return the value to use as the default or the literal value itself. Either way, the value will be cast based on its schema type before being set during document creation.</p>

<h4>Example:</h4>

<pre><code><span class="comment">// values are cast:</span>
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ aNumber: { type: Number, <span class="keyword">default</span>: <span class="number">4.815162342</span> }})
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, schema)
<span class="keyword">var</span> m = <span class="keyword">new</span> M;
console.log(m.aNumber) <span class="comment">// 4.815162342</span>

<span class="comment">// default unique objects for Mixed types:</span>
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ mixed: Schema.Types.Mixed });
schema.path(<span class="string">'mixed'</span>).<span class="keyword">default</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> {};
});

<span class="comment">// if we don't use a function to return object literals for Mixed defaults,</span>
<span class="comment">// each document will receive a reference to the same object literal creating</span>
<span class="comment">// a "shared" object instance:</span>
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ mixed: Schema.Types.Mixed });
schema.path(<span class="string">'mixed'</span>).<span class="keyword">default</span>({});
<span class="keyword">var</span> M = db.model(<span class="string">'M'</span>, schema);
<span class="keyword">var</span> m1 = <span class="keyword">new</span> M;
m1.mixed.added = <span class="number">1</span>;
console.log(m1.mixed); <span class="comment">// { added: 1 }</span>
<span class="keyword">var</span> m2 = <span class="keyword">new</span> M;
console.log(m2.mixed); <span class="comment">// { added: 1 }</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.<span class="keyword">default</span> = <span class="keyword">function</span>(val) {
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    <span class="keyword">if</span> (val === <span class="keyword">void</span> <span class="number">0</span>) {
      <span class="keyword">this</span>.defaultValue = <span class="keyword">void</span> <span class="number">0</span>;
      <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
    }
    <span class="keyword">this</span>.defaultValue = val;
    <span class="keyword">return</span> <span class="keyword">this</span>.defaultValue;
  } <span class="keyword">else</span> <span class="keyword">if</span> (arguments.length > <span class="number">1</span>) {
    <span class="keyword">this</span>.defaultValue = utils.args(arguments);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.defaultValue;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schematype_SchemaType-doValidate"><a href="#schematype_SchemaType-doValidate">SchemaType#doValidate(<code>value</code>, <code>callback</code>, <code>scope</code>)</a></h3><p>Performs a validation of <code>value</code> using the validators declared for this SchemaType.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;T&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.doValidate = <span class="keyword">function</span>(value, fn, scope) {
  <span class="keyword">var</span> err = <span class="literal">false</span>;
  <span class="keyword">var</span> path = <span class="keyword">this</span>.path;
  <span class="keyword">var</span> count = <span class="keyword">this</span>.validators.length;

  <span class="keyword">if</span> (!count) {
    <span class="keyword">return</span> fn(<span class="literal">null</span>);
  }

  <span class="keyword">var</span> validate = <span class="keyword">function</span>(ok, validatorProperties) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (ok === <span class="literal">undefined</span> || ok) {
      --count || fn(<span class="literal">null</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> ErrorConstructor = validatorProperties.ErrorConstructor || ValidatorError;
      err = <span class="keyword">new</span> ErrorConstructor(validatorProperties);
      err.$isValidatorError = <span class="literal">true</span>;
      fn(err);
    }
  };

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">this</span>.validators.forEach(<span class="keyword">function</span>(v) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span>;
    }

    <span class="keyword">var</span> validator = v.validator;
    <span class="keyword">var</span> ok;

    <span class="keyword">var</span> validatorProperties = utils.clone(v);
    validatorProperties.path = path;
    validatorProperties.value = value;

    <span class="keyword">if</span> (validator <span class="keyword">instanceof</span> RegExp) {
      validate(validator.test(value), validatorProperties);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> validator === <span class="string">'function'</span>) {
      <span class="keyword">if</span> (value === <span class="literal">undefined</span> &amp;&amp; validator !== _<span class="keyword">this</span>.requiredValidator) {
        validate(<span class="literal">true</span>, validatorProperties);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (validatorProperties.isAsync) {
        asyncValidate(validator, scope, value, validatorProperties, validate);
      } <span class="keyword">else</span> <span class="keyword">if</span> (validator.length === <span class="number">2</span> &amp;&amp; !(<span class="string">'isAsync'</span> <span class="keyword">in</span> validatorProperties)) {
        legacyAsyncValidate(validator, scope, value, validatorProperties,
          validate);
      } <span class="keyword">else</span> {
        <span class="keyword">try</span> {
          ok = validator.call(scope, value);
        } <span class="keyword">catch</span> (error) {
          ok = <span class="literal">false</span>;
          validatorProperties.reason = error;
        }
        <span class="keyword">if</span> (ok &amp;&amp; <span class="keyword">typeof</span> ok.then === <span class="string">'function'</span>) {
          ok.then(
            <span class="keyword">function</span>(ok) { validate(ok, validatorProperties); },
            <span class="keyword">function</span>(error) {
              validatorProperties.reason = error;
              ok = <span class="literal">false</span>;
              validate(ok, validatorProperties);
            });
        } <span class="keyword">else</span> {
          validate(ok, validatorProperties);
        }
      }
    }
  });
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="schematype_SchemaType-doValidateSync"><a href="#schematype_SchemaType-doValidateSync">SchemaType#doValidateSync(<code>value</code>, <code>scope</code>)</a></h3><p>Performs a validation of <code>value</code> using the validators declared for this SchemaType.</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;T&gt; </span><span></span></li><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#error_MongooseError">MongooseError</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/undefined">undefined</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Note:</h4>

<p>This method ignores the asynchronous validators.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.doValidateSync = <span class="keyword">function</span>(value, scope) {
  <span class="keyword">var</span> err = <span class="literal">null</span>,
      path = <span class="keyword">this</span>.path,
      count = <span class="keyword">this</span>.validators.length;

  <span class="keyword">if</span> (!count) {
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> validate = <span class="keyword">function</span>(ok, validatorProperties) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (ok !== <span class="literal">undefined</span> &amp;&amp; !ok) {
      <span class="keyword">var</span> ErrorConstructor = validatorProperties.ErrorConstructor || ValidatorError;
      err = <span class="keyword">new</span> ErrorConstructor(validatorProperties);
      err.$isValidatorError = <span class="literal">true</span>;
    }
  };

  <span class="keyword">var</span> validators = <span class="keyword">this</span>.validators;
  <span class="keyword">if</span> (value === <span class="keyword">void</span> <span class="number">0</span>) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.validators.length > <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.validators[<span class="number">0</span>].type === <span class="string">'required'</span>) {
      validators = [<span class="keyword">this</span>.validators[<span class="number">0</span>]];
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }
  }

  validators.forEach(<span class="keyword">function</span>(v) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span>;
    }

    <span class="keyword">var</span> validator = v.validator;
    <span class="keyword">var</span> validatorProperties = utils.clone(v);
    validatorProperties.path = path;
    validatorProperties.value = value;
    <span class="keyword">var</span> ok;

    <span class="keyword">if</span> (validator <span class="keyword">instanceof</span> RegExp) {
      validate(validator.test(value), validatorProperties);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> validator === <span class="string">'function'</span>) {
      <span class="comment">// if not async validators</span>
      <span class="keyword">if</span> (validator.length !== <span class="number">2</span> &amp;&amp; !validatorProperties.isAsync) {
        <span class="keyword">try</span> {
          ok = validator.call(scope, value);
        } <span class="keyword">catch</span> (error) {
          ok = <span class="literal">false</span>;
          validatorProperties.reason = error;
        }
        validate(ok, validatorProperties);
      }
    }
  });

  <span class="keyword">return</span> err;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schematype_SchemaType-get"><a href="#schematype_SchemaType-get">SchemaType#get(<code>fn</code>)</a></h3><p>Adds a getter to this schematype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">dob</span> <span class="params">(val)</span> {</span>
  <span class="keyword">if</span> (!val) <span class="keyword">return</span> val;
  <span class="keyword">return</span> (val.getMonth() + <span class="number">1</span>) + <span class="string">"/"</span> + val.getDate() + <span class="string">"/"</span> + val.getFullYear();
}

<span class="comment">// defining within the schema</span>
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ born: { type: Date, get: dob })

<span class="comment">// or by retreiving its SchemaType</span>
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ born: Date })
s.path(<span class="string">'born'</span>).get(dob)</code></pre>

<p>Getters allow you to transform the representation of the data as it travels from the raw mongodb document to the value that you see.</p>

<p>Suppose you are storing credit card numbers and you want to hide everything except the last 4 digits to the mongoose user. You can do so by defining a getter in the following way:</p>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">obfuscate</span> <span class="params">(cc)</span> {</span>
  <span class="keyword">return</span> <span class="string">'****-****-****-'</span> + cc.slice(cc.length-<span class="number">4</span>, cc.length);
}

<span class="keyword">var</span> AccountSchema = <span class="keyword">new</span> Schema({
  creditCardNumber: { type: String, get: obfuscate }
});

<span class="keyword">var</span> Account = db.model(<span class="string">'Account'</span>, AccountSchema);

Account.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, found)</span> {</span>
  console.log(found.creditCardNumber); <span class="comment">// '****-****-****-1234'</span>
});</code></pre>

<p>Getters are also passed a second argument, the schematype on which the getter was defined. This allows for tailored behavior based on options passed in the schema.</p>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">inspector</span> <span class="params">(val, schematype)</span> {</span>
  <span class="keyword">if</span> (schematype.options.required) {
    <span class="keyword">return</span> schematype.path + <span class="string">' is required'</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> schematype.path + <span class="string">' is not'</span>;
  }
}

<span class="keyword">var</span> VirusSchema = <span class="keyword">new</span> Schema({
  name: { type: String, required: <span class="literal">true</span>, get: inspector },
  taxonomy: { type: String, get: inspector }
})

<span class="keyword">var</span> Virus = db.model(<span class="string">'Virus'</span>, VirusSchema);

Virus.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, virus)</span> {</span>
  console.log(virus.name);     <span class="comment">// name is required</span>
  console.log(virus.taxonomy); <span class="comment">// taxonomy is not</span>
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.get = <span class="keyword">function</span>(fn) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'A getter must be a function.'</span>);
  }
  <span class="keyword">this</span>.getters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schematype_SchemaType-getDefault"><a href="#schematype_SchemaType-getDefault">SchemaType#getDefault(<code>scope</code>, <code>init</code>)</a></h3><p>Gets the default value</p><div class="params"><h4>Parameters:</h4><ul><li><code>scope</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the scope which callback are executed</span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.getDefault = <span class="keyword">function</span>(scope, init) {
  <span class="keyword">var</span> ret = <span class="keyword">typeof</span> <span class="keyword">this</span>.defaultValue === <span class="string">'function'</span>
      ? <span class="keyword">this</span>.defaultValue.call(scope)
      : <span class="keyword">this</span>.defaultValue;

  <span class="keyword">if</span> (ret !== <span class="literal">null</span> &amp;&amp; ret !== <span class="literal">undefined</span>) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> ret === <span class="string">'object'</span> &amp;&amp; (!<span class="keyword">this</span>.options || !<span class="keyword">this</span>.options.shared)) {
      ret = utils.clone(ret, { retainKeyOrder: <span class="literal">true</span> });
    }

    <span class="keyword">var</span> casted = <span class="keyword">this</span>.cast(ret, scope, init);
    <span class="keyword">if</span> (casted &amp;&amp; casted.$isSingleNested) {
      casted.$parent = scope;
    }
    <span class="keyword">return</span> casted;
  }
  <span class="keyword">return</span> ret;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schematype_SchemaType-index"><a href="#schematype_SchemaType-index">SchemaType#index(<code>options</code>)</a></h3><p>Declares the index options for this schematype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, index: <span class="literal">true</span> })
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ loc: { type: [Number], index: <span class="string">'hashed'</span> })
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ loc: { type: [Number], index: <span class="string">'2d'</span>, sparse: <span class="literal">true</span> })
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ loc: { type: [Number], index: { type: <span class="string">'2dsphere'</span>, sparse: <span class="literal">true</span> }})
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ date: { type: Date, index: { unique: <span class="literal">true</span>, expires: <span class="string">'1d'</span> }})
Schema.path(<span class="string">'my.path'</span>).index(<span class="literal">true</span>);
Schema.path(<span class="string">'my.date'</span>).index({ expires: <span class="number">60</span> });
Schema.path(<span class="string">'my.path'</span>).index({ unique: <span class="literal">true</span>, sparse: <span class="literal">true</span> });</code></pre>

<h4>NOTE:</h4>

<p><em>Indexes are created in the background by default. Specify <code>background: false</code> to override.</em></p>

<p><a href="http://www.mongodb.org/display/DOCS/Indexes#Indexes-CompoundKeysIndexes">Direction doesn't matter for single key indexes</a></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.index = <span class="keyword">function</span>(options) {
  <span class="keyword">this</span>._index = options;
  utils.expires(<span class="keyword">this</span>._index);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-required"><a href="#schematype_SchemaType-required">SchemaType#required(<code>required</code>, <code>[options.isRequired]</code>, <code>[options.ErrorConstructor]</code>, <code>[message]</code>)</a></h3><p>Adds a required validator to this SchemaType. The validator gets added<br />to the front of this SchemaType's validators array using <code>unshift()</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>required</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>enable/disable the validator, or function that returns required boolean, or options object</span></li><li><code>[options.isRequired]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>enable/disable the validator, or function that returns required boolean</span></li><li><code>[options.ErrorConstructor]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>custom error constructor. The constructor receives 1 parameter, an object containing the validator properties.</span></li><li><code>[message]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional custom error message</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#error_messages_MongooseError-messages" title="Customized Error Messages">Customized Error Messages</a></li><li><a href="#schema_array_SchemaArray.checkRequired" title="SchemaArray#checkRequired">SchemaArray#checkRequired</a></li><li><a href="#schema_boolean_SchemaBoolean-checkRequired" title="SchemaBoolean#checkRequired">SchemaBoolean#checkRequired</a></li><li><a href="#schema_buffer_SchemaBuffer.schemaName" title="SchemaBuffer#checkRequired">SchemaBuffer#checkRequired</a></li><li><a href="#schema_number_SchemaNumber-min" title="SchemaNumber#checkRequired">SchemaNumber#checkRequired</a></li><li><a href="#schema_objectid_ObjectId-auto" title="SchemaObjectId#checkRequired">SchemaObjectId#checkRequired</a></li><li><a href="#schema_string_SchemaString-checkRequired" title="SchemaString#checkRequired">SchemaString#checkRequired</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ born: { type: Date, required: <span class="literal">true</span> })

<span class="comment">// or with custom error message</span>

<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ born: { type: Date, required: <span class="string">'{PATH} is required!'</span> })

<span class="comment">// or with a function</span>

<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({
  userId: ObjectId,
  username: {
    type: String,
    required: <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="keyword">this</span>.userId != <span class="literal">null</span>; }
  }
})

<span class="comment">// or with a function and a custom message</span>
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({
  userId: ObjectId,
  username: {
    type: String,
    required: [
      <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="keyword">this</span>.userId != <span class="literal">null</span>; },
      <span class="string">'username is required if id is specified'</span>
    ]
  }
})

<span class="comment">// or through the path API</span>

Schema.path(<span class="string">'name'</span>).required(<span class="literal">true</span>);

<span class="comment">// with custom error messaging</span>

Schema.path(<span class="string">'name'</span>).required(<span class="literal">true</span>, <span class="string">'grrr :( '</span>);

<span class="comment">// or make a path conditionally required based on a function</span>
<span class="keyword">var</span> isOver18 = <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="keyword">this</span>.age &amp;gt;= <span class="number">18</span>; };
Schema.path(<span class="string">'voterRegistrationId'</span>).required(isOver18);</code></pre>

<p>The required validator uses the SchemaType's <code>checkRequired</code> function to<br />determine whether a given value satisfies the required validator. By default,<br />a value satisfies the required validator if <code>val != null</code> (that is, if<br />the value is not null nor undefined). However, most built-in mongoose schema<br />types override the default <code>checkRequired</code> function:</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.required = <span class="keyword">function</span>(required, message) {
  <span class="keyword">var</span> customOptions = {};
  <span class="keyword">if</span> (<span class="keyword">typeof</span> required === <span class="string">'object'</span>) {
    customOptions = required;
    message = customOptions.message || message;
    required = required.isRequired;
  }

  <span class="keyword">if</span> (required === <span class="literal">false</span>) {
    <span class="keyword">this</span>.validators = <span class="keyword">this</span>.validators.filter(<span class="keyword">function</span>(v) {
      <span class="keyword">return</span> v.validator !== <span class="keyword">this</span>.requiredValidator;
    }, <span class="keyword">this</span>);

    <span class="keyword">this</span>.isRequired = <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">this</span>.isRequired = <span class="literal">true</span>;

  <span class="keyword">this</span>.requiredValidator = <span class="keyword">function</span>(v) {
    <span class="comment">// in here, `this` refers to the validating document.</span>
    <span class="comment">// no validation when this path wasn't selected in the query.</span>
    <span class="keyword">if</span> (<span class="string">'isSelected'</span> <span class="keyword">in</span> <span class="keyword">this</span> &amp;&amp; !<span class="keyword">this</span>.isSelected(_<span class="keyword">this</span>.path) &amp;&amp; !<span class="keyword">this</span>.isModified(_<span class="keyword">this</span>.path)) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">return</span> ((<span class="keyword">typeof</span> required === <span class="string">'function'</span>) &amp;&amp; !required.apply(<span class="keyword">this</span>)) ||
        _<span class="keyword">this</span>.checkRequired(v, <span class="keyword">this</span>);
  };
  <span class="keyword">this</span>.originalRequiredValue = required;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> required === <span class="string">'string'</span>) {
    message = required;
    required = <span class="literal">undefined</span>;
  }

  <span class="keyword">var</span> msg = message || MongooseError.messages.general.required;
  <span class="keyword">this</span>.validators.unshift(utils.assign({}, customOptions, {
    validator: <span class="keyword">this</span>.requiredValidator,
    message: msg,
    type: <span class="string">'required'</span>
  }));

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType"><a href="#schematype_SchemaType">SchemaType(<code>path</code>, <code>[options]</code>, <code>[instance]</code>)</a></h3><p>SchemaType constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[instance]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SchemaType</span><span class="params">(path, options, instance)</span> {</span>
  <span class="keyword">this</span>.path = path;
  <span class="keyword">this</span>.instance = instance;
  <span class="keyword">this</span>.validators = [];
  <span class="keyword">this</span>.setters = [];
  <span class="keyword">this</span>.getters = [];
  <span class="keyword">this</span>.options = options;
  <span class="keyword">this</span>._index = <span class="literal">null</span>;
  <span class="keyword">this</span>.selected;

  <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> options) {
    <span class="keyword">if</span> (<span class="keyword">this</span>[prop] &amp;&amp; <span class="keyword">typeof</span> <span class="keyword">this</span>[prop] === <span class="string">'function'</span>) {
      <span class="comment">// { unique: true, index: true }</span>
      <span class="keyword">if</span> (prop === <span class="string">'index'</span> &amp;&amp; <span class="keyword">this</span>._index) {
        <span class="keyword">continue</span>;
      }

      <span class="keyword">var</span> val = options[prop];
      <span class="comment">// Special case so we don't screw up array defaults, see gh-5780</span>
      <span class="keyword">if</span> (prop === <span class="string">'default'</span>) {
        <span class="keyword">this</span>.<span class="keyword">default</span>(val);
        <span class="keyword">continue</span>;
      }

      <span class="keyword">var</span> opts = Array.isArray(val) ? val : [val];

      <span class="keyword">this</span>[prop].apply(<span class="keyword">this</span>, opts);
    }
  }

  Object.defineProperty(<span class="keyword">this</span>, <span class="string">'$$context'</span>, {
    enumerable: <span class="literal">false</span>,
    configurable: <span class="literal">false</span>,
    writable: <span class="literal">true</span>,
    value: <span class="literal">null</span>
  });
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-select"><a href="#schematype_SchemaType-select">SchemaType#select(<code>val</code>)</a></h3><p>Sets default <code>select()</code> behavior for this path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Set to <code>true</code> if this path should always be included in the results, <code>false</code> if it should be excluded by default. This setting can be overridden at the query level.</p>

<h4>Example:</h4>

<pre><code>T = db.model(<span class="string">'T'</span>, <span class="keyword">new</span> Schema({ x: { type: String, select: <span class="literal">true</span> }}));
T.find(..); <span class="comment">// field x will always be selected ..</span>
<span class="comment">// .. unless overridden;</span>
T.find().select(<span class="string">'-x'</span>).exec(callback);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.select = <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">(val)</span> {</span>
  <span class="keyword">this</span>.selected = !!val;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-set"><a href="#schematype_SchemaType-set">SchemaType#set(<code>fn</code>)</a></h3><p>Adds a setter to this schematype.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">capitalize</span> <span class="params">(val)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> val !== <span class="string">'string'</span>) val = <span class="string">''</span>;
  <span class="keyword">return</span> val.charAt(<span class="number">0</span>).toUpperCase() + val.substring(<span class="number">1</span>);
}

<span class="comment">// defining within the schema</span>
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, set: capitalize }})

<span class="comment">// or by retreiving its SchemaType</span>
<span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: String })
s.path(<span class="string">'name'</span>).set(capitalize)</code></pre>

<p>Setters allow you to transform the data before it gets to the raw mongodb document and is set as a value on an actual key.</p>

<p>Suppose you are implementing user registration for a website. Users provide an email and password, which gets saved to mongodb. The email is a string that you will want to normalize to lower case, in order to avoid one email having more than one account -- e.g., otherwise, <a href='mailto:avenue@q.com'>avenue@q.com</a> can be registered for 2 accounts via <a href='mailto:avenue@q.com'>avenue@q.com</a> and <a href='mailto:AvEnUe@Q.CoM'>AvEnUe@Q.CoM</a>.</p>

<p>You can set up email lower case normalization easily via a Mongoose setter.</p>

<pre><code>function toLower(v) {
  return v.toLowerCase();
}

var UserSchema = new Schema({
  email: { type: String, set: toLower }
});

var User = db.model('User', UserSchema);

var user = new User({email: '<a href='mailto:AVENUE@Q.COM'>AVENUE@Q.COM</a>'});
console.log(user.email); // '<a href='mailto:avenue@q.com'>avenue@q.com</a>'

// or
var user = new User();
user.email = '<a href='mailto:Avenue@Q.com'>Avenue@Q.com</a>';
console.log(user.email); // '<a href='mailto:avenue@q.com'>avenue@q.com</a>'
</code></pre>

<p>As you can see above, setters allow you to transform the data before it stored in MongoDB.</p>

<p>NOTE: setters by default do <strong>not</strong> run on queries by default.</p>

<pre><code>// Will **not** run the `toLower()` setter by default.
User.updateOne({ _id: _id }, { $set: { email: '<a href='mailto:AVENUE@Q.COM'>AVENUE@Q.COM</a>' } });
</code></pre>

<p>Use the <code>runSettersOnQuery</code> option to opt-in to running setters on <code>User.update()</code>:</p>

<pre><code>// Turn on `runSettersOnQuery` to run the setters from your schema.
User.updateOne({ _id: _id }, { $set: { email: '<a href='mailto:AVENUE@Q.COM'>AVENUE@Q.COM</a>' } }, {
  runSettersOnQuery: true
});
</code></pre>

<p><em>NOTE: we could have also just used the built-in <code>lowercase: true</code> SchemaType option instead of defining our own function.</em></p>

<pre><code><span class="keyword">new</span> Schema({ email: { type: String, lowercase: <span class="literal">true</span> }})</code></pre>

<p>Setters are also passed a second argument, the schematype on which the setter was defined. This allows for tailored behavior based on options passed in the schema.</p>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">inspector</span> <span class="params">(val, schematype)</span> {</span>
  <span class="keyword">if</span> (schematype.options.required) {
    <span class="keyword">return</span> schematype.path + <span class="string">' is required'</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> val;
  }
}

<span class="keyword">var</span> VirusSchema = <span class="keyword">new</span> Schema({
  name: { type: String, required: <span class="literal">true</span>, set: inspector },
  taxonomy: { type: String, set: inspector }
})

<span class="keyword">var</span> Virus = db.model(<span class="string">'Virus'</span>, VirusSchema);
<span class="keyword">var</span> v = <span class="keyword">new</span> Virus({ name: <span class="string">'Parvoviridae'</span>, taxonomy: <span class="string">'Parvovirinae'</span> });

console.log(v.name);     <span class="comment">// name is required</span>
console.log(v.taxonomy); <span class="comment">// Parvovirinae</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.set = <span class="keyword">function</span>(fn) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'A setter must be a function.'</span>);
  }
  <span class="keyword">this</span>.setters.push(fn);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-sparse"><a href="#schematype_SchemaType-sparse">SchemaType#sparse(<code>bool</code>)</a></h3><p>Declares a sparse index.</p><div class="params"><h4>Parameters:</h4><ul><li><code>bool</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, sparse: <span class="literal">true</span> })
Schema.path(<span class="string">'name'</span>).index({ sparse: <span class="literal">true</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.sparse = <span class="keyword">function</span>(bool) {
  <span class="keyword">if</span> (<span class="keyword">this</span>._index === <span class="literal">null</span> || <span class="keyword">this</span>._index === <span class="literal">undefined</span> ||
    <span class="keyword">typeof</span> <span class="keyword">this</span>._index === <span class="string">'boolean'</span>) {
    <span class="keyword">this</span>._index = {};
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._index === <span class="string">'string'</span>) {
    <span class="keyword">this</span>._index = {type: <span class="keyword">this</span>._index};
  }

  <span class="keyword">this</span>._index.sparse = bool;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-text"><a href="#schematype_SchemaType-text">SchemaType#text(<code>bool</code>)</a></h3><p>Declares a full text index.</p><div class="params"><h4>Parameters:</h4><ul><li><code>bool</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h3>Example:</h3>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({name : {type: String, text : <span class="literal">true</span> })
 Schema.path(<span class="string">'name'</span>).index({text : <span class="literal">true</span>});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.text = <span class="keyword">function</span>(bool) {
  <span class="keyword">if</span> (<span class="keyword">this</span>._index === <span class="literal">null</span> || <span class="keyword">this</span>._index === <span class="literal">undefined</span> ||
    <span class="keyword">typeof</span> <span class="keyword">this</span>._index === <span class="string">'boolean'</span>) {
    <span class="keyword">this</span>._index = {};
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._index === <span class="string">'string'</span>) {
    <span class="keyword">this</span>._index = {type: <span class="keyword">this</span>._index};
  }

  <span class="keyword">this</span>._index.text = bool;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-unique"><a href="#schematype_SchemaType-unique">SchemaType#unique(<code>bool</code>)</a></h3><p>Declares an unique index.</p><div class="params"><h4>Parameters:</h4><ul><li><code>bool</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> s = <span class="keyword">new</span> Schema({ name: { type: String, unique: <span class="literal">true</span> }});
Schema.path(<span class="string">'name'</span>).index({ unique: <span class="literal">true</span> });</code></pre>

<p><em>NOTE: violating the constraint returns an <code>E11000</code> error from MongoDB when saving, not a Mongoose validation error.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.unique = <span class="keyword">function</span>(bool) {
  <span class="keyword">if</span> (<span class="keyword">this</span>._index === <span class="literal">false</span>) {
    <span class="keyword">if</span> (!bool) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Path "'</span> + <span class="keyword">this</span>.path + <span class="string">'" may not have `index` set to '</span> +
      <span class="string">'false and `unique` set to true'</span>);
  }
  <span class="keyword">if</span> (<span class="keyword">this</span>._index == <span class="literal">null</span> || <span class="keyword">this</span>._index === <span class="literal">true</span>) {
    <span class="keyword">this</span>._index = {};
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._index === <span class="string">'string'</span>) {
    <span class="keyword">this</span>._index = {type: <span class="keyword">this</span>._index};
  }

  <span class="keyword">this</span>._index.unique = bool;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schematype_SchemaType-validate"><a href="#schematype_SchemaType-validate">SchemaType#validate(<code>obj</code>, <code>[errorMsg]</code>, <code>[type]</code>)</a></h3><p>Adds validator(s) for this document path.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>validator</span></li><li><code>[errorMsg]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional error message</span></li><li><code>[type]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>optional validator type</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Validators always receive the value to validate as their first argument and must return <code>Boolean</code>. Returning <code>false</code> means validation failed.</p>

<p>The error message argument is optional. If not passed, the <a href="#error_messages_MongooseError-messages">default generic error message template</a> will be used.</p>

<h4>Examples:</h4>

<pre><code><span class="comment">// make sure every value is equal to "something"</span>
<span class="function"><span class="keyword">function</span> <span class="title">validator</span> <span class="params">(val)</span> {</span>
  <span class="keyword">return</span> val == <span class="string">'something'</span>;
}
<span class="keyword">new</span> Schema({ name: { type: String, validate: validator }});

<span class="comment">// with a custom error message</span>

<span class="keyword">var</span> custom = [validator, <span class="string">'Uh oh, {PATH} does not equal "something".'</span>]
<span class="keyword">new</span> Schema({ name: { type: String, validate: custom }});

<span class="comment">// adding many validators at a time</span>

<span class="keyword">var</span> many = [
    { validator: validator, msg: <span class="string">'uh oh'</span> }
  , { validator: anotherValidator, msg: <span class="string">'failed'</span> }
]
<span class="keyword">new</span> Schema({ name: { type: String, validate: many }});

<span class="comment">// or utilizing SchemaType methods directly:</span>

<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ name: <span class="string">'string'</span> });
schema.path(<span class="string">'name'</span>).validate(validator, <span class="string">'validation of `{PATH}` failed with value `{VALUE}`'</span>);</code></pre>

<h4>Error message templates:</h4>

<p>From the examples above, you may have noticed that error messages support basic templating. There are a few other template keywords besides <code>{PATH}</code> and <code>{VALUE}</code> too. To find out more, details are available <a href="#error_messages_MongooseError.messages">here</a></p>

<h4>Asynchronous validation:</h4>

<p>Passing a validator function that receives two arguments tells mongoose that the validator is an asynchronous validator. The first argument passed to the validator function is the value being validated. The second argument is a callback function that must called when you finish validating the value and passed either <code>true</code> or <code>false</code> to communicate either success or failure respectively.</p>

<pre><code>schema.path(<span class="string">'name'</span>).validate({
  isAsync: <span class="literal">true</span>,
  validator: <span class="function"><span class="keyword">function</span> <span class="params">(value, respond)</span> {</span>
    doStuff(value, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ...
      respond(<span class="literal">false</span>); <span class="comment">// validation failed</span>
    });
  },
  message: <span class="string">'Custom error message!'</span> <span class="comment">// Optional</span>
});

<span class="comment">// Can also return a promise</span>
schema.path(<span class="string">'name'</span>).validate({
  validator: <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Promise(<span class="function"><span class="keyword">function</span> <span class="params">(resolve, reject)</span> {</span>
      resolve(<span class="literal">false</span>); <span class="comment">// validation failed</span>
    });
  }
});</code></pre>

<p>You might use asynchronous validators to retreive other documents from the database to validate against or to meet other I/O bound validation needs.</p>

<p>Validation occurs <code>pre('save')</code> or whenever you manually execute <a href="#document_Document-validate">document#validate</a>.</p>

<p>If validation fails during <code>pre('save')</code> and no callback was passed to receive the error, an <code>error</code> event will be emitted on your Models associated db <a href="#connection_Connection">connection</a>, passing the validation error object along.</p>

<pre><code><span class="keyword">var</span> conn = mongoose.createConnection(..);
conn.on(<span class="string">'error'</span>, handleError);

<span class="keyword">var</span> Product = conn.model(<span class="string">'Product'</span>, yourSchema);
<span class="keyword">var</span> dvd = <span class="keyword">new</span> Product(..);
dvd.save(); <span class="comment">// emits error on the `conn` above</span></code></pre>

<p>If you desire handling these errors at the Model level, attach an <code>error</code> listener to your Model and the event will instead be emitted there.</p>

<pre><code><span class="comment">// registering an error listener on the Model lets us handle errors more locally</span>
Product.on(<span class="string">'error'</span>, handleError);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType.prototype.validate = <span class="keyword">function</span>(obj, message, type) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj === <span class="string">'function'</span> || obj &amp;&amp; utils.getFunctionName(obj.constructor) === <span class="string">'RegExp'</span>) {
    <span class="keyword">var</span> properties;
    <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Object &amp;&amp; !type) {
      properties = utils.clone(message);
      <span class="keyword">if</span> (!properties.message) {
        properties.message = properties.msg;
      }
      properties.validator = obj;
      properties.type = properties.type || <span class="string">'user defined'</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (!message) {
        message = MongooseError.messages.general.<span class="keyword">default</span>;
      }
      <span class="keyword">if</span> (!type) {
        type = <span class="string">'user defined'</span>;
      }
      properties = {message: message, type: type, validator: obj};
    }
    <span class="keyword">this</span>.validators.push(properties);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> i,
      length,
      arg;

  <span class="keyword">for</span> (i = <span class="number">0</span>, length = arguments.length; i &lt; length; i++) {
    arg = arguments[i];
    <span class="keyword">if</span> (!(arg &amp;&amp; utils.getFunctionName(arg.constructor) === <span class="string">'Object'</span>)) {
      <span class="keyword">var</span> msg = <span class="string">'Invalid validator. Received ('</span> + <span class="keyword">typeof</span> arg + <span class="string">') '</span>
          + arg
          + <span class="string">'. See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate'</span>;

      <span class="keyword">throw</span> <span class="keyword">new</span> Error(msg);
    }
    <span class="keyword">this</span>.validate(arg.validator, arg);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item static private"><h3 id="schematype_SchemaType._isRef"><a href="#schematype_SchemaType._isRef">SchemaType._isRef(<code>self</code>, <code>value</code>, <code>doc</code>, <code>init</code>)</a></h3><p>Determines if value is a valid Reference.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">SchemaType._isRef = <span class="keyword">function</span>(self, value, doc, init) {
  <span class="comment">// fast path</span>
  <span class="keyword">var</span> ref = init &amp;&amp; self.options &amp;&amp; self.options.ref;

  <span class="keyword">if</span> (!ref &amp;&amp; doc &amp;&amp; doc.$__fullPath) {
    <span class="comment">// checks for</span>
    <span class="comment">// - this populated with adhoc model and no ref was set in schema OR</span>
    <span class="comment">// - setting / pushing values after population</span>
    <span class="keyword">var</span> path = doc.$__fullPath(self.path);
    <span class="keyword">var</span> owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    ref = owner.populated(path);
  }

  <span class="keyword">if</span> (ref) {
    <span class="keyword">if</span> (value == <span class="literal">null</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (!Buffer.isBuffer(value) &amp;&amp;  <span class="comment">// buffers are objects too</span>
        value._bsontype !== <span class="string">'Binary'</span> <span class="comment">// raw binary value from the db</span>
        &amp;&amp; utils.isObject(value)    <span class="comment">// might have deselected _id in population query</span>
    ) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
  }

  <span class="keyword">return</span> <span class="literal">false</span>;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>self</code><span class="types"> &lt;<a href="#schematype_SchemaType">SchemaType</a>&gt; </span><span></span></li><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li><li><code>init</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/querystream.js" id="querystream-js">querystream.js</a><div class="item method private"><h3 id="querystream_QueryStream-__next"><a href="#querystream_QueryStream-__next">QueryStream#__next()</a></h3><p>Pulls the next doc from the cursor.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#querystream_QueryStream-_next" title="QueryStream#_next">QueryStream#_next</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.__next = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>.paused || <span class="keyword">this</span>._destroyed) {
    <span class="keyword">this</span>._running = <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>._running;
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  _<span class="keyword">this</span>._inline = T_INIT;

  _<span class="keyword">this</span>._cursor.nextObject(<span class="function"><span class="keyword">function</span> <span class="title">cursorcb</span><span class="params">(err, doc)</span> {</span>
    _<span class="keyword">this</span>._onNextObject(err, doc);
  });

  <span class="comment">// if onNextObject() was already called in this tick</span>
  <span class="comment">// return ourselves to the trampoline.</span>
  <span class="keyword">if</span> (T_CONT === <span class="keyword">this</span>._inline) {
    <span class="keyword">return</span> <span class="literal">true</span>;
  }
  <span class="comment">// onNextObject() hasn't fired yet. tell onNextObject</span>
  <span class="comment">// that its ok to call _next b/c we are not within</span>
  <span class="comment">// the trampoline anymore.</span>
  <span class="keyword">this</span>._inline = T_IDLE;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="querystream_QueryStream-_init"><a href="#querystream_QueryStream-_init">QueryStream#_init()</a></h3><p>Initializes the query.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._init = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>._destroyed) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">var</span> query = <span class="keyword">this</span>.query,
      model = query.model,
      options = query._optionsForExec(model),
      _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">try</span> {
    query.cast(model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> _<span class="keyword">this</span>.destroy(err);
  }

  _<span class="keyword">this</span>._fields = utils.clone(query._fields);
  options.fields = query._castFields(_<span class="keyword">this</span>._fields);

  model.collection.find(query._conditions, options, <span class="keyword">function</span>(err, cursor) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> _<span class="keyword">this</span>.destroy(err);
    }
    _<span class="keyword">this</span>._cursor = cursor;
    _<span class="keyword">this</span>._next();
  });
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="querystream_QueryStream-_next"><a href="#querystream_QueryStream-_next">QueryStream#_next()</a></h3><p>Trampoline for pulling the next doc from cursor.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#querystream_QueryStream-__next" title="QueryStream#__next">QueryStream#__next</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._next = <span class="function"><span class="keyword">function</span> <span class="title">_next</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.paused || <span class="keyword">this</span>._destroyed) {
    <span class="keyword">this</span>._running = <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>._running;
  }

  <span class="keyword">this</span>._running = <span class="literal">true</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>._buffer &amp;&amp; <span class="keyword">this</span>._buffer.length) {
    <span class="keyword">var</span> arg;
    <span class="keyword">while</span> (!<span class="keyword">this</span>.paused &amp;&amp; !<span class="keyword">this</span>._destroyed &amp;&amp; (arg = <span class="keyword">this</span>._buffer.shift())) { <span class="comment">// eslint-disable-line no-cond-assign</span>
      <span class="keyword">this</span>._onNextObject.apply(<span class="keyword">this</span>, arg);
    }
  }

  <span class="comment">// avoid stack overflows with large result sets.</span>
  <span class="comment">// trampoline instead of recursion.</span>
  <span class="keyword">while</span> (<span class="keyword">this</span>.__next()) {
  }
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="querystream_QueryStream-_onNextObject"><a href="#querystream_QueryStream-_onNextObject">QueryStream#_onNextObject(<code>err</code>, <code>doc</code>)</a></h3><p>Transforms raw <code>doc</code>s returned from the cursor into a model instance.</p><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>, <a href="#null">null</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype._onNextObject = <span class="function"><span class="keyword">function</span> <span class="title">_onNextObject</span><span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._destroyed) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.paused) {
    <span class="keyword">this</span>._buffer || (<span class="keyword">this</span>._buffer = []);
    <span class="keyword">this</span>._buffer.push([err, doc]);
    <span class="keyword">this</span>._running = <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>._running;
  }

  <span class="keyword">if</span> (err) {
    <span class="keyword">return</span> <span class="keyword">this</span>.destroy(err);
  }

  <span class="comment">// when doc is null we hit the end of the cursor</span>
  <span class="keyword">if</span> (!doc) {
    <span class="keyword">this</span>.emit(<span class="string">'end'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.destroy();
  }

  <span class="keyword">var</span> opts = <span class="keyword">this</span>.query._mongooseOptions;

  <span class="keyword">if</span> (!opts.populate) {
    <span class="keyword">return</span> opts.lean === <span class="literal">true</span> ?
        emit(<span class="keyword">this</span>, doc) :
        createAndEmit(<span class="keyword">this</span>, <span class="literal">null</span>, doc);
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> pop = helpers.preparePopulationOptionsMQ(_<span class="keyword">this</span>.query, _<span class="keyword">this</span>.query._mongooseOptions);

  <span class="comment">// Hack to work around gh-3108</span>
  pop.forEach(<span class="keyword">function</span>(option) {
    <span class="keyword">delete</span> option.model;
  });

  pop.__noPromise = <span class="literal">true</span>;
  _<span class="keyword">this</span>.query.model.populate(doc, pop, <span class="keyword">function</span>(err, doc) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> _<span class="keyword">this</span>.destroy(err);
    }
    <span class="keyword">return</span> opts.lean === <span class="literal">true</span> ?
        emit(_<span class="keyword">this</span>, doc) :
        createAndEmit(_<span class="keyword">this</span>, pop, doc);
  });
};

<span class="function"><span class="keyword">function</span> <span class="title">createAndEmit</span><span class="params">(self, populatedIds, doc)</span> {</span>
  <span class="keyword">var</span> instance = helpers.createModel(self.query.model, doc, self._fields);
  <span class="keyword">var</span> opts = populatedIds ?
    {populated: populatedIds} :
    <span class="literal">undefined</span>;

  instance.init(doc, opts, <span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> self.destroy(err);
    }
    emit(self, instance);
  });
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="querystream_QueryStream-destroy"><a href="#querystream_QueryStream-destroy">QueryStream#destroy(<code>[err]</code>)</a></h3><p>Destroys the stream, closing the underlying cursor, which emits the close event. No more events will be emitted after the close event.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[err]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.destroy = <span class="keyword">function</span>(err) {
  <span class="keyword">if</span> (<span class="keyword">this</span>._destroyed) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">this</span>._destroyed = <span class="literal">true</span>;
  <span class="keyword">this</span>._running = <span class="literal">false</span>;
  <span class="keyword">this</span>.readable = <span class="literal">false</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>._cursor) {
    <span class="keyword">this</span>._cursor.close();
  }

  <span class="keyword">if</span> (err) {
    <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err);
  }

  <span class="keyword">this</span>.emit(<span class="string">'close'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="querystream_QueryStream-pause"><a href="#querystream_QueryStream-pause">QueryStream#pause()</a></h3><p>Pauses this stream.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.pause = <span class="keyword">function</span>() {
  <span class="keyword">this</span>.paused = <span class="literal">true</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="querystream_QueryStream-pipe"><a href="#querystream_QueryStream-pipe">QueryStream#pipe()</a></h3><p>Pipes this query stream into another stream. This method is inherited from NodeJS Streams.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://nodejs.org/api/stream.html" title="NodeJS">NodeJS</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>query.stream().pipe(writeStream [, options])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="querystream_QueryStream"><a href="#querystream_QueryStream">QueryStream(<code>query</code>, <code>[options]</code>)</a></h3><p>Provides a Node.js 0.8 style <a href="http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream">ReadStream</a> interface for Queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>query</code><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream" title="NodeJS Stream">NodeJS Stream</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>data</code>: emits a single Mongoose document</p></li><li><p><code>error</code>: emits when an error occurs during streaming. This will emit <em>before</em> the <code>close</code> event.</p></li><li><p><code>close</code>: emits when the stream reaches the end of the cursor or an error occurs, or the stream is manually <code>destroy</code>ed. After this event, no more events are emitted.</p></li></ul></div><div class="description"><pre><code><span class="keyword">var</span> stream = Model.find().stream();

stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
  <span class="comment">// do something with the mongoose document</span>
}).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="comment">// handle the error</span>
}).on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="comment">// the stream is closed</span>
});</code></pre>

<p>The stream interface allows us to simply "plug-in" to other <em>Node.js 0.8</em> style write streams.</p>

<pre><code>Model.where(<span class="string">'created'</span>).gte(twoWeeksAgo).stream().pipe(writeStream);</code></pre>

<h4>Valid options</h4>

<ul>
<li><code>transform</code>: optional function which accepts a mongoose document. The return value of the function will be emitted on <code>data</code>.</li>
</ul>

<h4>Example</h4>

<pre><code><span class="comment">// JSON.stringify all documents before emitting</span>
<span class="keyword">var</span> stream = Thing.find().stream({ transform: JSON.stringify });
stream.pipe(writeStream);</code></pre>

<p><em>NOTE: plugging into an HTTP response will *not* work out of the box. Those streams expect only strings or buffers to be emitted, so first formatting our documents as strings/buffers is necessary.</em></p>

<p><em>NOTE: these streams are Node.js 0.8 style read streams which differ from Node.js 0.10 style. Node.js 0.10 streams are not well tested yet and are not guaranteed to work.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">QueryStream</span><span class="params">(query, options)</span> {</span>
  Stream.call(<span class="keyword">this</span>);

  <span class="keyword">this</span>.query = query;
  <span class="keyword">this</span>.readable = <span class="literal">true</span>;
  <span class="keyword">this</span>.paused = <span class="literal">false</span>;
  <span class="keyword">this</span>._cursor = <span class="literal">null</span>;
  <span class="keyword">this</span>._destroyed = <span class="literal">null</span>;
  <span class="keyword">this</span>._fields = <span class="literal">null</span>;
  <span class="keyword">this</span>._buffer = <span class="literal">null</span>;
  <span class="keyword">this</span>._inline = T_INIT;
  <span class="keyword">this</span>._running = <span class="literal">false</span>;
  <span class="keyword">this</span>._transform = options &amp;&amp; <span class="keyword">typeof</span> options.transform === <span class="string">'function'</span>
      ? options.transform
      : K;

  <span class="comment">// give time to hook up events</span>
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  process.nextTick(<span class="keyword">function</span>() {
    _<span class="keyword">this</span>._init();
  });
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="querystream_QueryStream-resume"><a href="#querystream_QueryStream-resume">QueryStream#resume()</a></h3><p>Resumes this stream.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.resume = <span class="keyword">function</span>() {
  <span class="keyword">this</span>.paused = <span class="literal">false</span>;

  <span class="keyword">if</span> (!<span class="keyword">this</span>._cursor) {
    <span class="comment">// cannot start if not initialized</span>
    <span class="keyword">return</span>;
  }

  <span class="comment">// are we within the trampoline?</span>
  <span class="keyword">if</span> (T_INIT === <span class="keyword">this</span>._inline) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>._running) {
    <span class="comment">// outside QueryStream control, need manual restart</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._next();
  }
};</code></pre></div><hr class=""></div><div class="item property public"><h3 id="querystream_QueryStream-paused"><a href="#querystream_QueryStream-paused">QueryStream#<span>paused</span></a></h3><p>Flag stating whether or not this stream is paused.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.paused;

<span class="comment">// trampoline flags</span>
<span class="keyword">var</span> T_INIT = <span class="number">0</span>;
<span class="keyword">var</span> T_IDLE = <span class="number">1</span>;
<span class="keyword">var</span> T_CONT = <span class="number">2</span>;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="querystream_QueryStream-readable"><a href="#querystream_QueryStream-readable">QueryStream#<span>readable</span></a></h3><p>Flag stating whether or not this stream is readable.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">QueryStream.prototype.readable;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/model.js" id="model-js">model.js</a><div class="item method private"><h3 id="model_Model-%24__delta"><a href="#model_Model-%24__delta">Model#$__delta()</a></h3><p>Produces a special query document of the modified properties used in updates.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="model_Model-%24__version"><a href="#model_Model-%24__version">Model#$__version()</a></h3><p>Appends versioning to the where and update clauses.</p><div class="description"></div><hr class="private"></div><div class="item method private"><h3 id="model_Model-%24__where"><a href="#model_Model-%24__where">Model#$__where()</a></h3><p>Returns a query object</p><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="model_Model-%24where"><a href="#model_Model-%24where">Model#$where(<code>argument</code>)</a></h3><p>Creates a <code>Query</code> and specifies a <code>$where</code> condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>argument</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>is a javascript string or anonymous function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-%24where" title="Query.$where">Query.$where</a></li></ul></div><div class="description"><p>Sometimes you need to query for things in mongodb using a JavaScript expression. You can do so via <code>find({ $where: javascript })</code>, or you can use the mongoose shortcut method $where via a Query chain or from your mongoose Model.</p>

<pre><code>Blog.$where(<span class="string">'this.username.indexOf("val") !== -1'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>});</code></pre></div><hr class=""></div><div class="item method public"><h3 id="model_Model-increment"><a href="#model_Model-increment">Model#increment()</a></h3><p>Signal that we desire an increment of this documents version.</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../guide.html#versionKey" title="versionKeys">versionKeys</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Model.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  doc.increment();
  doc.save(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span> .. })
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.increment = <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.$__.version = VERSION_ALL;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="model_Model-model"><a href="#model_Model-model">Model#model(<code>name</code>)</a></h3><p>Returns another Model instance.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>model name</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> doc = <span class="keyword">new</span> Tank;
doc.model(<span class="string">'User'</span>).findById(id, callback);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.model = <span class="function"><span class="keyword">function</span> <span class="title">model</span><span class="params">(name)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.db.model(name);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="model_Model"><a href="#model_Model">Model(<code>doc</code>)</a></h3><p>Model constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>values with which to create the document</span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="../../api.html#document-js" title="Document">Document</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>error</code>: If listening to this event, &#39;error&#39; is emitted when a document was saved without passing a callback and an <code>error</code> occurred. If not listening, the event bubbles to the connection used to create this Model.</p></li><li><p><code>index</code>: Emitted after <code>Model#ensureIndexes</code> completes. If an error occurred it is passed with the event.</p></li><li><p><code>index-single-start</code>: Emitted when an individual index starts within <code>Model#ensureIndexes</code>. The fields and options being used to build the index are also passed with the event.</p></li><li><p><code>index-single-done</code>: Emitted when an individual index finishes within <code>Model#ensureIndexes</code>. If an error occurred it is passed with the event. The fields, options, and index name are also passed.</p></li></ul></div><div class="description"><p>Provides the interface to MongoDB collections as well as creates document instances.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Model</span><span class="params">(doc, fields, skipId)</span> {</span>
  <span class="keyword">if</span> (fields <span class="keyword">instanceof</span> Schema) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'2nd argument to `Model` must be a POJO or string, '</span> +
      <span class="string">'**not** a schema. Make sure you\'re calling `mongoose.model()`, not '</span> +
      <span class="string">'`mongoose.Model()`.'</span>);
  }
  Document.call(<span class="keyword">this</span>, doc, fields, skipId, <span class="literal">true</span>);
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="model_Model-remove"><a href="#model_Model-remove">Model#remove(<code>[fn]</code>)</a></h3><p>Removes this document from the db.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[fn]</code><span class="types"> &lt;<a href="#function(err">function(err</a>, <a href="#product)">product)</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>Promise</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>product.remove(<span class="function"><span class="keyword">function</span> <span class="params">(err, product)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  Product.findById(product._id, <span class="function"><span class="keyword">function</span> <span class="params">(err, product)</span> {</span>
    console.log(product) <span class="comment">// null</span>
  })
})</code></pre>

<p>As an extra measure of flow control, remove will return a Promise (bound to <code>fn</code> if passed) so it could be chained, or hooked to recive errors</p>

<h4>Example:</h4>

<pre><code>product.remove().then(<span class="function"><span class="keyword">function</span> <span class="params">(product)</span> {</span>
   ...
}).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
   assert.ok(err)
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.remove = <span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">(options, fn)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    fn = options;
    options = <span class="literal">undefined</span>;
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">if</span> (!options) {
    options = {};
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.removing) {
    <span class="keyword">if</span> (fn) {
      <span class="keyword">this</span>.$__.removing.then(
          <span class="keyword">function</span>(res) { fn(<span class="literal">null</span>, res); },
          <span class="keyword">function</span>(err) { fn(err); });
    }
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="keyword">if</span> (<span class="keyword">this</span>.$__.isDeleted) {
    setImmediate(<span class="keyword">function</span>() {
      fn(<span class="literal">null</span>, _<span class="keyword">this</span>);
    });
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> Promise = PromiseProvider.get();

  <span class="keyword">if</span> (fn) {
    fn = <span class="keyword">this</span>.constructor.$wrapCallback(fn);
  }

  <span class="keyword">this</span>.$__.removing = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">var</span> where = _<span class="keyword">this</span>.$__where();
    <span class="keyword">if</span> (where <span class="keyword">instanceof</span> Error) {
      reject(where);
      fn &amp;&amp; fn(where);
      <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (!options.safe &amp;&amp; _<span class="keyword">this</span>.schema.options.safe) {
      options.safe = _<span class="keyword">this</span>.schema.options.safe;
    }

    _<span class="keyword">this</span>.collection.remove(where, options, <span class="keyword">function</span>(err) {
      <span class="keyword">if</span> (!err) {
        _<span class="keyword">this</span>.$__.isDeleted = <span class="literal">true</span>;
        _<span class="keyword">this</span>.emit(<span class="string">'remove'</span>, _<span class="keyword">this</span>);
        _<span class="keyword">this</span>.constructor.emit(<span class="string">'remove'</span>, _<span class="keyword">this</span>);
        resolve(_<span class="keyword">this</span>);
        fn &amp;&amp; fn(<span class="literal">null</span>, _<span class="keyword">this</span>);
        <span class="keyword">return</span>;
      }
      _<span class="keyword">this</span>.$__.isDeleted = <span class="literal">false</span>;
      reject(err);
      fn &amp;&amp; fn(err);
    });
  });
  <span class="keyword">return</span> <span class="keyword">this</span>.$__.removing;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="model_Model-save"><a href="#model_Model-save">Model#save(<code>[options]</code>, <code>[options.safe]</code>, <code>[options.validateBeforeSave]</code>, <code>[fn]</code>)</a></h3><p>Saves this document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options optional options</span></li><li><code>[options.safe]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>overrides <a href="../../guide.html#safe">schema&#39;s safe option</a></span></li><li><code>[options.validateBeforeSave]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>set to false to save without validating.</span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>Promise</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../middleware.html" title="middleware">middleware</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>product.sold = Date.now();
product.save(<span class="function"><span class="keyword">function</span> <span class="params">(err, product, numAffected)</span> {</span>
  <span class="keyword">if</span> (err) ..
})</code></pre>

<p>The callback will receive three parameters</p>

<ol>
<li><code>err</code> if an error occurred</li>
<li><code>product</code> which is the saved <code>product</code></li>
<li><code>numAffected</code> will be 1 when the document was successfully persisted to MongoDB, otherwise 0. Unless you tweak mongoose's internals, you don't need to worry about checking this parameter for errors - checking <code>err</code> is sufficient to make sure your document was properly saved.</li>
</ol>

<p>As an extra measure of flow control, save will return a Promise.</p>

<h4>Example:</h4>

<pre><code>product.save().then(<span class="keyword">function</span>(product) {
   ...
});</code></pre>

<p>For legacy reasons, mongoose stores object keys in reverse order on initial<br />save. That is, <code>{ a: 1, b: 2 }</code> will be saved as <code>{ b: 2, a: 1 }</code> in<br />MongoDB. To override this behavior, set<br /><a href="../../api.html#document_Document-toObject">the <code>toObject.retainKeyOrder</code> option</a><br />to true on your schema.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.save = <span class="keyword">function</span>(options, fn) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    fn = options;
    options = <span class="literal">undefined</span>;
  }

  <span class="keyword">if</span> (!options) {
    options = {};
  }

  <span class="keyword">if</span> (fn) {
    fn = <span class="keyword">this</span>.constructor.$wrapCallback(fn);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.$__save(options, fn);
};</code></pre></div><hr class=""></div><div class="item static public"><h3 id="model_Model.aggregate"><a href="#model_Model.aggregate">Model.aggregate(<code>[...]</code>, <code>[callback]</code>)</a></h3><p>Performs <a href="http://docs.mongodb.org/manual/applications/aggregation/">aggregations</a> on the models collection.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.aggregate = <span class="function"><span class="keyword">function</span> <span class="title">aggregate</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> args = [].slice.call(arguments),
      aggregate,
      callback;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> args[args.length - <span class="number">1</span>] === <span class="string">'function'</span>) {
    callback = args.pop();
  }

  <span class="keyword">if</span> (args.length === <span class="number">1</span> &amp;&amp; util.isArray(args[<span class="number">0</span>])) {
    aggregate = <span class="keyword">new</span> Aggregate(args[<span class="number">0</span>]);
  } <span class="keyword">else</span> {
    aggregate = <span class="keyword">new</span> Aggregate(args);
  }

  aggregate.model(<span class="keyword">this</span>);

  <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'undefined'</span>) {
    <span class="keyword">return</span> aggregate;
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  aggregate.exec(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>aggregation pipeline operator(s) or operator array</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#aggregate_Aggregate">Aggregate</a>, <a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#aggregate_Aggregate" title="Aggregate">Aggregate</a></li><li><a href="http://docs.mongodb.org/manual/applications/aggregation/" title="MongoDB">MongoDB</a></li></ul></div><p>If a <code>callback</code> is passed, the <code>aggregate</code> is executed and a <code>Promise</code> is returned. If a callback is not passed, the <code>aggregate</code> itself is returned.</p>

<p>This function does not trigger any middleware.</p>

<h4>Example:</h4>

<pre><code><span class="comment">// Find the max balance of all accounts</span>
Users.aggregate(
  { $group: { _id: <span class="literal">null</span>, maxBalance: { $max: <span class="string">'$balance'</span> }}},
  { $project: { _id: <span class="number">0</span>, maxBalance: <span class="number">1</span> }},
  <span class="function"><span class="keyword">function</span> <span class="params">(err, res)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
    console.log(res); <span class="comment">// [ { maxBalance: 98000 } ]</span>
  });

<span class="comment">// Or use the aggregation pipeline builder.</span>
Users.aggregate()
  .group({ _id: <span class="literal">null</span>, maxBalance: { $max: <span class="string">'$balance'</span> } })
  .select(<span class="string">'-id maxBalance'</span>)
  .exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, res)</span> {</span>
    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
    console.log(res); <span class="comment">// [ { maxBalance: 98 } ]</span>
});</code></pre>

<h4>NOTE:</h4>

<ul>
<li>Arguments are not cast to the model's schema because <code>$project</code> operators allow redefining the "shape" of the documents at any stage of the pipeline, which may leave documents in an incompatible format.</li>
<li>The documents returned are plain javascript objects, not mongoose documents (since any shape of document can be returned).</li>
<li>Requires MongoDB >= 2.1</li>
</ul><hr class=""></div><div class="item static public"><h3 id="model_Model.bulkWrite"><a href="#model_Model.bulkWrite">Model.bulkWrite(<code>ops</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Sends multiple <code>insertOne</code>, <code>updateOne</code>, <code>updateMany</code>, <code>replaceOne</code>,<br /><code>deleteOne</code>, and/or <code>deleteMany</code> operations to the MongoDB server in one<br />command. This is faster than sending multiple independent operations (like)<br />if you use <code>create()</code>) because with <code>bulkWrite()</code> there is only one round<br />trip to MongoDB.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.bulkWrite = <span class="keyword">function</span>(ops, options, callback) {
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }
  options = options || {};

  <span class="keyword">var</span> validations = ops.map(<span class="keyword">function</span>(op) {
    <span class="keyword">if</span> (op[<span class="string">'insertOne'</span>]) {
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        op[<span class="string">'insertOne'</span>][<span class="string">'document'</span>] = <span class="keyword">new</span> _<span class="keyword">this</span>(op[<span class="string">'insertOne'</span>][<span class="string">'document'</span>]);
        op[<span class="string">'insertOne'</span>][<span class="string">'document'</span>].validate({ __noPromise: <span class="literal">true</span> }, <span class="keyword">function</span>(error) {
          <span class="keyword">if</span> (error) {
            <span class="keyword">return</span> callback(error);
          }
          callback(<span class="literal">null</span>);
        });
      };
    } <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="string">'updateOne'</span>]) {
      op = op[<span class="string">'updateOne'</span>];
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        <span class="keyword">try</span> {
          op[<span class="string">'filter'</span>] = cast(_<span class="keyword">this</span>.schema, op[<span class="string">'filter'</span>]);
          op[<span class="string">'update'</span>] = castUpdate(_<span class="keyword">this</span>.schema, op[<span class="string">'update'</span>],
            _<span class="keyword">this</span>.schema.options.strict);
          <span class="keyword">if</span> (op.setDefaultsOnInsert) {
            setDefaultsOnInsert(op[<span class="string">'filter'</span>], _<span class="keyword">this</span>.schema, op[<span class="string">'update'</span>], {
              setDefaultsOnInsert: <span class="literal">true</span>,
              upsert: op.upsert
            });
          }
        } <span class="keyword">catch</span> (error) {
          <span class="keyword">return</span> callback(error);
        }

        callback(<span class="literal">null</span>);
      };
    } <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="string">'updateMany'</span>]) {
      op = op[<span class="string">'updateMany'</span>];
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        <span class="keyword">try</span> {
          op[<span class="string">'filter'</span>] = cast(_<span class="keyword">this</span>.schema, op[<span class="string">'filter'</span>]);
          op[<span class="string">'update'</span>] = castUpdate(_<span class="keyword">this</span>.schema, op[<span class="string">'update'</span>], {
            strict: _<span class="keyword">this</span>.schema.options.strict,
            overwrite: <span class="literal">false</span>
          });
          <span class="keyword">if</span> (op.setDefaultsOnInsert) {
            setDefaultsOnInsert(op[<span class="string">'filter'</span>], _<span class="keyword">this</span>.schema, op[<span class="string">'update'</span>], {
              setDefaultsOnInsert: <span class="literal">true</span>,
              upsert: op.upsert
            });
          }
        } <span class="keyword">catch</span> (error) {
          <span class="keyword">return</span> callback(error);
        }

        callback(<span class="literal">null</span>);
      };
    } <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="string">'replaceOne'</span>]) {
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        <span class="keyword">try</span> {
          op[<span class="string">'replaceOne'</span>][<span class="string">'filter'</span>] = cast(_<span class="keyword">this</span>.schema,
            op[<span class="string">'replaceOne'</span>][<span class="string">'filter'</span>]);
        } <span class="keyword">catch</span> (error) {
          <span class="keyword">return</span> callback(error);
        }

        <span class="comment">// set `skipId`, otherwise we get "_id field cannot be changed"</span>
        op[<span class="string">'replaceOne'</span>][<span class="string">'replacement'</span>] =
          <span class="keyword">new</span> _<span class="keyword">this</span>(op[<span class="string">'replaceOne'</span>][<span class="string">'replacement'</span>], <span class="literal">null</span>, <span class="literal">true</span>);
        op[<span class="string">'replaceOne'</span>][<span class="string">'replacement'</span>].validate({ __noPromise: <span class="literal">true</span> }, <span class="keyword">function</span>(error) {
          <span class="keyword">if</span> (error) {
            <span class="keyword">return</span> callback(error);
          }
          callback(<span class="literal">null</span>);
        });
      };
    } <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="string">'deleteOne'</span>]) {
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        <span class="keyword">try</span> {
          op[<span class="string">'deleteOne'</span>][<span class="string">'filter'</span>] = cast(_<span class="keyword">this</span>.schema,
            op[<span class="string">'deleteOne'</span>][<span class="string">'filter'</span>]);
        } <span class="keyword">catch</span> (error) {
          <span class="keyword">return</span> callback(error);
        }

        callback(<span class="literal">null</span>);
      };
    } <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="string">'deleteMany'</span>]) {
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        <span class="keyword">try</span> {
          op[<span class="string">'deleteMany'</span>][<span class="string">'filter'</span>] = cast(_<span class="keyword">this</span>.schema,
            op[<span class="string">'deleteMany'</span>][<span class="string">'filter'</span>]);
        } <span class="keyword">catch</span> (error) {
          <span class="keyword">return</span> callback(error);
        }

        callback(<span class="literal">null</span>);
      };
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="keyword">function</span>(callback) {
        callback(<span class="keyword">new</span> Error(<span class="string">'Invalid op passed to `bulkWrite()`'</span>));
      };
    }
  });

  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    parallel(validations, <span class="keyword">function</span>(error) {
      <span class="keyword">if</span> (error) {
        callback &amp;&amp; callback(error);
        <span class="keyword">return</span> reject(error);
      }

      _<span class="keyword">this</span>.collection.bulkWrite(ops, options, <span class="keyword">function</span>(error, res) {
        <span class="keyword">if</span> (error) {
          callback &amp;&amp; callback(error);
          <span class="keyword">return</span> reject(error);
        }

        callback &amp;&amp; callback(<span class="literal">null</span>, res);
        resolve(res);
      });
    });
  });

  <span class="keyword">return</span> promise;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>ops</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback &lt;code&gt;function(error, bulkWriteOpResult) {}&lt;/code&gt;</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span>resolves to a `BulkWriteOpResult` if the operation succeeds</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~BulkWriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><p>Mongoose will perform casting on all operations you provide.</p>

<p>This function does <strong>not</strong> trigger any middleware, not <code>save()</code> nor <code>update()</code>.<br />If you need to trigger<br /><code>save()</code> middleware for every document use <a href="../../api.html#model_Model.create"><code>create()</code></a> instead.</p>

<h4>Example:</h4>

<pre><code>Character.bulkWrite([
  {
    insertOne: {
      document: {
        name: <span class="string">'Eddard Stark'</span>,
        title: <span class="string">'Warden of the North'</span>
      }
    }
  },
  {
    updateOne: {
      filter: { name: <span class="string">'Eddard Stark'</span> },
      <span class="comment">// If you were using the MongoDB driver directly, you'd need to do</span>
      <span class="comment">// `update: { $set: { title: ... } }` but mongoose adds $set for</span>
      <span class="comment">// you.</span>
      update: { title: <span class="string">'Hand of the King'</span> }
    }
  },
  {
    deleteOne: {
      {
        filter: { name: <span class="string">'Eddard Stark'</span> }
      }
    }
  }
]).then(handleResult);</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.count"><a href="#model_Model.count">Model.count(<code>conditions</code>, <code>[callback]</code>)</a></h3><p>Counts number of matching documents in a database collection.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.count = <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }

  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.count(conditions, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>Adventure.count({ type: <span class="string">'jungle'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, count)</span> {</span>
  <span class="keyword">if</span> (err) ..
  console.log(<span class="string">'there are %d jungle adventures'</span>, count);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.create"><a href="#model_Model.create">Model.create(<code>doc(s)</code>, <code>[callback]</code>)</a></h3><p>Shortcut for saving one or more documents to the database.<br /><code>MyModel.create(docs)</code> does <code>new MyModel(doc).save()</code> for every doc in<br />docs.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.create = <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(doc, callback)</span> {</span>
  <span class="keyword">var</span> args;
  <span class="keyword">var</span> cb;
  <span class="keyword">var</span> discriminatorKey = <span class="keyword">this</span>.schema.options.discriminatorKey;

  <span class="keyword">if</span> (Array.isArray(doc)) {
    args = doc;
    cb = callback;
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> last = arguments[arguments.length - <span class="number">1</span>];
    <span class="comment">// Handle falsy callbacks re: #5061</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> last === <span class="string">'function'</span> || !last) {
      cb = last;
      args = utils.args(arguments, <span class="number">0</span>, arguments.length - <span class="number">1</span>);
    } <span class="keyword">else</span> {
      args = utils.args(arguments);
    }
  }

  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">if</span> (cb) {
    cb = <span class="keyword">this</span>.$wrapCallback(cb);
  }

  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> (args.length === <span class="number">0</span>) {
      setImmediate(<span class="keyword">function</span>() {
        cb &amp;&amp; cb(<span class="literal">null</span>);
        resolve(<span class="literal">null</span>);
      });
      <span class="keyword">return</span>;
    }

    <span class="keyword">var</span> toExecute = [];
    <span class="keyword">var</span> firstError;
    args.forEach(<span class="keyword">function</span>(doc) {
      toExecute.push(<span class="keyword">function</span>(callback) {
        <span class="keyword">var</span> Model = _<span class="keyword">this</span>.discriminators &amp;&amp; doc[discriminatorKey] ?
          _<span class="keyword">this</span>.discriminators[doc[discriminatorKey]] :
          _<span class="keyword">this</span>;
        <span class="keyword">var</span> toSave = doc;
        <span class="keyword">var</span> callbackWrapper = <span class="keyword">function</span>(error, doc) {
          <span class="keyword">if</span> (error) {
            <span class="keyword">if</span> (!firstError) {
              firstError = error;
            }
            <span class="keyword">return</span> callback(<span class="literal">null</span>, { error: error });
          }
          callback(<span class="literal">null</span>, { doc: doc });
        };

        <span class="keyword">if</span> (!(toSave <span class="keyword">instanceof</span> Model)) {
          <span class="keyword">try</span> {
            toSave = <span class="keyword">new</span> Model(toSave);
          } <span class="keyword">catch</span> (error) {
            <span class="keyword">return</span> callbackWrapper(error);
          }
        }

        <span class="comment">// Hack to avoid getting a promise because of</span>
        <span class="comment">// $__registerHooksFromSchema</span>
        <span class="keyword">if</span> (toSave.$__original_save) {
          toSave.$__original_save({ __noPromise: <span class="literal">true</span> }, callbackWrapper);
        } <span class="keyword">else</span> {
          toSave.save({ __noPromise: <span class="literal">true</span> }, callbackWrapper);
        }
      });
    });

    parallel(toExecute, <span class="keyword">function</span>(error, res) {
      <span class="keyword">var</span> savedDocs = [];
      <span class="keyword">var</span> len = res.length;
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
        <span class="keyword">if</span> (res[i].doc) {
          savedDocs.push(res[i].doc);
        }
      }

      <span class="keyword">if</span> (firstError) {
        <span class="keyword">if</span> (cb) {
          cb(firstError, savedDocs);
        } <span class="keyword">else</span> {
          reject(firstError);
        }
        <span class="keyword">return</span>;
      }

      <span class="keyword">if</span> (doc <span class="keyword">instanceof</span> Array) {
        resolve(savedDocs);
        cb &amp;&amp; cb.call(_<span class="keyword">this</span>, <span class="literal">null</span>, savedDocs);
      } <span class="keyword">else</span> {
        resolve.apply(promise, savedDocs);
        <span class="keyword">if</span> (cb) {
          cb.apply(_<span class="keyword">this</span>, [<span class="literal">null</span>].concat(savedDocs));
        }
      }
    });
  });

  <span class="keyword">return</span> promise;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc(s)</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#*">*</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><h2>This function triggers the following middleware</h2>

<ul>
<li><code>save()</code></li>
</ul>

<h4>Example:</h4>

<pre><code><span class="comment">// pass individual docs</span>
Candy.create({ type: <span class="string">'jelly bean'</span> }, { type: <span class="string">'snickers'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, jellybean, snickers)</span> {</span>
  <span class="keyword">if</span> (err) <span class="comment">// ...</span>
});

<span class="comment">// pass an array</span>
<span class="keyword">var</span> array = [{ type: <span class="string">'jelly bean'</span> }, { type: <span class="string">'snickers'</span> }];
Candy.create(array, <span class="function"><span class="keyword">function</span> <span class="params">(err, candies)</span> {</span>
  <span class="keyword">if</span> (err) <span class="comment">// ...</span>

  <span class="keyword">var</span> jellybean = candies[<span class="number">0</span>];
  <span class="keyword">var</span> snickers = candies[<span class="number">1</span>];
  <span class="comment">// ...</span>
});

<span class="comment">// callback is optional; use the returned promise if you like:</span>
<span class="keyword">var</span> promise = Candy.create({ type: <span class="string">'jawbreaker'</span> });
promise.then(<span class="function"><span class="keyword">function</span> <span class="params">(jawbreaker)</span> {</span>
  <span class="comment">// ...</span>
})</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.createIndexes"><a href="#model_Model.createIndexes">Model.createIndexes(<code>[options]</code>, <code>[cb]</code>)</a></h3><p>Similar to <code>ensureIndexes()</code>, except for it uses the <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#createIndex"><code>createIndex</code></a><br />function. The <code>ensureIndex()</code> function checks to see if an index with that<br />name already exists, and, if not, does not attempt to create the index.<br /><code>createIndex()</code> bypasses this check.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.createIndexes = <span class="function"><span class="keyword">function</span> <span class="title">createIndexes</span><span class="params">(options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = {};
  }
  options = options || {};
  options.createIndex = <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>.ensureIndexes(options, callback);
};

<span class="function"><span class="keyword">function</span> <span class="title">_ensureIndexes</span><span class="params">(model, options, callback)</span> {</span>
  <span class="keyword">var</span> indexes = model.schema.indexes();
  options = options || {};

  <span class="keyword">var</span> done = <span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err &amp;&amp; model.schema.options.emitIndexErrors) {
      model.emit(<span class="string">'error'</span>, err);
    }
    model.emit(<span class="string">'index'</span>, err);
    callback &amp;&amp; callback(err);
  };

  <span class="keyword">if</span> (!indexes.length) {
    setImmediate(<span class="keyword">function</span>() {
      done();
    });
    <span class="keyword">return</span>;
  }
  <span class="comment">// Indexes are created one-by-one to support how MongoDB &lt; 2.4 deals</span>
  <span class="comment">// with background indexes.</span>

  <span class="keyword">var</span> indexSingleDone = <span class="keyword">function</span>(err, fields, options, name) {
    model.emit(<span class="string">'index-single-done'</span>, err, fields, options, name);
  };
  <span class="keyword">var</span> indexSingleStart = <span class="keyword">function</span>(fields, options) {
    model.emit(<span class="string">'index-single-start'</span>, fields, options);
  };

  <span class="keyword">var</span> create = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (options._automatic) {
      <span class="keyword">if</span> (model.schema.options.autoIndex === <span class="literal">false</span> ||
          (model.schema.options.autoIndex == <span class="literal">null</span> &amp;&amp; model.db.config.autoIndex === <span class="literal">false</span>)) {
        <span class="keyword">return</span> done();
      }
    }

    <span class="keyword">var</span> index = indexes.shift();
    <span class="keyword">if</span> (!index) <span class="keyword">return</span> done();

    <span class="keyword">var</span> indexFields = index[<span class="number">0</span>];
    <span class="keyword">var</span> indexOptions = index[<span class="number">1</span>];
    _handleSafe(options);

    indexSingleStart(indexFields, options);
    <span class="keyword">var</span> methodName = options.createIndex ? <span class="string">'createIndex'</span> : <span class="string">'ensureIndex'</span>;
    model.collection[methodName](indexFields, indexOptions, utils.tick(<span class="keyword">function</span>(err, name) {
      indexSingleDone(err, indexFields, indexOptions, name);
      <span class="keyword">if</span> (err) {
        <span class="keyword">return</span> done(err);
      }
      create();
    }));
  };

  setImmediate(<span class="keyword">function</span>() {
    <span class="comment">// If buffering is off, do this manually.</span>
    <span class="keyword">if</span> (options._automatic &amp;&amp; !model.collection.collection) {
      model.collection.addQueue(create, []);
    } <span class="keyword">else</span> {
      create();
    }
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">_handleSafe</span><span class="params">(options)</span> {</span>
  <span class="keyword">if</span> (options.safe) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> options.safe === <span class="string">'boolean'</span>) {
      options.w = options.safe;
      <span class="keyword">delete</span> options.safe;
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> options.safe === <span class="string">'object'</span>) {
      options.w = options.safe.w;
      options.j = options.safe.j;
      options.wtimeout = options.safe.wtimeout;
      <span class="keyword">delete</span> options.safe;
    }
  }
}</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>internal options</span></li><li><code>[cb]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><hr class=""></div><div class="item static public"><h3 id="model_Model.deleteMany"><a href="#model_Model.deleteMany">Model.deleteMany(<code>conditions</code>, <code>[callback]</code>)</a></h3><p>Deletes all of the documents that match <code>conditions</code> from the collection.<br />Behaves like <code>remove()</code>, but deletes all documents that match <code>conditions</code><br />regardless of the <code>single</code> option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.deleteMany = <span class="function"><span class="keyword">function</span> <span class="title">deleteMany</span><span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }

  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query(conditions, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.deleteMany(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>Character.deleteMany({ name: <span class="regexp">/Stark/</span>, age: { $gte: <span class="number">18</span> } }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>});</code></pre>

<h4>Note:</h4>

<p>Like <code>Model.remove()</code>, this function does <strong>not</strong> trigger <code>pre('remove')</code> or <code>post('remove')</code> hooks.</p><hr class=""></div><div class="item static public"><h3 id="model_Model.deleteOne"><a href="#model_Model.deleteOne">Model.deleteOne(<code>conditions</code>, <code>[callback]</code>)</a></h3><p>Deletes the first document that matches <code>conditions</code> from the collection.<br />Behaves like <code>remove()</code>, but deletes at most one document regardless of the<br /><code>single</code> option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.deleteOne = <span class="function"><span class="keyword">function</span> <span class="title">deleteOne</span><span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }

  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query(conditions, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.deleteOne(callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>Character.deleteOne({ name: <span class="string">'Eddard Stark'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>});</code></pre>

<h4>Note:</h4>

<p>Like <code>Model.remove()</code>, this function does <strong>not</strong> trigger <code>pre('remove')</code> or <code>post('remove')</code> hooks.</p><hr class=""></div><div class="item static public"><h3 id="model_Model.discriminator"><a href="#model_Model.discriminator">Model.discriminator(<code>name</code>, <code>schema</code>)</a></h3><p>Adds a discriminator type.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.discriminator = <span class="keyword">function</span>(name, schema) {
  <span class="keyword">var</span> model;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">'function'</span>) {
    model = name;
    name = utils.getFunctionName(model);
    <span class="keyword">if</span> (!(model.prototype <span class="keyword">instanceof</span> Model)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The provided class '</span> + name + <span class="string">' must extend Model'</span>);
    }
  }

  schema = discriminator(<span class="keyword">this</span>, name, schema);
  <span class="keyword">if</span> (<span class="keyword">this</span>.db.models[name]) {
    <span class="keyword">throw</span> <span class="keyword">new</span> OverwriteModelError(name);
  }

  schema.$isRootDiscriminator = <span class="literal">true</span>;

  model = <span class="keyword">this</span>.db.model(model || name, schema, <span class="keyword">this</span>.collection.name);
  <span class="keyword">this</span>.discriminators[name] = model;
  <span class="keyword">var</span> d = <span class="keyword">this</span>.discriminators[name];
  d.prototype.__proto__ = <span class="keyword">this</span>.prototype;
  Object.defineProperty(d, <span class="string">'baseModelName'</span>, {
    value: <span class="keyword">this</span>.modelName,
    configurable: <span class="literal">true</span>,
    writable: <span class="literal">false</span>
  });

  <span class="comment">// apply methods and statics</span>
  applyMethods(d, schema);
  applyStatics(d, schema);

  <span class="keyword">return</span> d;
};

<span class="comment">// Model (class) features</span></code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>discriminator model name</span></li><li><code>schema</code><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>discriminator model schema</span></li></ul></div><h4>Example:</h4>

<pre><code><span class="function"><span class="keyword">function</span> <span class="title">BaseSchema</span><span class="params">()</span> {</span>
  Schema.apply(<span class="keyword">this</span>, arguments);

  <span class="keyword">this</span>.add({
    name: String,
    createdAt: Date
  });
}
util.inherits(BaseSchema, Schema);

<span class="keyword">var</span> PersonSchema = <span class="keyword">new</span> BaseSchema();
<span class="keyword">var</span> BossSchema = <span class="keyword">new</span> BaseSchema({ department: String });

<span class="keyword">var</span> Person = mongoose.model(<span class="string">'Person'</span>, PersonSchema);
<span class="keyword">var</span> Boss = Person.discriminator(<span class="string">'Boss'</span>, BossSchema);</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.distinct"><a href="#model_Model.distinct">Model.distinct(<code>field</code>, <code>[conditions]</code>, <code>[callback]</code>)</a></h3><p>Creates a Query for a <code>distinct</code> operation.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.distinct = <span class="function"><span class="keyword">function</span> <span class="title">distinct</span><span class="params">(field, conditions, callback)</span> {</span>
  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);

  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.distinct(field, conditions, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>field</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><p>Passing a <code>callback</code> immediately executes the query.</p>

<h4>Example</h4>

<pre><code>Link.distinct(<span class="string">'url'</span>, { clicks: {$gt: <span class="number">100</span>}}, <span class="function"><span class="keyword">function</span> <span class="params">(err, result)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);

  assert(Array.isArray(result));
  console.log(<span class="string">'unique urls with more than 100 clicks'</span>, result);
})

<span class="keyword">var</span> query = Link.distinct(<span class="string">'url'</span>);
query.exec(callback);</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.ensureIndexes"><a href="#model_Model.ensureIndexes">Model.ensureIndexes(<code>[options]</code>, <code>[cb]</code>)</a></h3><p>Sends <code>createIndex</code> commands to mongo for each index declared in the schema.<br />The <code>createIndex</code> commands are sent in series.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.ensureIndexes = <span class="function"><span class="keyword">function</span> <span class="title">ensureIndexes</span><span class="params">(options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">if</span> (options &amp;&amp; options.__noPromise) {
    _ensureIndexes(<span class="keyword">this</span>, options, callback);
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    _ensureIndexes(_<span class="keyword">this</span>, options || {}, <span class="keyword">function</span>(error) {
      <span class="keyword">if</span> (error) {
        callback &amp;&amp; callback(error);
        reject(error);
      }
      callback &amp;&amp; callback();
      resolve();
    });
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>internal options</span></li><li><code>[cb]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>Event.ensureIndexes(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
});</code></pre>

<p>After completion, an <code>index</code> event is emitted on this <code>Model</code> passing an error if one occurred.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> eventSchema = <span class="keyword">new</span> Schema({ thing: { type: <span class="string">'string'</span>, unique: <span class="literal">true</span> }})
<span class="keyword">var</span> Event = mongoose.model(<span class="string">'Event'</span>, eventSchema);

Event.on(<span class="string">'index'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (err) console.error(err); <span class="comment">// error occurred during index creation</span>
})</code></pre>

<p><em>NOTE: It is not recommended that you run this in production. Index creation may impact database performance depending on your load. Use with caution.</em></p><hr class=""></div><div class="item static public"><h3 id="model_Model.find"><a href="#model_Model.find">Model.find(<code>conditions</code>, <code>[projection]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Finds documents</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.find = <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">(conditions, projection, options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
    projection = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> projection === <span class="string">'function'</span>) {
    callback = projection;
    projection = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);
  mq.select(projection);
  mq.setOptions(options);
  <span class="keyword">if</span> (<span class="keyword">this</span>.schema.discriminatorMapping &amp;&amp;
      <span class="keyword">this</span>.schema.discriminatorMapping.isRoot &amp;&amp;
      mq.selectedInclusively()) {
    <span class="comment">// Need to select discriminator key because original schema doesn't have it</span>
    mq.select(<span class="keyword">this</span>.schema.options.discriminatorKey);
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.find(conditions, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[projection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to return (http://bit.ly/1HotzBo)</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-select" title="field selection">field selection</a></li><li><a href="#promise-js" title="promise">promise</a></li></ul></div><p>The <code>conditions</code> are cast to their respective SchemaTypes before the command is sent.</p>

<h4>Examples:</h4>

<pre><code><span class="comment">// named john and at least 18</span>
MyModel.find({ name: <span class="string">'john'</span>, age: { $gte: <span class="number">18</span> }});

<span class="comment">// executes immediately, passing results to callback</span>
MyModel.find({ name: <span class="string">'john'</span>, age: { $gte: <span class="number">18</span> }}, <span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>});

<span class="comment">// name LIKE john and only selecting the "name" and "friends" fields, executing immediately</span>
MyModel.find({ name: <span class="regexp">/john/i</span> }, <span class="string">'name friends'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span> })

<span class="comment">// passing options</span>
MyModel.find({ name: <span class="regexp">/john/i</span> }, <span class="literal">null</span>, { skip: <span class="number">10</span> })

<span class="comment">// passing options and executing immediately</span>
MyModel.find({ name: <span class="regexp">/john/i</span> }, <span class="literal">null</span>, { skip: <span class="number">10</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>});

<span class="comment">// executing a query explicitly</span>
<span class="keyword">var</span> query = MyModel.find({ name: <span class="regexp">/john/i</span> }, <span class="literal">null</span>, { skip: <span class="number">10</span> })
query.exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>});

<span class="comment">// using the promise returned from executing a query</span>
<span class="keyword">var</span> query = MyModel.find({ name: <span class="regexp">/john/i</span> }, <span class="literal">null</span>, { skip: <span class="number">10</span> });
<span class="keyword">var</span> promise = query.exec();
promise.addBack(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findById"><a href="#model_Model.findById">Model.findById(<code>id</code>, <code>[projection]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Finds a single document by its _id field. <code>findById(id)</code> is almost*<br />equivalent to <code>findOne({ _id: id })</code>. If you want to query by a document's<br /><code>_id</code>, use <code>findById()</code> instead of <code>findOne()</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findById = <span class="function"><span class="keyword">function</span> <span class="title">findById</span><span class="params">(id, projection, options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">'undefined'</span>) {
    id = <span class="literal">null</span>;
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.findOne({_id: id}, projection, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>value of &lt;code&gt;_id&lt;/code&gt; to query by</span></li><li><code>[projection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to return (http://bit.ly/1HotzBo)</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-select" title="field selection">field selection</a></li><li><a href="#query_Query-lean" title="lean queries">lean queries</a></li></ul></div><p>The <code>id</code> is cast based on the Schema before sending the command.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOne()</code></li>
</ul>

<p>* Except for how it treats <code>undefined</code>. If you use <code>findOne()</code>, you'll see<br />that <code>findOne(undefined)</code> and <code>findOne({ _id: undefined })</code> are equivalent<br />to <code>findOne({})</code> and return arbitrary documents. However, mongoose<br />translates <code>findById(undefined)</code> into <code>findOne({ _id: null })</code>.</p>

<h4>Example:</h4>

<pre><code><span class="comment">// find adventure by id and execute immediately</span>
Adventure.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// same as above</span>
Adventure.findById(id).exec(callback);

<span class="comment">// select only the adventures name and length</span>
Adventure.findById(id, <span class="string">'name length'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// same as above</span>
Adventure.findById(id, <span class="string">'name length'</span>).exec(callback);

<span class="comment">// include all properties except for `length`</span>
Adventure.findById(id, <span class="string">'-length'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// passing options (in this case return the raw js objects, not mongoose documents by passing `lean`</span>
Adventure.findById(id, <span class="string">'name'</span>, { lean: <span class="literal">true</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>});

<span class="comment">// same as above</span>
Adventure.findById(id, <span class="string">'name'</span>).lean().exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findByIdAndRemove"><a href="#model_Model.findByIdAndRemove">Model.findByIdAndRemove(<code>id</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Issue a mongodb findAndModify remove command by a document's _id field. <code>findByIdAndRemove(id, ...)</code> is equivalent to <code>findOneAndRemove({ _id: id }, ...)</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findByIdAndRemove = function(id, options, callback) {
  if (arguments.length === 1 &amp;&amp; typeof id === 'function') {
    var msg = 'Model.findByIdAndRemove(): First argument must not be a function.

'
        + '  ' + this.modelName + '.findByIdAndRemove(id, callback)
'
        + '  ' + this.modelName + '.findByIdAndRemove(id)
'
        + '  ' + this.modelName + '.findByIdAndRemove()
';
    throw new TypeError(msg);
  }
  if (callback) {
    callback = this.$wrapCallback(callback);
  }

  return this.findOneAndRemove({_id: id}, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>value of &lt;code&gt;_id&lt;/code&gt; to query by</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.findOneAndRemove" title="Model.findOneAndRemove">Model.findOneAndRemove</a></li><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, removes it, passing the found document (if any) to the callback.</p>

<p>Executes immediately if <code>callback</code> is passed, else a <code>Query</code> object is returned.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOneAndRemove()</code></li>
</ul>

<h4>Options:</h4>

<ul>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>select</code>: sets the document fields to return</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
<li><code>strict</code>: overwrites the schema's <a href="../../guide.html#strict">strict mode option</a> for this update</li>
</ul>

<h4>Examples:</h4>

<pre><code>A.findByIdAndRemove(id, options, callback) <span class="comment">// executes</span>
A.findByIdAndRemove(id, options)  <span class="comment">// return Query</span>
A.findByIdAndRemove(id, callback) <span class="comment">// executes</span>
A.findByIdAndRemove(id) <span class="comment">// returns Query</span>
A.findByIdAndRemove()           <span class="comment">// returns Query</span></code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findByIdAndUpdate"><a href="#model_Model.findByIdAndUpdate">Model.findByIdAndUpdate(<code>id</code>, <code>[update]</code>, <code>[options]</code>, <code>[options.lean]</code>, <code>[callback]</code>)</a></h3><p>Issues a mongodb findAndModify update command by a document's _id field.<br /><code>findByIdAndUpdate(id, ...)</code> is equivalent to <code>findOneAndUpdate({ _id: id }, ...)</code>.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findByIdAndUpdate = function(id, update, options, callback) {
  if (callback) {
    callback = this.$wrapCallback(callback);
  }
  if (arguments.length === 1) {
    if (typeof id === 'function') {
      var msg = 'Model.findByIdAndUpdate(): First argument must not be a function.

'
          + '  ' + this.modelName + '.findByIdAndUpdate(id, callback)
'
          + '  ' + this.modelName + '.findByIdAndUpdate(id)
'
          + '  ' + this.modelName + '.findByIdAndUpdate()
';
      throw new TypeError(msg);
    }
    return this.findOneAndUpdate({_id: id}, undefined);
  }

  // if a model is passed in instead of an id
  if (id instanceof Document) {
    id = id._id;
  }

  return this.findOneAndUpdate.call(this, {_id: id}, update, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>id</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>value of &lt;code&gt;_id&lt;/code&gt; to query by</span></li><li><code>[update]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[options.lean]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-lean&quot;&gt;&lt;code&gt;Query.lean()&lt;/code&gt;&lt;/a&gt;.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.findOneAndUpdate" title="Model.findOneAndUpdate">Model.findOneAndUpdate</a></li><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, updates it according to the <code>update</code> arg,<br />passing any <code>options</code>, and returns the found document (if any) to the<br />callback. The query executes immediately if <code>callback</code> is passed else a<br />Query object is returned.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOneAndUpdate()</code></li>
</ul>

<h4>Options:</h4>

<ul>
<li><code>new</code>: bool - true to return the modified document rather than the original. defaults to false</li>
<li><code>upsert</code>: bool - creates the object if it doesn't exist. defaults to false.</li>
<li><code>runValidators</code>: if true, runs <a href="../../validation.html#update-validators">update validators</a> on this command. Update validators validate the update operation against the model's schema.</li>
<li><code>setDefaultsOnInsert</code>: if this and <code>upsert</code> are true, mongoose will apply the <a href="../../defaults.html">defaults</a> specified in the model's schema if a new document is created. This option only works on MongoDB >= 2.4 because it relies on <a href="https://docs.mongodb.org/v2.4/reference/operator/update/setOnInsert/">MongoDB's <code>$setOnInsert</code> operator</a>.</li>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>select</code>: sets the document fields to return</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
<li><code>strict</code>: overwrites the schema's <a href="../../guide.html#strict">strict mode option</a> for this update</li>
<li><code>runSettersOnQuery</code>: bool - if true, run all setters defined on the associated model's schema for all fields defined in the query and the update.</li>
</ul>

<h4>Examples:</h4>

<pre><code>A.findByIdAndUpdate(id, update, options, callback) <span class="comment">// executes</span>
A.findByIdAndUpdate(id, update, options)  <span class="comment">// returns Query</span>
A.findByIdAndUpdate(id, update, callback) <span class="comment">// executes</span>
A.findByIdAndUpdate(id, update)           <span class="comment">// returns Query</span>
A.findByIdAndUpdate()                     <span class="comment">// returns Query</span></code></pre>

<h4>Note:</h4>

<p>All top level update keys which are not <code>atomic</code> operation names are treated as set operations:</p>

<h4>Example:</h4>

<pre><code>Model.findByIdAndUpdate(id, { name: <span class="string">'jason bourne'</span> }, options, callback)

<span class="comment">// is sent as</span>
Model.findByIdAndUpdate(id, { $set: { name: <span class="string">'jason bourne'</span> }}, options, callback)</code></pre>

<p>This helps prevent accidentally overwriting your document with <code>{ name: 'jason bourne' }</code>.</p>

<h4>Note:</h4>

<p>Values are cast to their appropriate types when using the findAndModify helpers.<br />However, the below are not executed by default.</p>

<ul>
<li>defaults. Use the <code>setDefaultsOnInsert</code> option to override.</li>
<li>setters. Use the <code>runSettersOnQuery</code> option to override.</li>
</ul>

<p><code>findAndModify</code> helpers support limited validation. You can<br />enable these by setting the <code>runValidators</code> options,<br />respectively.</p>

<p>If you need full-fledged validation, use the traditional approach of first<br />retrieving the document.</p>

<pre><code>Model.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (err) ..
  doc.name = <span class="string">'jason bourne'</span>;
  doc.save(callback);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findOne"><a href="#model_Model.findOne">Model.findOne(<code>[conditions]</code>, <code>[projection]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Finds one document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOne = <span class="function"><span class="keyword">function</span> <span class="title">findOne</span><span class="params">(conditions, projection, options, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> projection === <span class="string">'function'</span>) {
    callback = projection;
    projection = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
    projection = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  }

  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);
  mq.select(projection);
  mq.setOptions(options);
  <span class="keyword">if</span> (<span class="keyword">this</span>.schema.discriminatorMapping &amp;&amp;
      <span class="keyword">this</span>.schema.discriminatorMapping.isRoot &amp;&amp;
      mq.selectedInclusively()) {
    mq.select(<span class="keyword">this</span>.schema.options.discriminatorKey);
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.findOne(conditions, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[projection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to return (http://bit.ly/1HotzBo)</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-select" title="field selection">field selection</a></li><li><a href="#query_Query-lean" title="lean queries">lean queries</a></li></ul></div><p>The <code>conditions</code> are cast to their respective SchemaTypes before the command is sent.</p>

<p><em>Note:</em> <code>conditions</code> is optional, and if <code>conditions</code> is null or undefined,<br />mongoose will send an empty <code>findOne</code> command to MongoDB, which will return<br />an arbitrary document. If you're querying by <code>_id</code>, use <code>findById()</code> instead.</p>

<h4>Example:</h4>

<pre><code><span class="comment">// find one iphone adventures - iphone adventures??</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// same as above</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// select only the adventures name</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }, <span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// same as above</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }, <span class="string">'name'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, adventure)</span> {</span>});

<span class="comment">// specify options, in this case lean</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }, <span class="string">'name'</span>, { lean: <span class="literal">true</span> }, callback);

<span class="comment">// same as above</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }, <span class="string">'name'</span>, { lean: <span class="literal">true</span> }).exec(callback);

<span class="comment">// chaining findOne queries (same as above)</span>
Adventure.findOne({ type: <span class="string">'iphone'</span> }).select(<span class="string">'name'</span>).lean().exec(callback);</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findOneAndRemove"><a href="#model_Model.findOneAndRemove">Model.findOneAndRemove(<code>conditions</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Issue a mongodb findAndModify remove command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOneAndRemove = function(conditions, options, callback) {
  if (arguments.length === 1 &amp;&amp; typeof conditions === 'function') {
    var msg = 'Model.findOneAndRemove(): First argument must not be a function.

'
        + '  ' + this.modelName + '.findOneAndRemove(conditions, callback)
'
        + '  ' + this.modelName + '.findOneAndRemove(conditions)
'
        + '  ' + this.modelName + '.findOneAndRemove()
';
    throw new TypeError(msg);
  }

  if (typeof options === 'function') {
    callback = options;
    options = undefined;
  }
  if (callback) {
    callback = this.$wrapCallback(callback);
  }

  var fields;
  if (options) {
    fields = options.select;
    options.select = undefined;
  }

  var mq = new this.Query({}, {}, this, this.collection);
  mq.select(fields);

  return mq.findOneAndRemove(conditions, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, removes it, passing the found document (if any) to the callback.</p>

<p>Executes immediately if <code>callback</code> is passed else a Query object is returned.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOneAndRemove()</code></li>
</ul>

<h4>Options:</h4>

<ul>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>maxTimeMS</code>: puts a time limit on the query - requires mongodb >= 2.6.0</li>
<li><code>select</code>: sets the document fields to return</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
<li><code>strict</code>: overwrites the schema's <a href="../../guide.html#strict">strict mode option</a> for this update</li>
</ul>

<h4>Examples:</h4>

<pre><code>A.findOneAndRemove(conditions, options, callback) <span class="comment">// executes</span>
A.findOneAndRemove(conditions, options)  <span class="comment">// return Query</span>
A.findOneAndRemove(conditions, callback) <span class="comment">// executes</span>
A.findOneAndRemove(conditions) <span class="comment">// returns Query</span>
A.findOneAndRemove()           <span class="comment">// returns Query</span></code></pre>

<p>Values are cast to their appropriate types when using the findAndModify helpers.<br />However, the below are not executed by default.</p>

<ul>
<li>defaults. Use the <code>setDefaultsOnInsert</code> option to override.</li>
<li>setters. Use the <code>runSettersOnQuery</code> option to override.</li>
</ul>

<p><code>findAndModify</code> helpers support limited validation. You can<br />enable these by setting the <code>runValidators</code> options,<br />respectively.</p>

<p>If you need full-fledged validation, use the traditional approach of first<br />retrieving the document.</p>

<pre><code>Model.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (err) ..
  doc.name = <span class="string">'jason bourne'</span>;
  doc.save(callback);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.findOneAndUpdate"><a href="#model_Model.findOneAndUpdate">Model.findOneAndUpdate(<code>[conditions]</code>, <code>[update]</code>, <code>[options]</code>, <code>[options.lean]</code>, <code>[callback]</code>)</a></h3><p>Issues a mongodb findAndModify update command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.findOneAndUpdate = function(conditions, update, options, callback) {
  if (typeof options === 'function') {
    callback = options;
    options = null;
  } else if (arguments.length === 1) {
    if (typeof conditions === 'function') {
      var msg = 'Model.findOneAndUpdate(): First argument must not be a function.

'
          + '  ' + this.modelName + '.findOneAndUpdate(conditions, update, options, callback)
'
          + '  ' + this.modelName + '.findOneAndUpdate(conditions, update, options)
'
          + '  ' + this.modelName + '.findOneAndUpdate(conditions, update)
'
          + '  ' + this.modelName + '.findOneAndUpdate(update)
'
          + '  ' + this.modelName + '.findOneAndUpdate()
';
      throw new TypeError(msg);
    }
    update = conditions;
    conditions = undefined;
  }
  if (callback) {
    callback = this.$wrapCallback(callback);
  }

  var fields;
  if (options &amp;&amp; options.fields) {
    fields = options.fields;
  }

  var retainKeyOrder = get(options, 'retainKeyOrder') ||
    get(this, 'schema.options.retainKeyOrder') ||
    false;
  update = utils.clone(update, {
    depopulate: true,
    _isNested: true,
    retainKeyOrder: retainKeyOrder
  });
  if (this.schema.options.versionKey &amp;&amp; options &amp;&amp; options.upsert) {
    if (options.overwrite) {
      update[this.schema.options.versionKey] = 0;
    } else {
      if (!update.$setOnInsert) {
        update.$setOnInsert = {};
      }
      update.$setOnInsert[this.schema.options.versionKey] = 0;
    }
  }

  var mq = new this.Query({}, {}, this, this.collection);
  mq.select(fields);

  return mq.findOneAndUpdate(conditions, update, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[update]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[options.lean]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-lean&quot;&gt;&lt;code&gt;Query.lean()&lt;/code&gt;&lt;/a&gt;.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><p>Finds a matching document, updates it according to the <code>update</code> arg, passing any <code>options</code>, and returns the found document (if any) to the callback. The query executes immediately if <code>callback</code> is passed else a Query object is returned.</p>

<h4>Options:</h4>

<ul>
<li><code>new</code>: bool - if true, return the modified document rather than the original. defaults to false (changed in 4.0)</li>
<li><code>upsert</code>: bool - creates the object if it doesn't exist. defaults to false.</li>
<li><code>fields</code>: {Object|String} - Field selection. Equivalent to <code>.select(fields).findOneAndUpdate()</code></li>
<li><code>maxTimeMS</code>: puts a time limit on the query - requires mongodb >= 2.6.0</li>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>runValidators</code>: if true, runs <a href="../../validation.html#update-validators">update validators</a> on this command. Update validators validate the update operation against the model's schema.</li>
<li><code>setDefaultsOnInsert</code>: if this and <code>upsert</code> are true, mongoose will apply the <a href="../../defaults.html">defaults</a> specified in the model's schema if a new document is created. This option only works on MongoDB >= 2.4 because it relies on <a href="https://docs.mongodb.org/v2.4/reference/operator/update/setOnInsert/">MongoDB's <code>$setOnInsert</code> operator</a>.</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
<li><code>strict</code>: overwrites the schema's <a href="../../guide.html#strict">strict mode option</a> for this update</li>
<li><code>runSettersOnQuery</code>: bool - if true, run all setters defined on the associated model's schema for all fields defined in the query and the update.</li>
</ul>

<h4>Examples:</h4>

<pre><code>A.findOneAndUpdate(conditions, update, options, callback) <span class="comment">// executes</span>
A.findOneAndUpdate(conditions, update, options)  <span class="comment">// returns Query</span>
A.findOneAndUpdate(conditions, update, callback) <span class="comment">// executes</span>
A.findOneAndUpdate(conditions, update)           <span class="comment">// returns Query</span>
A.findOneAndUpdate()                             <span class="comment">// returns Query</span></code></pre>

<h4>Note:</h4>

<p>All top level update keys which are not <code>atomic</code> operation names are treated as set operations:</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> query = { name: <span class="string">'borne'</span> };
Model.findOneAndUpdate(query, { name: <span class="string">'jason bourne'</span> }, options, callback)

<span class="comment">// is sent as</span>
Model.findOneAndUpdate(query, { $set: { name: <span class="string">'jason bourne'</span> }}, options, callback)</code></pre>

<p>This helps prevent accidentally overwriting your document with <code>{ name: 'jason bourne' }</code>.</p>

<h4>Note:</h4>

<p>Values are cast to their appropriate types when using the findAndModify helpers.<br />However, the below are not executed by default.</p>

<ul>
<li>defaults. Use the <code>setDefaultsOnInsert</code> option to override.</li>
<li>setters. Use the <code>runSettersOnQuery</code> option to override.</li>
</ul>

<p><code>findAndModify</code> helpers support limited validation. You can<br />enable these by setting the <code>runValidators</code> options,<br />respectively.</p>

<p>If you need full-fledged validation, use the traditional approach of first<br />retrieving the document.</p>

<pre><code>Model.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (err) ..
  doc.name = <span class="string">'jason bourne'</span>;
  doc.save(callback);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.geoNear"><a href="#model_Model.geoNear">Model.geoNear(<code>GeoJSON</code>, <code>options</code>, <code>[callback]</code>)</a></h3><p>geoNear support for Mongoose</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.geoNear = <span class="keyword">function</span>(near, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = {};
  }

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">if</span> (!near) {
    <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
      <span class="keyword">var</span> error = <span class="keyword">new</span> Error(<span class="string">'Must pass a near option to geoNear'</span>);
      reject(error);
      callback &amp;&amp; callback(error);
    });
  }

  <span class="keyword">var</span> x;
  <span class="keyword">var</span> y;
  <span class="keyword">var</span> schema = <span class="keyword">this</span>.schema;

  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">var</span> handler = <span class="keyword">function</span>(err, res) {
      <span class="keyword">if</span> (err) {
        reject(err);
        callback &amp;&amp; callback(err);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (options.lean) {
        resolve(res.results, res.stats);
        callback &amp;&amp; callback(<span class="literal">null</span>, res.results, res.stats);
        <span class="keyword">return</span>;
      }

      <span class="keyword">var</span> count = res.results.length;
      <span class="comment">// if there are no results, fulfill the promise now</span>
      <span class="keyword">if</span> (count === <span class="number">0</span>) {
        resolve(res.results, res.stats);
        callback &amp;&amp; callback(<span class="literal">null</span>, res.results, res.stats);
        <span class="keyword">return</span>;
      }

      <span class="keyword">var</span> errSeen = <span class="literal">false</span>;

      <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(err)</span> {</span>
        <span class="keyword">if</span> (err &amp;&amp; !errSeen) {
          errSeen = <span class="literal">true</span>;
          reject(err);
          callback &amp;&amp; callback(err);
          <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (--count &lt;= <span class="number">0</span>) {
          resolve(res.results, res.stats);
          callback &amp;&amp; callback(<span class="literal">null</span>, res.results, res.stats);
        }
      }

      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; res.results.length; i++) {
        <span class="keyword">var</span> temp = res.results[i].obj;
        res.results[i].obj = <span class="keyword">new</span> _<span class="keyword">this</span>();
        res.results[i].obj.init(temp, init);
      }
    };

    <span class="keyword">if</span> (options.query != <span class="literal">null</span>) {
      options.query = utils.clone(options.query, { retainKeyOrder: <span class="number">1</span> });
      cast(schema, options.query);
    }

    <span class="keyword">if</span> (Array.isArray(near)) {
      <span class="keyword">if</span> (near.length !== <span class="number">2</span>) {
        <span class="keyword">var</span> error = <span class="keyword">new</span> Error(<span class="string">'If using legacy coordinates, must be an array '</span> +
            <span class="string">'of size 2 for geoNear'</span>);
        reject(error);
        callback &amp;&amp; callback(error);
        <span class="keyword">return</span>;
      }
      x = near[<span class="number">0</span>];
      y = near[<span class="number">1</span>];
      _<span class="keyword">this</span>.collection.geoNear(x, y, options, handler);
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (near.type !== <span class="string">'Point'</span> || !Array.isArray(near.coordinates)) {
        error = <span class="keyword">new</span> Error(<span class="string">'Must pass either a legacy coordinate array or '</span> +
            <span class="string">'GeoJSON Point to geoNear'</span>);
        reject(error);
        callback &amp;&amp; callback(error);
        <span class="keyword">return</span>;
      }

      _<span class="keyword">this</span>.collection.geoNear(near, options, handler);
    }
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>GeoJSON</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>point or legacy coordinate pair [x,y] to search near</span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>for the query</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback for the query</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/core/2dsphere/">http://docs.mongodb.org/manual/core/2dsphere/</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/api-generated/collection.html?highlight=geonear#geoNear">http://mongodb.github.io/node-mongodb-native/api-generated/collection.html?highlight=geonear#geoNear</a></li></ul></div><p>This function does not trigger any middleware. In particular, this<br />bypasses <code>find()</code> middleware.</p>

<h4>Options:</h4>

<ul>
<li><code>lean</code> {Boolean} return the raw object</li>
<li>All options supported by the driver are also supported</li>
</ul>

<h4>Example:</h4>

<pre><code><span class="comment">// Legacy point</span>
Model.geoNear([<span class="number">1</span>,<span class="number">3</span>], { maxDistance : <span class="number">5</span>, spherical : <span class="literal">true</span> }, <span class="keyword">function</span>(err, results, stats) {
   console.log(results);
});

<span class="comment">// geoJson</span>
<span class="keyword">var</span> point = { type : <span class="string">"Point"</span>, coordinates : [<span class="number">9</span>,<span class="number">9</span>] };
Model.geoNear(point, { maxDistance : <span class="number">5</span>, spherical : <span class="literal">true</span> }, <span class="keyword">function</span>(err, results, stats) {
   console.log(results);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.geoSearch"><a href="#model_Model.geoSearch">Model.geoSearch(<code>conditions</code>, <code>[options]</code>, <code>[options.lean]</code>, <code>[callback]</code>)</a></h3><p>Implements <code>$geoSearch</code> functionality for Mongoose</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.geoSearch = <span class="keyword">function</span>(conditions, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = {};
  }
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">var</span> error;
    <span class="keyword">if</span> (conditions === <span class="literal">undefined</span> || !utils.isObject(conditions)) {
      error = <span class="keyword">new</span> Error(<span class="string">'Must pass conditions to geoSearch'</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (!options.near) {
      error = <span class="keyword">new</span> Error(<span class="string">'Must specify the near option in geoSearch'</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (!Array.isArray(options.near)) {
      error = <span class="keyword">new</span> Error(<span class="string">'near option must be an array [x, y]'</span>);
    }

    <span class="keyword">if</span> (error) {
      callback &amp;&amp; callback(error);
      reject(error);
      <span class="keyword">return</span>;
    }

    <span class="comment">// send the conditions in the options object</span>
    options.search = conditions;

    _<span class="keyword">this</span>.collection.geoHaystackSearch(options.near[<span class="number">0</span>], options.near[<span class="number">1</span>], options, <span class="keyword">function</span>(err, res) {
      <span class="comment">// have to deal with driver problem. Should be fixed in a soon-ish release</span>
      <span class="comment">// (7/8/2013)</span>
      <span class="keyword">if</span> (err) {
        callback &amp;&amp; callback(err);
        reject(err);
        <span class="keyword">return</span>;
      }

      <span class="keyword">var</span> count = res.results.length;
      <span class="keyword">if</span> (options.lean || count === <span class="number">0</span>) {
        callback &amp;&amp; callback(<span class="literal">null</span>, res.results, res.stats);
        resolve(res.results, res.stats);
        <span class="keyword">return</span>;
      }

      <span class="keyword">var</span> errSeen = <span class="literal">false</span>;

      <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(err)</span> {</span>
        <span class="keyword">if</span> (err &amp;&amp; !errSeen) {
          callback &amp;&amp; callback(err);
          reject(err);
          <span class="keyword">return</span>;
        }

        <span class="keyword">if</span> (!--count &amp;&amp; !errSeen) {
          callback &amp;&amp; callback(<span class="literal">null</span>, res.results, res.stats);
          resolve(res.results, res.stats);
        }
      }

      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; res.results.length; i++) {
        <span class="keyword">var</span> temp = res.results[i];
        res.results[i] = <span class="keyword">new</span> _<span class="keyword">this</span>();
        res.results[i].init(temp, {}, init);
      }
    });
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>an object that specifies the match condition (required)</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>for the geoSearch, some (near, maxDistance) are required</span></li><li><code>[options.lean]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-lean&quot;&gt;&lt;code&gt;Query.lean()&lt;/code&gt;&lt;/a&gt;.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/command/geoSearch/">http://docs.mongodb.org/manual/reference/command/geoSearch/</a></li><li><a href="http://docs.mongodb.org/manual/core/geohaystack/">http://docs.mongodb.org/manual/core/geohaystack/</a></li></ul></div><p>This function does not trigger any middleware</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> options = { near: [<span class="number">10</span>, <span class="number">10</span>], maxDistance: <span class="number">5</span> };
Locations.geoSearch({ type : <span class="string">"house"</span> }, options, <span class="keyword">function</span>(err, res) {
  console.log(res);
});</code></pre>

<h4>Options:</h4>

<ul>
<li><code>near</code> {Array} x,y point to search for</li>
<li><code>maxDistance</code> {Number} the maximum distance from the point near that a result can be</li>
<li><code>limit</code> {Number} The maximum number of results to return</li>
<li><code>lean</code> {Boolean} return the raw object instead of the Mongoose Model</li>
</ul><hr class=""></div><div class="item static public"><h3 id="model_Model.hydrate"><a href="#model_Model.hydrate">Model.hydrate(<code>obj</code>)</a></h3><p>Shortcut for creating a new Document from existing raw data, pre-saved in the DB.<br />The document returned has no paths marked as modified initially.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.hydrate = <span class="keyword">function</span>(obj) {
  <span class="keyword">var</span> model = require(<span class="string">'./queryhelpers'</span>).createModel(<span class="keyword">this</span>, obj);
  model.init(obj);
  <span class="keyword">return</span> model;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#document_Document">Document</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code><span class="comment">// hydrate previous data into a Mongoose document</span>
<span class="keyword">var</span> mongooseCandy = Candy.hydrate({ _id: <span class="string">'54108337212ffb6d459f854c'</span>, type: <span class="string">'jelly bean'</span> });</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.init"><a href="#model_Model.init">Model.init(<code>[callback]</code>)</a></h3><p>Performs any async initialization of this model against MongoDB. Currently,<br />this function is only responsible for building <a href="https://docs.mongodb.com/manual/indexes/">indexes</a>,<br />unless <a href="../../guide.html#autoIndex"><code>autoIndex</code></a> is turned off.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.init = <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(callback)</span> {</span>
  <span class="keyword">this</span>.schema.emit(<span class="string">'init'</span>, <span class="keyword">this</span>);

  <span class="keyword">if</span> (<span class="keyword">this</span>.$init) {
    <span class="keyword">return</span> <span class="keyword">this</span>.$init;
  }

  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">this</span>.$init = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> ((_<span class="keyword">this</span>.schema.options.autoIndex) ||
        (_<span class="keyword">this</span>.schema.options.autoIndex == <span class="literal">null</span> &amp;&amp; _<span class="keyword">this</span>.db.config.autoIndex)) {
      _<span class="keyword">this</span>.ensureIndexes({ _automatic: <span class="literal">true</span>, __noPromise: <span class="literal">true</span> }, <span class="keyword">function</span>(error) {
        <span class="keyword">if</span> (error) {
          callback &amp;&amp; callback(error);
          <span class="keyword">return</span> reject(error);
        }
        callback &amp;&amp; callback(<span class="literal">null</span>, _<span class="keyword">this</span>);
        resolve(_<span class="keyword">this</span>);
      });
    } <span class="keyword">else</span> {
      resolve(_<span class="keyword">this</span>);
    }
  });

  <span class="keyword">return</span> <span class="keyword">this</span>.$init;
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><p>This function is called automatically, so you don't need to call it.<br />This function is also idempotent, so you may call it to get back a promise<br />that will resolve when your indexes are finished building as an alternative<br />to <code>MyModel.on('index')</code></p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> eventSchema = <span class="keyword">new</span> Schema({ thing: { type: <span class="string">'string'</span>, unique: <span class="literal">true</span> }})
<span class="comment">// This calls `Event.init()` implicitly, so you don't need to call</span>
<span class="comment">// `Event.init()` on your own.</span>
<span class="keyword">var</span> Event = mongoose.model(<span class="string">'Event'</span>, eventSchema);

Event.init().then(<span class="keyword">function</span>(Event) {
  <span class="comment">// You can also use `Event.on('index')` if you prefer event emitters</span>
  <span class="comment">// over promises.</span>
  console.log(<span class="string">'Indexes are done building!'</span>);
});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.insertMany"><a href="#model_Model.insertMany">Model.insertMany(<code>doc(s)</code>, <code>[options]</code>, <code>[options.ordered</code>, <code>[options.rawResult</code>, <code>[callback]</code>)</a></h3><p>Shortcut for validating an array of documents and inserting them into<br />MongoDB if they're all valid. This function is faster than <code>.create()</code><br />because it only sends one operation to the server, rather than one for each<br />document.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.insertMany = <span class="keyword">function</span>(arr, options, callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }
  callback = callback || utils.noop;
  options = options || {};
  <span class="keyword">var</span> limit = get(options, <span class="string">'limit'</span>, <span class="number">1000</span>);
  <span class="keyword">var</span> rawResult = get(options, <span class="string">'rawResult'</span>, <span class="literal">false</span>);
  <span class="keyword">var</span> ordered = get(options, <span class="string">'ordered'</span>, <span class="literal">true</span>);

  <span class="keyword">if</span> (!Array.isArray(arr)) {
    arr = [arr];
  }

  <span class="keyword">var</span> toExecute = [];
  <span class="keyword">var</span> validationErrors = [];
  arr.forEach(<span class="keyword">function</span>(doc) {
    toExecute.push(<span class="keyword">function</span>(callback) {
      doc = <span class="keyword">new</span> _<span class="keyword">this</span>(doc);
      doc.validate({ __noPromise: <span class="literal">true</span> }, <span class="keyword">function</span>(error) {
        <span class="keyword">if</span> (error) {
          <span class="comment">// Option `ordered` signals that insert should be continued after reaching</span>
          <span class="comment">// a failing insert. Therefore we delegate "null", meaning the validation</span>
          <span class="comment">// failed. It's up to the next function to filter out all failed models</span>
          <span class="keyword">if</span> (ordered === <span class="literal">false</span>) {
            validationErrors.push(error);
            <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="literal">null</span>);
          }
          <span class="keyword">return</span> callback(error);
        }
        callback(<span class="literal">null</span>, doc);
      });
    });
  });

  parallelLimit(toExecute, limit, <span class="keyword">function</span>(error, docs) {
    <span class="keyword">if</span> (error) {
      callback &amp;&amp; callback(error);
      <span class="keyword">return</span>;
    }
    <span class="comment">// We filter all failed pre-validations by removing nulls</span>
    <span class="keyword">var</span> docAttributes = docs.filter(<span class="keyword">function</span>(doc) {
      <span class="keyword">return</span> doc != <span class="literal">null</span>;
    });
    <span class="comment">// Quickly escape while there aren't any valid docAttributes</span>
    <span class="keyword">if</span> (docAttributes.length &lt; <span class="number">1</span>) {
      callback(<span class="literal">null</span>, []);
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> docObjects = docAttributes.map(<span class="keyword">function</span>(doc) {
      <span class="keyword">if</span> (doc.schema.options.versionKey) {
        doc[doc.schema.options.versionKey] = <span class="number">0</span>;
      }
      <span class="keyword">if</span> (doc.initializeTimestamps) {
        <span class="keyword">return</span> doc.initializeTimestamps().toObject(INSERT_MANY_CONVERT_OPTIONS);
      }
      <span class="keyword">return</span> doc.toObject(INSERT_MANY_CONVERT_OPTIONS);
    });

    _<span class="keyword">this</span>.collection.insertMany(docObjects, options, <span class="keyword">function</span>(error, res) {
      <span class="keyword">if</span> (error) {
        callback &amp;&amp; callback(error);
        <span class="keyword">return</span>;
      }
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; docAttributes.length; ++i) {
        docAttributes[i].isNew = <span class="literal">false</span>;
        docAttributes[i].emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
        docAttributes[i].constructor.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
      }
      <span class="keyword">if</span> (rawResult) {
        <span class="keyword">if</span> (ordered === <span class="literal">false</span>) {
          <span class="comment">// Decorate with mongoose validation errors in case of unordered,</span>
          <span class="comment">// because then still do `insertMany()`</span>
          res.mongoose = {
            validationErrors: validationErrors
          };
        }
        <span class="keyword">return</span> callback(<span class="literal">null</span>, res);
      }
      callback(<span class="literal">null</span>, docAttributes);
    });
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>doc(s)</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#*">*</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>see the &lt;a href=&quot;http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#insertMany&quot;&gt;mongodb driver options&lt;/a&gt;</span></li><li><code>[options.ordered</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>= true] if true, will fail fast on the first error encountered. If false, will insert all the documents it can and report errors later. An &lt;code&gt;insertMany()&lt;/code&gt; with &lt;code&gt;ordered = false&lt;/code&gt; is called an &quot;unordered&quot; &lt;code&gt;insertMany()&lt;/code&gt;.</span></li><li><code>[options.rawResult</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>= false] if false, the returned promise resolves to the documents that passed mongoose document validation. If &lt;code&gt;false&lt;/code&gt;, will return the &lt;a href=&quot;http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~insertWriteOpCallback&quot;&gt;raw result from the MongoDB driver&lt;/a&gt; with a &lt;code&gt;mongoose&lt;/code&gt; property that contains &lt;code&gt;validationErrors&lt;/code&gt; if this is an unordered &lt;code&gt;insertMany&lt;/code&gt;.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><p>Mongoose always validates each document <strong>before</strong> sending <code>insertMany</code><br />to MongoDB. So if one document has a validation error, no documents will<br />be saved, unless you set<br /><a href="https://docs.mongodb.com/manual/reference/method/db.collection.insertMany/#error-handling">the <code>ordered</code> option to false</a>.</p>

<p>This function does <strong>not</strong> trigger save middleware.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>insertMany()</code></li>
</ul>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> arr = [{ name: <span class="string">'Star Wars'</span> }, { name: <span class="string">'The Empire Strikes Back'</span> }];
Movies.insertMany(arr, <span class="keyword">function</span>(error, docs) {});</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.mapReduce"><a href="#model_Model.mapReduce">Model.mapReduce(<code>o</code>, <code>[callback]</code>)</a></h3><p>Executes a mapReduce command.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.mapReduce = <span class="function"><span class="keyword">function</span> <span class="title">mapReduce</span><span class="params">(o, callback)</span> {</span>
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }
  <span class="keyword">var</span> resolveToObject = o.resolveToObject;
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> (!Model.mapReduce.schema) {
      <span class="keyword">var</span> opts = {noId: <span class="literal">true</span>, noVirtualId: <span class="literal">true</span>, strict: <span class="literal">false</span>};
      Model.mapReduce.schema = <span class="keyword">new</span> Schema({}, opts);
    }

    <span class="keyword">if</span> (!o.out) o.out = {inline: <span class="number">1</span>};
    <span class="keyword">if</span> (o.verbose !== <span class="literal">false</span>) o.verbose = <span class="literal">true</span>;

    o.map = String(o.map);
    o.reduce = String(o.reduce);

    <span class="keyword">if</span> (o.query) {
      <span class="keyword">var</span> q = <span class="keyword">new</span> _<span class="keyword">this</span>.Query(o.query);
      q.cast(_<span class="keyword">this</span>);
      o.query = q._conditions;
      q = <span class="literal">undefined</span>;
    }

    _<span class="keyword">this</span>.collection.mapReduce(<span class="literal">null</span>, <span class="literal">null</span>, o, <span class="keyword">function</span>(err, ret, stats) {
      <span class="keyword">if</span> (err) {
        callback &amp;&amp; callback(err);
        reject(err);
        <span class="keyword">return</span>;
      }

      <span class="keyword">if</span> (ret.findOne &amp;&amp; ret.mapReduce) {
        <span class="comment">// returned a collection, convert to Model</span>
        <span class="keyword">var</span> model = Model.compile(
            <span class="string">'_mapreduce_'</span> + ret.collectionName
            , Model.mapReduce.schema
            , ret.collectionName
            , _<span class="keyword">this</span>.db
            , _<span class="keyword">this</span>.base);

        model._mapreduce = <span class="literal">true</span>;

        callback &amp;&amp; callback(<span class="literal">null</span>, model, stats);
        <span class="keyword">return</span> resolveToObject ? resolve({
          model: model,
          stats: stats
        }) : resolve(model, stats);
      }

      callback &amp;&amp; callback(<span class="literal">null</span>, ret, stats);
      <span class="keyword">if</span> (resolveToObject) {
        <span class="keyword">return</span> resolve({ model: ret, stats: stats });
      }
      resolve(ret, stats);
    });
  });
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>o</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>an object specifying map-reduce options</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional callback</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/MapReduce">http://www.mongodb.org/display/DOCS/MapReduce</a></li></ul></div><p><code>o</code> is an object specifying all mapReduce options as well as the map and reduce functions. All options are delegated to the driver implementation. See <a href="http://mongodb.github.io/node-mongodb-native/api-generated/collection.html#mapreduce">node-mongodb-native mapReduce() documentation</a> for more detail about options.</p>

<p>This function does not trigger any middleware.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> o = {};
o.map = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> emit(<span class="keyword">this</span>.name, <span class="number">1</span>) }
o.reduce = <span class="function"><span class="keyword">function</span> <span class="params">(k, vals)</span> {</span> <span class="keyword">return</span> vals.length }
User.mapReduce(o, <span class="function"><span class="keyword">function</span> <span class="params">(err, results)</span> {</span>
  console.log(results)
})</code></pre>

<h4>Other options:</h4>

<ul>
<li><code>query</code> {Object} query filter object.</li>
<li><code>sort</code> {Object} sort input objects using this key</li>
<li><code>limit</code> {Number} max number of documents</li>
<li><code>keeptemp</code> {Boolean, default:false} keep temporary data</li>
<li><code>finalize</code> {Function} finalize function</li>
<li><code>scope</code> {Object} scope variables exposed to map/reduce/finalize during execution</li>
<li><code>jsMode</code> {Boolean, default:false} it is possible to make the execution stay in JS. Provided in MongoDB > 2.0.X</li>
<li><code>verbose</code> {Boolean, default:false} provide statistics on job execution time.</li>
<li><code>readPreference</code> {String}</li>
<li><code>out*</code> {Object, default: {inline:1}} sets the output target for the map reduce job.</li>
</ul>

<h4>* out options:</h4>

<ul>
<li><code>{inline:1}</code> the results are returned in an array</li>
<li><code>{replace: 'collectionName'}</code> add the results to collectionName: the results replace the collection</li>
<li><code>{reduce: 'collectionName'}</code> add the results to collectionName: if dups are detected, uses the reducer / finalize functions</li>
<li><code>{merge: 'collectionName'}</code> add the results to collectionName: if dups exist the new docs overwrite the old</li>
</ul>

<p>If <code>options.out</code> is set to <code>replace</code>, <code>merge</code>, or <code>reduce</code>, a Model instance is returned that can be used for further querying. Queries run against this model are all executed with the <code>lean</code> option; meaning only the js object is returned and no Mongoose magic is applied (getters, setters, etc).</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> o = {};
o.map = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> emit(<span class="keyword">this</span>.name, <span class="number">1</span>) }
o.reduce = <span class="function"><span class="keyword">function</span> <span class="params">(k, vals)</span> {</span> <span class="keyword">return</span> vals.length }
o.out = { replace: <span class="string">'createdCollectionNameForResults'</span> }
o.verbose = <span class="literal">true</span>;

User.mapReduce(o, <span class="function"><span class="keyword">function</span> <span class="params">(err, model, stats)</span> {</span>
  console.log(<span class="string">'map reduce took %d ms'</span>, stats.processtime)
  model.find().where(<span class="string">'value'</span>).gt(<span class="number">10</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>
    console.log(docs);
  });
})

<span class="comment">// `mapReduce()` returns a promise. However, ES6 promises can only</span>
<span class="comment">// resolve to exactly one value,</span>
o.resolveToObject = <span class="literal">true</span>;
<span class="keyword">var</span> promise = User.mapReduce(o);
promise.then(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span> {</span>
  <span class="keyword">var</span> model = res.model;
  <span class="keyword">var</span> stats = res.stats;
  console.log(<span class="string">'map reduce took %d ms'</span>, stats.processtime)
  <span class="keyword">return</span> model.find().where(<span class="string">'value'</span>).gt(<span class="number">10</span>).exec();
}).then(<span class="function"><span class="keyword">function</span> <span class="params">(docs)</span> {</span>
   console.log(docs);
}).then(<span class="literal">null</span>, handleError).end()</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.populate"><a href="#model_Model.populate">Model.populate(<code>docs</code>, <code>options</code>, <code>[callback(err,doc)]</code>)</a></h3><p>Populates document references.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.populate = <span class="keyword">function</span>(docs, paths, callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="comment">// normalized paths</span>
  <span class="keyword">var</span> noPromise = paths &amp;&amp; !!paths.__noPromise;
  paths = utils.populate(paths);

  <span class="comment">// data that should persist across subPopulate calls</span>
  <span class="keyword">var</span> cache = {};

  <span class="keyword">if</span> (noPromise) {
    _populate(<span class="keyword">this</span>, docs, paths, cache, callback);
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> Promise = PromiseProvider.get();
    <span class="keyword">return</span> <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
      _populate(_<span class="keyword">this</span>, docs, paths, cache, <span class="keyword">function</span>(error, docs) {
        <span class="keyword">if</span> (error) {
          callback &amp;&amp; callback(error);
          reject(error);
        } <span class="keyword">else</span> {
          callback &amp;&amp; callback(<span class="literal">null</span>, docs);
          resolve(docs);
        }
      });
    });
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>docs</code><span class="types"> &lt;<a href="#document_Document">Document</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>Either a single document or array of documents to populate.</span></li><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>A hash of key/val (path, options) used for population.</span></li><li><code>[callback(err,doc)]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>Optional callback, executed upon completion. Receives &lt;code&gt;err&lt;/code&gt; and the &lt;code&gt;doc(s)&lt;/code&gt;.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><h4>Available options:</h4>

<ul>
<li>path: space delimited path(s) to populate</li>
<li>select: optional fields to select</li>
<li>match: optional query conditions to match</li>
<li>model: optional name of the model to use for population</li>
<li>options: optional query options like sort, limit, etc</li>
</ul>

<h4>Examples:</h4>

<pre><code><span class="comment">// populates a single object</span>
User.findById(id, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> {</span>
  <span class="keyword">var</span> opts = [
      { path: <span class="string">'company'</span>, match: { x: <span class="number">1</span> }, select: <span class="string">'name'</span> }
    , { path: <span class="string">'notes'</span>, options: { limit: <span class="number">10</span> }, model: <span class="string">'override'</span> }
  ]

  User.populate(user, opts, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> {</span>
    console.log(user);
  });
});

<span class="comment">// populates an array of objects</span>
User.find(match, <span class="function"><span class="keyword">function</span> <span class="params">(err, users)</span> {</span>
  <span class="keyword">var</span> opts = [{ path: <span class="string">'company'</span>, match: { x: <span class="number">1</span> }, select: <span class="string">'name'</span> }]

  <span class="keyword">var</span> promise = User.populate(users, opts);
  promise.then(console.log).end();
})

<span class="comment">// imagine a Weapon model exists with two saved documents:</span>
<span class="comment">//   { _id: 389, name: 'whip' }</span>
<span class="comment">//   { _id: 8921, name: 'boomerang' }</span>
<span class="comment">// and this schema:</span>
<span class="comment">// new Schema({</span>
<span class="comment">//   name: String,</span>
<span class="comment">//   weapon: { type: ObjectId, ref: 'Weapon' }</span>
<span class="comment">// });</span>

<span class="keyword">var</span> user = { name: <span class="string">'Indiana Jones'</span>, weapon: <span class="number">389</span> }
Weapon.populate(user, { path: <span class="string">'weapon'</span>, model: <span class="string">'Weapon'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> {</span>
  console.log(user.weapon.name) <span class="comment">// whip</span>
})

<span class="comment">// populate many plain objects</span>
<span class="keyword">var</span> users = [{ name: <span class="string">'Indiana Jones'</span>, weapon: <span class="number">389</span> }]
users.push({ name: <span class="string">'Batman'</span>, weapon: <span class="number">8921</span> })
Weapon.populate(users, { path: <span class="string">'weapon'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, users)</span> {</span>
  users.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(user)</span> {</span>
    console.log(<span class="string">'%s uses a %s'</span>, users.name, user.weapon.name)
    <span class="comment">// Indiana Jones uses a whip</span>
    <span class="comment">// Batman uses a boomerang</span>
  });
});
<span class="comment">// Note that we didn't need to specify the Weapon model because</span>
<span class="comment">// it is in the schema's ref</span></code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.remove"><a href="#model_Model.remove">Model.remove(<code>conditions</code>, <code>[callback]</code>)</a></h3><p>Removes all documents that match <code>conditions</code> from the collection.<br />To remove just the first document that matches <code>conditions</code>, set the <code>single</code><br />option to true.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.remove = <span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">(conditions, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }

  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection);

  <span class="keyword">if</span> (callback) {
    callback = <span class="keyword">this</span>.$wrapCallback(callback);
  }

  <span class="keyword">return</span> mq.remove(conditions, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h4>Example:</h4>

<pre><code>Character.remove({ name: <span class="string">'Eddard Stark'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>});</code></pre>

<h4>Note:</h4>

<p>This method sends a remove command directly to MongoDB, no Mongoose documents<br />are involved. Because no Mongoose documents are involved, <em>no middleware<br />(hooks) are executed</em>.</p><hr class=""></div><div class="item static public"><h3 id="model_Model.replaceOne"><a href="#model_Model.replaceOne">Model.replaceOne(<code>conditions</code>, <code>doc</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Same as <code>update()</code>, except MongoDB replace the existing document with the<br />given document (no atomic operators like <code>$set</code>).</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.replaceOne = <span class="function"><span class="keyword">function</span> <span class="title">replaceOne</span><span class="params">(conditions, doc, options, callback)</span> {</span>
  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'replaceOne'</span>, conditions, doc, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h2>This function triggers the following middleware</h2>

<ul>
<li><code>replaceOne()</code></li>
</ul><hr class=""></div><div class="item static public"><h3 id="model_Model.translateAliases"><a href="#model_Model.translateAliases">Model.translateAliases(<code>raw</code>)</a></h3><p>Translate any aliases fields/conditions so the final query or document object is pure</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.translateAliases = <span class="function"><span class="keyword">function</span> <span class="title">translateAliases</span><span class="params">(fields)</span> {</span>
  <span class="keyword">var</span> aliases = <span class="keyword">this</span>.schema.aliases;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">'object'</span>) {
    <span class="comment">// Fields is an object (query conditions or document fields)</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> fields) {
      <span class="keyword">if</span> (aliases[key]) {
        fields[aliases[key]] = fields[key];
        <span class="keyword">delete</span> fields[key];
      }
    }

    <span class="keyword">return</span> fields;
  } <span class="keyword">else</span> {
    <span class="comment">// Don't know typeof fields</span>
    <span class="keyword">return</span> fields;
  }
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>raw</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>fields/conditions that may contain aliased keys</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the translated 'pure' fields/conditions</span></li></ul></div><h4>Example:</h4>

<pre><code>Character
  .find(Character.translateAliases({
    <span class="string">'名'</span>: <span class="string">'Eddard Stark'</span> <span class="comment">// Alias for 'name'</span>
  })
  .exec(<span class="keyword">function</span>(err, characters) {})</code></pre>

<h4>Note:</h4>

<p>Only translate arguments of object type anything else is returned raw</p><hr class=""></div><div class="item static public"><h3 id="model_Model.update"><a href="#model_Model.update">Model.update(<code>conditions</code>, <code>doc</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Updates one document in the database without returning it.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(conditions, doc, options, callback)</span> {</span>
  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'update'</span>, conditions, doc, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../guide.html#strict" title="strict">strict</a></li><li><a href="http://docs.mongodb.org/v2.6/reference/command/update/#output" title="response">response</a></li></ul></div><h2>This function triggers the following middleware</h2>

<ul>
<li><code>update()</code></li>
</ul>

<h4>Examples:</h4>

<pre><code>MyModel.update({ age: { $gt: <span class="number">18</span> } }, { oldEnough: <span class="literal">true</span> }, fn);
MyModel.update({ name: <span class="string">'Tobi'</span> }, { ferret: <span class="literal">true</span> }, { multi: <span class="literal">true</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, raw)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  console.log(<span class="string">'The raw response from Mongo was '</span>, raw);
});</code></pre>

<h4>Valid options:</h4>

<ul>
<li><code>safe</code> (boolean) safe mode (defaults to value set in schema (true))</li>
<li><code>upsert</code> (boolean) whether to create the doc if it doesn't match (false)</li>
<li><code>multi</code> (boolean) whether multiple documents should be updated (false)</li>
<li><code>runValidators</code>: if true, runs <a href="../../validation.html#update-validators">update validators</a> on this command. Update validators validate the update operation against the model's schema.</li>
<li><code>setDefaultsOnInsert</code>: if this and <code>upsert</code> are true, mongoose will apply the <a href="../../defaults.html">defaults</a> specified in the model's schema if a new document is created. This option only works on MongoDB >= 2.4 because it relies on <a href="https://docs.mongodb.org/v2.4/reference/operator/update/setOnInsert/">MongoDB's <code>$setOnInsert</code> operator</a>.</li>
<li><code>strict</code> (boolean) overrides the <code>strict</code> option for this update</li>
<li><code>overwrite</code> (boolean) disables update-only mode, allowing you to overwrite the doc (false)</li>
</ul>

<p>All <code>update</code> values are cast to their appropriate SchemaTypes before being sent.</p>

<p>The <code>callback</code> function receives <code>(err, rawResponse)</code>.</p>

<ul>
<li><code>err</code> is the error if any occurred</li>
<li><code>rawResponse</code> is the full response from Mongo</li>
</ul>

<h4>Note:</h4>

<p>All top level keys which are not <code>atomic</code> operation names are treated as set operations:</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> query = { name: <span class="string">'borne'</span> };
Model.update(query, { name: <span class="string">'jason bourne'</span> }, options, callback)

<span class="comment">// is sent as</span>
Model.update(query, { $set: { name: <span class="string">'jason bourne'</span> }}, options, callback)
<span class="comment">// if overwrite option is false. If overwrite is true, sent without the $set wrapper.</span></code></pre>

<p>This helps prevent accidentally overwriting all documents in your collection with <code>{ name: 'jason bourne' }</code>.</p>

<h4>Note:</h4>

<p>Be careful to not use an existing model instance for the update clause (this won't work and can cause weird behavior like infinite loops). Also, ensure that the update clause does not have an _id property, which causes Mongo to return a "Mod on _id not allowed" error.</p>

<h4>Note:</h4>

<p>To update documents without waiting for a response from MongoDB, do not pass a <code>callback</code>, then call <code>exec</code> on the returned <a href="#query-js">Query</a>:</p>

<pre><code>Comment.update({ _id: id }, { $set: { text: <span class="string">'changed'</span> }}).exec();</code></pre>

<h4>Note:</h4>

<p>Although values are casted to their appropriate types when using update, the following are <em>not</em> applied:</p>

<ul>
<li>defaults</li>
<li>setters</li>
<li>validators</li>
<li>middleware</li>
</ul>

<p>If you need those features, use the traditional approach of first retrieving the document.</p>

<pre><code>Model.findOne({ name: <span class="string">'borne'</span> }, <span class="function"><span class="keyword">function</span> <span class="params">(err, doc)</span> {</span>
  <span class="keyword">if</span> (err) ..
  doc.name = <span class="string">'jason bourne'</span>;
  doc.save(callback);
})</code></pre><hr class=""></div><div class="item static public"><h3 id="model_Model.updateMany"><a href="#model_Model.updateMany">Model.updateMany(<code>conditions</code>, <code>doc</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Same as <code>update()</code>, except MongoDB will update <em>all</em> documents that match<br /><code>criteria</code> (as opposed to just the first one) regardless of the value of<br />the <code>multi</code> option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.updateMany = <span class="function"><span class="keyword">function</span> <span class="title">updateMany</span><span class="params">(conditions, doc, options, callback)</span> {</span>
  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'updateMany'</span>, conditions, doc, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><p><strong>Note</strong> updateMany will <em>not</em> fire update middleware. Use <code>pre('updateMany')</code><br />and <code>post('updateMany')</code> instead.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>updateMany()</code></li>
</ul><hr class=""></div><div class="item static public"><h3 id="model_Model.updateOne"><a href="#model_Model.updateOne">Model.updateOne(<code>conditions</code>, <code>doc</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Same as <code>update()</code>, except MongoDB will update <em>only</em> the first document that<br />matches <code>criteria</code> regardless of the value of the <code>multi</code> option.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.updateOne = <span class="function"><span class="keyword">function</span> <span class="title">updateOne</span><span class="params">(conditions, doc, options, callback)</span> {</span>
  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'updateOne'</span>, conditions, doc, options, callback);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>conditions</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>doc</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional see &lt;a href=&quot;http://mongoosejs.com/docs/api.html#query_Query-setOptions&quot;&gt;&lt;code&gt;Query.prototype.setOptions()&lt;/code&gt;&lt;/a&gt;</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><h2>This function triggers the following middleware</h2>

<ul>
<li><code>updateOne()</code></li>
</ul><hr class=""></div><div class="item static public"><h3 id="model_Model.where"><a href="#model_Model.where">Model.where(<code>path</code>, <code>[val]</code>)</a></h3><p>Creates a Query, applies the passed conditions, and returns the Query.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.where = <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">(path, val)</span> {</span>
  <span class="keyword">void</span> val; <span class="comment">// eslint</span>
  <span class="comment">// get the mongodb collection object</span>
  <span class="keyword">var</span> mq = <span class="keyword">new</span> <span class="keyword">this</span>.Query({}, {}, <span class="keyword">this</span>, <span class="keyword">this</span>.collection).find({});
  <span class="keyword">return</span> mq.where.apply(mq, arguments);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional value</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span></span></li></ul></div><p>For example, instead of writing:</p>

<pre><code>User.find({age: {$gte: <span class="number">21</span>, $lte: <span class="number">65</span>}}, callback);</code></pre>

<p>we can instead write:</p>

<pre><code>User.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>).exec(callback);</code></pre>

<p>Since the Query class also supports <code>where</code> you can continue chaining</p>

<pre><code>User
.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>)
.where(<span class="string">'name'</span>, <span class="regexp">/^b/i</span>)
... etc</code></pre><hr class=""></div><div class="item property public"><h3 id="model_Model-%2524where"><a href="#model_Model-%2524where">Model#<span>$where</span></a></h3><p>Additional properties to attach to the query when calling <code>save()</code> and<br /><code>isNew</code> is false.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.$where;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-base"><a href="#model_Model-base">Model#<span>base</span></a></h3><p>Base Mongoose instance the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.base;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-baseModelName"><a href="#model_Model-baseModelName">Model#<span>baseModelName</span></a></h3><p>If this is a discriminator model, <code>baseModelName</code> is the name of<br />the base model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.baseModelName;

Model.prototype.$__handleSave = <span class="keyword">function</span>(options, callback) {
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> i;
  <span class="keyword">var</span> keys;
  <span class="keyword">var</span> len;
  <span class="keyword">if</span> (!options.safe &amp;&amp; <span class="keyword">this</span>.schema.options.safe) {
    options.safe = <span class="keyword">this</span>.schema.options.safe;
  }
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options.safe === <span class="string">'boolean'</span>) {
    options.safe = <span class="literal">null</span>;
  }
  <span class="keyword">var</span> safe = options.safe ? utils.clone(options.safe, { retainKeyOrder: <span class="literal">true</span> }) : options.safe;

  <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
    <span class="comment">// send entire doc</span>
    <span class="keyword">var</span> toObjectOptions = {};

    toObjectOptions.retainKeyOrder = <span class="keyword">this</span>.schema.options.retainKeyOrder;
    toObjectOptions.depopulate = <span class="number">1</span>;
    toObjectOptions._skipDepopulateTopLevel = <span class="literal">true</span>;
    toObjectOptions.transform = <span class="literal">false</span>;
    toObjectOptions.flattenDecimals = <span class="literal">false</span>;

    <span class="keyword">var</span> obj = <span class="keyword">this</span>.toObject(toObjectOptions);

    <span class="keyword">if</span> ((obj || {})._id === <span class="keyword">void</span> <span class="number">0</span>) {
      <span class="comment">// documents must have an _id else mongoose won't know</span>
      <span class="comment">// what to update later if more changes are made. the user</span>
      <span class="comment">// wouldn't know what _id was generated by mongodb either</span>
      <span class="comment">// nor would the ObjectId generated my mongodb necessarily</span>
      <span class="comment">// match the schema definition.</span>
      setTimeout(<span class="keyword">function</span>() {
        callback(<span class="keyword">new</span> Error(<span class="string">'document must have an _id before saving'</span>));
      }, <span class="number">0</span>);
      <span class="keyword">return</span>;
    }

    <span class="keyword">this</span>.$__version(<span class="literal">true</span>, obj);
    <span class="keyword">this</span>.collection.insert(obj, safe, <span class="keyword">function</span>(err, ret) {
      <span class="keyword">if</span> (err) {
        _<span class="keyword">this</span>.isNew = <span class="literal">true</span>;
        _<span class="keyword">this</span>.emit(<span class="string">'isNew'</span>, <span class="literal">true</span>);
        _<span class="keyword">this</span>.constructor.emit(<span class="string">'isNew'</span>, <span class="literal">true</span>);

        callback(err);
        <span class="keyword">return</span>;
      }

      callback(<span class="literal">null</span>, ret);
    });
    <span class="keyword">this</span>.$__reset();
    <span class="keyword">this</span>.isNew = <span class="literal">false</span>;
    <span class="keyword">this</span>.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
    <span class="keyword">this</span>.constructor.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
    <span class="comment">// Make it possible to retry the insert</span>
    <span class="keyword">this</span>.$__.inserting = <span class="literal">true</span>;
  } <span class="keyword">else</span> {
    <span class="comment">// Make sure we don't treat it as a new object on error,</span>
    <span class="comment">// since it already exists</span>
    <span class="keyword">this</span>.$__.inserting = <span class="literal">false</span>;

    <span class="keyword">var</span> delta = <span class="keyword">this</span>.$__delta();

    <span class="keyword">if</span> (delta) {
      <span class="keyword">if</span> (delta <span class="keyword">instanceof</span> Error) {
        callback(delta);
        <span class="keyword">return</span>;
      }

      <span class="keyword">var</span> where = <span class="keyword">this</span>.$__where(delta[<span class="number">0</span>]);
      <span class="keyword">if</span> (where <span class="keyword">instanceof</span> Error) {
        callback(where);
        <span class="keyword">return</span>;
      }

      <span class="keyword">if</span> (<span class="keyword">this</span>.$where) {
        keys = Object.keys(<span class="keyword">this</span>.$where);
        len = keys.length;
        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) {
          where[keys[i]] = <span class="keyword">this</span>.$where[keys[i]];
        }
      }

      <span class="keyword">this</span>.collection.update(where, delta[<span class="number">1</span>], safe, <span class="keyword">function</span>(err, ret) {
        <span class="keyword">if</span> (err) {
          callback(err);
          <span class="keyword">return</span>;
        }
        ret.$where = where;
        callback(<span class="literal">null</span>, ret);
      });
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.$__reset();
      callback();
      <span class="keyword">return</span>;
    }

    <span class="keyword">this</span>.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
    <span class="keyword">this</span>.constructor.emit(<span class="string">'isNew'</span>, <span class="literal">false</span>);
  }
};</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-collection"><a href="#model_Model-collection">Model#<span>collection</span></a></h3><p>Collection the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.collection;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-db"><a href="#model_Model-db">Model#<span>db</span></a></h3><p>Connection the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.db;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-discriminators"><a href="#model_Model-discriminators">Model#<span>discriminators</span></a></h3><p>Registered discriminators for this model.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.discriminators;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-modelName"><a href="#model_Model-modelName">Model#<span>modelName</span></a></h3><p>The name of the model</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.prototype.modelName;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="model_Model-schema"><a href="#model_Model-schema">Model#<span>schema</span></a></h3><p>Schema the model uses.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Model.schema;</code></pre></div><hr class=""></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/query.js" id="query-js">query.js</a><div class="item method private"><h3 id="query_Query-_applyPaths"><a href="#query_Query-_applyPaths">Query#_applyPaths()</a></h3><p>Applies schematype selected options to this query.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._applyPaths = <span class="function"><span class="keyword">function</span> <span class="title">applyPaths</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>._fields = <span class="keyword">this</span>._fields || {};
  helpers.applyPaths(<span class="keyword">this</span>._fields, <span class="keyword">this</span>.model.schema);
  selectPopulatedFields(<span class="keyword">this</span>);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="query_Query-_castFields"><a href="#query_Query-_castFields">Query#_castFields(<code>fields</code>)</a></h3><p>Casts selected field arguments for field selection with mongo 2.2</p><div class="params"><h4>Parameters:</h4><ul><li><code>fields</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/Automattic/mongoose/issues/1091">https://github.com/Automattic/mongoose/issues/1091</a></li><li><a href="http://docs.mongodb.org/manual/reference/projection/elemMatch/">http://docs.mongodb.org/manual/reference/projection/elemMatch/</a></li></ul></div><div class="description"><pre><code>query.select({ ids: { $elemMatch: { $<span class="keyword">in</span>: [hexString] }})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._castFields = <span class="function"><span class="keyword">function</span> <span class="title">_castFields</span><span class="params">(fields)</span> {</span>
  <span class="keyword">var</span> selected,
      elemMatchKeys,
      keys,
      key,
      out,
      i;

  <span class="keyword">if</span> (fields) {
    keys = Object.keys(fields);
    elemMatchKeys = [];
    i = keys.length;

    <span class="comment">// collect $elemMatch args</span>
    <span class="keyword">while</span> (i--) {
      key = keys[i];
      <span class="keyword">if</span> (fields[key].$elemMatch) {
        selected || (selected = {});
        selected[key] = fields[key];
        elemMatchKeys.push(key);
      }
    }
  }

  <span class="keyword">if</span> (selected) {
    <span class="comment">// they passed $elemMatch, cast em</span>
    <span class="keyword">try</span> {
      out = <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model, selected);
    } <span class="keyword">catch</span> (err) {
      <span class="keyword">return</span> err;
    }

    <span class="comment">// apply the casted field args</span>
    i = elemMatchKeys.length;
    <span class="keyword">while</span> (i--) {
      key = elemMatchKeys[i];
      fields[key] = out[key];
    }
  }

  <span class="keyword">return</span> fields;
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="query_Query-_count"><a href="#query_Query-_count">Query#_count(<code>[callback]</code>)</a></h3><p>Thunk around count()</p><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.count/" title="count">count</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._count = <span class="keyword">function</span>(callback) {
  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">this</span>.error(err);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.error()) {
    <span class="keyword">return</span> callback(<span class="keyword">this</span>.error());
  }

  <span class="keyword">var</span> conds = <span class="keyword">this</span>._conditions;
  <span class="keyword">var</span> options = <span class="keyword">this</span>._optionsForExec();

  <span class="keyword">this</span>._collection.count(conds, options, utils.tick(callback));
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="query_Query-_find"><a href="#query_Query-_find">Query#_find(<code>[callback]</code>)</a></h3><p>Thunk around find()</p><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._find = <span class="keyword">function</span>(callback) {
  <span class="keyword">this</span>._castConditions();

  <span class="keyword">if</span> (<span class="keyword">this</span>.error() != <span class="literal">null</span>) {
    callback(<span class="keyword">this</span>.error());
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">this</span>._applyPaths();
  <span class="keyword">this</span>._fields = <span class="keyword">this</span>._castFields(<span class="keyword">this</span>._fields);

  <span class="keyword">var</span> fields = <span class="keyword">this</span>._fieldsForExec();
  <span class="keyword">var</span> mongooseOptions = <span class="keyword">this</span>._mongooseOptions;
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  <span class="keyword">var</span> userProvidedFields = _<span class="keyword">this</span>._userProvidedFields || {};

  <span class="keyword">var</span> cb = <span class="keyword">function</span>(err, docs) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> callback(err);
    }

    <span class="keyword">if</span> (docs.length === <span class="number">0</span>) {
      <span class="keyword">return</span> callback(<span class="literal">null</span>, docs);
    }

    <span class="keyword">if</span> (!mongooseOptions.populate) {
      <span class="keyword">return</span> !!mongooseOptions.lean === <span class="literal">true</span>
          ? callback(<span class="literal">null</span>, docs)
          : completeMany(_<span class="keyword">this</span>.model, docs, fields, userProvidedFields, <span class="literal">null</span>, callback);
    }

    <span class="keyword">var</span> pop = helpers.preparePopulationOptionsMQ(_<span class="keyword">this</span>, mongooseOptions);
    pop.__noPromise = <span class="literal">true</span>;
    _<span class="keyword">this</span>.model.populate(docs, pop, <span class="keyword">function</span>(err, docs) {
      <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);
      <span class="keyword">return</span> !!mongooseOptions.lean === <span class="literal">true</span>
          ? callback(<span class="literal">null</span>, docs)
          : completeMany(_<span class="keyword">this</span>.model, docs, fields, userProvidedFields, pop, callback);
    });
  };

  <span class="keyword">var</span> options = <span class="keyword">this</span>._optionsForExec();
  options.fields = <span class="keyword">this</span>._fieldsForExec();
  <span class="keyword">var</span> filter = <span class="keyword">this</span>._conditions;
  <span class="keyword">return</span> <span class="keyword">this</span>._collection.find(filter, options, cb);
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="query_Query-_findOne"><a href="#query_Query-_findOne">Query#_findOne(<code>[callback]</code>)</a></h3><p>Thunk around findOne()</p><div class="params"><h4>Parameters:</h4><ul><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.findOne/" title="findOne">findOne</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._findOne = <span class="keyword">function</span>(callback) {
  <span class="keyword">this</span>._castConditions();

  <span class="keyword">if</span> (<span class="keyword">this</span>.error()) {
    <span class="keyword">return</span> callback(<span class="keyword">this</span>.error());
  }

  <span class="keyword">this</span>._applyPaths();
  <span class="keyword">this</span>._fields = <span class="keyword">this</span>._castFields(<span class="keyword">this</span>._fields);

  <span class="keyword">var</span> options = <span class="keyword">this</span>._mongooseOptions;
  <span class="keyword">var</span> projection = <span class="keyword">this</span>._fieldsForExec();
  <span class="keyword">var</span> userProvidedFields = <span class="keyword">this</span>._userProvidedFields || {};
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="comment">// don't pass in the conditions because we already merged them in</span>
  Query.base.findOne.call(_<span class="keyword">this</span>, {}, <span class="keyword">function</span>(err, doc) {
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> callback(err);
    }
    <span class="keyword">if</span> (!doc) {
      <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="literal">null</span>);
    }

    <span class="keyword">if</span> (!options.populate) {
      <span class="keyword">return</span> !!options.lean === <span class="literal">true</span>
          ? callback(<span class="literal">null</span>, doc)
          : completeOne(_<span class="keyword">this</span>.model, doc, <span class="literal">null</span>, {}, projection, userProvidedFields, <span class="literal">null</span>, callback);
    }

    <span class="keyword">var</span> pop = helpers.preparePopulationOptionsMQ(_<span class="keyword">this</span>, options);
    pop.__noPromise = <span class="literal">true</span>;
    _<span class="keyword">this</span>.model.populate(doc, pop, <span class="keyword">function</span>(err, doc) {
      <span class="keyword">if</span> (err) {
        <span class="keyword">return</span> callback(err);
      }
      <span class="keyword">return</span> !!options.lean === <span class="literal">true</span>
          ? callback(<span class="literal">null</span>, doc)
          : completeOne(_<span class="keyword">this</span>.model, doc, <span class="literal">null</span>, {}, projection, userProvidedFields, pop, callback);
    });
  });
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="query_Query-_optionsForExec"><a href="#query_Query-_optionsForExec">Query#_optionsForExec(<code>model</code>)</a></h3><p>Returns default options for this query.</p><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#model_Model">Model</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype._optionsForExec = <span class="keyword">function</span>(model) {
  <span class="keyword">var</span> options = Query.base._optionsForExec.call(<span class="keyword">this</span>);

  <span class="keyword">delete</span> options.populate;
  <span class="keyword">delete</span> options.retainKeyOrder;
  model = model || <span class="keyword">this</span>.model;

  <span class="keyword">if</span> (!model) {
    <span class="keyword">return</span> options;
  }

  <span class="keyword">if</span> (!(<span class="string">'safe'</span> <span class="keyword">in</span> options) &amp;&amp; model.schema.options.safe) {
    options.safe = model.schema.options.safe;
  }

  <span class="keyword">if</span> (!(<span class="string">'readPreference'</span> <span class="keyword">in</span> options) &amp;&amp; model.schema.options.read) {
    options.readPreference = model.schema.options.read;
  }

  <span class="keyword">if</span> (options.upsert !== <span class="keyword">void</span> <span class="number">0</span>) {
    options.upsert = !!options.upsert;
  }

  <span class="keyword">return</span> options;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="query_Query-%24where"><a href="#query_Query-%24where">Query#$where(<code>js</code>)</a></h3><p>Specifies a javascript function or expression to pass to MongoDBs query system.</p><div class="params"><h4>Parameters:</h4><ul><li><code>js</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>javascript string or function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/where/" title="$where">$where</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.$where(<span class="string">'this.comments.length === 10 || this.name.length === 5'</span>)

<span class="comment">// or</span>

query.$where(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.comments.length === <span class="number">10</span> || <span class="keyword">this</span>.name.length === <span class="number">5</span>;
})</code></pre>

<h4>NOTE:</h4>

<p>Only use <code>$where</code> when you have a condition that cannot be met using other MongoDB operators like <code>$lt</code>.<br /><strong>Be sure to read about all of <a href="http://docs.mongodb.org/manual/reference/operator/where/">its caveats</a> before using.</strong></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-all"><a href="#query_Query-all">Query#all(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies an $all query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/all/" title="$all">$all</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-and"><a href="#query_Query-and">Query#and(<code>array</code>)</a></h3><p>Specifies arguments for a <code>$and</code> condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>array</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>array of conditions</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/and/" title="$and">$and</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.and([{ color: <span class="string">'green'</span> }, { status: <span class="string">'ok'</span> }])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-batchSize"><a href="#query_Query-batchSize">Query#batchSize(<code>val</code>)</a></h3><p>Specifies the batchSize option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/cursor.batchSize/" title="batchSize">batchSize</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.batchSize(<span class="number">100</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-box"><a href="#query_Query-box">Query#box(<code>val</code>, <code>Upper</code>)</a></h3><p>Specifies a $box condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>Upper</code><span class="types"> &lt;<a href="#[Array]">[Array]</a>&gt; </span><span>Right Coords</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/box/" title="$box">$box</a></li><li><a href="#query_Query-within" title="within() Query#within">within() Query#within</a></li><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> lowerLeft = [<span class="number">40.73083</span>, -<span class="number">73.99756</span>]
<span class="keyword">var</span> upperRight= [<span class="number">40.741404</span>,  -<span class="number">73.988135</span>]

query.where(<span class="string">'loc'</span>).within().box(lowerLeft, upperRight)
query.box({ ll : lowerLeft, ur : upperRight })</code></pre></div><hr class=""></div><div class="item method private"><h3 id="query_Query-canMerge"><a href="#query_Query-canMerge">Query#canMerge(<code>conds</code>)</a></h3><p>Determines if <code>conds</code> can be merged using <code>mquery().merge()</code></p><div class="params"><h4>Parameters:</h4><ul><li><code>conds</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class="private"></div><div class="item method public"><h3 id="query_Query-cast"><a href="#query_Query-cast">Query#cast(<code>model</code>, <code>[obj]</code>)</a></h3><p>Casts this query to the schema of <code>model</code></p><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="#model_Model">Model</a>&gt; </span><span></span></li><li><code>[obj]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Note</h4>

<p>If <code>obj</code> is present, it is cast instead of this query.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.cast = <span class="keyword">function</span>(model, obj) {
  obj || (obj = <span class="keyword">this</span>._conditions);

  <span class="keyword">try</span> {
    <span class="keyword">return</span> cast(model.schema, obj, {
      upsert: <span class="keyword">this</span>.options &amp;&amp; <span class="keyword">this</span>.options.upsert,
      strict: (<span class="keyword">this</span>.options &amp;&amp; <span class="string">'strict'</span> <span class="keyword">in</span> <span class="keyword">this</span>.options) ?
        <span class="keyword">this</span>.options.strict :
        (model.schema.options &amp;&amp; model.schema.options.strict),
      strictQuery: (<span class="keyword">this</span>.options &amp;&amp; <span class="keyword">this</span>.options.strictQuery) ||
        (model.schema.options &amp;&amp; model.schema.options.strictQuery)
    }, <span class="keyword">this</span>);
  } <span class="keyword">catch</span> (err) {
    <span class="comment">// CastError, assign model</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> err.setModel === <span class="string">'function'</span>) {
      err.setModel(model);
    }
    <span class="keyword">throw</span> err;
  }
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-catch"><a href="#query_Query-catch">Query#catch(<code>[reject]</code>)</a></h3><p>Executes the query returning a <code>Promise</code> which will be<br />resolved with either the doc(s) or rejected with the error.<br />Like <code>.then()</code>, but only takes a rejection handler.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[reject]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.<span class="keyword">catch</span> = <span class="keyword">function</span>(reject) {
  <span class="keyword">return</span> <span class="keyword">this</span>.exec().then(<span class="literal">null</span>, reject);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-center"><a href="#query_Query-center">Query#center()</a></h3><p><em>DEPRECATED</em> Alias for <a href="#query_Query-circle">circle</a></p><div class="description"><p><strong>Deprecated.</strong> Use <a href="#query_Query-circle">circle</a> instead.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-centerSphere"><a href="#query_Query-centerSphere">Query#centerSphere(<code>[path]</code>, <code>val</code>)</a></h3><p><em>DEPRECATED</em> Specifies a $centerSphere condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/centerSphere/" title="$centerSphere">$centerSphere</a></li></ul></div><div class="description"><p><strong>Deprecated.</strong> Use <a href="#query_Query-circle">circle</a> instead.</p>

<h4>Example</h4>

<pre><code><span class="keyword">var</span> area = { center: [<span class="number">50</span>, <span class="number">50</span>], radius: <span class="number">10</span> };
query.where(<span class="string">'loc'</span>).within().centerSphere(area);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.centerSphere = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (arguments[<span class="number">0</span>] &amp;&amp; arguments[<span class="number">0</span>].constructor.name === <span class="string">'Object'</span>) {
    arguments[<span class="number">0</span>].spherical = <span class="literal">true</span>;
  }

  <span class="keyword">if</span> (arguments[<span class="number">1</span>] &amp;&amp; arguments[<span class="number">1</span>].constructor.name === <span class="string">'Object'</span>) {
    arguments[<span class="number">1</span>].spherical = <span class="literal">true</span>;
  }

  Query.base.circle.apply(<span class="keyword">this</span>, arguments);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-circle"><a href="#query_Query-circle">Query#circle(<code>[path]</code>, <code>area</code>)</a></h3><p>Specifies a $center or $centerSphere condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>area</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/center/" title="$center">$center</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/centerSphere/" title="$centerSphere">$centerSphere</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/geoWithin/" title="$geoWithin">$geoWithin</a></li><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> area = { center: [<span class="number">50</span>, <span class="number">50</span>], radius: <span class="number">10</span>, unique: <span class="literal">true</span> }
query.where(<span class="string">'loc'</span>).within().circle(area)
<span class="comment">// alternatively</span>
query.circle(<span class="string">'loc'</span>, area);

<span class="comment">// spherical calculations</span>
<span class="keyword">var</span> area = { center: [<span class="number">50</span>, <span class="number">50</span>], radius: <span class="number">10</span>, unique: <span class="literal">true</span>, spherical: <span class="literal">true</span> }
query.where(<span class="string">'loc'</span>).within().circle(area)
<span class="comment">// alternatively</span>
query.circle(<span class="string">'loc'</span>, area);</code></pre>

<p>New in 3.7.0</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-collation"><a href="#query_Query-collation">Query#collation(<code>value</code>)</a></h3><p>Adds a collation to this op (MongoDB 3.4 and up)</p><div class="params"><h4>Parameters:</h4><ul><li><code>value</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="docs%20https_/docs.mongodb.com/manual/reference/method/cursor.collation/index.html#cursor.collation" title="MongoDB">MongoDB</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.collation = <span class="keyword">function</span>(value) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.options == <span class="literal">null</span>) {
    <span class="keyword">this</span>.options = {};
  }
  <span class="keyword">this</span>.options.collation = value;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-comment"><a href="#query_Query-comment">Query#comment(<code>val</code>)</a></h3><p>Specifies the <code>comment</code> option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/comment/" title="comment">comment</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.comment(<span class="string">'login query'</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-count"><a href="#query_Query-count">Query#count(<code>[criteria]</code>, <code>[callback]</code>)</a></h3><p>Specifying this query as a <code>count</code> query.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, count)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.count/" title="count">count</a></li></ul></div><div class="description"><p>Passing a <code>callback</code> executes the query.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>count()</code></li>
</ul>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> countQuery = model.where({ <span class="string">'color'</span>: <span class="string">'black'</span> }).count();

query.count({ color: <span class="string">'black'</span> }).count(callback)

query.count({ color: <span class="string">'black'</span> }, callback)

query.where(<span class="string">'color'</span>, <span class="string">'black'</span>).count(<span class="function"><span class="keyword">function</span> <span class="params">(err, count)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  console.log(<span class="string">'there are %d kittens'</span>, count);
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.count = <span class="keyword">function</span>(conditions, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
  }

  <span class="keyword">if</span> (mquery.canMerge(conditions)) {
    <span class="keyword">this</span>.merge(conditions);
  }

  <span class="keyword">this</span>.op = <span class="string">'count'</span>;
  <span class="keyword">if</span> (!callback) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">this</span>._count(callback);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-cursor"><a href="#query_Query-cursor">Query#cursor(<code>[options]</code>)</a></h3><p>Returns a wrapper around a <a href="http://mongodb.github.io/node-mongodb-native/2.1/api/Cursor.html">mongodb driver cursor</a>.<br />A QueryCursor exposes a <a href="https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/">Streams3</a>-compatible<br />interface, as well as a <code>.next()</code> function.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#QueryCursor">QueryCursor</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="QueryCursor.html" title="QueryCursor">QueryCursor</a></li></ul></div><div class="description"><p>The <code>.cursor()</code> function triggers pre find hooks, but <strong>not</strong> post find hooks.</p>

<h4>Example</h4>

<pre><code><span class="comment">// There are 2 ways to use a cursor. First, as a stream:</span>
Thing.
  find({ name: <span class="regexp">/^hello/</span> }).
  cursor().
  on(<span class="string">'data'</span>, <span class="keyword">function</span>(doc) { console.log(doc); }).
  on(<span class="string">'end'</span>, <span class="keyword">function</span>() { console.log(<span class="string">'Done!'</span>); });

<span class="comment">// Or you can use `.next()` to manually get the next doc in the stream.</span>
<span class="comment">// `.next()` returns a promise, so you can use promises or callbacks.</span>
<span class="keyword">var</span> cursor = Thing.find({ name: <span class="regexp">/^hello/</span> }).cursor();
cursor.next(<span class="keyword">function</span>(error, doc) {
  console.log(doc);
});

<span class="comment">// Because `.next()` returns a promise, you can use co</span>
<span class="comment">// to easily iterate through all documents without loading them</span>
<span class="comment">// all into memory.</span>
co(<span class="keyword">function</span>*() {
  const cursor = Thing.find({ name: <span class="regexp">/^hello/</span> }).cursor();
  <span class="keyword">for</span> (let doc = yield cursor.next(); doc != <span class="literal">null</span>; doc = yield cursor.next()) {
    console.log(doc);
  }
});</code></pre>

<h4>Valid options</h4>

<ul>
<li><code>transform</code>: optional function which accepts a mongoose document. The return value of the function will be emitted on <code>data</code> and returned by <code>.next()</code>.</li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.cursor = <span class="function"><span class="keyword">function</span> <span class="title">cursor</span><span class="params">(opts)</span> {</span>
  <span class="keyword">this</span>._applyPaths();
  <span class="keyword">this</span>._fields = <span class="keyword">this</span>._castFields(<span class="keyword">this</span>._fields);
  <span class="keyword">this</span>.setOptions({ fields: <span class="keyword">this</span>._fieldsForExec() });
  <span class="keyword">if</span> (opts) {
    <span class="keyword">this</span>.setOptions(opts);
  }

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">return</span> (<span class="keyword">new</span> QueryCursor(<span class="keyword">this</span>, <span class="keyword">this</span>.options))._markError(err);
  }

  <span class="keyword">return</span> <span class="keyword">new</span> QueryCursor(<span class="keyword">this</span>, <span class="keyword">this</span>.options);
};

<span class="comment">// the rest of these are basically to support older Mongoose syntax with mquery</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-deleteMany"><a href="#query_Query-deleteMany">Query#deleteMany(<code>[filter]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as a <code>deleteMany()</code> operation. Works like<br />remove, except it deletes <em>every</em> document that matches <code>criteria</code> in the<br />collection, regardless of the value of <code>single</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[filter]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#query-js">Query</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.remove/" title="remove">remove</a></li></ul></div><div class="description"><p>This function does not trigger any middleware</p>

<h4>Example</h4>

<pre><code>Character.deleteMany({ name: <span class="regexp">/Stark/</span>, age: { $gte: <span class="number">18</span> } }, callback)
Character.deleteMany({ name: <span class="regexp">/Stark/</span>, age: { $gte: <span class="number">18</span> } }).then(next)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.deleteMany = <span class="keyword">function</span>(filter, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> filter === <span class="string">'function'</span>) {
    callback = filter;
    filter = <span class="literal">null</span>;
  }

  filter = utils.toObject(filter, { retainKeyOrder: <span class="literal">true</span> });

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model, filter);
    <span class="keyword">this</span>.merge(filter);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">this</span>.error(err);
  }

  prepareDiscriminatorCriteria(<span class="keyword">this</span>);

  <span class="keyword">if</span> (!callback) {
    <span class="keyword">return</span> Query.base.deleteMany.call(<span class="keyword">this</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._deleteMany.call(<span class="keyword">this</span>, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-deleteOne"><a href="#query_Query-deleteOne">Query#deleteOne(<code>[filter]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as a <code>deleteOne()</code> operation. Works like<br />remove, except it deletes at most one document regardless of the <code>single</code><br />option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[filter]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#query-js">Query</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.remove/" title="remove">remove</a></li></ul></div><div class="description"><p>This function does not trigger any middleware.</p>

<h4>Example</h4>

<pre><code>Character.deleteOne({ name: <span class="string">'Eddard Stark'</span> }, callback)
Character.deleteOne({ name: <span class="string">'Eddard Stark'</span> }).then(next)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.deleteOne = <span class="keyword">function</span>(filter, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> filter === <span class="string">'function'</span>) {
    callback = filter;
    filter = <span class="literal">null</span>;
  }

  filter = utils.toObject(filter, { retainKeyOrder: <span class="literal">true</span> });

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model, filter);
    <span class="keyword">this</span>.merge(filter);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">this</span>.error(err);
  }

  prepareDiscriminatorCriteria(<span class="keyword">this</span>);

  <span class="keyword">if</span> (!callback) {
    <span class="keyword">return</span> Query.base.deleteOne.call(<span class="keyword">this</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._deleteOne.call(<span class="keyword">this</span>, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-distinct"><a href="#query_Query-distinct">Query#distinct(<code>[field]</code>, <code>[criteria]</code>, <code>[callback]</code>)</a></h3><p>Declares or executes a distict() operation.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[field]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#query-js">Query</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, arr)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.distinct/" title="distinct">distinct</a></li></ul></div><div class="description"><p>Passing a <code>callback</code> executes the query.</p>

<p>This function does not trigger any middleware.</p>

<h4>Example</h4>

<pre><code>distinct(field, conditions, callback)
distinct(field, conditions)
distinct(field, callback)
distinct(field)
distinct(callback)
distinct()</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.distinct = <span class="keyword">function</span>(field, conditions, callback) {
  <span class="keyword">if</span> (!callback) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
      callback = conditions;
      conditions = <span class="literal">undefined</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> field === <span class="string">'function'</span>) {
      callback = field;
      field = <span class="literal">undefined</span>;
      conditions = <span class="literal">undefined</span>;
    }
  }

  conditions = utils.toObject(conditions);

  <span class="keyword">if</span> (mquery.canMerge(conditions)) {
    <span class="keyword">this</span>.merge(conditions);
  }

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">if</span> (!callback) {
      <span class="keyword">throw</span> err;
    }
    callback(err);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">return</span> Query.base.distinct.call(<span class="keyword">this</span>, {}, field, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-elemMatch"><a href="#query_Query-elemMatch">Query#elemMatch(<code>path</code>, <code>criteria</code>)</a></h3><p>Specifies an <code>$elemMatch</code> condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>criteria</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/elemMatch/" title="$elemMatch">$elemMatch</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.elemMatch(<span class="string">'comment'</span>, { author: <span class="string">'autobot'</span>, votes: {$gte: <span class="number">5</span>}})

query.where(<span class="string">'comment'</span>).elemMatch({ author: <span class="string">'autobot'</span>, votes: {$gte: <span class="number">5</span>}})

query.elemMatch(<span class="string">'comment'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(elem)</span> {</span>
  elem.where(<span class="string">'author'</span>).equals(<span class="string">'autobot'</span>);
  elem.where(<span class="string">'votes'</span>).gte(<span class="number">5</span>);
})

query.where(<span class="string">'comment'</span>).elemMatch(<span class="function"><span class="keyword">function</span> <span class="params">(elem)</span> {</span>
  elem.where({ author: <span class="string">'autobot'</span> });
  elem.where(<span class="string">'votes'</span>).gte(<span class="number">5</span>);
})</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-equals"><a href="#query_Query-equals">Query#equals(<code>val</code>)</a></h3><p>Specifies the complementary comparison value for paths specified with <code>where()</code></p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>User.where(<span class="string">'age'</span>).equals(<span class="number">49</span>);

<span class="comment">// is the same as</span>

User.where(<span class="string">'age'</span>, <span class="number">49</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-error"><a href="#query_Query-error">Query#error(<code>err</code>)</a></h3><p>Gets/sets the error flag on this query. If this flag is not null or<br />undefined, the <code>exec()</code> promise will reject without executing.</p><div class="params"><h4>Parameters:</h4><ul><li><code>err</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error">Error</a>, <a href="#null">null</a>&gt; </span><span>if set, <code>exec()</code> will fail fast before sending the query to MongoDB</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Query().error(); <span class="comment">// Get current error value</span>
Query().error(<span class="literal">null</span>); <span class="comment">// Unset the current error</span>
Query().error(<span class="keyword">new</span> Error(<span class="string">'test'</span>)); <span class="comment">// `exec()` will resolve with test</span>
Schema.pre(<span class="string">'find'</span>, <span class="keyword">function</span>() {
  <span class="keyword">if</span> (!<span class="keyword">this</span>.getQuery().userId) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> Error(<span class="string">'Not allowed to query without setting userId'</span>));
  }
});</code></pre>

<p>Note that query casting runs <strong>after</strong> hooks, so cast errors will override<br />custom errors.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> TestSchema = <span class="keyword">new</span> Schema({ num: Number });
<span class="keyword">var</span> TestModel = db.model(<span class="string">'Test'</span>, TestSchema);
TestModel.find({ num: <span class="string">'not a number'</span> }).error(<span class="keyword">new</span> Error(<span class="string">'woops'</span>)).exec(<span class="keyword">function</span>(error) {
  <span class="comment">// `error` will be a cast error because `num` failed to cast</span>
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.error = <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">(err)</span> {</span>
  <span class="keyword">if</span> (arguments.length === <span class="number">0</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>._error;
  }

  <span class="keyword">this</span>._error = err;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-exec"><a href="#query_Query-exec">Query#exec(<code>[operation]</code>, <code>[callback]</code>)</a></h3><p>Executes the query</p><div class="params"><h4>Parameters:</h4><ul><li><code>[operation]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params depend on the function being called</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Examples:</h4>

<pre><code><span class="keyword">var</span> promise = query.exec();
<span class="keyword">var</span> promise = query.exec(<span class="string">'update'</span>);

query.exec(callback);
query.exec(<span class="string">'find'</span>, callback);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.exec = <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">(op, callback)</span> {</span>
  <span class="keyword">var</span> Promise = PromiseProvider.get();
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> op === <span class="string">'function'</span>) {
    callback = op;
    op = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> op === <span class="string">'string'</span>) {
    <span class="keyword">this</span>.op = op;
  }

  <span class="keyword">var</span> _results;
  <span class="keyword">var</span> promise = <span class="keyword">new</span> Promise.ES6(<span class="keyword">function</span>(resolve, reject) {
    <span class="keyword">if</span> (!_<span class="keyword">this</span>.op) {
      resolve();
      <span class="keyword">return</span>;
    }

    _<span class="keyword">this</span>[_<span class="keyword">this</span>.op].call(_<span class="keyword">this</span>, <span class="keyword">function</span>(error, res) {
      <span class="keyword">if</span> (error) {
        reject(error);
        <span class="keyword">return</span>;
      }
      _results = arguments;
      resolve(res);
    });
  });

  <span class="keyword">if</span> (callback) {
    promise.then(
      <span class="keyword">function</span>() {
        callback.apply(<span class="literal">null</span>, _results);
        <span class="keyword">return</span> <span class="literal">null</span>;
      },
      <span class="keyword">function</span>(error) {
        callback(error, <span class="literal">null</span>);
      }).
      <span class="keyword">catch</span>(<span class="keyword">function</span>(error) {
        <span class="comment">// If we made it here, we must have an error in the callback re:</span>
        <span class="comment">// gh-4500, so we need to emit.</span>
        setImmediate(<span class="keyword">function</span>() {
          _<span class="keyword">this</span>.model.emit(<span class="string">'error'</span>, error);
        });
      });
  }

  <span class="keyword">return</span> promise;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-exists"><a href="#query_Query-exists">Query#exists(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies an <code>$exists</code> condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/exists/" title="$exists">$exists</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// { name: { $exists: true }}</span>
Thing.where(<span class="string">'name'</span>).exists()
Thing.where(<span class="string">'name'</span>).exists(<span class="literal">true</span>)
Thing.find().exists(<span class="string">'name'</span>)

<span class="comment">// { name: { $exists: false }}</span>
Thing.where(<span class="string">'name'</span>).exists(<span class="literal">false</span>);
Thing.find().exists(<span class="string">'name'</span>, <span class="literal">false</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-find"><a href="#query_Query-find">Query#find(<code>[filter]</code>, <code>[callback]</code>)</a></h3><p>Finds documents.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[filter]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>When no <code>callback</code> is passed, the query is not executed. When the query is executed, the result will be an array of documents.</p>

<h4>Example</h4>

<pre><code>query.find({ name: <span class="string">'Los Pollos Hermanos'</span> }).find(callback)</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.find = <span class="keyword">function</span>(conditions, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = {};
  }

  conditions = utils.toObject(conditions);

  <span class="keyword">if</span> (mquery.canMerge(conditions)) {
    <span class="keyword">this</span>.merge(conditions);

    prepareDiscriminatorCriteria(<span class="keyword">this</span>);
  } <span class="keyword">else</span> <span class="keyword">if</span> (conditions != <span class="literal">null</span>) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> ObjectParameterError(conditions, <span class="string">'filter'</span>, <span class="string">'find'</span>));
  }

  <span class="comment">// if we don't have a callback, then just return the query object</span>
  <span class="keyword">if</span> (!callback) {
    <span class="keyword">return</span> Query.base.find.call(<span class="keyword">this</span>);
  }

  <span class="keyword">this</span>._find(callback);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-findOne"><a href="#query_Query-findOne">Query#findOne(<code>[filter]</code>, <code>[projection]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Declares the query a findOne operation. When executed, the first found document is passed to the callback.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[filter]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>mongodb selector</span></li><li><code>[projection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional fields to return</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>see <a href="../../api.html#query_Query-setOptions"><code>setOptions()</code></a></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, document)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.findOne/" title="findOne">findOne</a></li><li><a href="#query_Query-select" title="Query.select">Query.select</a></li></ul></div><div class="description"><p>Passing a <code>callback</code> executes the query. The result of the query is a single document.</p>

<ul>
<li><em>Note:</em> <code>conditions</code> is optional, and if <code>conditions</code> is null or undefined,
mongoose will send an empty <code>findOne</code> command to MongoDB, which will return
an arbitrary document. If you're querying by <code>_id</code>, use <code>Model.findById()</code>
instead.</li>
</ul>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOne()</code></li>
</ul>

<h4>Example</h4>

<pre><code><span class="keyword">var</span> query  = Kitten.where({ color: <span class="string">'white'</span> });
query.findOne(<span class="function"><span class="keyword">function</span> <span class="params">(err, kitten)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  <span class="keyword">if</span> (kitten) {
    <span class="comment">// doc may be null if no document matched</span>
  }
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.findOne = <span class="keyword">function</span>(conditions, projection, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    callback = conditions;
    conditions = <span class="literal">null</span>;
    projection = <span class="literal">null</span>;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> projection === <span class="string">'function'</span>) {
    callback = projection;
    options = <span class="literal">null</span>;
    projection = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    callback = options;
    options = <span class="literal">null</span>;
  }

  <span class="comment">// make sure we don't send in the whole Document to merge()</span>
  conditions = utils.toObject(conditions);

  <span class="keyword">this</span>.op = <span class="string">'findOne'</span>;

  <span class="keyword">if</span> (options) {
    <span class="keyword">this</span>.setOptions(options);
  }

  <span class="keyword">if</span> (projection) {
    <span class="keyword">this</span>.select(projection);
  }

  <span class="keyword">if</span> (mquery.canMerge(conditions)) {
    <span class="keyword">this</span>.merge(conditions);

    prepareDiscriminatorCriteria(<span class="keyword">this</span>);

    <span class="keyword">try</span> {
      <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model);
      <span class="keyword">this</span>.error(<span class="literal">null</span>);
    } <span class="keyword">catch</span> (err) {
      <span class="keyword">this</span>.error(err);
    }
  } <span class="keyword">else</span> <span class="keyword">if</span> (conditions != <span class="literal">null</span>) {
    <span class="keyword">this</span>.error(<span class="keyword">new</span> ObjectParameterError(conditions, <span class="string">'filter'</span>, <span class="string">'findOne'</span>));
  }

  <span class="keyword">if</span> (!callback) {
    <span class="comment">// already merged in the conditions, don't need to send them in.</span>
    <span class="keyword">return</span> Query.base.findOne.call(<span class="keyword">this</span>);
  }

  <span class="keyword">this</span>._findOne(callback);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-findOneAndRemove"><a href="#query_Query-findOneAndRemove">Query#findOneAndRemove(<code>[conditions]</code>, <code>[options]</code>, <code>[options.passRawResult]</code>, <code>[options.strict]</code>, <code>[callback]</code>)</a></h3><p>Issues a mongodb <a href="http://www.mongodb.org/display/DOCS/findAndModify+Command">findAndModify</a> remove command.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options.passRawResult]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></span></li><li><code>[options.strict]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>overwrites the schema&#39;s <a href="../../guide.html#strict">strict mode option</a></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, document)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li></ul></div><div class="description"><p>Finds a matching document, removes it, passing the found document (if any) to the callback. Executes immediately if <code>callback</code> is passed.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOneAndRemove()</code></li>
</ul>

<h4>Available options</h4>

<ul>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>maxTimeMS</code>: puts a time limit on the query - requires mongodb >= 2.6.0</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
</ul>

<h4>Callback Signature</h4>

<pre><code>function(error, doc, result) {
  // error: any errors that occurred
  // doc: the document before updates are applied if `new: false`, or after updates if `new = true`
  // result: [raw result from the MongoDB driver](<a href='http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify'>http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify</a>)
}
</code></pre>

<h4>Examples</h4>

<pre><code>A.where().findOneAndRemove(conditions, options, callback) <span class="comment">// executes</span>
A.where().findOneAndRemove(conditions, options)  <span class="comment">// return Query</span>
A.where().findOneAndRemove(conditions, callback) <span class="comment">// executes</span>
A.where().findOneAndRemove(conditions) <span class="comment">// returns Query</span>
A.where().findOneAndRemove(callback)   <span class="comment">// executes</span>
A.where().findOneAndRemove()           <span class="comment">// returns Query</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-findOneAndUpdate"><a href="#query_Query-findOneAndUpdate">Query#findOneAndUpdate(<code>[query]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[options.passRawResult]</code>, <code>[options.strict]</code>, <code>[options.multipleCastError]</code>, <code>[callback]</code>)</a></h3><p>Issues a mongodb <a href="http://www.mongodb.org/display/DOCS/findAndModify+Command">findAndModify</a> update command.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[query]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#query-js">Query</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options.passRawResult]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></span></li><li><code>[options.strict]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>overwrites the schema&#39;s <a href="../../guide.html#strict">strict mode option</a></span></li><li><code>[options.multipleCastError]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, doc), <em>unless</em> <code>passRawResult</code> is used, in which case params are (error, doc, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/findAndModify+Command" title="mongodb">mongodb</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><div class="description"><p>Finds a matching document, updates it according to the <code>update</code> arg, passing any <code>options</code>, and returns the found document (if any) to the callback. The query executes immediately if <code>callback</code> is passed.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>findOneAndUpdate()</code></li>
</ul>

<h4>Available options</h4>

<ul>
<li><code>new</code>: bool - if true, return the modified document rather than the original. defaults to false (changed in 4.0)</li>
<li><code>upsert</code>: bool - creates the object if it doesn't exist. defaults to false.</li>
<li><code>fields</code>: {Object|String} - Field selection. Equivalent to <code>.select(fields).findOneAndUpdate()</code></li>
<li><code>sort</code>: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</li>
<li><code>maxTimeMS</code>: puts a time limit on the query - requires mongodb >= 2.6.0</li>
<li><code>runValidators</code>: if true, runs <a href="../../validation.html#update-validators">update validators</a> on this command. Update validators validate the update operation against the model's schema.</li>
<li><code>setDefaultsOnInsert</code>: if this and <code>upsert</code> are true, mongoose will apply the <a href="../../defaults.html">defaults</a> specified in the model's schema if a new document is created. This option only works on MongoDB >= 2.4 because it relies on <a href="https://docs.mongodb.org/v2.4/reference/operator/update/setOnInsert/">MongoDB's <code>$setOnInsert</code> operator</a>.</li>
<li><code>passRawResult</code>: if true, passes the <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#findAndModify">raw result from the MongoDB driver as the third callback parameter</a></li>
<li><code>context</code> (string) if set to 'query' and <code>runValidators</code> is on, <code>this</code> will refer to the query in custom validator functions that update validation runs. Does nothing if <code>runValidators</code> is false.</li>
<li><code>runSettersOnQuery</code>: bool - if true, run all setters defined on the associated model's schema for all fields defined in the query and the update.</li>
</ul>

<h4>Callback Signature</h4>

<pre><code><span class="keyword">function</span>(error, doc) {
  <span class="comment">// error: any errors that occurred</span>
  <span class="comment">// doc: the document before updates are applied if `new: false`, or after updates if `new = true`</span>
}</code></pre>

<h4>Examples</h4>

<pre><code>query.findOneAndUpdate(conditions, update, options, callback) <span class="comment">// executes</span>
query.findOneAndUpdate(conditions, update, options)  <span class="comment">// returns Query</span>
query.findOneAndUpdate(conditions, update, callback) <span class="comment">// executes</span>
query.findOneAndUpdate(conditions, update)           <span class="comment">// returns Query</span>
query.findOneAndUpdate(update, callback)             <span class="comment">// returns Query</span>
query.findOneAndUpdate(update)                       <span class="comment">// returns Query</span>
query.findOneAndUpdate(callback)                     <span class="comment">// executes</span>
query.findOneAndUpdate()                             <span class="comment">// returns Query</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-geometry"><a href="#query_Query-geometry">Query#geometry(<code>object</code>)</a></h3><p>Specifies a <code>$geometry</code> condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>object</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Must contain a <code>type</code> property which is a String and a <code>coordinates</code> property which is an Array. See the examples.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/geometry/" title="$geometry">$geometry</a></li><li><a href="http://docs.mongodb.org/manual/release-notes/2.4/#new-geospatial-indexes-with-geojson-and-improved-spherical-geometry">http://docs.mongodb.org/manual/release-notes/2.4/#new-geospatial-indexes-with-geojson-and-improved-spherical-geometry</a></li><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> polyA = [[[ <span class="number">10</span>, <span class="number">20</span> ], [ <span class="number">10</span>, <span class="number">40</span> ], [ <span class="number">30</span>, <span class="number">40</span> ], [ <span class="number">30</span>, <span class="number">20</span> ]]]
query.where(<span class="string">'loc'</span>).within().geometry({ type: <span class="string">'Polygon'</span>, coordinates: polyA })

<span class="comment">// or</span>
<span class="keyword">var</span> polyB = [[ <span class="number">0</span>, <span class="number">0</span> ], [ <span class="number">1</span>, <span class="number">1</span> ]]
query.where(<span class="string">'loc'</span>).within().geometry({ type: <span class="string">'LineString'</span>, coordinates: polyB })

<span class="comment">// or</span>
<span class="keyword">var</span> polyC = [ <span class="number">0</span>, <span class="number">0</span> ]
query.where(<span class="string">'loc'</span>).within().geometry({ type: <span class="string">'Point'</span>, coordinates: polyC })

<span class="comment">// or</span>
query.where(<span class="string">'loc'</span>).intersects().geometry({ type: <span class="string">'Point'</span>, coordinates: polyC })</code></pre>

<p>The argument is assigned to the most recent path passed to <code>where()</code>.</p>

<h4>NOTE:</h4>

<p><code>geometry()</code> <strong>must</strong> come after either <code>intersects()</code> or <code>within()</code>.</p>

<p>The <code>object</code> argument must contain <code>type</code> and <code>coordinates</code> properties.<br />- type {String}<br />- coordinates {Array}</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-getQuery"><a href="#query_Query-getQuery">Query#getQuery()</a></h3><p>Returns the current query conditions as a JSON object.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>current query conditions</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> query = <span class="keyword">new</span> Query();
query.find({ a: <span class="number">1</span> }).where(<span class="string">'b'</span>).gt(<span class="number">2</span>);
query.getQuery(); <span class="comment">// { a: 1, b: { $gt: 2 } }</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.getQuery = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._conditions;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-getUpdate"><a href="#query_Query-getUpdate">Query#getUpdate()</a></h3><p>Returns the current update operations as a JSON object.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>current update operations</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> query = <span class="keyword">new</span> Query();
query.update({}, { $set: { a: <span class="number">5</span> } });
query.getUpdate(); <span class="comment">// { $set: { a: 5 } }</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.getUpdate = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._update;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-gt"><a href="#query_Query-gt">Query#gt(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $gt query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/gt/" title="$gt">$gt</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p>

<h4>Example</h4>

<pre><code>Thing.find().where(<span class="string">'age'</span>).gt(<span class="number">21</span>)

<span class="comment">// or</span>
Thing.find().gt(<span class="string">'age'</span>, <span class="number">21</span>)</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-gte"><a href="#query_Query-gte">Query#gte(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $gte query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/gte/" title="$gte">$gte</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-hint"><a href="#query_Query-hint">Query#hint(<code>val</code>)</a></h3><p>Sets query hints.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>a hint object</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/hint/" title="$hint">$hint</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.hint({ indexA: <span class="number">1</span>, indexB: -<span class="number">1</span>})</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-in"><a href="#query_Query-in">Query#in(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies an $in query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/in/" title="$in">$in</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-intersects"><a href="#query_Query-intersects">Query#intersects(<code>[arg]</code>)</a></h3><p>Declares an intersects query for <code>geometry()</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[arg]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/geometry/" title="$geometry">$geometry</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/geoIntersects/" title="geoIntersects">geoIntersects</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.where(<span class="string">'path'</span>).intersects().geometry({
    type: <span class="string">'LineString'</span>
  , coordinates: [[<span class="number">180.0</span>, <span class="number">11.0</span>], [<span class="number">180</span>, <span class="number">9.0</span>]]
})

query.where(<span class="string">'path'</span>).intersects({
    type: <span class="string">'LineString'</span>
  , coordinates: [[<span class="number">180.0</span>, <span class="number">11.0</span>], [<span class="number">180</span>, <span class="number">9.0</span>]]
})</code></pre>

<h4>NOTE:</h4>

<p><strong>MUST</strong> be used after <code>where()</code>.</p>

<h4>NOTE:</h4>

<p>In Mongoose 3.7, <code>intersects</code> changed from a getter to a function. If you need the old syntax, use <a href="https://github.com/ebensing/mongoose-within">this</a>.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-lean"><a href="#query_Query-lean">Query#lean(<code>bool</code>)</a></h3><p>Sets the lean option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>bool</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>defaults to true</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>Documents returned from queries with the <code>lean</code> option enabled are plain javascript objects, not <a href="#document-js">MongooseDocuments</a>. They have no <code>save</code> method, getters/setters or other Mongoose magic applied.</p>

<h4>Example:</h4>

<pre><code><span class="keyword">new</span> Query().lean() <span class="comment">// true</span>
<span class="keyword">new</span> Query().lean(<span class="literal">true</span>)
<span class="keyword">new</span> Query().lean(<span class="literal">false</span>)

Model.find().lean().exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>
  docs[<span class="number">0</span>] <span class="keyword">instanceof</span> mongoose.Document <span class="comment">// false</span>
});</code></pre>

<p>This is a <a href="https://groups.google.com/forum/#!topic/mongoose-orm/u2_DzDydcnA/discussion">great</a> option in high-performance read-only scenarios, especially when combined with <a href="#query_Query-stream">stream</a>.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.lean = <span class="keyword">function</span>(v) {
  <span class="keyword">this</span>._mongooseOptions.lean = arguments.length ? v : <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-limit"><a href="#query_Query-limit">Query#limit(<code>val</code>)</a></h3><p>Specifies the maximum number of documents the query will return.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.limit(<span class="number">20</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-lt"><a href="#query_Query-lt">Query#lt(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $lt query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/lt/" title="$lt">$lt</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-lte"><a href="#query_Query-lte">Query#lte(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $lte query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/lte/" title="$lte">$lte</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-maxDistance"><a href="#query_Query-maxDistance">Query#maxDistance(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $maxDistance query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/maxDistance/" title="$maxDistance">$maxDistance</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-maxscan"><a href="#query_Query-maxscan">Query#maxscan()</a></h3><p><em>DEPRECATED</em> Alias of <code>maxScan</code></p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-maxScan" title="maxScan">maxScan</a></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="query_Query-maxScan"><a href="#query_Query-maxScan">Query#maxScan(<code>val</code>)</a></h3><p>Specifies the maxScan option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/maxScan/" title="maxScan">maxScan</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.maxScan(<span class="number">100</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-merge"><a href="#query_Query-merge">Query#merge(<code>source</code>)</a></h3><p>Merges another Query or conditions object into this one.</p><div class="params"><h4>Parameters:</h4><ul><li><code>source</code><span class="types"> &lt;<a href="#query-js">Query</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>When a Query is passed, conditions, field selection and options are merged.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.merge = <span class="keyword">function</span>(source) {
  <span class="keyword">if</span> (!source) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> opts = { retainKeyOrder: <span class="keyword">this</span>.options.retainKeyOrder, overwrite: <span class="literal">true</span> };

  <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Query) {
    <span class="comment">// if source has a feature, apply it to ourselves</span>

    <span class="keyword">if</span> (source._conditions) {
      utils.merge(<span class="keyword">this</span>._conditions, source._conditions, opts);
    }

    <span class="keyword">if</span> (source._fields) {
      <span class="keyword">this</span>._fields || (<span class="keyword">this</span>._fields = {});
      utils.merge(<span class="keyword">this</span>._fields, source._fields, opts);
    }

    <span class="keyword">if</span> (source.options) {
      <span class="keyword">this</span>.options || (<span class="keyword">this</span>.options = {});
      utils.merge(<span class="keyword">this</span>.options, source.options, opts);
    }

    <span class="keyword">if</span> (source._update) {
      <span class="keyword">this</span>._update || (<span class="keyword">this</span>._update = {});
      utils.mergeClone(<span class="keyword">this</span>._update, source._update);
    }

    <span class="keyword">if</span> (source._distinct) {
      <span class="keyword">this</span>._distinct = source._distinct;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="comment">// plain object</span>
  utils.merge(<span class="keyword">this</span>._conditions, source, opts);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-merge"><a href="#query_Query-merge">Query#merge(<code>source</code>)</a></h3><p>Merges another Query or conditions object into this one.</p><div class="params"><h4>Parameters:</h4><ul><li><code>source</code><span class="types"> &lt;<a href="#query-js">Query</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>When a Query is passed, conditions, field selection and options are merged.</p>

<p>New in 3.7.0</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-mod"><a href="#query_Query-mod">Query#mod(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a <code>$mod</code> condition, filters documents for documents whose<br /><code>path</code> property is a number that is equal to <code>remainder</code> modulo <code>divisor</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>must be of length 2, first element is <code>divisor</code>, 2nd element is <code>remainder</code>.</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/mod/" title="$mod">$mod</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// All find products whose inventory is odd</span>
Product.find().mod(<span class="string">'inventory'</span>, [<span class="number">2</span>, <span class="number">1</span>]);
Product.find().where(<span class="string">'inventory'</span>).mod([<span class="number">2</span>, <span class="number">1</span>]);
<span class="comment">// This syntax is a little strange, but supported.</span>
Product.find().where(<span class="string">'inventory'</span>).mod(<span class="number">2</span>, <span class="number">1</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-mongooseOptions"><a href="#query_Query-mongooseOptions">Query#mongooseOptions(<code>options</code>)</a></h3><p>Getter/setter around the current mongoose-specific options for this query<br />(populate, lean, etc.)</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if specified, overwrites the current options</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.mongooseOptions = <span class="keyword">function</span>(v) {
  <span class="keyword">if</span> (arguments.length > <span class="number">0</span>) {
    <span class="keyword">this</span>._mongooseOptions = v;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>._mongooseOptions;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-ne"><a href="#query_Query-ne">Query#ne(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $ne query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/ne/" title="$ne">$ne</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-near"><a href="#query_Query-near">Query#near(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a <code>$near</code> or <code>$nearSphere</code> condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/near/" title="$near">$near</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/nearSphere/" title="$nearSphere">$nearSphere</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/maxDistance/" title="$maxDistance">$maxDistance</a></li><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><div class="description"><p>These operators return documents sorted by distance.</p>

<h4>Example</h4>

<pre><code>query.where(<span class="string">'loc'</span>).near({ center: [<span class="number">10</span>, <span class="number">10</span>] });
query.where(<span class="string">'loc'</span>).near({ center: [<span class="number">10</span>, <span class="number">10</span>], maxDistance: <span class="number">5</span> });
query.where(<span class="string">'loc'</span>).near({ center: [<span class="number">10</span>, <span class="number">10</span>], maxDistance: <span class="number">5</span>, spherical: <span class="literal">true</span> });
query.near(<span class="string">'loc'</span>, { center: [<span class="number">10</span>, <span class="number">10</span>], maxDistance: <span class="number">5</span> });</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-nearSphere"><a href="#query_Query-nearSphere">Query#nearSphere()</a></h3><p><em>DEPRECATED</em> Specifies a <code>$nearSphere</code> condition</p><div class="see"><h4>See:</h4><ul class="see"><li><a href="#query_Query-near" title="near()">near()</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/near/" title="$near">$near</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/nearSphere/" title="$nearSphere">$nearSphere</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/maxDistance/" title="$maxDistance">$maxDistance</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.where(<span class="string">'loc'</span>).nearSphere({ center: [<span class="number">10</span>, <span class="number">10</span>], maxDistance: <span class="number">5</span> });</code></pre>

<p><strong>Deprecated.</strong> Use <code>query.near()</code> instead with the <code>spherical</code> option set to <code>true</code>.</p>

<h4>Example</h4>

<pre><code>query.where(<span class="string">'loc'</span>).near({ center: [<span class="number">10</span>, <span class="number">10</span>], spherical: <span class="literal">true</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.nearSphere = <span class="keyword">function</span>() {
  <span class="keyword">this</span>._mongooseOptions.nearSphere = <span class="literal">true</span>;
  <span class="keyword">this</span>.near.apply(<span class="keyword">this</span>, arguments);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-nin"><a href="#query_Query-nin">Query#nin(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies an $nin query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/nin/" title="$nin">$nin</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-nor"><a href="#query_Query-nor">Query#nor(<code>array</code>)</a></h3><p>Specifies arguments for a <code>$nor</code> condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>array</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>array of conditions</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/nor/" title="$nor">$nor</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.nor([{ color: <span class="string">'green'</span> }, { status: <span class="string">'ok'</span> }])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-or"><a href="#query_Query-or">Query#or(<code>array</code>)</a></h3><p>Specifies arguments for an <code>$or</code> condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>array</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>array of conditions</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/or/" title="$or">$or</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.or([{ color: <span class="string">'red'</span> }, { status: <span class="string">'emergency'</span> }])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-polygon"><a href="#query_Query-polygon">Query#polygon(<code>[path]</code>, <code>[coordinatePairs...]</code>)</a></h3><p>Specifies a $polygon condition</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li><li><code>[coordinatePairs...]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/polygon/" title="$polygon">$polygon</a></li><li><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.where(<span class="string">'loc'</span>).within().polygon([<span class="number">10</span>,<span class="number">20</span>], [<span class="number">13</span>, <span class="number">25</span>], [<span class="number">7</span>,<span class="number">15</span>])
query.polygon(<span class="string">'loc'</span>, [<span class="number">10</span>,<span class="number">20</span>], [<span class="number">13</span>, <span class="number">25</span>], [<span class="number">7</span>,<span class="number">15</span>])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-populate"><a href="#query_Query-populate">Query#populate(<code>path</code>, <code>[select]</code>, <code>[model]</code>, <code>[match]</code>, <code>[options]</code>)</a></h3><p>Specifies paths which should be populated with other documents.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>either the path to populate or an object specifying all parameters</span></li><li><code>[select]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>Field selection for the population query</span></li><li><code>[model]</code><span class="types"> &lt;<a href="#model_Model">Model</a>&gt; </span><span>The model you wish to use for population. If not specified, populate will look up the model by the name in the Schema&#39;s <code>ref</code> field.</span></li><li><code>[match]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Conditions for the population query</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Options for the population query (sort, etc)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="populate.html" title="population">population</a></li><li><a href="#query_Query-select" title="Query#select">Query#select</a></li><li><a href="#model_Model.populate" title="Model.populate">Model.populate</a></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code>Kitten.findOne().populate(<span class="string">'owner'</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, kitten)</span> {</span>
  console.log(kitten.owner.name) <span class="comment">// Max</span>
})

Kitten.find().populate({
    path: <span class="string">'owner'</span>
  , select: <span class="string">'name'</span>
  , match: { color: <span class="string">'black'</span> }
  , options: { sort: { name: -<span class="number">1</span> }}
}).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, kittens)</span> {</span>
  console.log(kittens[<span class="number">0</span>].owner.name) <span class="comment">// Zoopa</span>
})

<span class="comment">// alternatively</span>
Kitten.find().populate(<span class="string">'owner'</span>, <span class="string">'name'</span>, <span class="literal">null</span>, {sort: { name: -<span class="number">1</span> }}).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, kittens)</span> {</span>
  console.log(kittens[<span class="number">0</span>].owner.name) <span class="comment">// Zoopa</span>
})</code></pre>

<p>Paths are populated after the query executes and a response is received. A separate query is then executed for each path specified for population. After a response for each query has also been returned, the results are passed to the callback.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.populate = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (arguments.length === <span class="number">0</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">var</span> i;

  <span class="keyword">var</span> res = utils.populate.apply(<span class="literal">null</span>, arguments);

  <span class="comment">// Propagate readPreference from parent query, unless one already specified</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.options &amp;&amp; <span class="keyword">this</span>.options.readPreference != <span class="literal">null</span>) {
    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; res.length; ++i) {
      <span class="keyword">if</span> (!res[i].options || res[i].options.readPreference == <span class="literal">null</span>) {
        res[i].options = res[i].options || {};
        res[i].options.readPreference = <span class="keyword">this</span>.options.readPreference;
      }
    }
  }

  <span class="keyword">var</span> opts = <span class="keyword">this</span>._mongooseOptions;

  <span class="keyword">if</span> (!utils.isObject(opts.populate)) {
    opts.populate = {};
  }

  <span class="keyword">var</span> pop = opts.populate;

  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; res.length; ++i) {
    <span class="keyword">var</span> path = res[i].path;
    <span class="keyword">if</span> (pop[path] &amp;&amp; pop[path].populate &amp;&amp; res[i].populate) {
      res[i].populate = pop[path].populate.concat(res[i].populate);
    }
    pop[res[i].path] = res[i];
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="query_Query"><a href="#query_Query">Query(<code>[options]</code>, <code>[model]</code>, <code>[conditions]</code>, <code>[collection]</code>)</a></h3><p>Query constructor used for building queries.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[model]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[conditions]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[collection]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Mongoose collection</span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> query = <span class="keyword">new</span> Query();
query.setOptions({ lean : <span class="literal">true</span> });
query.collection(model.collection);
query.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).exec(callback);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Query</span><span class="params">(conditions, options, model, collection)</span> {</span>
  <span class="comment">// this stuff is for dealing with custom queries created by #toConstructor</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._mongooseOptions) {
    <span class="keyword">this</span>._mongooseOptions = {};
  }

  <span class="comment">// this is the case where we have a CustomQuery, we need to check if we got</span>
  <span class="comment">// options passed in, and if we did, merge them in</span>
  <span class="keyword">if</span> (options) {
    <span class="keyword">var</span> keys = Object.keys(options);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; ++i) {
      <span class="keyword">var</span> k = keys[i];
      <span class="keyword">this</span>._mongooseOptions[k] = options[k];
    }
  }

  <span class="keyword">if</span> (collection) {
    <span class="keyword">this</span>.mongooseCollection = collection;
  }

  <span class="keyword">if</span> (model) {
    <span class="keyword">this</span>.model = model;
    <span class="keyword">this</span>.schema = model.schema;
  }

  <span class="comment">// this is needed because map reduce returns a model that can be queried, but</span>
  <span class="comment">// all of the queries on said model should be lean</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.model &amp;&amp; <span class="keyword">this</span>.model._mapreduce) {
    <span class="keyword">this</span>.lean();
  }

  <span class="comment">// inherit mquery</span>
  mquery.call(<span class="keyword">this</span>, <span class="keyword">this</span>.mongooseCollection, options);

  <span class="keyword">if</span> (conditions) {
    <span class="keyword">this</span>.find(conditions);
  }

  <span class="keyword">this</span>.options = <span class="keyword">this</span>.options || {};
  <span class="keyword">if</span> (<span class="keyword">this</span>.schema != <span class="literal">null</span> &amp;&amp; <span class="keyword">this</span>.schema.options.collation != <span class="literal">null</span>) {
    <span class="keyword">this</span>.options.collation = <span class="keyword">this</span>.schema.options.collation;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.schema) {
    <span class="keyword">var</span> kareemOptions = {
      useErrorHandlers: <span class="literal">true</span>,
      numCallbackParams: <span class="number">1</span>,
      nullResultByDefault: <span class="literal">true</span>
    };
    <span class="keyword">this</span>._count = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'count'</span>,
        Query.prototype._count, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._execUpdate = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'update'</span>,
        Query.prototype._execUpdate, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._find = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'find'</span>,
        Query.prototype._find, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._findOne = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'findOne'</span>,
        Query.prototype._findOne, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._findOneAndRemove = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'findOneAndRemove'</span>,
        Query.prototype._findOneAndRemove, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._findOneAndUpdate = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'findOneAndUpdate'</span>,
        Query.prototype._findOneAndUpdate, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._replaceOne = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'replaceOne'</span>,
        Query.prototype._replaceOne, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._updateMany = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'updateMany'</span>,
        Query.prototype._updateMany, <span class="keyword">this</span>, kareemOptions);
    <span class="keyword">this</span>._updateOne = <span class="keyword">this</span>.model.hooks.createWrapper(<span class="string">'updateOne'</span>,
        Query.prototype._updateOne, <span class="keyword">this</span>, kareemOptions);
  }
}</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="query_Query-read"><a href="#query_Query-read">Query#read(<code>pref</code>, <code>[tags]</code>)</a></h3><p>Determines the MongoDB nodes from which to read.</p><div class="params"><h4>Parameters:</h4><ul><li><code>pref</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>one of the listed preference options or aliases</span></li><li><code>[tags]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>optional tags for this query</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/applications/replication/#read-preference" title="mongodb">mongodb</a></li><li><a href="http://mongodb.github.com/node-mongodb-native/driver-articles/anintroductionto1_1and2_2.html#read-preferences" title="driver">driver</a></li></ul></div><div class="description"><h4>Preferences:</h4>

<pre><code>primary - (<span class="keyword">default</span>) Read from primary only. Operations will produce an error <span class="keyword">if</span> primary is unavailable. Cannot be combined <span class="keyword">with</span> tags.
secondary            Read from secondary <span class="keyword">if</span> available, otherwise error.
primaryPreferred     Read from primary <span class="keyword">if</span> available, otherwise a secondary.
secondaryPreferred   Read from a secondary <span class="keyword">if</span> available, otherwise read from the primary.
nearest              All operations read from among the nearest candidates, but unlike other modes, <span class="keyword">this</span> option will include both the primary and all secondaries <span class="keyword">in</span> the random selection.</code></pre>

<p>Aliases</p>

<pre><code>p   primary
pp  primaryPreferred
s   secondary
sp  secondaryPreferred
n   nearest</code></pre>

<h4>Example:</h4>

<pre><code><span class="keyword">new</span> Query().read(<span class="string">'primary'</span>)
<span class="keyword">new</span> Query().read(<span class="string">'p'</span>)  <span class="comment">// same as primary</span>

<span class="keyword">new</span> Query().read(<span class="string">'primaryPreferred'</span>)
<span class="keyword">new</span> Query().read(<span class="string">'pp'</span>) <span class="comment">// same as primaryPreferred</span>

<span class="keyword">new</span> Query().read(<span class="string">'secondary'</span>)
<span class="keyword">new</span> Query().read(<span class="string">'s'</span>)  <span class="comment">// same as secondary</span>

<span class="keyword">new</span> Query().read(<span class="string">'secondaryPreferred'</span>)
<span class="keyword">new</span> Query().read(<span class="string">'sp'</span>) <span class="comment">// same as secondaryPreferred</span>

<span class="keyword">new</span> Query().read(<span class="string">'nearest'</span>)
<span class="keyword">new</span> Query().read(<span class="string">'n'</span>)  <span class="comment">// same as nearest</span>

<span class="comment">// read from secondaries with matching tags</span>
<span class="keyword">new</span> Query().read(<span class="string">'s'</span>, [{ dc:<span class="string">'sf'</span>, s: <span class="number">1</span> },{ dc:<span class="string">'ma'</span>, s: <span class="number">2</span> }])</code></pre>

<p>Read more about how to use read preferrences <a href="http://docs.mongodb.org/manual/applications/replication/#read-preference">here</a> and <a href="http://mongodb.github.com/node-mongodb-native/driver-articles/anintroductionto1_1and2_2.html#read-preferences">here</a>.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-regex"><a href="#query_Query-regex">Query#regex(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $regex query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/RegExp">RegExp</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/regex/" title="$regex">$regex</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-remove"><a href="#query_Query-remove">Query#remove(<code>[filter]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as a remove() operation.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[filter]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="#query-js">Query</a>&gt; </span><span>mongodb selector</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.remove/" title="remove">remove</a></li></ul></div><div class="description"><p>This function does not trigger any middleware</p>

<h4>Example</h4>

<pre><code>Model.remove({ artist: <span class="string">'Anne Murray'</span> }, callback)</code></pre>

<h4>Note</h4>

<p>The operation is only executed when a callback is passed. To force execution without a callback, you must first call <code>remove()</code> and then execute it by using the <code>exec()</code> method.</p>

<pre><code><span class="comment">// not executed</span>
<span class="keyword">var</span> query = Model.find().remove({ name: <span class="string">'Anne Murray'</span> })

<span class="comment">// executed</span>
query.remove({ name: <span class="string">'Anne Murray'</span> }, callback)
query.remove({ name: <span class="string">'Anne Murray'</span> }).remove(callback)

<span class="comment">// executed without a callback</span>
query.exec()

<span class="comment">// summary</span>
query.remove(conds, fn); <span class="comment">// executes</span>
query.remove(conds)
query.remove(fn) <span class="comment">// executes</span>
query.remove()</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.remove = <span class="keyword">function</span>(filter, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> filter === <span class="string">'function'</span>) {
    callback = filter;
    filter = <span class="literal">null</span>;
  }

  filter = utils.toObject(filter, { retainKeyOrder: <span class="literal">true</span> });

  <span class="keyword">try</span> {
    <span class="keyword">this</span>.cast(<span class="keyword">this</span>.model, filter);
    <span class="keyword">this</span>.merge(filter);
  } <span class="keyword">catch</span> (err) {
    <span class="keyword">this</span>.error(err);
  }

  prepareDiscriminatorCriteria(<span class="keyword">this</span>);

  <span class="keyword">if</span> (!callback) {
    <span class="keyword">return</span> Query.base.remove.call(<span class="keyword">this</span>);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._remove(callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-replaceOne"><a href="#query_Query-replaceOne">Query#replaceOne(<code>[criteria]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as a replaceOne() operation. Same as<br /><code>update()</code>, except MongoDB will replace the existing document and will<br />not accept any atomic operators (<code>$set</code>, etc.)</p><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the update command</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.update" title="Model.update">Model.update</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" title="update">update</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><div class="description"><p><strong>Note</strong> replaceOne will <em>not</em> fire update middleware. Use <code>pre('replaceOne')</code><br />and <code>post('replaceOne')</code> instead.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>replaceOne()</code></li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.replaceOne = <span class="keyword">function</span>(conditions, doc, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    <span class="comment">// .update(conditions, doc, callback)</span>
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> doc === <span class="string">'function'</span>) {
    <span class="comment">// .update(doc, callback);</span>
    callback = doc;
    doc = conditions;
    conditions = {};
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    <span class="comment">// .update(callback)</span>
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
    doc = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'object'</span> &amp;&amp; !doc &amp;&amp; !options &amp;&amp; !callback) {
    <span class="comment">// .update(doc)</span>
    doc = conditions;
    conditions = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
    callback = <span class="literal">undefined</span>;
  }

  <span class="keyword">this</span>.setOptions({ overwrite: <span class="literal">true</span> });
  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'replaceOne'</span>, conditions, doc, options, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-select"><a href="#query_Query-select">Query#select(<code>arg</code>)</a></h3><p>Specifies which document fields to include or exclude (also known as the query "projection")</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#schematype_SchemaType" title="SchemaType">SchemaType</a></li></ul></div><div class="description"><p>When using string syntax, prefixing a path with <code>-</code> will flag that path as excluded. When a path does not have the <code>-</code> prefix, it is included. Lastly, if a path is prefixed with <code>+</code>, it forces inclusion of the path, which is useful for paths excluded at the <a href="../../api.html#schematype_SchemaType-select">schema level</a>.</p>

<p>A projection <em>must</em> be either inclusive or exclusive. In other words, you must<br />either list the fields to include (which excludes all others), or list the fields<br />to exclude (which implies all other fields are included). The <a href="https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/#suppress-id-field"><code>_id</code> field is the only exception because MongoDB includes it by default</a>.</p>

<h4>Example</h4>

<pre><code><span class="comment">// include a and b, exclude other fields</span>
query.select(<span class="string">'a b'</span>);

<span class="comment">// exclude c and d, include other fields</span>
query.select(<span class="string">'-c -d'</span>);

<span class="comment">// or you may use object notation, useful when</span>
<span class="comment">// you have keys already prefixed with a "-"</span>
query.select({ a: <span class="number">1</span>, b: <span class="number">1</span> });
query.select({ c: <span class="number">0</span>, d: <span class="number">0</span> });

<span class="comment">// force inclusion of field excluded at schema level</span>
query.select(<span class="string">'+path'</span>)</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-selected"><a href="#query_Query-selected">Query#selected()</a></h3><p>Determines if field selection has been made.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><hr class=""></div><div class="item method public"><h3 id="query_Query-selectedExclusively"><a href="#query_Query-selectedExclusively">Query#selectedExclusively()</a></h3><p>Determines if exclusive field selection has been made.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><pre><code>query.selectedExclusively() <span class="comment">// false</span>
query.select(<span class="string">'-name'</span>)
query.selectedExclusively() <span class="comment">// true</span>
query.selectedInclusively() <span class="comment">// false</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-selectedInclusively"><a href="#query_Query-selectedInclusively">Query#selectedInclusively()</a></h3><p>Determines if inclusive field selection has been made.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"><pre><code>query.selectedInclusively() <span class="comment">// false</span>
query.select(<span class="string">'name'</span>)
query.selectedInclusively() <span class="comment">// true</span></code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-setOptions"><a href="#query_Query-setOptions">Query#setOptions(<code>options</code>)</a></h3><p>Sets query options. Some options only make sense for certain operations.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Options:</h4>

<p>The following options are only for <code>find()</code>:<br />- <a href="http://www.mongodb.org/display/DOCS/Tailable+Cursors">tailable</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Bsort()%7D%7D">sort</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Blimit%28%29%7D%7D">limit</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Bskip%28%29%7D%7D">skip</a><br />- <a href="https://docs.mongodb.org/v3.2/reference/operator/meta/maxScan/#metaOp._S_maxScan">maxscan</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7BbatchSize%28%29%7D%7D">batchSize</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%24comment">comment</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%7B%7Bsnapshot%28%29%7D%7D">snapshot</a><br />- <a href="http://docs.mongodb.org/manual/applications/replication/#read-preference">readPreference</a><br />- <a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-%24hint">hint</a></p>

<p>The following options are only for <code>update()</code>, <code>updateOne()</code>, <code>updateMany()</code>, <code>replaceOne()</code>, <code>findOneAndUpdate()</code>, and <code>findByIdAndUpdate()</code>:<br />- <a href="https://docs.mongodb.com/manual/reference/method/db.collection.update/">upsert</a><br />- <a href="https://docs.mongodb.com/manual/reference/method/db.collection.update/">writeConcern</a></p>

<p>The following options are only for <code>find()</code>, <code>findOne()</code>, <code>findById()</code>, <code>findOneAndUpdate()</code>, and <code>findByIdAndUpdate()</code>:<br />- <a href="api.html#query_Query-lean">lean</a></p>

<p>The following options are only for all operations <strong>except</strong> <code>update()</code>, <code>updateOne()</code>, <code>updateMany()</code>, <code>remove()</code>, <code>deleteOne()</code>, and <code>deleteMany()</code>:<br />- <a href="https://docs.mongodb.com/manual/reference/operator/meta/maxTimeMS/">maxTimeMS</a></p>

<h2>The following options are for all operations</h2>

<ul>
<li><a href="https://docs.mongodb.com/manual/reference/collation/">collation</a></li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.setOptions = <span class="keyword">function</span>(options, overwrite) {
  <span class="comment">// overwrite is only for internal use</span>
  <span class="keyword">if</span> (overwrite) {
    <span class="comment">// ensure that _mongooseOptions &amp; options are two different objects</span>
    <span class="keyword">this</span>._mongooseOptions = (options &amp;&amp; utils.clone(options)) || {};
    <span class="keyword">this</span>.options = options || {};

    <span class="keyword">if</span> (<span class="string">'populate'</span> <span class="keyword">in</span> options) {
      <span class="keyword">this</span>.populate(<span class="keyword">this</span>._mongooseOptions);
    }
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (options == <span class="literal">null</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> (Array.isArray(options.populate)) {
    <span class="keyword">var</span> populate = options.populate;
    <span class="keyword">delete</span> options.populate;
    <span class="keyword">var</span> _numPopulate = populate.length;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _numPopulate; ++i) {
      <span class="keyword">this</span>.populate(populate[i]);
    }
  }

  <span class="keyword">return</span> Query.base.setOptions.call(<span class="keyword">this</span>, options);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-size"><a href="#query_Query-size">Query#size(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $size query condition.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/size/" title="$size">$size</a></li></ul></div><div class="description"><p>When called with one argument, the most recent path passed to <code>where()</code> is used.</p>

<h4>Example</h4>

<pre><code>MyModel.where(<span class="string">'tags'</span>).size(<span class="number">0</span>).exec(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> {</span>
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);

  assert(Array.isArray(docs));
  console.log(<span class="string">'documents with 0 tags'</span>, docs);
})</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-skip"><a href="#query_Query-skip">Query#skip(<code>val</code>)</a></h3><p>Specifies the number of documents to skip.</p><div class="params"><h4>Parameters:</h4><ul><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/cursor.skip/" title="cursor.skip">cursor.skip</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.skip(<span class="number">100</span>).limit(<span class="number">20</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-slaveOk"><a href="#query_Query-slaveOk">Query#slaveOk(<code>v</code>)</a></h3><p><em>DEPRECATED</em> Sets the slaveOk option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>v</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>defaults to true</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/applications/replication/#read-preference" title="mongodb">mongodb</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/rs.slaveOk/" title="slaveOk">slaveOk</a></li><li><a href="#query_Query-read" title="read()">read()</a></li></ul></div><div class="description"><p><strong>Deprecated</strong> in MongoDB 2.2 in favor of <a href="#query_Query-read">read preferences</a>.</p>

<h4>Example:</h4>

<pre><code>query.slaveOk() <span class="comment">// true</span>
query.slaveOk(<span class="literal">true</span>)
query.slaveOk(<span class="literal">false</span>)</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-slice"><a href="#query_Query-slice">Query#slice(<code>[path]</code>, <code>val</code>)</a></h3><p>Specifies a $slice projection for an array.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>val</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>number/range of elements to slice</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://www.mongodb.org/display/DOCS/Retrieving+a+Subset+of+Fields#RetrievingaSubsetofFields-RetrievingaSubrangeofArrayElements" title="mongodb">mongodb</a></li><li><a href="http://docs.mongodb.org/manual/reference/projection/slice/#prj._S_slice" title="$slice">$slice</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.slice(<span class="string">'comments'</span>, <span class="number">5</span>)
query.slice(<span class="string">'comments'</span>, -<span class="number">5</span>)
query.slice(<span class="string">'comments'</span>, [<span class="number">10</span>, <span class="number">5</span>])
query.where(<span class="string">'comments'</span>).slice(<span class="number">5</span>)
query.where(<span class="string">'comments'</span>).slice([-<span class="number">10</span>, <span class="number">5</span>])</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-slice"><a href="#query_Query-slice">Query#slice(<code>[path]</code>, <code>[val]</code>)</a></h3><p>Specifies a <code>path</code> for use with chaining.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[path]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[val]</code><span class="types"> &lt;T&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// instead of writing:</span>
User.find({age: {$gte: <span class="number">21</span>, $lte: <span class="number">65</span>}}, callback);

<span class="comment">// we can instead write:</span>
User.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>);

<span class="comment">// passing query conditions is permitted</span>
User.find().where({ name: <span class="string">'vonderful'</span> })

<span class="comment">// chaining</span>
User
.where(<span class="string">'age'</span>).gte(<span class="number">21</span>).lte(<span class="number">65</span>)
.where(<span class="string">'name'</span>, <span class="regexp">/^vonderful/i</span>)
.where(<span class="string">'friends'</span>).slice(<span class="number">10</span>)
.exec(callback)</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-snapshot"><a href="#query_Query-snapshot">Query#snapshot()</a></h3><p>Specifies this query as a <code>snapshot</code> query.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/snapshot/" title="snapshot">snapshot</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.snapshot() <span class="comment">// true</span>
query.snapshot(<span class="literal">true</span>)
query.snapshot(<span class="literal">false</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><hr class=""></div><div class="item method public"><h3 id="query_Query-sort"><a href="#query_Query-sort">Query#sort(<code>arg</code>)</a></h3><p>Sets the sort order</p><div class="params"><h4>Parameters:</h4><ul><li><code>arg</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/method/cursor.sort/" title="cursor.sort">cursor.sort</a></li></ul></div><div class="description"><p>If an object is passed, values allowed are <code>asc</code>, <code>desc</code>, <code>ascending</code>, <code>descending</code>, <code>1</code>, and <code>-1</code>.</p>

<p>If a string is passed, it must be a space delimited list of path names. The<br />sort order of each path is ascending unless the path name is prefixed with <code>-</code><br />which will be treated as descending.</p>

<h4>Example</h4>

<pre><code><span class="comment">// sort by "field" ascending and "test" descending</span>
query.sort({ field: <span class="string">'asc'</span>, test: -<span class="number">1</span> });

<span class="comment">// equivalent</span>
query.sort(<span class="string">'field -test'</span>);</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.sort = <span class="keyword">function</span>(arg) {
  <span class="keyword">if</span> (arguments.length > <span class="number">1</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'sort() only takes 1 Argument'</span>);
  }

  <span class="keyword">return</span> Query.base.sort.call(<span class="keyword">this</span>, arg);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-stream"><a href="#query_Query-stream">Query#stream(<code>[options]</code>)</a></h3><p>Returns a Node.js 0.8 style <a href="http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream">read stream</a> interface.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#querystream_QueryStream">QueryStream</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#querystream_QueryStream" title="QueryStream">QueryStream</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// follows the nodejs 0.8 stream api</span>
Thing.find({ name: <span class="regexp">/^hello/</span> }).stream().pipe(res)

<span class="comment">// manual streaming</span>
<span class="keyword">var</span> stream = Thing.find({ name: <span class="regexp">/^hello/</span> }).stream();

stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
  <span class="comment">// do something with the mongoose document</span>
}).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
  <span class="comment">// handle the error</span>
}).on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="comment">// the stream is closed</span>
});</code></pre>

<h4>Valid options</h4>

<ul>
<li><code>transform</code>: optional function which accepts a mongoose document. The return value of the function will be emitted on <code>data</code>.</li>
</ul>

<h4>Example</h4>

<pre><code><span class="comment">// JSON.stringify all documents before emitting</span>
<span class="keyword">var</span> stream = Thing.find().stream({ transform: JSON.stringify });
stream.pipe(writeStream);</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.stream = <span class="function"><span class="keyword">function</span> <span class="title">stream</span><span class="params">(opts)</span> {</span>
  <span class="keyword">this</span>._applyPaths();
  <span class="keyword">this</span>._fields = <span class="keyword">this</span>._castFields(<span class="keyword">this</span>._fields);
  <span class="keyword">this</span>._castConditions();
  <span class="keyword">return</span> <span class="keyword">new</span> QueryStream(<span class="keyword">this</span>, opts);
};
Query.prototype.stream = util.deprecate(Query.prototype.stream, <span class="string">'Mongoose: '</span> +
  <span class="string">'Query.prototype.stream() is deprecated in mongoose >= 4.5.0, '</span> +
  <span class="string">'use Query.prototype.cursor() instead'</span>);</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-tailable"><a href="#query_Query-tailable">Query#tailable(<code>bool</code>, <code>[opts]</code>, <code>[opts.numberOfRetries]</code>, <code>[opts.tailableRetryInterval]</code>)</a></h3><p>Sets the tailable option (for use with capped collections).</p><div class="params"><h4>Parameters:</h4><ul><li><code>bool</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>defaults to true</span></li><li><code>[opts]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>options to set</span></li><li><code>[opts.numberOfRetries]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>if cursor is exhausted, retry this many times before giving up</span></li><li><code>[opts.tailableRetryInterval]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Number">Number</a>&gt; </span><span>if cursor is exhausted, wait this many milliseconds before retrying</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/tutorial/create-tailable-cursor/" title="tailable">tailable</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.tailable() <span class="comment">// true</span>
query.tailable(<span class="literal">true</span>)
query.tailable(<span class="literal">false</span>)</code></pre>

<h4>Note</h4>

<p>Cannot be used with <code>distinct()</code></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.tailable = <span class="keyword">function</span>(val, opts) {
  <span class="comment">// we need to support the tailable({ awaitdata : true }) as well as the</span>
  <span class="comment">// tailable(true, {awaitdata :true}) syntax that mquery does not support</span>
  <span class="keyword">if</span> (val &amp;&amp; val.constructor.name === <span class="string">'Object'</span>) {
    opts = val;
    val = <span class="literal">true</span>;
  }

  <span class="keyword">if</span> (val === <span class="literal">undefined</span>) {
    val = <span class="literal">true</span>;
  }

  <span class="keyword">if</span> (opts &amp;&amp; <span class="keyword">typeof</span> opts === <span class="string">'object'</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> opts) {
      <span class="keyword">if</span> (key === <span class="string">'awaitdata'</span>) {
        <span class="comment">// For backwards compatibility</span>
        <span class="keyword">this</span>.options[key] = !!opts[key];
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.options[key] = opts[key];
      }
    }
  }

  <span class="keyword">return</span> Query.base.tailable.call(<span class="keyword">this</span>, val);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-then"><a href="#query_Query-then">Query#then(<code>[resolve]</code>, <code>[reject]</code>)</a></h3><p>Executes the query returning a <code>Promise</code> which will be<br />resolved with either the doc(s) or rejected with the error.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[resolve]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li><li><code>[reject]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#promise_Promise">Promise</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.then = <span class="keyword">function</span>(resolve, reject) {
  <span class="keyword">return</span> <span class="keyword">this</span>.exec().then(resolve, reject);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-toConstructor"><a href="#query_Query-toConstructor">Query#toConstructor()</a></h3><p>Converts this query to a customized, reusable query constructor with all arguments and options retained.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>subclass-of-Query</span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="comment">// Create a query for adventure movies and read from the primary</span>
<span class="comment">// node in the replica-set unless it is down, in which case we'll</span>
<span class="comment">// read from a secondary node.</span>
<span class="keyword">var</span> query = Movie.find({ tags: <span class="string">'adventure'</span> }).read(<span class="string">'primaryPreferred'</span>);

<span class="comment">// create a custom Query constructor based off these settings</span>
<span class="keyword">var</span> Adventure = query.toConstructor();

<span class="comment">// Adventure is now a subclass of mongoose.Query and works the same way but with the</span>
<span class="comment">// default query parameters and options set.</span>
Adventure().exec(callback)

<span class="comment">// further narrow down our query results while still using the previous settings</span>
Adventure().where({ name: <span class="regexp">/^Life/</span> }).exec(callback);

<span class="comment">// since Adventure is a stand-alone constructor we can also add our own</span>
<span class="comment">// helper methods and getters without impacting global queries</span>
Adventure.prototype.startsWith = <span class="function"><span class="keyword">function</span> <span class="params">(prefix)</span> {</span>
  <span class="keyword">this</span>.where({ name: <span class="keyword">new</span> RegExp(<span class="string">'^'</span> + prefix) })
  <span class="keyword">return</span> <span class="keyword">this</span>;
}
Object.defineProperty(Adventure.prototype, <span class="string">'highlyRated'</span>, {
  get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.where({ rating: { $gt: <span class="number">4.5</span> }});
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
})
Adventure().highlyRated.startsWith(<span class="string">'Life'</span>).exec(callback)</code></pre>

<p>New in 3.7.3</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.toConstructor = <span class="function"><span class="keyword">function</span> <span class="title">toConstructor</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> model = <span class="keyword">this</span>.model;
  <span class="keyword">var</span> coll = <span class="keyword">this</span>.mongooseCollection;

  <span class="keyword">var</span> CustomQuery = <span class="keyword">function</span>(criteria, options) {
    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> CustomQuery)) {
      <span class="keyword">return</span> <span class="keyword">new</span> CustomQuery(criteria, options);
    }
    <span class="keyword">this</span>._mongooseOptions = utils.clone(p._mongooseOptions);
    Query.call(<span class="keyword">this</span>, criteria, options || <span class="literal">null</span>, model, coll);
  };

  util.inherits(CustomQuery, Query);

  <span class="comment">// set inherited defaults</span>
  <span class="keyword">var</span> p = CustomQuery.prototype;

  p.options = {};

  p.setOptions(<span class="keyword">this</span>.options);

  p.op = <span class="keyword">this</span>.op;
  p._conditions = utils.clone(<span class="keyword">this</span>._conditions, { retainKeyOrder: <span class="literal">true</span> });
  p._fields = utils.clone(<span class="keyword">this</span>._fields);
  p._update = utils.clone(<span class="keyword">this</span>._update, {
    flattenDecimals: <span class="literal">false</span>,
    retainKeyOrder: <span class="literal">true</span>
  });
  p._path = <span class="keyword">this</span>._path;
  p._distinct = <span class="keyword">this</span>._distinct;
  p._collection = <span class="keyword">this</span>._collection;
  p._mongooseOptions = <span class="keyword">this</span>._mongooseOptions;

  <span class="keyword">return</span> CustomQuery;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-update"><a href="#query_Query-update">Query#update(<code>[criteria]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[options.multipleCastError]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as an update() operation.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the update command</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options.multipleCastError]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional, params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.update" title="Model.update">Model.update</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" title="update">update</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><div class="description"><p><em>All paths passed that are not $atomic operations will become $set ops.</em></p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>update()</code></li>
</ul>

<h4>Example</h4>

<pre><code>Model.where({ _id: id }).update({ title: <span class="string">'words'</span> })

<span class="comment">// becomes</span>

Model.where({ _id: id }).update({ $set: { title: <span class="string">'words'</span> }})</code></pre>

<h4>Valid options:</h4>

<ul>
<li><code>safe</code> (boolean) safe mode (defaults to value set in schema (true))</li>
<li><code>upsert</code> (boolean) whether to create the doc if it doesn't match (false)</li>
<li><code>multi</code> (boolean) whether multiple documents should be updated (false)</li>
<li><code>runValidators</code>: if true, runs <a href="../../validation.html#update-validators">update validators</a> on this command. Update validators validate the update operation against the model's schema.</li>
<li><code>setDefaultsOnInsert</code>: if this and <code>upsert</code> are true, mongoose will apply the <a href="../../defaults.html">defaults</a> specified in the model's schema if a new document is created. This option only works on MongoDB >= 2.4 because it relies on <a href="https://docs.mongodb.org/v2.4/reference/operator/update/setOnInsert/">MongoDB's <code>$setOnInsert</code> operator</a>.</li>
<li><code>strict</code> (boolean) overrides the <code>strict</code> option for this update</li>
<li><code>overwrite</code> (boolean) disables update-only mode, allowing you to overwrite the doc (false)</li>
<li><code>context</code> (string) if set to 'query' and <code>runValidators</code> is on, <code>this</code> will refer to the query in custom validator functions that update validation runs. Does nothing if <code>runValidators</code> is false.</li>
</ul>

<h4>Note</h4>

<p>Passing an empty object <code>{}</code> as the doc will result in a no-op unless the <code>overwrite</code> option is passed. Without the <code>overwrite</code> option set, the update operation will be ignored and the callback executed without sending the command to MongoDB so as to prevent accidently overwritting documents in the collection.</p>

<h4>Note</h4>

<p>The operation is only executed when a callback is passed. To force execution without a callback, we must first call update() and then execute it by using the <code>exec()</code> method.</p>

<pre><code>var q = Model.where({ _id: id });
q.update({ $set: { name: 'bob' }}).update(); // not executed

q.update({ $set: { name: 'bob' }}).exec(); // executed

// keys that are not $atomic ops become $set.
// this executes the same command as the previous example.
q.update({ name: 'bob' }).exec();

// overwriting with empty docs
var q = Model.where({ _id: id }).setOptions({ overwrite: true })
q.update({ }, callback); // executes

// multi update with overwrite to empty doc
var q = Model.where({ _id: id });
q.setOptions({ multi: true, overwrite: true })
q.update({ });
q.update(callback); // executed

// multi updates
Model.where()
     .update({ name: /^match/ }, { $set: { arr: [] }}, { multi: true }, callback)

// more multi updates
Model.where()
     .setOptions({ multi: true })
     .update({ $set: { arr: [] }}, callback)

// single update by default
Model.where({ email: '<a href='mailto:address@example.com'>address@example.com</a>' })
     .update({ $inc: { counter: 1 }}, callback)
</code></pre>

<p>API summary</p>

<pre><code>update(criteria, doc, options, cb) <span class="comment">// executes</span>
update(criteria, doc, options)
update(criteria, doc, cb) <span class="comment">// executes</span>
update(criteria, doc)
update(doc, cb) <span class="comment">// executes</span>
update(doc)
update(cb) <span class="comment">// executes</span>
update(<span class="literal">true</span>) <span class="comment">// executes</span>
update()</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.update = <span class="keyword">function</span>(conditions, doc, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    <span class="comment">// .update(conditions, doc, callback)</span>
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> doc === <span class="string">'function'</span>) {
    <span class="comment">// .update(doc, callback);</span>
    callback = doc;
    doc = conditions;
    conditions = {};
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    <span class="comment">// .update(callback)</span>
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
    doc = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'object'</span> &amp;&amp; !doc &amp;&amp; !options &amp;&amp; !callback) {
    <span class="comment">// .update(doc)</span>
    doc = conditions;
    conditions = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
    callback = <span class="literal">undefined</span>;
  }

  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'update'</span>, conditions, doc, options, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-updateMany"><a href="#query_Query-updateMany">Query#updateMany(<code>[criteria]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as an updateMany() operation. Same as<br /><code>update()</code>, except MongoDB will update <em>all</em> documents that match<br /><code>criteria</code> (as opposed to just the first one) regardless of the value of<br />the <code>multi</code> option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the update command</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>optional params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.update" title="Model.update">Model.update</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" title="update">update</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><div class="description"><p><strong>Note</strong> updateMany will <em>not</em> fire update middleware. Use <code>pre('updateMany')</code><br />and <code>post('updateMany')</code> instead.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>updateMany()</code></li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.updateMany = <span class="keyword">function</span>(conditions, doc, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    <span class="comment">// .update(conditions, doc, callback)</span>
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> doc === <span class="string">'function'</span>) {
    <span class="comment">// .update(doc, callback);</span>
    callback = doc;
    doc = conditions;
    conditions = {};
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    <span class="comment">// .update(callback)</span>
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
    doc = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'object'</span> &amp;&amp; !doc &amp;&amp; !options &amp;&amp; !callback) {
    <span class="comment">// .update(doc)</span>
    doc = conditions;
    conditions = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
    callback = <span class="literal">undefined</span>;
  }

  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'updateMany'</span>, conditions, doc, options, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-updateOne"><a href="#query_Query-updateOne">Query#updateOne(<code>[criteria]</code>, <code>[doc]</code>, <code>[options]</code>, <code>[callback]</code>)</a></h3><p>Declare and/or execute this query as an updateOne() operation. Same as<br /><code>update()</code>, except MongoDB will update <em>only</em> the first document that<br />matches <code>criteria</code> regardless of the value of the <code>multi</code> option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>[criteria]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[doc]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>the update command</span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[callback]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>params are (error, writeOpResult)</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="#model_Model.update" title="Model.update">Model.update</a></li><li><a href="http://docs.mongodb.org/manual/reference/method/db.collection.update/" title="update">update</a></li><li><a href="http://mongodb.github.io/node-mongodb-native/2.2/api/Collection.html#~WriteOpResult" title="writeOpResult">writeOpResult</a></li></ul></div><div class="description"><p><strong>Note</strong> updateOne will <em>not</em> fire update middleware. Use <code>pre('updateOne')</code><br />and <code>post('updateOne')</code> instead.</p>

<h2>This function triggers the following middleware</h2>

<ul>
<li><code>updateOne()</code></li>
</ul></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.prototype.updateOne = <span class="keyword">function</span>(conditions, doc, options, callback) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) {
    <span class="comment">// .update(conditions, doc, callback)</span>
    callback = options;
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> doc === <span class="string">'function'</span>) {
    <span class="comment">// .update(doc, callback);</span>
    callback = doc;
    doc = conditions;
    conditions = {};
    options = <span class="literal">null</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'function'</span>) {
    <span class="comment">// .update(callback)</span>
    callback = conditions;
    conditions = <span class="literal">undefined</span>;
    doc = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> conditions === <span class="string">'object'</span> &amp;&amp; !doc &amp;&amp; !options &amp;&amp; !callback) {
    <span class="comment">// .update(doc)</span>
    doc = conditions;
    conditions = <span class="literal">undefined</span>;
    options = <span class="literal">undefined</span>;
    callback = <span class="literal">undefined</span>;
  }

  <span class="keyword">return</span> _update(<span class="keyword">this</span>, <span class="string">'updateOne'</span>, conditions, doc, options, callback);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="query_Query-within"><a href="#query_Query-within">Query#within()</a></h3><p>Defines a <code>$within</code> or <code>$geoWithin</code> argument for geo-spatial queries.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#query-js">Query</a>&gt; </span><span>this</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/polygon/" title="$polygon">$polygon</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/box/" title="$box">$box</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/geometry/" title="$geometry">$geometry</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/center/" title="$center">$center</a></li><li><a href="http://docs.mongodb.org/manual/reference/operator/centerSphere/" title="$centerSphere">$centerSphere</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>query.where(path).within().box()
query.where(path).within().circle()
query.where(path).within().geometry()

query.where(<span class="string">'loc'</span>).within({ center: [<span class="number">50</span>,<span class="number">50</span>], radius: <span class="number">10</span>, unique: <span class="literal">true</span>, spherical: <span class="literal">true</span> });
query.where(<span class="string">'loc'</span>).within({ box: [[<span class="number">40.73</span>, -<span class="number">73.9</span>], [<span class="number">40.7</span>, -<span class="number">73.988</span>]] });
query.where(<span class="string">'loc'</span>).within({ polygon: [[],[],[],[]] });

query.where(<span class="string">'loc'</span>).within([], [], []) <span class="comment">// polygon</span>
query.where(<span class="string">'loc'</span>).within([], []) <span class="comment">// box</span>
query.where(<span class="string">'loc'</span>).within({ type: <span class="string">'LineString'</span>, coordinates: [...] }); <span class="comment">// geometry</span></code></pre>

<p><strong>MUST</strong> be used after <code>where()</code>.</p>

<h4>NOTE:</h4>

<p>As of Mongoose 3.7, <code>$geoWithin</code> is always used for queries. To change this behavior, see <a href="#query_Query-use%2524geoWithin">Query.use$geoWithin</a>.</p>

<h4>NOTE:</h4>

<p>In Mongoose 3.7, <code>within</code> changed from a getter to a function. If you need the old syntax, use <a href="https://github.com/ebensing/mongoose-within">this</a>.</p></div><hr class=""></div><div class="item static private"><h3 id="query_Query._ensurePath"><a href="#query_Query._ensurePath">Query._ensurePath(<code>method</code>)</a></h3><p>Makes sure _path is set.</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="query_Query._fieldsForExec"><a href="#query_Query._fieldsForExec">Query._fieldsForExec()</a></h3><p>Returns fields selection for this query.</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><hr class="private"></div><div class="item static private"><h3 id="query_Query._updateForExec"><a href="#query_Query._updateForExec">Query._updateForExec()</a></h3><p>Return an update document with corrected $set operations.</p><hr class="private"></div><div class="item property public"><h3 id="query_Query-use%2524geoWithin"><a href="#query_Query-use%2524geoWithin">Query#<span>use$geoWithin</span></a></h3><p>Flag to opt out of using <code>$geoWithin</code>.</p>

<pre><code>mongoose.Query.use$geoWithin = <span class="literal">false</span>;</code></pre>

<p>MongoDB 2.4 deprecated the use of <code>$within</code>, replacing it with <code>$geoWithin</code>. Mongoose uses <code>$geoWithin</code> by default (which is 100% backward compatible with $within). If you are running an older version of MongoDB, set this flag to <code>false</code> so your <code>within()</code> queries continue to work.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Query.use$geoWithin = mquery.use$geoWithin;</code></pre></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="http://docs.mongodb.org/manual/reference/operator/geoWithin/">http://docs.mongodb.org/manual/reference/operator/geoWithin/</a></li></ul></div><hr class=""></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/promise_provider.js" id="promise_provider-js">promise_provider.js</a><div class="item method private"><h3 id="promise_provider_"><a href="#promise_provider_">()</a></h3><p>Helper for multiplexing promise implementations</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> Promise = {
  _promise: MPromise
};</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="promise_provider_Promise.get"><a href="#promise_provider_Promise.get">Promise.get()</a></h3><p>Get the current promise constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.get = <span class="keyword">function</span>() {
  <span class="keyword">return</span> Promise._promise;
};</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="promise_provider_Promise.reset"><a href="#promise_provider_Promise.reset">Promise.reset()</a></h3><p>Resets to using mpromise</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.reset = <span class="keyword">function</span>() {
  Promise._promise = MPromise;
};

module.exports = Promise;</code></pre></div><hr class="private"></div><div class="item static private"><h3 id="promise_provider_Promise.set"><a href="#promise_provider_Promise.set">Promise.set()</a></h3><p>Set the current promise constructor</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Promise.set = <span class="keyword">function</span>(lib) {
  <span class="keyword">if</span> (lib === MPromise) {
    <span class="keyword">return</span> Promise.reset();
  }
  Promise._promise = require(<span class="string">'./ES6Promise'</span>);
  Promise._promise.use(lib);
  require(<span class="string">'mquery'</span>).Promise = Promise._promise.ES6;
};</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/schema.js" id="schema-js">schema.js</a><div class="item method public"><h3 id="schema_Schema-add"><a href="#schema_Schema-add">Schema#add(<code>obj</code>, <code>prefix</code>)</a></h3><p>Adds key path / schema type pairs to this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>prefix</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> ToySchema = <span class="keyword">new</span> Schema;
ToySchema.add({ name: <span class="string">'string'</span>, color: <span class="string">'string'</span>, price: <span class="string">'number'</span> });</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(obj, prefix)</span> {</span>
  prefix = prefix || <span class="string">''</span>;
  <span class="keyword">var</span> keys = Object.keys(obj);

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; ++i) {
    <span class="keyword">var</span> key = keys[i];

    <span class="keyword">if</span> (obj[key] == <span class="literal">null</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid value for schema path `'</span> + prefix + key + <span class="string">'`'</span>);
    }

    <span class="keyword">if</span> (Array.isArray(obj[key]) &amp;&amp; obj[key].length === <span class="number">1</span> &amp;&amp; obj[key][<span class="number">0</span>] == <span class="literal">null</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid value for schema Array path `'</span> + prefix + key + <span class="string">'`'</span>);
    }

    <span class="keyword">if</span> (utils.isObject(obj[key]) &amp;&amp;
        (!obj[key].constructor || utils.getFunctionName(obj[key].constructor) === <span class="string">'Object'</span>) &amp;&amp;
        (!obj[key][<span class="keyword">this</span>.options.typeKey] || (<span class="keyword">this</span>.options.typeKey === <span class="string">'type'</span> &amp;&amp; obj[key].type.type))) {
      <span class="keyword">if</span> (Object.keys(obj[key]).length) {
        <span class="comment">// nested object { last: { name: String }}</span>
        <span class="keyword">this</span>.nested[prefix + key] = <span class="literal">true</span>;
        <span class="keyword">this</span>.add(obj[key], prefix + key + <span class="string">'.'</span>);
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (prefix) {
          <span class="keyword">this</span>.nested[prefix.substr(<span class="number">0</span>, prefix.length - <span class="number">1</span>)] = <span class="literal">true</span>;
        }
        <span class="keyword">this</span>.path(prefix + key, obj[key]); <span class="comment">// mixed type</span>
      }
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (prefix) {
        <span class="keyword">this</span>.nested[prefix.substr(<span class="number">0</span>, prefix.length - <span class="number">1</span>)] = <span class="literal">true</span>;
      }
      <span class="keyword">this</span>.path(prefix + key, obj[key]);
    }
  }
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-clone"><a href="#schema_Schema-clone">Schema#clone()</a></h3><p>Returns a deep copy of the schema</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>the cloned schema</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.clone = <span class="keyword">function</span>() {
  <span class="keyword">var</span> s = <span class="keyword">new</span> Schema(<span class="keyword">this</span>.paths, <span class="keyword">this</span>.options);
  <span class="comment">// Clone the call queue</span>
  <span class="keyword">var</span> cloneOpts = { retainKeyOrder: <span class="literal">true</span> };
  s.callQueue = <span class="keyword">this</span>.callQueue.map(<span class="keyword">function</span>(f) { <span class="keyword">return</span> f; });
  s.methods = utils.clone(<span class="keyword">this</span>.methods, cloneOpts);
  s.statics = utils.clone(<span class="keyword">this</span>.statics, cloneOpts);
  s.query = utils.clone(<span class="keyword">this</span>.query, cloneOpts);
  s.plugins = Array.prototype.slice.call(<span class="keyword">this</span>.plugins);
  s._indexes = utils.clone(<span class="keyword">this</span>._indexes, cloneOpts);
  s.s.hooks = <span class="keyword">this</span>.s.hooks.clone();
  <span class="keyword">return</span> s;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_Schema-defaultOptions"><a href="#schema_Schema-defaultOptions">Schema#defaultOptions(<code>options</code>)</a></h3><p>Returns default options for this schema, merged with <code>options</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>options</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.defaultOptions = <span class="keyword">function</span>(options) {
  <span class="keyword">if</span> (options &amp;&amp; options.safe === <span class="literal">false</span>) {
    options.safe = {w: <span class="number">0</span>};
  }

  <span class="keyword">if</span> (options &amp;&amp; options.safe &amp;&amp; options.safe.w === <span class="number">0</span>) {
    <span class="comment">// if you turn off safe writes, then versioning goes off as well</span>
    options.versionKey = <span class="literal">false</span>;
  }

  <span class="keyword">this</span>._userProvidedOptions = utils.clone(options, {
    retainKeyOrder: <span class="literal">true</span>
  });

  options = utils.options({
    strict: <span class="literal">true</span>,
    bufferCommands: <span class="literal">true</span>,
    capped: <span class="literal">false</span>, <span class="comment">// { size, max, autoIndexId }</span>
    versionKey: <span class="string">'__v'</span>,
    discriminatorKey: <span class="string">'__t'</span>,
    minimize: <span class="literal">true</span>,
    autoIndex: <span class="literal">null</span>,
    shardKey: <span class="literal">null</span>,
    read: <span class="literal">null</span>,
    validateBeforeSave: <span class="literal">true</span>,
    <span class="comment">// the following are only applied at construction time</span>
    noId: <span class="literal">false</span>, <span class="comment">// deprecated, use { _id: false }</span>
    _id: <span class="literal">true</span>,
    noVirtualId: <span class="literal">false</span>, <span class="comment">// deprecated, use { id: false }</span>
    id: <span class="literal">true</span>,
    typeKey: <span class="string">'type'</span>,
    retainKeyOrder: <span class="literal">false</span>
  }, options);

  <span class="keyword">if</span> (options.read) {
    options.read = readPref(options.read);
  }

  <span class="keyword">return</span> options;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-eachPath"><a href="#schema_Schema-eachPath">Schema#eachPath(<code>fn</code>)</a></h3><p>Iterates the schemas paths similar to Array#forEach.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback function</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#schema_Schema">Schema</a>&gt; </span><span>this</span></li></ul></div><div class="description"><p>The callback is passed the pathname and schemaType as arguments on each iteration.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.eachPath = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> keys = Object.keys(<span class="keyword">this</span>.paths),
      len = keys.length;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
    fn(keys[i], <span class="keyword">this</span>.paths[keys[i]]);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-get"><a href="#schema_Schema-get">Schema#get(<code>key</code>)</a></h3><p>Gets a schema option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>option name</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.get = <span class="keyword">function</span>(key) {
  <span class="keyword">return</span> <span class="keyword">this</span>.options[key];
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_Schema-hasMixedParent"><a href="#schema_Schema-hasMixedParent">Schema#hasMixedParent(<code>path</code>)</a></h3><p>Returns true iff this path is a child of a mixed schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.hasMixedParent = <span class="keyword">function</span>(path) {
  <span class="keyword">var</span> subpaths = path.split(<span class="regexp">/\./g</span>);
  path = <span class="string">''</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; subpaths.length; ++i) {
    path = i > <span class="number">0</span> ? path + <span class="string">'.'</span> + subpaths[i] : subpaths[i];
    <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.paths &amp;&amp;
        <span class="keyword">this</span>.paths[path] <span class="keyword">instanceof</span> MongooseTypes.Mixed) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
  }

  <span class="keyword">return</span> <span class="literal">false</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-index"><a href="#schema_Schema-index">Schema#index(<code>fields</code>, <code>[options]</code>, <code>[options.expires=null]</code>)</a></h3><p>Defines an index (most likely compound) for this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>fields</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>Options to pass to <a href="http://mongodb.github.io/node-mongodb-native/2.0/api/Collection.html#createIndex">MongoDB driver&#39;s <code>createIndex()</code> function</a></span></li><li><code>[options.expires=null]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>Mongoose-specific syntactic sugar, uses <a href="https://www.npmjs.com/package/ms">ms</a> to convert <code>expires</code> option into seconds for the <code>expireAfterSeconds</code> in the above link.</span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>schema.index({ first: <span class="number">1</span>, last: -<span class="number">1</span> })</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.index = <span class="keyword">function</span>(fields, options) {
  options || (options = {});

  <span class="keyword">if</span> (options.expires) {
    utils.expires(options);
  }

  <span class="keyword">this</span>._indexes.push([fields, options]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_Schema-indexedPaths"><a href="#schema_Schema-indexedPaths">Schema#indexedPaths()</a></h3><p>Returns indexes from fields and schema-level indexes (cached).</p><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.indexedPaths = <span class="function"><span class="keyword">function</span> <span class="title">indexedPaths</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._indexedpaths) {
    <span class="keyword">return</span> <span class="keyword">this</span>._indexedpaths;
  }
  <span class="keyword">this</span>._indexedpaths = <span class="keyword">this</span>.indexes();
  <span class="keyword">return</span> <span class="keyword">this</span>._indexedpaths;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-indexes"><a href="#schema_Schema-indexes">Schema#indexes()</a></h3><p>Returns a list of indexes that this schema declares, via <code>schema.index()</code><br />or by <code>index: true</code> in a path's options.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.indexes = <span class="keyword">function</span>() {
  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> indexes = [];
  <span class="keyword">var</span> schemaStack = [];

  <span class="keyword">var</span> collectIndexes = <span class="keyword">function</span>(schema, prefix) {
    <span class="comment">// Ignore infinitely nested schemas, if we've already seen this schema</span>
    <span class="comment">// along this path there must be a cycle</span>
    <span class="keyword">if</span> (schemaStack.indexOf(schema) !== -<span class="number">1</span>) {
      <span class="keyword">return</span>;
    }
    schemaStack.push(schema);

    prefix = prefix || <span class="string">''</span>;
    <span class="keyword">var</span> key, path, index, field, isObject, options, type;
    <span class="keyword">var</span> keys = Object.keys(schema.paths);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; ++i) {
      key = keys[i];
      path = schema.paths[key];

      <span class="keyword">if</span> ((path <span class="keyword">instanceof</span> MongooseTypes.DocumentArray) || path.$isSingleNested) {
        <span class="keyword">if</span> (path.options.excludeIndexes !== <span class="literal">true</span>) {
          collectIndexes(path.schema, prefix + key + <span class="string">'.'</span>);
        }
      } <span class="keyword">else</span> {
        index = path._index || (path.caster &amp;&amp; path.caster._index);

        <span class="keyword">if</span> (index !== <span class="literal">false</span> &amp;&amp; index !== <span class="literal">null</span> &amp;&amp; index !== <span class="literal">undefined</span>) {
          field = {};
          isObject = utils.isObject(index);
          options = isObject ? index : {};
          type = <span class="keyword">typeof</span> index === <span class="string">'string'</span> ? index :
              isObject ? index.type :
                  <span class="literal">false</span>;

          <span class="keyword">if</span> (type &amp;&amp; ~Schema.indexTypes.indexOf(type)) {
            field[prefix + key] = type;
          } <span class="keyword">else</span> <span class="keyword">if</span> (options.text) {
            field[prefix + key] = <span class="string">'text'</span>;
            <span class="keyword">delete</span> options.text;
          } <span class="keyword">else</span> {
            field[prefix + key] = <span class="number">1</span>;
          }

          <span class="keyword">delete</span> options.type;
          <span class="keyword">if</span> (!(<span class="string">'background'</span> <span class="keyword">in</span> options)) {
            options.background = <span class="literal">true</span>;
          }

          indexes.push([field, options]);
        }
      }
    }

    schemaStack.pop();

    <span class="keyword">if</span> (prefix) {
      fixSubIndexPaths(schema, prefix);
    } <span class="keyword">else</span> {
      schema._indexes.forEach(<span class="keyword">function</span>(index) {
        <span class="keyword">if</span> (!(<span class="string">'background'</span> <span class="keyword">in</span> index[<span class="number">1</span>])) {
          index[<span class="number">1</span>].background = <span class="literal">true</span>;
        }
      });
      indexes = indexes.concat(schema._indexes);
    }
  };

  collectIndexes(<span class="keyword">this</span>);
  <span class="keyword">return</span> indexes;</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-loadClass"><a href="#schema_Schema-loadClass">Schema#loadClass(<code>model</code>)</a></h3><p>Loads an ES6 class into a schema. Maps setters + getters, static methods, and instance methods to schema virtuals, statics, and methods.</p><div class="params"><h4>Parameters:</h4><ul><li><code>model</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.loadClass = <span class="keyword">function</span>(model, virtualsOnly) {
  <span class="keyword">if</span> (model === Object.prototype ||
      model === Function.prototype ||
      model.prototype.hasOwnProperty(<span class="string">'$isMongooseModelPrototype'</span>)) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">this</span>.loadClass(Object.getPrototypeOf(model));

  <span class="comment">// Add static methods</span>
  <span class="keyword">if</span> (!virtualsOnly) {
    Object.getOwnPropertyNames(model).forEach(<span class="keyword">function</span>(name) {
      <span class="keyword">if</span> (name.match(<span class="regexp">/^(length|name|prototype)$/</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> method = Object.getOwnPropertyDescriptor(model, name);
      <span class="keyword">if</span> (<span class="keyword">typeof</span> method.value === <span class="string">'function'</span>) {
        <span class="keyword">this</span>.static(name, method.value);
      }
    }, <span class="keyword">this</span>);
  }

  <span class="comment">// Add methods and virtuals</span>
  Object.getOwnPropertyNames(model.prototype).forEach(<span class="keyword">function</span>(name) {
    <span class="keyword">if</span> (name.match(<span class="regexp">/^(constructor)$/</span>)) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> method = Object.getOwnPropertyDescriptor(model.prototype, name);
    <span class="keyword">if</span> (!virtualsOnly) {
      <span class="keyword">if</span> (<span class="keyword">typeof</span> method.value === <span class="string">'function'</span>) {
        <span class="keyword">this</span>.method(name, method.value);
      }
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> method.get === <span class="string">'function'</span>) {
      <span class="keyword">this</span>.virtual(name).get(method.get);
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> method.set === <span class="string">'function'</span>) {
      <span class="keyword">this</span>.virtual(name).set(method.set);
    }
  }, <span class="keyword">this</span>);

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-method"><a href="#schema_Schema-method">Schema#method(<code>method</code>, <code>[fn]</code>)</a></h3><p>Adds an instance method to documents constructed from Models compiled from this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>name</span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> schema = kittySchema = <span class="keyword">new</span> Schema(..);

schema.method(<span class="string">'meow'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  console.log(<span class="string">'meeeeeoooooooooooow'</span>);
})

<span class="keyword">var</span> Kitty = mongoose.model(<span class="string">'Kitty'</span>, schema);

<span class="keyword">var</span> fizz = <span class="keyword">new</span> Kitty;
fizz.meow(); <span class="comment">// meeeeeooooooooooooow</span></code></pre>

<p>If a hash of name/fn pairs is passed as the only argument, each name/fn pair will be added as methods.</p>

<pre><code>schema.method({
    purr: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
  , scratch: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
});

<span class="comment">// later</span>
fizz.purr();
fizz.scratch();</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.method = <span class="keyword">function</span>(name, fn) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> name !== <span class="string">'string'</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> name) {
      <span class="keyword">this</span>.methods[i] = name[i];
    }
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.methods[name] = fn;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-path"><a href="#schema_Schema-path">Schema#path(<code>path</code>, <code>constructor</code>)</a></h3><p>Gets/sets schema paths.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>constructor</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Sets a path (if arity 2)<br />Gets a path (if arity 1)</p>

<h4>Example</h4>

<pre><code>schema.path(<span class="string">'name'</span>) <span class="comment">// returns a SchemaType</span>
schema.path(<span class="string">'name'</span>, Number) <span class="comment">// changes the schemaType of `name` to Number</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.path = <span class="keyword">function</span>(path, obj) {
  <span class="keyword">if</span> (obj === <span class="literal">undefined</span>) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path]) {
      <span class="keyword">return</span> <span class="keyword">this</span>.paths[path];
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.subpaths[path]) {
      <span class="keyword">return</span> <span class="keyword">this</span>.subpaths[path];
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.singleNestedPaths[path]) {
      <span class="keyword">return</span> <span class="keyword">this</span>.singleNestedPaths[path];
    }

    <span class="comment">// subpaths?</span>
    <span class="keyword">return</span> <span class="regexp">/\.\d+\.?.*$/</span>.test(path)
        ? getPositionalPath(<span class="keyword">this</span>, path)
        : <span class="literal">undefined</span>;
  }

  <span class="comment">// some path names conflict with document methods</span>
  <span class="keyword">if</span> (reserved[path]) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'`'</span> + path + <span class="string">'` may not be used as a schema pathname'</span>);
  }

  <span class="keyword">if</span> (warnings[path]) {
    console.log(<span class="string">'WARN: '</span> + warnings[path]);
  }

  <span class="comment">// update the tree</span>
  <span class="keyword">var</span> subpaths = path.split(<span class="regexp">/\./</span>),
      last = subpaths.pop(),
      branch = <span class="keyword">this</span>.tree;

  subpaths.forEach(<span class="keyword">function</span>(sub, i) {
    <span class="keyword">if</span> (!branch[sub]) {
      branch[sub] = {};
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> branch[sub] !== <span class="string">'object'</span>) {
      <span class="keyword">var</span> msg = <span class="string">'Cannot set nested path `'</span> + path + <span class="string">'`. '</span>
          + <span class="string">'Parent path `'</span>
          + subpaths.slice(<span class="number">0</span>, i).concat([sub]).join(<span class="string">'.'</span>)
          + <span class="string">'` already set to type '</span> + branch[sub].name
          + <span class="string">'.'</span>;
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(msg);
    }
    branch = branch[sub];
  });

  branch[last] = utils.clone(obj);

  <span class="keyword">this</span>.paths[path] = Schema.interpretAsType(path, obj, <span class="keyword">this</span>.options);

  <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path].$isSingleNested) {
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> <span class="keyword">this</span>.paths[path].schema.paths) {
      <span class="keyword">this</span>.singleNestedPaths[path + <span class="string">'.'</span> + key] =
          <span class="keyword">this</span>.paths[path].schema.paths[key];
    }
    <span class="keyword">for</span> (key <span class="keyword">in</span> <span class="keyword">this</span>.paths[path].schema.singleNestedPaths) {
      <span class="keyword">this</span>.singleNestedPaths[path + <span class="string">'.'</span> + key] =
          <span class="keyword">this</span>.paths[path].schema.singleNestedPaths[key];
    }

    <span class="keyword">this</span>.childSchemas.push({
      schema: <span class="keyword">this</span>.paths[path].schema,
      model: <span class="keyword">this</span>.paths[path].caster
    });
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path].$isMongooseDocumentArray) {
    <span class="keyword">this</span>.childSchemas.push({
      schema: <span class="keyword">this</span>.paths[path].schema,
      model: <span class="keyword">this</span>.paths[path].casterConstructor
    });
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-pathType"><a href="#schema_Schema-pathType">Schema#pathType(<code>path</code>)</a></h3><p>Returns the pathType of <code>path</code> for this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="description"><p>Given a path, returns whether it is a real, virtual, nested, or ad-hoc/undefined path.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pathType = <span class="keyword">function</span>(path) {
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.paths) {
    <span class="keyword">return</span> <span class="string">'real'</span>;
  }
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.virtuals) {
    <span class="keyword">return</span> <span class="string">'virtual'</span>;
  }
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.nested) {
    <span class="keyword">return</span> <span class="string">'nested'</span>;
  }
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.subpaths) {
    <span class="keyword">return</span> <span class="string">'real'</span>;
  }
  <span class="keyword">if</span> (path <span class="keyword">in</span> <span class="keyword">this</span>.singleNestedPaths) {
    <span class="keyword">return</span> <span class="string">'real'</span>;
  }

  <span class="keyword">if</span> (<span class="regexp">/\.\d+\.|\.\d+$/</span>.test(path)) {
    <span class="keyword">return</span> getPositionalPathType(<span class="keyword">this</span>, path);
  }
  <span class="keyword">return</span> <span class="string">'adhocOrUndefined'</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-plugin"><a href="#schema_Schema-plugin">Schema#plugin(<code>plugin</code>, <code>[opts]</code>)</a></h3><p>Registers a plugin for this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>plugin</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li><li><code>[opts]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="plugins-2.html" title="plugins">plugins</a></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.plugin = <span class="keyword">function</span>(fn, opts) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'First param to `schema.plugin()` must be a function, '</span> +
      <span class="string">'got "'</span> + (<span class="keyword">typeof</span> fn) + <span class="string">'"'</span>);
  }

  <span class="keyword">if</span> (opts &amp;&amp;
      opts.deduplicate) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.plugins.length; ++i) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.plugins[i].fn === fn) {
        <span class="keyword">return</span> <span class="keyword">this</span>;
      }
    }
  }
  <span class="keyword">this</span>.plugins.push({ fn: fn, opts: opts });

  fn(<span class="keyword">this</span>, opts);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-post"><a href="#schema_Schema-post">Schema#post(<code>method</code>, <code>fn</code>)</a></h3><p>Defines a post hook for the document</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the method to hook</span></li><li><code>fn</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span>callback</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="../../middleware.html" title="middleware">middleware</a></li><li><a href="https://www.npmjs.com/package/hooks-fixed" title="hooks.js">hooks.js</a></li><li><a href="http://npmjs.org/package/kareem" title="kareem">kareem</a></li></ul></div><div class="description"><pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema(..);
schema.post(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(doc)</span> {</span>
  console.log(<span class="string">'this fired after a document was saved'</span>);
});

schema.post(<span class="string">'find'</span>, <span class="keyword">function</span>(docs) {
  console.log(<span class="string">'this fired after you run a find query'</span>);
});

<span class="keyword">var</span> Model = mongoose.model(<span class="string">'Model'</span>, schema);

<span class="keyword">var</span> m = <span class="keyword">new</span> Model(..);
m.save(<span class="keyword">function</span>(err) {
  console.log(<span class="string">'this fires after the `post` hook'</span>);
});

m.find(<span class="keyword">function</span>(err, docs) {
  console.log(<span class="string">'this fires after the post find hook'</span>);
});</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.post = <span class="keyword">function</span>(method, fn) {
  <span class="keyword">if</span> (IS_KAREEM_HOOK[method]) {
    <span class="keyword">this</span>.s.hooks.post.apply(<span class="keyword">this</span>.s.hooks, arguments);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="comment">// assuming that all callbacks with arity &lt; 2 are synchronous post hooks</span>
  <span class="keyword">if</span> (fn.length &lt; <span class="number">2</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="string">'on'</span>, [arguments[<span class="number">0</span>], <span class="keyword">function</span>(doc) {
      <span class="keyword">return</span> fn.call(doc, doc);
    }]);
  }

  <span class="keyword">if</span> (fn.length === <span class="number">3</span>) {
    <span class="keyword">this</span>.s.hooks.post(method + <span class="string">':error'</span>, fn);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="string">'post'</span>, [arguments[<span class="number">0</span>], <span class="keyword">function</span>(next) {
    <span class="comment">// wrap original function so that the callback goes last,</span>
    <span class="comment">// for compatibility with old code that is using synchronous post hooks</span>
    <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
    <span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">1</span>);
    fn.call(<span class="keyword">this</span>, <span class="keyword">this</span>, <span class="keyword">function</span>(err) {
      <span class="keyword">return</span> next.apply(_<span class="keyword">this</span>, [err].concat(args));
    });
  }]);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-pre"><a href="#schema_Schema-pre">Schema#pre(<code>method</code>, <code>callback</code>)</a></h3><p>Defines a pre hook for the document.</p><div class="params"><h4>Parameters:</h4><ul><li><code>method</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>callback</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3" title="hooks.js">hooks.js</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> toySchema = <span class="keyword">new</span> Schema(..);

toySchema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>.created) <span class="keyword">this</span>.created = <span class="keyword">new</span> Date;
  next();
})

toySchema.pre(<span class="string">'validate'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.name !== <span class="string">'Woody'</span>) <span class="keyword">this</span>.name = <span class="string">'Woody'</span>;
  next();
})</code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.pre = <span class="keyword">function</span>() {
  <span class="keyword">var</span> name = arguments[<span class="number">0</span>];
  <span class="keyword">if</span> (IS_KAREEM_HOOK[name]) {
    <span class="keyword">this</span>.s.hooks.pre.apply(<span class="keyword">this</span>.s.hooks, arguments);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="string">'pre'</span>, arguments);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-queue"><a href="#schema_Schema-queue">Schema#queue(<code>name</code>, <code>args</code>)</a></h3><p>Adds a method call to the queue.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the document method to call later</span></li><li><code>args</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>arguments to pass to the method</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.queue = <span class="keyword">function</span>(name, args) {
  <span class="keyword">this</span>.callQueue.push([name, args]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-remove"><a href="#schema_Schema-remove">Schema#remove(<code>path</code>)</a></h3><p>Removes the given <code>path</code> (or [<code>paths</code>]).</p><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.remove = <span class="keyword">function</span>(path) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) {
    path = [path];
  }
  <span class="keyword">if</span> (Array.isArray(path)) {
    path.forEach(<span class="keyword">function</span>(name) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.path(name)) {
        <span class="keyword">delete</span> <span class="keyword">this</span>.paths[name];

        <span class="keyword">var</span> pieces = name.split(<span class="string">'.'</span>);
        <span class="keyword">var</span> last = pieces.pop();
        <span class="keyword">var</span> branch = <span class="keyword">this</span>.tree;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pieces.length; ++i) {
          branch = branch[pieces[i]];
        }
        <span class="keyword">delete</span> branch[last];
      }
    }, <span class="keyword">this</span>);
  }
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-requiredPaths"><a href="#schema_Schema-requiredPaths">Schema#requiredPaths(<code>invalidate</code>)</a></h3><p>Returns an Array of path strings that are required by this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>invalidate</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>&gt; </span><span>refresh the cache</span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.requiredPaths = <span class="function"><span class="keyword">function</span> <span class="title">requiredPaths</span><span class="params">(invalidate)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._requiredpaths &amp;&amp; !invalidate) {
    <span class="keyword">return</span> <span class="keyword">this</span>._requiredpaths;
  }

  <span class="keyword">var</span> paths = Object.keys(<span class="keyword">this</span>.paths),
      i = paths.length,
      ret = [];

  <span class="keyword">while</span> (i--) {
    <span class="keyword">var</span> path = paths[i];
    <span class="keyword">if</span> (<span class="keyword">this</span>.paths[path].isRequired) {
      ret.push(path);
    }
  }
  <span class="keyword">this</span>._requiredpaths = ret;
  <span class="keyword">return</span> <span class="keyword">this</span>._requiredpaths;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema"><a href="#schema_Schema">Schema(<code>definition</code>, <code>[options]</code>)</a></h3><p>Schema constructor.</p><div class="params"><h4>Parameters:</h4><ul><li><code>definition</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="inherits"><h4>Inherits:</h4><ul><li><a href="http://nodejs.org/api/events.html#events_class_events_eventemitter" title="NodeJS EventEmitter">NodeJS EventEmitter</a></li></ul></div><div class="events"><h4>Events:</h4><ul><li><p><code>init</code>: Emitted after the schema is compiled into a <code>Model</code>.</p></li></ul></div><div class="description"><h4>Example:</h4>

<pre><code><span class="keyword">var</span> child = <span class="keyword">new</span> Schema({ name: String });
<span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ name: String, age: Number, children: [child] });
<span class="keyword">var</span> Tree = mongoose.model(<span class="string">'Tree'</span>, schema);

<span class="comment">// setting schema options</span>
<span class="keyword">new</span> Schema({ name: String }, { _id: <span class="literal">false</span>, autoIndex: <span class="literal">false</span> })</code></pre>

<h4>Options:</h4>

<ul>
<li><a href="../../guide.html#autoIndex">autoIndex</a>: bool - defaults to null (which means use the connection's autoIndex option)</li>
<li><a href="../../guide.html#bufferCommands">bufferCommands</a>: bool - defaults to true</li>
<li><a href="../../guide.html#capped">capped</a>: bool - defaults to false</li>
<li><a href="../../guide.html#collection">collection</a>: string - no default</li>
<li><a href="../../guide.html#emitIndexErrors">emitIndexErrors</a>: bool - defaults to false.</li>
<li><a href="../../guide.html#id">id</a>: bool - defaults to true</li>
<li><a href="../../guide.html#_id">_id</a>: bool - defaults to true</li>
<li><code>minimize</code>: bool - controls <a href="#document_Document-toObject">document#toObject</a> behavior when called manually - defaults to true</li>
<li><a href="../../guide.html#read">read</a>: string</li>
<li><a href="../../guide.html#safe">safe</a>: bool - defaults to true.</li>
<li><a href="../../guide.html#shardKey">shardKey</a>: bool - defaults to <code>null</code></li>
<li><a href="../../guide.html#strict">strict</a>: bool - defaults to true</li>
<li><a href="../../guide.html#toJSON">toJSON</a> - object - no default</li>
<li><a href="../../guide.html#toObject">toObject</a> - object - no default</li>
<li><a href="../../guide.html#typeKey">typeKey</a> - string - defaults to 'type'</li>
<li><a href="../../guide.html#useNestedStrict">useNestedStrict</a> - boolean - defaults to false</li>
<li><a href="../../guide.html#validateBeforeSave">validateBeforeSave</a> - bool - defaults to <code>true</code></li>
<li><a href="../../guide.html#versionKey">versionKey</a>: string - defaults to "__v"</li>
<li><a href="../../guide.html#collation">collation</a>: object - defaults to null (which means use no collation)</li>
</ul>

<h4>Note:</h4>

<p><em>When nesting schemas, (<code>children</code> in the example above), always declare the child schema first before passing it into its parent.</em></p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Schema</span><span class="params">(obj, options)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Schema)) {
    <span class="keyword">return</span> <span class="keyword">new</span> Schema(obj, options);
  }

  <span class="keyword">this</span>.obj = obj;
  <span class="keyword">this</span>.paths = {};
  <span class="keyword">this</span>.aliases = {};
  <span class="keyword">this</span>.subpaths = {};
  <span class="keyword">this</span>.virtuals = {};
  <span class="keyword">this</span>.singleNestedPaths = {};
  <span class="keyword">this</span>.nested = {};
  <span class="keyword">this</span>.inherits = {};
  <span class="keyword">this</span>.callQueue = [];
  <span class="keyword">this</span>._indexes = [];
  <span class="keyword">this</span>.methods = {};
  <span class="keyword">this</span>.statics = {};
  <span class="keyword">this</span>.tree = {};
  <span class="keyword">this</span>.query = {};
  <span class="keyword">this</span>.childSchemas = [];
  <span class="keyword">this</span>.plugins = [];

  <span class="keyword">this</span>.s = {
    hooks: <span class="keyword">new</span> Kareem(),
    kareemHooks: IS_KAREEM_HOOK
  };

  <span class="keyword">this</span>.options = <span class="keyword">this</span>.defaultOptions(options);

  <span class="comment">// build paths</span>
  <span class="keyword">if</span> (obj) {
    <span class="keyword">this</span>.add(obj);
  }

  <span class="comment">// check if _id's value is a subdocument (gh-2276)</span>
  <span class="keyword">var</span> _idSubDoc = obj &amp;&amp; obj._id &amp;&amp; utils.isObject(obj._id);

  <span class="comment">// ensure the documents get an auto _id unless disabled</span>
  <span class="keyword">var</span> auto_id = !<span class="keyword">this</span>.paths[<span class="string">'_id'</span>] &amp;&amp;
      (!<span class="keyword">this</span>.options.noId &amp;&amp; <span class="keyword">this</span>.options._id) &amp;&amp; !_idSubDoc;

  <span class="keyword">if</span> (auto_id) {
    <span class="keyword">var</span> _obj = {_id: {auto: <span class="literal">true</span>}};
    _obj._id[<span class="keyword">this</span>.options.typeKey] = Schema.ObjectId;
    <span class="keyword">this</span>.add(_obj);
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>._defaultMiddleware.length; ++i) {
    <span class="keyword">var</span> m = <span class="keyword">this</span>._defaultMiddleware[i];
    <span class="keyword">this</span>[m.kind](m.hook, !!m.isAsync, m.fn);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.options.timestamps) {
    <span class="keyword">this</span>.setupTimestamp(<span class="keyword">this</span>.options.timestamps);
  }

  <span class="comment">// Assign virtual properties based on alias option</span>
  aliasFields(<span class="keyword">this</span>);
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-set"><a href="#schema_Schema-set">Schema#set(<code>key</code>, <code>[value]</code>)</a></h3><p>Sets/gets a schema option.</p><div class="params"><h4>Parameters:</h4><ul><li><code>key</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>option name</span></li><li><code>[value]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>if not passed, the current option value is returned</span></li></ul></div><div class="see"><h4>See:</h4><ul class="see"><li><a href="index-2.html" title="Schema">Schema</a></li></ul></div><div class="description"><h4>Example</h4>

<pre><code>schema.set(<span class="string">'strict'</span>); <span class="comment">// 'true' by default</span>
schema.set(<span class="string">'strict'</span>, <span class="literal">false</span>); <span class="comment">// Sets 'strict' to false</span>
schema.set(<span class="string">'strict'</span>); <span class="comment">// 'false'</span></code></pre></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.set = <span class="keyword">function</span>(key, value, _tags) {
  <span class="keyword">if</span> (arguments.length === <span class="number">1</span>) {
    <span class="keyword">return</span> <span class="keyword">this</span>.options[key];
  }

  <span class="keyword">switch</span> (key) {
    <span class="keyword">case</span> <span class="string">'read'</span>:
      <span class="keyword">this</span>.options[key] = readPref(value, _tags);
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">'safe'</span>:
      <span class="keyword">this</span>.options[key] = value === <span class="literal">false</span>
          ? {w: <span class="number">0</span>}
          : value;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">'timestamps'</span>:
      <span class="keyword">this</span>.setupTimestamp(value);
      <span class="keyword">this</span>.options[key] = value;
      <span class="keyword">break</span>;
    <span class="keyword">default</span>:
      <span class="keyword">this</span>.options[key] = value;
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="schema_Schema-setupTimestamp"><a href="#schema_Schema-setupTimestamp">Schema#setupTimestamp(<code>timestamps</code>)</a></h3><p>Setup updatedAt and createdAt timestamps to documents if enabled</p><div class="params"><h4>Parameters:</h4><ul><li><code>timestamps</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Boolean">Boolean</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>timestamps options</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.setupTimestamp = <span class="keyword">function</span>(timestamps) {
  <span class="keyword">if</span> (timestamps) {
    <span class="keyword">var</span> createdAt = handleTimestampOption(timestamps, <span class="string">'createdAt'</span>);
    <span class="keyword">var</span> updatedAt = handleTimestampOption(timestamps, <span class="string">'updatedAt'</span>);
    <span class="keyword">var</span> schemaAdditions = {};

    <span class="keyword">if</span> (updatedAt &amp;&amp; !<span class="keyword">this</span>.paths[updatedAt]) {
      schemaAdditions[updatedAt] = Date;
    }

    <span class="keyword">if</span> (createdAt &amp;&amp; !<span class="keyword">this</span>.paths[createdAt]) {
      schemaAdditions[createdAt] = Date;
    }

    <span class="keyword">this</span>.add(schemaAdditions);

    <span class="keyword">this</span>.pre(<span class="string">'save'</span>, <span class="keyword">function</span>(next) {
      <span class="keyword">var</span> defaultTimestamp = <span class="keyword">new</span> Date();
      <span class="keyword">var</span> auto_id = <span class="keyword">this</span>._id &amp;&amp; <span class="keyword">this</span>._id.auto;

      <span class="keyword">if</span> (createdAt != <span class="literal">null</span> &amp;&amp; !<span class="keyword">this</span>.get(createdAt) &amp;&amp; <span class="keyword">this</span>.isSelected(createdAt)) {
        <span class="keyword">this</span>.set(createdAt, auto_id ? <span class="keyword">this</span>._id.getTimestamp() : defaultTimestamp);
      }

      <span class="keyword">if</span> (updatedAt != <span class="literal">null</span> &amp;&amp; (<span class="keyword">this</span>.isNew || <span class="keyword">this</span>.isModified())) {
        <span class="keyword">var</span> ts = defaultTimestamp;
        <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) {
          <span class="keyword">if</span> (createdAt != <span class="literal">null</span>) {
            ts = <span class="keyword">this</span>.get(createdAt);
          } <span class="keyword">else</span> <span class="keyword">if</span> (auto_id) {
            ts = <span class="keyword">this</span>._id.getTimestamp();
          }
        }
        <span class="keyword">this</span>.set(updatedAt, ts);
      }

      next();
    });

    <span class="keyword">var</span> genUpdates = <span class="keyword">function</span>(currentUpdate, overwrite) {
      <span class="keyword">var</span> now = <span class="keyword">new</span> Date();
      <span class="keyword">var</span> updates = {};
      <span class="keyword">var</span> _updates = updates;
      <span class="keyword">if</span> (overwrite) {
        <span class="keyword">if</span> (currentUpdate &amp;&amp; currentUpdate.$set) {
          currentUpdate = currentUpdate.$set;
          updates.$set = {};
          _updates = updates.$set;
        }
        <span class="keyword">if</span> (updatedAt != <span class="literal">null</span> &amp;&amp; !currentUpdate[updatedAt]) {
          _updates[updatedAt] = now;
        }
        <span class="keyword">if</span> (createdAt != <span class="literal">null</span> &amp;&amp; !currentUpdate[createdAt]) {
          _updates[createdAt] = now;
        }
        <span class="keyword">return</span> updates;
      }
      updates = { $set: {} };
      currentUpdate = currentUpdate || {};

      <span class="keyword">if</span> (updatedAt != <span class="literal">null</span> &amp;&amp;
          (!currentUpdate.$currentDate || !currentUpdate.$currentDate[updatedAt])) {
        updates.$set[updatedAt] = now;
      }

      <span class="keyword">if</span> (createdAt != <span class="literal">null</span>) {
        <span class="keyword">if</span> (currentUpdate[createdAt]) {
          <span class="keyword">delete</span> currentUpdate[createdAt];
        }
        <span class="keyword">if</span> (currentUpdate.$set &amp;&amp; currentUpdate.$set[createdAt]) {
          <span class="keyword">delete</span> currentUpdate.$set[createdAt];
        }

        updates.$setOnInsert = {};
        updates.$setOnInsert[createdAt] = now;
      }

      <span class="keyword">return</span> updates;
    };

    <span class="keyword">this</span>.methods.initializeTimestamps = <span class="keyword">function</span>() {
      <span class="keyword">if</span> (!<span class="keyword">this</span>.get(createdAt)) {
        <span class="keyword">this</span>.set(createdAt, <span class="keyword">new</span> Date());
      }
      <span class="keyword">if</span> (!<span class="keyword">this</span>.get(updatedAt)) {
        <span class="keyword">this</span>.set(updatedAt, <span class="keyword">new</span> Date());
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    <span class="keyword">this</span>.pre(<span class="string">'findOneAndUpdate'</span>, <span class="keyword">function</span>(next) {
      <span class="keyword">var</span> overwrite = <span class="keyword">this</span>.options.overwrite;
      <span class="keyword">this</span>.findOneAndUpdate({}, genUpdates(<span class="keyword">this</span>.getUpdate(), overwrite), {
        overwrite: overwrite
      });
      applyTimestampsToChildren(<span class="keyword">this</span>);
      next();
    });

    <span class="keyword">this</span>.pre(<span class="string">'update'</span>, <span class="keyword">function</span>(next) {
      <span class="keyword">var</span> overwrite = <span class="keyword">this</span>.options.overwrite;
      <span class="keyword">this</span>.update({}, genUpdates(<span class="keyword">this</span>.getUpdate(), overwrite), {
        overwrite: overwrite
      });
      applyTimestampsToChildren(<span class="keyword">this</span>);
      next();
    });
  }
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="schema_Schema-static"><a href="#schema_Schema-static">Schema#static(<code>name</code>, <code>[fn]</code>)</a></h3><p>Adds static "class" methods to Models compiled from this schema.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>, <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li><li><code>[fn]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function">Function</a>&gt; </span><span></span></li></ul></div><div class="description"><h4>Example</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema(..);
schema.static(<span class="string">'findByName'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(name, callback)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.find({ name: name }, callback);
});

<span class="keyword">var</span> Drink = mongoose.model(<span class="string">'Drink'</span>, schema);
Drink.findByName(<span class="string">'sanpellegrino'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, drinks)</span> {</span>
  <span class="comment">//</span>
});</code></pre>

<p>If a hash of name/fn pairs is passed as the only argument, each name/fn pair will be added as statics.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.static = <span class="keyword">function</span>(name, fn) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> name !== <span class="string">'string'</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> name) {
      <span class="keyword">this</span>.statics[i] = name[i];
    }
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.statics[name] = fn;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-virtual"><a href="#schema_Schema-virtual">Schema#virtual(<code>name</code>, <code>[options]</code>)</a></h3><p>Creates a virtual type with the given name.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>[options]</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtual = <span class="keyword">function</span>(name, options) {
  <span class="keyword">if</span> (options &amp;&amp; options.ref) {
    <span class="keyword">if</span> (!options.localField) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Reference virtuals require `localField` option'</span>);
    }

    <span class="keyword">if</span> (!options.foreignField) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Reference virtuals require `foreignField` option'</span>);
    }

    <span class="keyword">this</span>.pre(<span class="string">'init'</span>, <span class="keyword">function</span>(next, obj) {
      <span class="keyword">if</span> (mpath.has(name, obj)) {
        <span class="keyword">var</span> _v = mpath.get(name, obj);
        <span class="keyword">if</span> (!<span class="keyword">this</span>.$$populatedVirtuals) {
          <span class="keyword">this</span>.$$populatedVirtuals = {};
        }

        <span class="keyword">if</span> (options.justOne) {
          <span class="keyword">this</span>.$$populatedVirtuals[name] = Array.isArray(_v) ?
            _v[<span class="number">0</span>] :
            _v;
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.$$populatedVirtuals[name] = Array.isArray(_v) ?
            _v :
            _v == <span class="literal">null</span> ? [] : [_v];
        }

        mpath.unset(name, obj);
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.ownerDocument) {
        next();
        <span class="keyword">return</span> <span class="keyword">this</span>;
      } <span class="keyword">else</span> {
        next();
      }
    });

    <span class="keyword">var</span> virtual = <span class="keyword">this</span>.virtual(name);
    virtual.options = options;
    <span class="keyword">return</span> virtual.
      get(<span class="keyword">function</span>() {
        <span class="keyword">if</span> (!<span class="keyword">this</span>.$$populatedVirtuals) {
          <span class="keyword">this</span>.$$populatedVirtuals = {};
        }
        <span class="keyword">if</span> (name <span class="keyword">in</span> <span class="keyword">this</span>.$$populatedVirtuals) {
          <span class="keyword">return</span> <span class="keyword">this</span>.$$populatedVirtuals[name];
        }
        <span class="keyword">return</span> <span class="literal">null</span>;
      }).
      set(<span class="keyword">function</span>(_v) {
        <span class="keyword">if</span> (!<span class="keyword">this</span>.$$populatedVirtuals) {
          <span class="keyword">this</span>.$$populatedVirtuals = {};
        }

        <span class="keyword">if</span> (options.justOne) {
          <span class="keyword">this</span>.$$populatedVirtuals[name] = Array.isArray(_v) ?
            _v[<span class="number">0</span>] :
            _v;

          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.$$populatedVirtuals[name] !== <span class="string">'object'</span>) {
            <span class="keyword">this</span>.$$populatedVirtuals[name] = <span class="literal">null</span>;
          }
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.$$populatedVirtuals[name] = Array.isArray(_v) ?
            _v :
            _v == <span class="literal">null</span> ? [] : [_v];

          <span class="keyword">this</span>.$$populatedVirtuals[name] = <span class="keyword">this</span>.$$populatedVirtuals[name].filter(<span class="keyword">function</span>(doc) {
            <span class="keyword">return</span> doc &amp;&amp; <span class="keyword">typeof</span> doc === <span class="string">'object'</span>;
          });
        }
      });
  }

  <span class="keyword">var</span> virtuals = <span class="keyword">this</span>.virtuals;
  <span class="keyword">var</span> parts = name.split(<span class="string">'.'</span>);

  <span class="keyword">if</span> (<span class="keyword">this</span>.pathType(name) === <span class="string">'real'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Virtual path "'</span> + name + <span class="string">'"'</span> +
      <span class="string">' conflicts with a real path in the schema'</span>);
  }

  virtuals[name] = parts.reduce(<span class="keyword">function</span>(mem, part, i) {
    mem[part] || (mem[part] = (i === parts.length - <span class="number">1</span>)
        ? <span class="keyword">new</span> VirtualType(options, name)
        : {});
    <span class="keyword">return</span> mem[part];
  }, <span class="keyword">this</span>.tree);

  <span class="keyword">return</span> virtuals[name];
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="schema_Schema-virtualpath"><a href="#schema_Schema-virtualpath">Schema#virtualpath(<code>name</code>)</a></h3><p>Returns the virtual type with the given <code>name</code>.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li></ul></div><div class="returns"><h4>Returns:</h4><ul><li><span class="types"> &lt;<a href="#virtualtype_VirtualType">VirtualType</a>&gt; </span><span></span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.virtualpath = <span class="keyword">function</span>(name) {
  <span class="keyword">return</span> <span class="keyword">this</span>.virtuals[name];
};</code></pre></div><hr class=""></div><div class="item static public"><h3 id="schema_Schema.indexTypes"><a href="#schema_Schema.indexTypes">Schema.indexTypes()</a></h3><p>The allowed index types</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="keyword">var</span> indexTypes = <span class="string">'2d 2dsphere hashed text'</span>.split(<span class="string">' '</span>);

Object.defineProperty(Schema, <span class="string">'indexTypes'</span>, {
  get: <span class="keyword">function</span>() {
    <span class="keyword">return</span> indexTypes;
  },
  set: <span class="keyword">function</span>() {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Cannot overwrite Schema.indexTypes'</span>);
  }
});</code></pre></div><hr class=""></div><div class="item static private"><h3 id="schema_Schema.interpretAsType"><a href="#schema_Schema.interpretAsType">Schema.interpretAsType(<code>path</code>, <code>obj</code>)</a></h3><p>Converts type arguments into Mongoose Types.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.interpretAsType = function(path, obj, options) {
  if (obj instanceof SchemaType) {
    return obj;
  }

  if (obj.constructor) {
    var constructorName = utils.getFunctionName(obj.constructor);
    if (constructorName !== 'Object') {
      var oldObj = obj;
      obj = {};
      obj[options.typeKey] = oldObj;
    }
  }

  // Get the type making sure to allow keys named "type"
  // and default to mixed if not specified.
  // { type: { type: String, default: 'freshcut' } }
  var type = obj[options.typeKey] &amp;&amp; (options.typeKey !== 'type' || !obj.type.type)
      ? obj[options.typeKey]
      : {};

  if (utils.getFunctionName(type.constructor) === 'Object' || type === 'mixed') {
    return new MongooseTypes.Mixed(path, obj);
  }

  if (Array.isArray(type) || Array === type || type === 'array') {
    // if it was specified through { type } look for `cast`
    var cast = (Array === type || type === 'array')
        ? obj.cast
        : type[0];

    if (cast &amp;&amp; cast.instanceOfSchema) {
      return new MongooseTypes.DocumentArray(path, cast, obj);
    }
    if (cast &amp;&amp;
        cast[options.typeKey] &amp;&amp;
        cast[options.typeKey].instanceOfSchema) {
      return new MongooseTypes.DocumentArray(path, cast[options.typeKey], cast);
    }

    if (Array.isArray(cast)) {
      return new MongooseTypes.Array(path, Schema.interpretAsType(path, cast, options), obj);
    }

    if (typeof cast === 'string') {
      cast = MongooseTypes[cast.charAt(0).toUpperCase() + cast.substring(1)];
    } else if (cast &amp;&amp; (!cast[options.typeKey] || (options.typeKey === 'type' &amp;&amp; cast.type.type))
        &amp;&amp; utils.getFunctionName(cast.constructor) === 'Object') {
      if (Object.keys(cast).length) {
        // The `minimize` and `typeKey` options propagate to child schemas
        // declared inline, like `{ arr: [{ val: { $type: String } }] }`.
        // See gh-3560
        var childSchemaOptions = {minimize: options.minimize};
        if (options.typeKey) {
          childSchemaOptions.typeKey = options.typeKey;
        }
        //propagate 'strict' option to child schema
        if (options.hasOwnProperty('strict')) {
          childSchemaOptions.strict = options.strict;
        }
        //propagate 'runSettersOnQuery' option to child schema
        if (options.hasOwnProperty('runSettersOnQuery')) {
          childSchemaOptions.runSettersOnQuery = options.runSettersOnQuery;
        }
        var childSchema = new Schema(cast, childSchemaOptions);
        childSchema.$implicitlyCreated = true;
        return new MongooseTypes.DocumentArray(path, childSchema, obj);
      } else {
        // Special case: empty object becomes mixed
        return new MongooseTypes.Array(path, MongooseTypes.Mixed, obj);
      }
    }

    if (cast) {
      type = cast[options.typeKey] &amp;&amp; (options.typeKey !== 'type' || !cast.type.type)
          ? cast[options.typeKey]
          : cast;

      name = typeof type === 'string'
          ? type
          : type.schemaName || utils.getFunctionName(type);

      if (!(name in MongooseTypes)) {
        throw new TypeError('Undefined type `' + name + '` at array `' + path +
          '`');
      }
    }

    return new MongooseTypes.Array(path, cast || MongooseTypes.Mixed, obj, options);
  }

  if (type &amp;&amp; type.instanceOfSchema) {
    return new MongooseTypes.Embedded(type, path, obj);
  }

  var name;
  if (Buffer.isBuffer(type)) {
    name = 'Buffer';
  } else {
    name = typeof type === 'string'
        ? type
      // If not string, `type` is a function. Outside of IE, function.name
      // gives you the function name. In IE, you need to compute it
        : type.schemaName || utils.getFunctionName(type);
  }

  if (name) {
    name = name.charAt(0).toUpperCase() + name.substring(1);
  }

  if (undefined == MongooseTypes[name]) {
    throw new TypeError('Undefined type `' + name + '` at `' + path +
        '`
  Did you try nesting Schemas? ' +
        'You can only nest using refs or arrays.');
  }

  obj = utils.clone(obj, { retainKeyOrder: true });
  if (!('runSettersOnQuery' in obj)) {
    obj.runSettersOnQuery = options.runSettersOnQuery;
  }
  return new MongooseTypes[name](path, obj);
};</code></pre></div><div class="params"><h4>Parameters:</h4><ul><li><code>path</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span></span></li><li><code>obj</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>constructor</span></li></ul></div><hr class="private"></div><div class="item static public"><h3 id="schema_Schema.reserved"><a href="#schema_Schema.reserved">Schema.reserved</a></h3><p>Reserved document keys.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.reserved = Object.create(<span class="literal">null</span>);
<span class="keyword">var</span> reserved = Schema.reserved;
<span class="comment">// Core object</span>
reserved[<span class="string">'prototype'</span>] =
<span class="comment">// EventEmitter</span>
reserved.emit =
reserved.on =
reserved.once =
reserved.listeners =
reserved.removeListener =
<span class="comment">// document properties and functions</span>
reserved.collection =
reserved.db =
reserved.errors =
reserved.init =
reserved.isModified =
reserved.isNew =
reserved.get =
reserved.modelName =
reserved.save =
reserved.schema =
reserved.toObject =
reserved.validate =
reserved.remove =
<span class="comment">// hooks.js</span>
reserved._pres = reserved._posts = <span class="number">1</span>;</code></pre></div><p>Keys in this object are names that are rejected in schema declarations b/c they conflict with mongoose functionality. Using these key name will throw an error.</p>

<pre><code>on, emit, _events, db, get, set, init, isNew, errors, schema, options, modelName, collection, _pres, _posts, toObject</code></pre>

<p><em>NOTE:</em> Use of these terms as method names is permitted, but play at your own risk, as they may be existing mongoose document methods you are stomping on.</p>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema(..);
 schema.methods.init = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>} <span class="comment">// potentially breaking</span></code></pre><hr class=""></div><div class="item static public"><h3 id="schema_Schema.Types"><a href="#schema_Schema.Types">Schema.Types</a></h3><p>The various built-in Mongoose Schema Types.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.Types = MongooseTypes = require(<span class="string">'./schema/index'</span>);</code></pre></div><h4>Example:</h4>

<pre><code><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>);
<span class="keyword">var</span> ObjectId = mongoose.Schema.Types.ObjectId;</code></pre>

<h4>Types:</h4>

<ul>
<li><a href="#schema-string-js">String</a></li>
<li><a href="#schema-number-js">Number</a></li>
<li><a href="#schema-boolean-js">Boolean</a> | Bool</li>
<li><a href="#schema-array-js">Array</a></li>
<li><a href="#schema-buffer-js">Buffer</a></li>
<li><a href="#schema-date-js">Date</a></li>
<li><a href="#schema-objectid-js">ObjectId</a> | Oid</li>
<li><a href="#schema-mixed-js">Mixed</a></li>
</ul>

<p>Using this exposed access to the <code>Mixed</code> SchemaType, we can use them in our schema.</p>

<pre><code><span class="keyword">var</span> Mixed = mongoose.Schema.Types.Mixed;
<span class="keyword">new</span> mongoose.Schema({ _user: Mixed })</code></pre><hr class=""></div><div class="item property private"><h3 id="schema_Schema-_defaultMiddleware"><a href="#schema_Schema-_defaultMiddleware">Schema#<span>_defaultMiddleware</span></a></h3><p>Default middleware attached to a schema. Cannot be changed.</p>

<p>This field is used to make sure discriminators don't get multiple copies of<br />built-in middleware. Declared as a constant because changing this at runtime<br />may lead to instability with Model.prototype.discriminator().</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Object.defineProperty(Schema.prototype, <span class="string">'_defaultMiddleware'</span>, {
  configurable: <span class="literal">false</span>,
  enumerable: <span class="literal">false</span>,
  writable: <span class="literal">false</span>,
  value: [
    {
      kind: <span class="string">'pre'</span>,
      hook: <span class="string">'remove'</span>,
      isAsync: <span class="literal">true</span>,
      fn: <span class="keyword">function</span>(next, done) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.ownerDocument) {
          done();
          next();
          <span class="keyword">return</span>;
        }

        <span class="keyword">var</span> subdocs = <span class="keyword">this</span>.$__getAllSubdocs();

        <span class="keyword">if</span> (!subdocs.length) {
          done();
          next();
          <span class="keyword">return</span>;
        }

        each(subdocs, <span class="keyword">function</span>(subdoc, cb) {
          subdoc.remove({ noop: <span class="literal">true</span> }, <span class="keyword">function</span>(err) {
            cb(err);
          });
        }, <span class="keyword">function</span>(error) {
          <span class="keyword">if</span> (error) {
            done(error);
            <span class="keyword">return</span>;
          }
          next();
          done();
        });
      }
    }
  ]
});</code></pre></div><hr class="private"></div><div class="item property public"><h3 id="schema_Schema-childSchemas"><a href="#schema_Schema-childSchemas">Schema#<span>childSchemas</span></a></h3><p>Array of child schemas (from document arrays and single nested subdocs)<br />and their corresponding compiled models. Each element of the array is<br />an object with 2 properties: <code>schema</code> and <code>model</code>.</p>

<p>This property is typically only useful for plugin authors and advanced users.<br />You do not need to interact with this property at all to use mongoose.</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Object.defineProperty(Schema.prototype, <span class="string">'childSchemas'</span>, {
  configurable: <span class="literal">false</span>,
  enumerable: <span class="literal">true</span>,
  writable: <span class="literal">true</span>
});</code></pre></div><hr class=""></div><div class="item property public"><h3 id="schema_Schema-obj"><a href="#schema_Schema-obj">Schema#<span>obj</span></a></h3><p>The original object passed to the schema constructor</p>

<h4>Example:</h4>

<pre><code><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema({ a: String }).add({ b: String });
schema.obj; <span class="comment">// { a: String }</span></code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.obj;</code></pre></div><hr class=""></div><div class="item property private"><h3 id="schema_Schema-paths"><a href="#schema_Schema-paths">Schema#<span>paths</span></a></h3><p>Schema as flat paths</p>

<h4>Example:</h4>

<pre><code>{
    <span class="string">'_id'</span>        : SchemaType,
  , <span class="string">'nested.key'</span> : SchemaType,
}</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.paths;</code></pre></div><hr class="private"></div><div class="item property private"><h3 id="schema_Schema-tree"><a href="#schema_Schema-tree">Schema#<span>tree</span></a></h3><p>Schema as a tree</p>

<h4>Example:</h4>

<pre><code>{
    <span class="string">'_id'</span>     : ObjectId
  , <span class="string">'nested'</span>  : {
        <span class="string">'key'</span> : String
    }
}</code></pre><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Schema.prototype.tree;</code></pre></div><hr class="private"></div></li><li class="module private"><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/document_provider.web.js" id="document_provider-web-js">document_provider.web.js</a><div class="item static private"><h3 id="document_provider.web_module.exports"><a href="#document_provider.web_module.exports">module.exports()</a></h3><p>Returns the Document constructor for the current context</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">module.exports = <span class="keyword">function</span>() {
  <span class="keyword">return</span> BrowserDocument;
};</code></pre></div><hr class="private"></div></li><li class="module "><a href="https://github.com/LearnBoost/mongoose/blob/4.13.20/lib/collection.js" id="collection-js">collection.js</a><div class="item method private"><h3 id="collection_Collection-addQueue"><a href="#collection_Collection-addQueue">Collection#addQueue(<code>name</code>, <code>args</code>)</a></h3><p>Queues a method for later execution when its<br />database connection opens.</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the method to queue</span></li><li><code>args</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">Array</a>&gt; </span><span>arguments to pass to the method when executed</span></li></ul></div><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.addQueue = <span class="keyword">function</span>(name, args) {
  <span class="keyword">this</span>.queue.push([name, args]);
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="collection_Collection"><a href="#collection_Collection">Collection(<code>name</code>, <code>conn</code>, <code>opts</code>)</a></h3><p>Abstract Collection constructor</p><div class="params"><h4>Parameters:</h4><ul><li><code>name</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String">String</a>&gt; </span><span>name of the collection</span></li><li><code>conn</code><span class="types"> &lt;<a href="#connection_Connection">Connection</a>&gt; </span><span>A MongooseConnection instance</span></li><li><code>opts</code><span class="types"> &lt;<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object">Object</a>&gt; </span><span>optional collection options</span></li></ul></div><div class="description"><p>This is the base class that drivers inherit from and implement.</p></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Collection</span><span class="params">(name, conn, opts)</span> {</span>
  <span class="keyword">if</span> (opts === <span class="keyword">void</span> <span class="number">0</span>) {
    opts = {};
  }
  <span class="keyword">if</span> (opts.capped === <span class="keyword">void</span> <span class="number">0</span>) {
    opts.capped = {};
  }

  opts.bufferCommands = <span class="literal">undefined</span> === opts.bufferCommands
      ? <span class="literal">true</span>
      : opts.bufferCommands;

  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.capped === <span class="string">'number'</span>) {
    opts.capped = {size: opts.capped};
  }

  <span class="keyword">this</span>.opts = opts;
  <span class="keyword">this</span>.name = name;
  <span class="keyword">this</span>.collectionName = name;
  <span class="keyword">this</span>.conn = conn;
  <span class="keyword">this</span>.queue = [];
  <span class="keyword">this</span>.buffer = <span class="keyword">this</span>.opts.bufferCommands;
  <span class="keyword">this</span>.emitter = <span class="keyword">new</span> EventEmitter();

  <span class="keyword">if</span> (STATES.connected === <span class="keyword">this</span>.conn.readyState) {
    <span class="keyword">this</span>.onOpen();
  }
}</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-createIndex"><a href="#collection_Collection-createIndex">Collection#createIndex()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.createIndex = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#ensureIndex unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="collection_Collection-doQueue"><a href="#collection_Collection-doQueue">Collection#doQueue()</a></h3><p>Executes all queued methods and clears the queue.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.doQueue = <span class="keyword">function</span>() {
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.queue.length; i &lt; l; i++) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.queue[i][<span class="number">0</span>] === <span class="string">'function'</span>) {
      <span class="keyword">this</span>.queue[i][<span class="number">0</span>].apply(<span class="keyword">this</span>, <span class="keyword">this</span>.queue[i][<span class="number">1</span>]);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>[<span class="keyword">this</span>.queue[i][<span class="number">0</span>]].apply(<span class="keyword">this</span>, <span class="keyword">this</span>.queue[i][<span class="number">1</span>]);
    }
  }
  <span class="keyword">this</span>.queue = [];
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  process.nextTick(<span class="keyword">function</span>() {
    _<span class="keyword">this</span>.emitter.emit(<span class="string">'queue'</span>);
  });
  <span class="keyword">return</span> <span class="keyword">this</span>;
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="collection_Collection-ensureIndex"><a href="#collection_Collection-ensureIndex">Collection#ensureIndex()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.ensureIndex = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#ensureIndex unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-find"><a href="#collection_Collection-find">Collection#find()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.find = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#find unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-findAndModify"><a href="#collection_Collection-findAndModify">Collection#findAndModify()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.findAndModify = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#findAndModify unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-findOne"><a href="#collection_Collection-findOne">Collection#findOne()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.findOne = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#findOne unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-getIndexes"><a href="#collection_Collection-getIndexes">Collection#getIndexes()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.getIndexes = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#getIndexes unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-insert"><a href="#collection_Collection-insert">Collection#insert()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.insert = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#insert unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-mapReduce"><a href="#collection_Collection-mapReduce">Collection#mapReduce()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.mapReduce = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#mapReduce unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method private"><h3 id="collection_Collection-onClose"><a href="#collection_Collection-onClose">Collection#onClose()</a></h3><p>Called when the database disconnects</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.onClose = <span class="keyword">function</span>(force) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.opts.bufferCommands &amp;&amp; !force) {
    <span class="keyword">this</span>.buffer = <span class="literal">true</span>;
  }
};</code></pre></div><hr class="private"></div><div class="item method private"><h3 id="collection_Collection-onOpen"><a href="#collection_Collection-onOpen">Collection#onOpen()</a></h3><p>Called when the database connects</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.onOpen = <span class="keyword">function</span>() {
  <span class="keyword">this</span>.buffer = <span class="literal">false</span>;
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
  setImmediate(<span class="keyword">function</span>() {
    _<span class="keyword">this</span>.doQueue();
  });
};</code></pre></div><hr class="private"></div><div class="item method public"><h3 id="collection_Collection-save"><a href="#collection_Collection-save">Collection#save()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.save = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#save unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item method public"><h3 id="collection_Collection-update"><a href="#collection_Collection-update">Collection#update()</a></h3><p>Abstract method that drivers must implement.</p><div class="description"></div><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.update = <span class="keyword">function</span>() {
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Collection#update unimplemented by driver'</span>);
};</code></pre></div><hr class=""></div><div class="item property public"><h3 id="collection_Collection-collectionName"><a href="#collection_Collection-collectionName">Collection#<span>collectionName</span></a></h3><p>The collection name</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.collectionName;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="collection_Collection-conn"><a href="#collection_Collection-conn">Collection#<span>conn</span></a></h3><p>The Connection instance</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.conn;</code></pre></div><hr class=""></div><div class="item property public"><h3 id="collection_Collection-name"><a href="#collection_Collection-name">Collection#<span>name</span></a></h3><p>The collection name</p><span class="showcode">show code</span><div class="sourcecode"><pre><code class="javascript">Collection.prototype.name;</code></pre></div><hr class=""></div></li></ul></div><script>document.body.className = 'load';</script><script type="text/javascript">!function(name,path,ctx){
  var latest,prev=name!=='Keen'&&window.Keen?window.Keen:false;ctx[name]=ctx[name]||{ready:function(fn){var h=document.getElementsByTagName('head')[0],s=document.createElement('script'),w=window,loaded;s.onload=s.onerror=s.onreadystatechange=function(){if((s.readyState&&!(/^c|loade/.test(s.readyState)))||loaded){return}s.onload=s.onreadystatechange=null;loaded=1;latest=w.Keen;if(prev){w.Keen=prev}else{try{delete w.Keen}catch(e){w.Keen=void 0}}ctx[name]=latest;ctx[name].ready(fn)};s.async=1;s.src=path;h.parentNode.insertBefore(s,h)}}
}('KeenAsync','../../../../d26b395fwzu5fz.cloudfront.net/keen-tracking-1.1.3.min.js',this);

KeenAsync.ready(function(){
  // Configure a client instance
  var client = new KeenAsync({
    projectId: '59aad9cbc9e77c0001ce1b32',
    writeKey: '4B38B0046086885E425D368BFAEAD8FD0D4F2DC2FA2F936FDE058D79508AEFAD9886BC020B96520823BB9C8241D9D9BCFDC0EF52E6033BD89D06E4B24FC13AE955896BF443406269A84DD009CEB5862DCEC944874DB2107FD648DA91ADC1E6DE'
  });
  
  client.recordEvent('pageView', {
    host: window.location.host,
    pathname: window.location.pathname,
    hash: window.location.hash
  });
});</script><script src="../../js/zepto.min.js"></script><script src="../../js/cookies.min.js"></script><script>$(".toggle-item").click(function() {
  var $parent = $(this).parent(),
      $icon   = $(this).find("i");
      
  if($parent.hasClass('displayed')){
    $parent.removeClass('displayed');
    $icon.addClass("fa-caret-right").removeClass("fa-caret-down");
  } else {
    $parent.addClass('displayed');
    $icon.removeClass("fa-caret-right").addClass("fa-caret-down");
  }
});
$(".module").on("click", ".showcode", function (e) {
  $(this).closest(".item").find(".sourcecode").first().toggle();
});
$("#content .controls input").on("click", function (e) {
  $(".private").toggle()
  var checked = $(this).prop('checked');
  Cookies.set('prv', checked);
});
;(function(){
  var checked = 'true' === Cookies.get('prv');
  if (checked) {
    $("#content .controls input").prop('checked', 'checked');
    $(".private").show()
  }
  $("#links, #content").on("click", "a", function (e) {
    if (_gaq && this.hash) {
      _gaq.push(['_trackEvent', 'anchor', 'click', this.hash])
    }
  })
})()</script></body>
<!-- Mirrored from mongoosejs.com/docs/4.x/docs/api.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 18 Apr 2022 10:54:58 GMT -->
</html>